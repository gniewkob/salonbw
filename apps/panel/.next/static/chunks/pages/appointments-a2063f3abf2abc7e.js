(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[883],{6525:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/appointments",function(){return n(5187)}])},9952:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return r}});var i=n(1549),s=n(4194);function r(e){var t,n,r;let{services:a,initial:o,onSubmit:u,onCancel:l}=e,[c,d]=(0,s.useState)(null!==(n=null==o?void 0:o.serviceId)&&void 0!==n?n:null===(t=a[0])||void 0===t?void 0:t.id),[m,p]=(0,s.useState)(null!==(r=null==o?void 0:o.startTime)&&void 0!==r?r:""),[h,v]=(0,s.useState)(""),[y,f]=(0,s.useState)(!1),b=async e=>{e.preventDefault(),v("");try{f(!0),await u({serviceId:Number(c),startTime:m})}catch(e){"object"==typeof e&&null!==e&&"status"in e&&409===e.status?v("Conflict"):e instanceof Error?v(e.message||"Error"):v("Error")}finally{f(!1)}};return(0,i.jsxs)("form",{onSubmit:e=>void b(e),className:"space-y-2",children:[(0,i.jsx)("select",{className:"border p-1 w-full","data-testid":"service-select",value:c,onChange:e=>d(Number(e.target.value)),children:a.map(e=>(0,i.jsx)("option",{value:e.id,children:e.name},e.id))}),(0,i.jsx)("input",{type:"datetime-local",value:m,onChange:e=>p(e.target.value),className:"border p-1 w-full"}),h&&(0,i.jsx)("p",{role:"alert",className:"text-red-600 text-sm",children:h}),(0,i.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,i.jsx)("button",{type:"button",onClick:l,className:"border px-2 py-1",children:"Cancel"}),(0,i.jsx)("button",{type:"submit",className:"border px-2 py-1",disabled:y,children:y?"Saving…":"Save"})]})]})}},2592:function(e,t,n){"use strict";n.d(t,{Z:function(){return r}});var i=n(1549),s=n(4194);function r(e){let{open:t,onClose:n,children:r}=e;return((0,s.useEffect)(()=>{if("undefined"==typeof document)return;let e=e=>{"Escape"===e.key&&n()};return t&&document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[t,n]),t)?(0,i.jsx)("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center",children:(0,i.jsx)("div",{role:"dialog",className:"bg-white p-4 rounded shadow min-w-[300px]",children:r})}):null}},6982:function(e,t,n){"use strict";n.d(t,{s:function(){return a}});var i=n(70),s=n(1247);let r=e=>["api",e];function a(e){var t,n;let{apiFetch:a}=(0,s.a)(),o=(0,i.a)({queryKey:r(e),queryFn:()=>a(e)});return{data:null!==(t=o.data)&&void 0!==t?t:null,error:null!==(n=o.error)&&void 0!==n?n:null,loading:o.isLoading,refetch:o.refetch,queryKey:r(e)}}},5187:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return O}});var i=n(1549),s=n(8583),r=n(1554),a=n(2592),o=n(6982);let u=["api","/appointments"];var l=n(6900),c=n(4194),d=n(6492),m=n(5269),p=n(5412),h=n(4022),v=class extends p.l{#e;#t=void 0;#n;#i;constructor(e,t){super(),this.#e=e,this.setOptions(t),this.bindMethods(),this.#s()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){let t=this.options;this.options=this.#e.defaultMutationOptions(e),(0,h.VS)(this.options,t)||this.#e.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#n,observer:this}),t?.mutationKey&&this.options.mutationKey&&(0,h.Ym)(t.mutationKey)!==(0,h.Ym)(this.options.mutationKey)?this.reset():this.#n?.state.status==="pending"&&this.#n.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#n?.removeObserver(this)}onMutationUpdate(e){this.#s(),this.#r(e)}getCurrentResult(){return this.#t}reset(){this.#n?.removeObserver(this),this.#n=void 0,this.#s(),this.#r()}mutate(e,t){return this.#i=t,this.#n?.removeObserver(this),this.#n=this.#e.getMutationCache().build(this.#e,this.options),this.#n.addObserver(this),this.#n.execute(e)}#s(){let e=this.#n?.state??(0,d.R)();this.#t={...e,isPending:"pending"===e.status,isSuccess:"success"===e.status,isError:"error"===e.status,isIdle:"idle"===e.status,mutate:this.mutate,reset:this.reset}}#r(e){m.Vr.batch(()=>{if(this.#i&&this.hasListeners()){let t=this.#t.variables,n=this.#t.context,i={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};e?.type==="success"?(this.#i.onSuccess?.(e.data,t,n,i),this.#i.onSettled?.(e.data,null,t,n,i)):e?.type==="error"&&(this.#i.onError?.(e.error,t,n,i),this.#i.onSettled?.(void 0,e.error,t,n,i))}this.listeners.forEach(e=>{e(this.#t)})})}};function y(e,t){let n=(0,l.NL)(t),[i]=c.useState(()=>new v(n,e));c.useEffect(()=>{i.setOptions(e)},[i,e]);let s=c.useSyncExternalStore(c.useCallback(e=>i.subscribe(m.Vr.batchCalls(e)),[i]),()=>i.getCurrentResult(),()=>i.getCurrentResult()),r=c.useCallback((e,t)=>{i.mutate(e,t).catch(h.ZT)},[i]);if(s.error&&(0,h.L3)(i.options.throwOnError,[s.error]))throw s.error;return{...s,mutate:r,mutateAsync:s.mutate}}var f=n(1247),b=n(2806),g=n(4607),x=n(7666),S=n.n(x);let N=null,j=null;async function C(){return N||j||(j=Promise.all([Promise.all([n.e(758),n.e(962),n.e(443),n.e(323)]).then(n.bind(n,8323)),Promise.all([n.e(758),n.e(962),n.e(443),n.e(822)]).then(n.bind(n,7822)),Promise.all([n.e(758),n.e(962),n.e(128)]).then(n.bind(n,8128))]).then(e=>{var t,n,i;let[s,r,a]=e,o=[null!==(t=s.default)&&void 0!==t?t:s,null!==(n=r.default)&&void 0!==n?n:r,null!==(i=a.default)&&void 0!==i?i:a];return N=o,o}).finally(()=>{j=null}))}let E=S()(()=>Promise.all([n.e(758),n.e(962),n.e(32)]).then(n.bind(n,4032)),{loadableGenerated:{webpack:()=>[null]},ssr:!1,loading:()=>(0,i.jsx)("div",{className:"rounded border border-dashed p-6 text-sm text-gray-600",children:"Loading calendar…"})}),w=S()(()=>Promise.resolve().then(n.bind(n,9952)),{loadableGenerated:{webpack:()=>[9952]},ssr:!1,loading:()=>(0,i.jsx)("div",{className:"p-4 text-sm text-gray-500",children:"Loading form…"})});function O(){let{data:e,loading:t,error:n}={...(0,o.s)("/appointments"),queryKey:u},{data:d}=(0,o.s)("/services"),m=function(){let{apiFetch:e}=(0,f.a)(),t=(0,b.p)(),n=(0,l.NL)(),i=(0,c.useCallback)(()=>{n.invalidateQueries({queryKey:u})},[n]),s=(0,c.useCallback)(e=>{t.error(e instanceof Error?e.message:"Error")},[t]),r=y({mutationFn:async t=>e("/appointments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),onSuccess:e=>{t.success("Appointment created"),i();try{if(null==e?void 0:e.service){var n,s;(0,g.L9)("purchase",{value:null!==(s=e.service.price)&&void 0!==s?s:0,currency:"PLN",items:[{item_id:e.service.id,item_name:e.service.name,item_category:null===(n=e.service.category)||void 0===n?void 0:n.name}],event_source:"appointments"})}}catch(e){}},onError:s}),a=y({mutationFn:async t=>e("/appointments/".concat(t.id),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.data)}),onSuccess:()=>{t.success("Appointment updated"),i()},onError:s}),o=y({mutationFn:async t=>e("/appointments/".concat(t,"/cancel"),{method:"PATCH"}),onSuccess:()=>{t.success("Appointment cancelled"),i()},onError:s}),d=y({mutationFn:async t=>e("/appointments/".concat(t,"/complete"),{method:"PATCH"}),onSuccess:e=>{t.success("Appointment completed"),i();try{if(null==e?void 0:e.service){var n,s;(0,g.L9)("purchase",{value:null!==(s=e.service.price)&&void 0!==s?s:0,currency:"PLN",items:[{item_id:e.service.id,item_name:e.service.name,item_category:null===(n=e.service.category)||void 0===n?void 0:n.name}],event_source:"appointments"})}}catch(e){}},onError:s});return{create:r.mutateAsync,update:(e,t)=>a.mutateAsync({id:e,data:t}),cancel:o.mutateAsync,complete:d.mutateAsync,mutations:{create:r,update:a,cancel:o,complete:d}}}(),{role:p}=(0,f.a)(),[h,v]=(0,c.useState)(!1),[x,S]=(0,c.useState)(null),[N,j]=(0,c.useState)(""),[O,_]=(0,c.useState)(null),[k,M]=(0,c.useState)(null);(0,c.useEffect)(()=>{let e=!0;return C().then(t=>{e&&(_(t),M(null))}).catch(t=>{e&&(M(t instanceof Error?t.message:"Failed to load calendar"),_([]))}),()=>{e=!1}},[]);let P=(0,c.useMemo)(()=>{var t;return null!==(t=null==e?void 0:e.map(e=>{var t,n;return{id:String(e.id),title:null!==(n=null===(t=e.client)||void 0===t?void 0:t.name)&&void 0!==n?n:String(e.id),start:e.startTime}}))&&void 0!==t?t:[]},[e]);if(t||!d)return(0,i.jsx)("div",{children:"Loading..."});if(n)return(0,i.jsx)("div",{children:"Error"});let T=async e=>{try{let t={startTime:e.event.start.toISOString()};await m.update(Number(e.event.id),t)}catch(t){alert("Conflict"),e.revert()}},L=async e=>{if(x)await m.update(x,{startTime:e.startTime});else{let t={serviceId:e.serviceId,startTime:e.startTime,employeeId:1,...e.clientId?{clientId:e.clientId}:{}};await m.create(t)}v(!1)};return(0,i.jsx)(s.Z,{roles:["client","employee","receptionist","admin"],permission:"nav:appointments",children:(0,i.jsxs)(r.Z,{children:["receptionist"===p&&(0,i.jsx)("div",{children:"Viewing appointments for all employees"}),k?(0,i.jsx)("div",{className:"rounded border border-red-200 bg-red-50 p-4 text-sm text-red-700",children:k}):O?(0,i.jsx)(E,{plugins:O,initialView:"timeGridWeek",events:P,dateClick:e=>{S(null),j(e.dateStr),v(!0)},eventClick:e=>{S(Number(e.event.id)),j(e.event.startStr),v(!0)},eventDrop:e=>{T(e)},editable:!0}):(0,i.jsx)("div",{className:"rounded border border-dashed p-6 text-sm text-gray-600",children:"Preparing calendar…"}),h?(0,i.jsx)(a.Z,{open:!0,onClose:()=>v(!1),children:(0,i.jsx)(w,{services:d,initial:{startTime:N},onSubmit:L,onCancel:()=>v(!1)})}):null]})})}}},function(e){e.O(0,[282,966,888,774,179],function(){return e(e.s=6525)}),_N_E=e.O()}]);