function get_new_calendar_api(){return window.reactLegacyBridge.calendar.api}function is_calendar_interacting(){return document.body.classList.contains("fc-unselectable")}function is_background(e){return"background"===e.rendering}function set_input_value(e,t){$(e).val(t)}function show_event_screen(e,t,n){if(n=n||{},!$.lock_is_active){close_popup(!0),$.lock_is_active=!0,VersumUtils.show_indicator();("new"===t?EventViews.get_new_event_data({beginning:e.beginning,end:e.end,allday:e.allday}):EventViews.fetch_event_data({event_id:e.extendedProps.event_id})).then(function(e){PaymentMethods.set_metod_active("overpayment_balance",e.overpayment_balance>0||PaymentMethods.is_overpayment_balance_present_in_payments(e.main_event.payments)),$.current_event_screen=EventViews.show_event_screen($.extend(e,{action:"new"===t?"edit":"show",component_params:{overpayment_balance:e.overpayment_balance,customer_edition_enabled:!0,services_for_select_manager:services_for_select_manager,default_employee_id:n.default_employee_id,default_resource_id:n.default_resource_id,on_save:function(e,n,a){!n&&close_popup(!0),refresh_events(e);var r;r="new"===t?I18n.t("event_added",{scope:"js.calendar.messages"}):!a&&1===e.length&&e[0].can_be_reverted?I18n.t("changes_commited_with_revert_html",{scope:"js.calendar.messages",event_id:e[0].event_id}):I18n.t("changes_commited",{scope:"js.calendar.messages"}),$.jGrowl(r,{life:3e3,theme:"flash_notice"})},on_finalization:function(t,n){n&&close_popup(!0),refresh_events(t);var a="js.calendar.messages";if(e.events[0].finalized)var r=I18n.t("changes_commited",{scope:a});else if(e.events.length>1)var r=I18n.t("events_finalized",{scope:a});else var r=I18n.t("event_finalized",{scope:a});$.jGrowl(r,{life:3e3,theme:"flash_notice"})},on_component_switch:function(e){$.current_event_screen=e},on_arrived_tag_change:function(e){close_popup(!0),refresh_events(e)},on_beginning_date_change:function(e){$("#datepicker").datepicker("setDate",e.format("YYYY-MM-DD")),get_new_calendar_api().gotoDate(e.format("YYYY-MM-DD"))}}}))}).always(function(){VersumUtils.hide_indicator()})}}function destroy_event(e,t,n){n=n||{},$.lock_is_active=!0;var a=[{label:I18n.t("js.event.remove"),cssClass:"button-danger",action:function(t){CalendarEvent.rest_delete({id:e},n),t.close()}},{label:I18n.t("js.dialog.cancel"),cssClass:"btn btn-default pull-right",action:function(e){e.close()}}];n.destroy_all_future_events_enabled&&(a.push(a[1]),a[1]={label:I18n.t("js.event.remove_with_all_future_events"),cssClass:"button btn-default",action:function(t){n.destroy_all_future_events=1,CalendarEvent.rest_delete({id:e},n),t.close()}}),BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:I18n.t("js.dialog.notice"),message:t?I18n.t("js.event.confirm_removal_when_paid"):I18n.t("js.event.confirm_removal"),onhide:function(){$.lock_is_active=!1},buttons:a})}function revert_event(e){CalendarModels.create_event_reverter(e,"revert").run().then(function(e){$.jGrowl(I18n.t("js.calendar.messages.changes_reverted"),{life:3e3,theme:"flash_notice"}),refresh_events(e)})}function undelete_event(e){CalendarModels.create_event_reverter(e,"undelete").run().then(function(e){$.jGrowl(I18n.t("js.calendar.messages.changes_reverted"),{life:3e3,theme:"flash_notice"}),refresh_events(e)})}function undelete_event_with_confirmation(e){DialogUtils.standard_confirmation({content:I18n.t("js.events.confirm_undeletion"),accept_callback:function(){CalendarModels.create_event_reverter(e,"undelete").run().then(function(e){location.href=e[0].calendar_url})}})}function restore_event_with_confirmation(e){DialogUtils.standard_confirmation({content:I18n.t("js.events.confirm_undeletion"),accept_callback:function(){CalendarModels.create_event_reverter(e,"restore").run().then(function(e){location.href=e[0].calendar_url})}})}function recalculate_calendar_data(e){return e.reduce(function(e,t){const n=$.inArray(t.id,$.map(e,function(e){return e.id}));if(-1!==n){var a=e[n];$.map(t.entities,function(e){if(-1===$.inArray(e,a.entities))return a.entities.push(e)}),t=a}else t.created_at&&(t.created_at=moment.parseZone(t.created_at).utc(!0).toDate()),t.full_start&&(t.full_start=moment.parseZone(t.full_start).utc(!0).toDate()),t.full_end&&(t.full_end=moment.parseZone(t.full_end).utc(!0).toDate()),e.push(t);return t.resourceIds=$.map(t.entities,function(e){return e.id}),(t.canceled||t.finalized)&&(t.editable=!1,t.resourceEditable=!1),t.not_an_appointment&&t.allDay&&(t.resourceEditable=!1,t.durationEditable=!1),t.title=" ",t.prepayment=new reactLegacyBridge.prepayments.Prepayment(t.prepayment),e},[])}function refresh_events(e){var t=CalendarResourceManager.get_active_entities_list(),n=$.map(e,function(e){return e.event_id}),a=get_new_calendar_api().getEvents();a&&$.each(a,function(e,t){-1!==$.inArray(t.extendedProps.event_id,n)&&t.remove()}),e=recalculate_calendar_data(e);for(var r=0;r<e.length;r++){var s=e[r];s.entities.filter(function(e){return-1!==t.findIndex(function(t){return t.id===e.id})}).length&&(s.deleted_at||get_new_calendar_api().addEvent(s,"events"))}setTimeout(function(){for(var t=0;t<e.length;t++)CalendarEvent.mark_event($("._fullcalendar_event_"+e[t].id))},50)}function appointment_was_canceled(){$(".active_popup .bg2 .line, .active_popup .bg2 .advanced_summary").hide(),$("#finalized_at_line").addClass("hidden_line"),$(".active_popup .bg2 .description_line").show(),$('<span class="no_appointment">'+I18n.t("js.calendar.popup.cancelation_reason")+"<br><br></span>").insertBefore(".active_popup .bg2 .description_line").show()}function setup_popup(){$.fn.popup.defaults.blur=!1,$.fn.popup.defaults.background=!1,$.fn.popup.defaults.escape=!1,$.fn.popup.defaults.keepfocus=!1,$.fn.popup.defaults.vertical="top",$(document).on("keydown",function(e){27==e.keyCode&&$.current_popup&&$.current_popup.data("popup-visible")&&($.current_popup.popup("hide"),get_new_calendar_api().unselect())})}function display_popup(e){var t=480;e.width>0&&(t=e.width),$(".popup_content_visible").removeClass("active_popup"),$('.popup_wrapper:not("#print_form_wrapper")').remove(),$.current_popup=$(e.dom_template),$.current_popup.css("max-width",t+"px").addClass("active_popup"),$.current_popup.popup({onopen:function(){if(VersumUtils.loading_stop(),$.current_popup.find(".time-picker").length>0&&("edit"==e.action||"new"==e.action)&&$.current_popup.find(".time-picker").each(function(e,t){var n=$.current_popup.find("#time"+(e+1)).position();$(t).css("left",n.left)}),e.event&&e.event.canceled&&e.action.search("edit")>=0&&appointment_was_canceled(),$(".popup_close_link").show(),$.current_popup.draggable({handle:".bg1"}),!$.current_popup.data("unwrapped")){var t=$(this).offset();$(this).siblings().remove(),$(this).css("position","absolute").css("z-index","100001").css("left",t.left+"px").css("top",t.top+"px").css("margin-top","0").unwrap(),$.current_popup.data("unwrapped",!0),$(".customer_popover").popover("destroy")}$("#description").autogrow({animate:!1}).focus(function(){$(this).keyup()}),$.current_popup.css("height","auto"),e.action.search("new")>=0&&window.setTimeout('$("#customer").click().focus()',200),add_popup_handlers()},onclose:function(){$("#customer-form").hide(),$.current_popup.data("draggable")&&$.current_popup.draggable("destroy"),$(".customer_popover").popover("destroy"),$("#customer").hasClass("ui-autocomplete-input")&&$("#customer").autocomplete("destroy"),$("#event_services, #tags, #event_services").select2("destroy"),VersumUtils.loading_stop()}}),$.current_popup.popup("show")}function add_popup_handlers(){$("a.close, button.close").unbind("click").on("click",function(){close_popup()}),VersumUtils.touch_enabled()||$('[data-toggle="tooltip"]').tooltip()}function print_calendar(){var e={type:"html",event_object:$("#print_calendar"),action:"print",dom_template:print_popup()};close_popup(),display_popup(e)}function print_popup(){return set_input_value("#print_date",moment(get_new_calendar_api().getDate()).format(I18n.t("js.date_format"))),$("#print_date").datepicker({inline:!1,dateFormat:I18n.t("js.date_input_format")}),get_new_calendar_api().getView().type===CalendarViewType.RECEPTION?select_all_print_users():(deselect_all_print_users(),$("input.printuser[value="+$("input.checkboxuser:checked").data("entity-id")+"]").prop("checked",!0)),deselect_all_print_resources(),$("#select_all_users_for_printing").click(function(){select_all_print_users()}),$("#deselect_all_users_for_printing").click(function(){deselect_all_print_users()}),$("#select_all_resources_for_printing").click(function(){select_all_print_resources()}),$("#deselect_all_resources_for_printing").click(function(){deselect_all_print_resources()}),$("#print_button").unbind("click").click(function(e){e.preventDefault(),display_print_prompt()}),"#print_form"}function select_all_print_users(){$("input.printuser").prop("checked",!0)}function deselect_all_print_users(){$("input.printuser").prop("checked",!1)}function select_all_print_resources(){$("input.printresource").prop("checked",!0)}function deselect_all_print_resources(){$("input.printresource").prop("checked",!1)}function display_print_prompt(){var e=moment($("#print_date").datepicker("getDate")),t=moment(e).add(1,"day"),n=[];$("input.printuser:checked").each(function(){n.push($(this).val())});var a=[];$("input.printresource:checked").each(function(){a.push($(this).val())});var r="/print_calendar.pdf/?start="+e.format("YYYY-MM-DD")+"&end="+t.format("YYYY-MM-DD")+"&"+jQuery.param({users:n,resources:a});return window.open(r),close_popup(),!1}function extract_date(e){return moment.parseZone(e).format(I18n.t("js.date_format"))}function extract_date2(e){return parseInt(e.year()+""+add_leading_zero(e.month()+1)+add_leading_zero(e.date()))}function add_leading_zero(e){return e<10?"0"+e:e}function close_popup(e){VersumUtils.loading_stop(),null!==$.current_popup&&($.current_popup.popup("hide"),get_new_calendar_api().unselect()),null!==$.current_event_screen&&$.current_event_screen.isMounted()&&($.current_event_screen.close(e),get_new_calendar_api().unselect())}function confirmation_dialog(e,t,n,a){var r=[];"unrecoverable"!=n.type&&r.push({label:I18n.t("js.dialog.ignore_notice_event"),cssClass:"button-blue",action:function(n){0==$.lock_is_active&&(VersumUtils.loading_start($(this)),_skip_check="&skip_hours_check=skip","create"==t?CalendarEvent.rest_create(e):CalendarEvent.rest_update(e),n.close())}}),r.push({label:I18n.t("js.dialog.correct_event"),cssClass:"unrecoverable"==n.type?"btn-primary":"",action:function(t){t.close(),VersumUtils.loading_stop(),a!=undefined&&(CalendarViewState.is_multi_user()&&e.newEntity&&("employee"==e.newEntity.type?e.employee_id=e.employee.id=e.newEntity.id:"resource"==e.newEntity.type&&(e.resource_ids.splice($.inArray(e.originalEntity.id,e.resource_ids),1),e.resource_ids.push(e.newEntity.id)),e.className=e.newEntity.class_name,e.entities=[e.newEntity]),a())}}),BootstrapDialog.show({title:"unrecoverable"==n.type?I18n.t("js.dialog.error"):I18n.t("js.dialog.notice"),message:n.notice,buttons:r,closable:!1,onhidden:function(){VersumUtils.loading_stop()}})}function translate_view_type(e){return"agendaDay"===e?CalendarViewType.DAY:"agendaWeek"===e?CalendarViewType.WEEK:"month"===e?CalendarViewType.MONTH:CalendarViewType.RECEPTION}function translate_cookie_view_type(e){return e===CalendarViewType.DAY||e===CalendarViewType.MONTH||e===CalendarViewType.WEEK||e===CalendarViewType.RECEPTION?e:translate_view_type(e)}function get_calendar_scroll_time(){return"undefined"==typeof _fullcalendar_scroll_time?"09:00:00":_fullcalendar_scroll_time}function get_calendar_min_time(){return"undefined"==typeof _fullcalendar_min_time?"06:00:00":_fullcalendar_min_time}function get_calendar_max_time(){return"undefined"==typeof _fullcalendar_max_time?"22:00:00":_fullcalendar_max_time}function highlight_event(){var e;if(_fullcalendar_highlight_event.length>0){if(_fullcalendar_highlight_event_service.length>0&&(e=get_new_calendar_api().getEventById(_fullcalendar_highlight_event+"_"+_fullcalendar_highlight_event_service)),!e){var t=get_new_calendar_api().getEvents().filter(function(e){return e.extendedProps.event_id===parseInt(_fullcalendar_highlight_event)}).sort(function(e,t){return e.start<t.start});t&&t.length>0&&(e=t[0])}e&&get_new_calendar_api().scrollToTime(moment.utc(e.start).format("HH:mm:ss")),setTimeout(function(){var e=$("[class*=_fullcalendar_event_"+_fullcalendar_highlight_event+"_]");CalendarEvent.mark_event(e),_fullcalendar_highlight_event=""},50)}}function create_versum_calendar(e){CalendarState.init();var t,n;new Date,DateUtils.get_time_format();if(/reset=/.test(window.location.href)){if(n=moment().format("YYYY-MM-DD"),t=translate_view_type(_fullcalendar_default_view),window.history.replaceState){var a=VersumUtils.remove_param_from_url(window.location.href,"reset");History.replaceState({},document.title,a)}}else n=_fullcalendar_date||CalendarState.get("current_date")||moment().format("YYYY-MM-DD"),t=translate_cookie_view_type(CalendarState.get("current_view"))||translate_view_type(_fullcalendar_default_view);screen_is_narrow&&t!==CalendarViewType.RECEPTION&&(t=CalendarViewType.DAY),$.current_view=t,CalendarViewState.init($.current_view),CalendarResourceManager.init({inputs:$("#entities_box input"),current_single_entity:_fullcalendar_entities&&_fullcalendar_entities.length>0&&t!==CalendarViewType.RECEPTION?_fullcalendar_entities[0]:CalendarState.get("current_single_entity"),current_multiple_entities:_fullcalendar_entities&&_fullcalendar_entities.length>0&&t===CalendarViewType.RECEPTION?CalendarState.get("current_multiple_entities")?$.merge(_fullcalendar_entities,CalendarState.get("current_multiple_entities")):CalendarState.get("current_multiple_entities"):CalendarState.get("current_multiple_entities")||[],multiple_entities_options_container:$(".calendar_entity_options").first(),resources_list_container:$("#calendar #entities_box .scrollable_list").first(),multi_user_mode:CalendarState.get("multi_user_mode")}),CalendarResourcePager.init({calendar_object:e,pages_container:$("[data-calendar-pages-container]").first()}),CalendarWorkingHours.init({calendar_object:e}),CalendarResourceManager.run(),CalendarResourcePager.run(),window.reactLegacyBridge.calendar.config={slot_length_in_minutes:slot_length_in_minutes,_fullcalendar_restricted:_fullcalendar_restricted,_fullcalendar_reception_restricted:_fullcalendar_reception_restricted,_fullcalendar_min_time:get_calendar_min_time(),_fullcalendar_max_time:get_calendar_max_time(),_fullcalendar_scroll_time:get_calendar_scroll_time(),_fullcalendar_time_zone:_fullcalendar_time_zone,get_default_view:function(){return t},get_default_date:function(){return n},get_first_day_of_the_week:function(){return parseInt(DateUtils.get_first_day_of_the_week())},get_week_number_title:function(){return screen_is_narrow?I18n.t("js.calendar.week_tiny"):I18n.t("js.calendar.week_short")},get_time_format:DateUtils.get_time_format,get_datetime_format:DateUtils.get_datetime_format,get_date_format:function(e){return"month_title"===e?I18n.t("js.calendar.titleFormat.month"):"month_column"===e?I18n.t("js.calendar.columnFormat.month"):DateUtils.get_date_format(e)},get_moment_js_locale:DateUtils.get_moment_js_locale,get_current_resources:function(){return CalendarState.set("current_single_entity",CalendarResourceManager.get_current_single_entity()),CalendarState.set("current_multiple_entities",CalendarResourceManager.get_current_multiple_entities()),CalendarResourceManager.get_active_entities_list()},get_event_sources:function(){return[{id:"events",events:function(e,t){var n=moment.utc(e.startStr),a=moment.utc(e.endStr),r=CalendarResourceManager.get_active_entities_list(),s=$.grep(r,function(e){return"employee"===e.type}),i=$.grep(r,function(e){return"resource"===e.type});$.get(events_url,{format:"json",r:rand(),user_ids:$.map(s,function(e){return e.id}),resource_ids:$.map(i,function(e){return e.id}),start:n.format("YYYY-MM-DD"),end:a.format("YYYY-MM-DD")},function(e){t(recalculate_calendar_data(e)),$.is_refetching_events=!1})}},{id:"working-hours",events:function(e,t){var n=moment.utc(e.startStr),a=CalendarResourceManager.get_active_entities_list(),r=$.grep(a,function(e){return"employee"===e.type}),s=$.grep(a,function(e){return"resource"===e.type});$.current_view===CalendarViewType.MONTH&&(n=n.endOf("week")),CalendarWorkingHours.load_working_hours({entity_ids:{employee:$.map(r,function(e){return e.id}),resource:$.map(s,function(e){return e.id})},date:n,period:$.current_view,calendar_callback:t})}}]},handle_loading:function(e){e?($(".fc-button-next,.fc-button-prev").addClass("fc-state-disabled"),VersumUtils.show_indicator()):($(".fc-button-next,.fc-button-prev").removeClass("fc-state-disabled"),VersumUtils.hide_indicator(),highlight_event())},handle_select:function(e,t,n,a,r,s){var i=moment.parseZone(e).utc().utcOffset(moment(e).utcOffset(),!0),o=moment.parseZone(t).utc().utcOffset(moment(t).utcOffset(),!0);if(0!=$.lock_is_active||0!=_fullcalendar_restricted||$.current_popup&&$.current_popup.data("popup-visible"))get_new_calendar_api().unselect();else{var c=n,_=moment();s.type===CalendarViewType.MONTH&&24===moment.duration(o.diff(i)).asHours()&&(c=!1,i.hour(_.hour()),o=i.clone().add(slot_length_in_minutes,"minutes")),c&&(i.hour(_.hour()),o.hour(_.hour()));var p={allday:c,beginning:i,end:o};r?(p.user_id=r&&"employee"===r.extendedProps.type?parseInt(r.id):null,p.resource_id=r&&"resource"===r.extendedProps.type?parseInt(r.id):null):(r=CalendarResourceManager.get_current_single_entity(),p.user_id=r&&"employee"===r.type?parseInt(r.id):null,p.resource_id=r&&"resource"===r.type?parseInt(r.id):null),show_event_screen(p,"new",{default_employee_id:p.user_id,default_resource_id:p.resource_id})}},handle_event_drop:function(e,t,n,a,r,s){if("mousedown"===s.type||"touchstart"===s.type)return void e.remove();if(t=moment.duration(t),e.newEntity=a,e.originalEntity=r,!e.end)return void n();if(0!==t.asMinutes()||!entity_unchanged(e)){CalendarModels.create_event_mover(e,{delta:t,all_employees:$("#event_overlay").data("all-employees"),employees_with_calendar:$("#event_overlay").data("employees-with-calendar"),all_resources:$("#event_overlay").data("all-resources")}).move().done(function(e){close_popup(),refresh_events(e);var t;t=e[0]&&e[0].can_be_reverted?I18n.t("changes_commited_with_revert_html",{scope:"js.calendar.messages",event_id:e[0].event_id}):I18n.t("changes_commited",{scope:"js.calendar.messages"}),$.jGrowl(t,{life:3e3,theme:"flash_notice"})}).fail(function(){n()})}},handle_event_drag_start:function(){$.lock_is_active=!0},handle_event_drag_stop:function(){$.lock_is_active=!1},handle_event_resize:function(e,t,n,a){if("mousedown"===a.type||"touchstart"===a.type)return void e.remove();if(t=moment.duration(t),0!==t.asMinutes()){CalendarModels.create_event_resizer(e,{delta:t,employees_with_calendar:$("#event_overlay").data("employees-with-calendar"),all_resources:$("#event_overlay").data("all-resources")}).resize().done(function(e){close_popup(),refresh_events(e);var t;t=e[0]&&e[0].can_be_reverted?I18n.t("changes_commited_with_revert_html",{scope:"js.calendar.messages",event_id:e[0].event_id}):I18n.t("changes_commited",{scope:"js.calendar.messages"}),$.jGrowl(t,{life:3e3,theme:"flash_notice"})}).fail(function(){n()})}},handle_event_mouseover:function(e){if(-1===e.classNames.indexOf("fc-helper")){$('[class*="_fullcalendar_event_'+e.extendedProps.event_id+'"]').addClass("hovered")}},handle_event_mouseout:function(e){$('[class*="_fullcalendar_event_'+e.extendedProps.event_id+'"]').removeClass("hovered")},handle_event_after_render:function(e,t,n,a){var r=$(t);r.attr("e2e-calendar-event",""),r.data("tooltip")||is_background(e)||a||r.uitooltip({content:function(){var t=$("<div>");$(this).find(".fc-title").length>0?(t.append("<b>"+$(this).find(".full-event-time").html()+"</b><br>"),t.append($(this).find(".fc-title").html())):t.append($(this).find(".full-event-time").html()),t.find(".event-health-survey-status").show();var n=t.find(".event-service-name");return n.show(),e.extendedProps.block_events_services_ids&&n.length>e.extendedProps.block_events_services_ids.length&&n.each(function(){var t=$(this);-1!==$.inArray(t.data("es-id"),e.extendedProps.block_events_services_ids)&&t.addClass("bold")}),t},items:"a",position:{my:"left+1 center",at:"right top+1",collision:"flipfit"},show:!1}).data("tooltip",!0),r.on("tap",function(t){if(!is_background(e)){var n=null;if(e.extendedProps.entities&&e.extendedProps.entities.length)for(var a=0;a<e.extendedProps.entities.length;a++)if("employee"===e.extendedProps.entities[a].type){n=e.extendedProps.entities[a].id;break}show_event_screen(e,"show",{default_employee_id:n,default_resource_id:null})}t.preventDefault()}),VersumUtils.touch_enabled()&&r.addTouch()},handle_event_destroy:function(e){var t=$(".fc-content-skeleton ._fullcalendar_event_"+e.id);if(t.data("tooltip"))try{t.uitooltip("destroy")}catch(e){}$(".ui-tooltip").remove(),$(".ui-helper-hidden-accessible").remove()},handle_view_render:function(e){var t=moment($("#datepicker").datepicker("getDate")).utc(!0),n=moment.utc(e.currentStart),a=moment.utc(e.currentEnd).subtract(1,"minute");!$("#datepicker").datepicker("getDate")||t>=n&&t<=a||$("#datepicker").datepicker("setDate",n.format("YYYY-MM-DD"));var r=moment();(r<n||r>a)&&(r=moment(e.currentStart)),CalendarState.set("current_date",r.utc().format("YYYY-MM-DD")),add_hours_to_hovered_slots(e),CalendarState.set("current_view",e.type),e.type===CalendarViewType.MONTH&&screen_is_narrow&&$(".fc-dayGridMonth-view tbody div").css("min-height","50px"),0===$("#print_calendar").length&&($(".fc-toolbar .fc-left").append('<a href="javascript:;" id="print_calendar" title="'+I18n.t("js.calendar.print_timetable")+'"><div class="icon sprite-print_blue"></div></a>'),$("#print_calendar").click(function(){print_calendar()})),toogle_responsive_view_settings()},handle_resize:function(){toogle_responsive_view_settings();var e=window.matchMedia("(max-width: 768px)").matches?19:17;slot_height!==e&&(slot_height=e,get_new_calendar_api().rerenderEvents()),"undefined"==typeof $(window).get(0).tagName&&waitForFinalEvent(function(){add_hours_to_hovered_slots(get_new_calendar_api().getView()),$.current_working_hours_id="",set_calendar_content_height()},400,"change_employees_listing")},handle_dates_render:function(){set_calendar_content_height(!0)},get_show_events_during_refetch:function(){return $.show_events_during_refetch},is_state_single_user:function(){return CalendarViewState.is_single_user()},get_current_resource_class_name:function(){return CalendarResourceManager.get_current_single_entity().class_name},get_annotation:function(e,t,n){return CalendarWorkingHours.get_period_annotation(e,t,n)},handle_view_or_date_range_changed:function(e){e&&$.current_view!==e&&($.current_view=e,CalendarViewState.handle_view_type_change($.current_view,{state_changed:function(){CalendarResourceManager.handle_view_state(!0),CalendarResourcePager.handle_view_state()}}),set_calendar_content_height(),$.show_events_during_refetch=!1)},set_current_resource:function(e){CalendarResourceManager.set_single_entity({id:e.id,type:e.extendedProps.type,class_name:e.extendedProps.class_name,title:e.title})},handle_event_services_resize:function(e,t,n,a,r){var s="YYYY-MM-DD HH:mm",i=moment.duration(a).asMinutes(),o=moment(moment.utc(t).format(s)),c=moment(moment.utc(n).format(s)),_=moment(c).add(i,"minutes"),p=$.map(e.extendedProps.events_services,function(e){var t={};return $.extend(t,e,{item_duration:parseInt(e.duration),started_at:moment(e.started_at,s),old_started_at:moment(e.started_at,s),get_finished_at:function(){return moment(this.started_at).add(this.item_duration,"minutes")}}),t}).filter(function(t){return-1!==e.extendedProps.block_events_services_ids.indexOf(t.id)});CalendarModels.create_services_resizer(p,{start:o,end:_,old_end:c}).resize();var l=$.map(p,function(e){return{id:e.id,endDelta:moment.duration(e.item_duration-e.duration,"minutes").asMilliseconds(),datesDelta:moment.duration(e.started_at.diff(e.old_started_at)).asMilliseconds()}}).filter(function(e){return-1!==r.indexOf(e.id)});return l.length>0?{endDelta:{years:0,months:0,days:0,milliseconds:l.reduce(function(e,t){return e+t.endDelta},0)},datesDelta:{years:0,months:0,days:0,milliseconds:l[0].datesDelta}}:{}}},window.reactLegacyBridge.calendar.render(e[0]).then(function(){calendar_is_active=!0,set_calendar_content_height(),attach_datepicker(n),setTimeout("calendar_after_load()",40),setup_popup()})}function toogle_responsive_view_settings(){screen_is_narrow?($(".fc-toolbar .fc-today-button, .fc-toolbar #print_calendar").hide(),$(".fc-view thead th").addClass("fc-nowrap"),$("#calendar, .main-container").css("overflow","visible")):($(".fc-toolbar .fc-today-button, .fc-toolbar #print_calendar").show(),$(".fc-view thead th").removeClass("fc-nowrap"),$("#calendar, .main-container").css("overflow","hidden"))}function entity_unchanged(e){return!e.newEntity&&!e.originalEntity||e.newEntity&&e.originalEntity&&e.newEntity.type===e.originalEntity.type&&e.newEntity.id===e.originalEntity.id}function get_column_width(){return $(".fc-view:visible .fc-time-grid .fc-bg td.fc-day:first").outerWidth()}function calendar_after_load(){toogle_responsive_view_settings(),all_users_for_reception_view(),$(document).on("click",".active_popup #canceled",function(){$(this).is(":checked")?appointment_was_canceled():($(".active_popup .bg2 .line, .active_popup .bg2 .advanced_summary").show(),$("#finalized_at_line").removeClass("hidden_line"),$(".active_popup .bg2 .reminders_setup").hide(),$(".active_popup .no_appointment").remove())})}function all_users_for_reception_view(){$(".employee_list_item input.checkboxuser").each(function(){""!=$(this).val()&&(reception_users_list[$(this).val()]=$(this).val())})}function attach_datepicker(e){var t={dateFormat:"yy-mm-dd",showOtherMonths:!0,selectOtherMonths:!0,firstDay:DateUtils.get_first_day_of_the_week(),onSelect:function(e){$("#datepicker").datepicker("setDate",e),$.show_events_during_refetch=!0,get_new_calendar_api().gotoDate(e),CalendarState.set("current_date",e)}};e&&(t.defaultDate=e),$("#datepicker").datepicker(t)}function add_hours_to_hovered_slots(e){if(e.type!==CalendarViewType.MONTH&&!VersumUtils.touch_enabled()){var t=0;_column_width=get_column_width();var n=$(".fc-view:visible .fc-slats"),a=n.find(".fc-axis:first").outerWidth(),r=n.offset().left+a;$(".fc-time-helper").remove(),n.find('td.fc-widget-content:not(".fc-axis")').unbind("mousenter").unbind("mousemove").unbind("mouseleave").on("mouseenter mousemove",function(e){is_calendar_interacting()||(t=Math.max(Math.floor((e.pageX-r)/_column_width)),$(this).html("<div class='fc-time-helper' style='left: "+(_column_width*t+a)+"px'>"+moment($(this).parent().attr("data-time"),"HH:mm:ss").format(DateUtils.get_time_format())+"</div>"))}).on("mouseleave",function(){$(".fc-time-helper").remove()})}}function set_calendar_content_height(e){var t=$(window).height()-100,n=$(".fc-view-container .fc-view:visible");n.hasClass("fc-dayGridMonth-view")||n.find("thead .fc-widget-header").height()+n.find(".fc-day-grid").height()+n.find(".fc-slats").height()+10<t&&(t="auto"),screen_is_narrow&&(t="auto"),(void 0===get_new_calendar_api().getOption("contentHeight")||get_new_calendar_api().getOption("contentHeight")!==t||e)&&(get_new_calendar_api().setOption("contentHeight",t),$.skip_scroll?$.skip_scroll=!1:get_new_calendar_api().scrollToTime(_fullcalendar_scroll_time||"09:00:00"))}function update_events_if_neccessary(e){$.lock_is_active||last_changed_event==e||$("#loading_indicator").is(":visible")||(last_changed_event=e,$.show_events_during_refetch=!0,$.is_refetching_events=!0,$.skip_scroll=!0,setTimeout(function(){get_new_calendar_api().refetchEvents()},1e3))}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){var t={init:function(n){var a=e.extend({items:1,itemsOnPage:1,pages:0,displayedPages:5,edges:2,currentPage:0,hrefTextPrefix:"#page-",hrefTextSuffix:"",prevText:"Prev",nextText:"Next",ellipseText:"&hellip;",cssStyle:"light-theme",labelMap:[],selectOnClick:!0,nextAtFront:!1,invertPageOrder:!1,onPageClick:function(){},onInit:function(){}},n||{}),r=this;return a.pages=a.pages?a.pages:Math.ceil(a.items/a.itemsOnPage)?Math.ceil(a.items/a.itemsOnPage):1,a.currentPage?a.currentPage=a.currentPage-1:a.currentPage=a.invertPageOrder?a.pages-1:0,a.halfDisplayed=a.displayedPages/2,this.each(function(){r.addClass(a.cssStyle+" simple-pagination").data("pagination",a),t._draw.call(r)}),a.onInit(),this},selectPage:function(e){return t._selectPage.call(this,e-1),this},prevPage:function(){var e=this.data("pagination");return e.invertPageOrder?e.currentPage<e.pages-1&&t._selectPage.call(this,e.currentPage+1):e.currentPage>0&&t._selectPage.call(this,e.currentPage-1),this},nextPage:function(){var e=this.data("pagination");return e.invertPageOrder?e.currentPage>0&&t._selectPage.call(this,e.currentPage-1):e.currentPage<e.pages-1&&t._selectPage.call(this,e.currentPage+1),this},getPagesCount:function(){return this.data("pagination").pages},getCurrentPage:function(){return this.data("pagination").currentPage+1},destroy:function(){return this.empty(),this},drawPage:function(e){var n=this.data("pagination");return n.currentPage=e-1,this.data("pagination",n),t._draw.call(this),this},redraw:function(){return t._draw.call(this),this},disable:function(){var e=this.data("pagination");return e.disabled=!0,this.data("pagination",e),t._draw.call(this),this},enable:function(){var e=this.data("pagination");return e.disabled=!1,this.data("pagination",e),t._draw.call(this),this},updateItems:function(e){var n=this.data("pagination");n.items=e,n.pages=t._getPages(n),this.data("pagination",n),t._draw.call(this)},updateItemsOnPage:function(e){var n=this.data("pagination");return n.itemsOnPage=e,n.pages=t._getPages(n),this.data("pagination",n),t._selectPage.call(this,0),this},_draw:function(){var n,a,r=this.data("pagination"),s=t._getInterval(r);t.destroy.call(this),a="function"==typeof this.prop?this.prop("tagName"):this.attr("tagName")
;var i="UL"===a?this:e("<ul></ul>").appendTo(this);if(r.prevText&&t._appendItem.call(this,r.invertPageOrder?r.currentPage+1:r.currentPage-1,{text:r.prevText,classes:"prev"}),r.nextText&&r.nextAtFront&&t._appendItem.call(this,r.invertPageOrder?r.currentPage-1:r.currentPage+1,{text:r.nextText,classes:"next"}),r.invertPageOrder){if(s.end<r.pages&&r.edges>0){var o=Math.max(r.pages-r.edges,s.end);for(n=r.pages-1;n>=o;n--)t._appendItem.call(this,n);r.pages-r.edges>s.end&&r.pages-r.edges-s.end!=1?i.append('<li class="disabled"><span class="ellipse">'+r.ellipseText+"</span></li>"):r.pages-r.edges-s.end==1&&t._appendItem.call(this,s.end)}}else if(s.start>0&&r.edges>0){var c=Math.min(r.edges,s.start);for(n=0;n<c;n++)t._appendItem.call(this,n);r.edges<s.start&&s.start-r.edges!=1?i.append('<li class="disabled"><span class="ellipse">'+r.ellipseText+"</span></li>"):s.start-r.edges==1&&t._appendItem.call(this,r.edges)}if(r.invertPageOrder)for(n=s.end-1;n>=s.start;n--)t._appendItem.call(this,n);else for(n=s.start;n<s.end;n++)t._appendItem.call(this,n);if(r.invertPageOrder){if(s.start>0&&r.edges>0){r.edges<s.start&&s.start-r.edges!=1?i.append('<li class="disabled"><span class="ellipse">'+r.ellipseText+"</span></li>"):s.start-r.edges==1&&t._appendItem.call(this,r.edges);var c=Math.min(r.edges,s.start);for(n=c-1;n>=0;n--)t._appendItem.call(this,n)}}else if(s.end<r.pages&&r.edges>0){r.pages-r.edges>s.end&&r.pages-r.edges-s.end!=1?i.append('<li class="disabled"><span class="ellipse">'+r.ellipseText+"</span></li>"):r.pages-r.edges-s.end==1&&t._appendItem.call(this,s.end);var o=Math.max(r.pages-r.edges,s.end);for(n=o;n<r.pages;n++)t._appendItem.call(this,n)}r.nextText&&!r.nextAtFront&&t._appendItem.call(this,r.invertPageOrder?r.currentPage-1:r.currentPage+1,{text:r.nextText,classes:"next"})},_getPages:function(e){return Math.ceil(e.items/e.itemsOnPage)||1},_getInterval:function(e){return{start:Math.ceil(e.currentPage>e.halfDisplayed?Math.max(Math.min(e.currentPage-e.halfDisplayed,e.pages-e.displayedPages),0):0),end:Math.ceil(e.currentPage>e.halfDisplayed?Math.min(e.currentPage+e.halfDisplayed,e.pages):Math.min(e.displayedPages,e.pages))}},_appendItem:function(n,a){var r,s,i=this,o=i.data("pagination"),c=e("<li></li>"),_=i.find("ul");n=n<0?0:n<o.pages?n:o.pages-1,r={text:n+1,classes:""},o.labelMap.length&&o.labelMap[n]&&(r.text=o.labelMap[n]),r=e.extend(r,a||{}),n==o.currentPage||o.disabled?(o.disabled?c.addClass("disabled"):c.addClass("active"),s=e('<span class="current">'+r.text+"</span>")):(s=e('<a href="'+o.hrefTextPrefix+(n+1)+o.hrefTextSuffix+'" class="page-link">'+r.text+"</a>"),s.click(function(e){return t._selectPage.call(i,n,e)})),r.classes&&s.addClass(r.classes),c.append(s),_.length?_.append(c):i.append(c)},_selectPage:function(e,n){var a=this.data("pagination");return a.currentPage=e,a.selectOnClick&&t._draw.call(this),a.onPageClick(e+1,n)}};e.fn.pagination=function(n){return t[n]&&"_"!=n.charAt(0)?t[n].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof n&&n?void e.error("Method "+n+" does not exist on jQuery.pagination"):t.init.apply(this,arguments)}}(jQuery);var VersumPagination=function(e){function t(e,t){var n=this,a=t.onPageClick;delete t.onPageClick,t=t||{},t.onPageClick=function(e,t){n._toggle_arrows(),n._add_dropdowns(),t&&VersumUtils.preventEvent(t),"function"==typeof a&&a(e,t)},t.hrefTextPrefix="#page-",this.element=e,this.element.addClass("versum-pagination"),this.element.pagination(t),this.show_arrows=t.show_arrows,this.dropdown_position=t.dropdown_position||"top",this._toggle_arrows(),this._add_dropdowns()}return t.prototype.select_page=function(e){this.element.pagination("selectPage",e)},t.prototype.draw_page=function(e){this.element.pagination("drawPage",e),this._toggle_arrows(),this._add_dropdowns()},t.prototype._toggle_arrows=function(){this.show_arrows||this.element.find("li:first-child, li:last-child").remove()},t.prototype._add_dropdowns=function(){var t=this;this.element.find(".ellipse").each(function(){t._add_dropdown(e(this))})},t.prototype._add_dropdown=function(t){var n=t.parent();n.attr("data-dropdown-hover",!0),"top"==this.dropdown_position&&n.addClass("dropup");var a=e('<div class="dropdown-menu"></div>');this._add_controls_to_dropdown_menu(a,n),n.append(a),t.attr("data-toggle","dropdown")},t.prototype._add_controls_to_dropdown_menu=function(e,t){for(var n=parseInt(t.prev().find(".page-link").attr("href").replace("#page-",""))+1,a=parseInt(t.next().find(".page-link").attr("href").replace("#page-",""))-1,r=n;r<=a;r++)this._add_page_control(r,e)},t.prototype._add_page_control=function(t,n){var a=this,r=e("<a>",{href:"#page-"+t,text:t,"class":"page-link"});r.click(function(e){VersumUtils.preventEvent(e),a.select_page(t)}),n.append(r)},t}(jQuery),calendar_object,users_list=[],reception_users_list=[],events_url="/events/",curentQtip=null,curentQtip_target=null,currently_edited_event=null,revert_modified_event,revert_deleted_event,event_data_cache=null,finalization_screen_data_cache=null,_skip_check="",working_hours=[],template_cache=[],screen_is_narrow=$(window).width()<768,services_for_select_manager=null;$.lock_is_active=!1;var _column_width=120;$.current_event_screen=null,$.current_popup=null,$.current_working_hours_id="",$.current_view="",$.show_events_during_refetch=!0;var slot_height=window.matchMedia("(max-width: 768px)").matches?19:17;$.is_refetching_events=!0,$.skip_scroll=!1;var CalendarViewType={RECEPTION:"resourceTimeGridDay",DAY:"timeGridDay",WEEK:"timeGridWeek",MONTH:"dayGridMonth"};$(document).ready(function(){services_for_select_manager=CalendarModels.ServicesForSelectManagerAltered,calendar_object=$("#calendar_container"),calendar_object.length>0&&("reception"==_fullcalendar_default_view&&all_users_for_reception_view(),create_versum_calendar($("#calendar_container")),$(document).on("click","#entities_box input",function(e){!$(this).is(":checked")&&CalendarResourceManager.get_multiple_entities_count()<=1?(VersumUtils.preventEvent(e),$.jGrowl(I18n.t("js.calendar.employee_must_be_selected"),{life:5e3,theme:"flash_alert"})):(CalendarResourceManager.update_active_entities(),CalendarResourcePager.update_controls(),add_hours_to_hovered_slots(get_new_calendar_api().getView()))}),$.PeriodicalUpdater("/track_new_events.json",{method:"get",data:"",minTimeout:18e4,maxTimeout:18e4,multiplier:1,type:"json",maxCalls:0,autoStop:0},function(e){update_events_if_neccessary(e.last_event_update)}))}),function(e,t){e.rest_delete=function(e,n){n=n||{};var a={};n.start&&n.start(),n.destroy_all_future_events&&(a.destroy_all_future_events=1),jQuery.ajax({type:"DELETE",url:events_url+e.id,dataType:"json",cache:!1,data:a,success:function(e){var a;a=e[0]&&e[0].can_be_undeleted?I18n.t("js.calendar.messages.event_deleted_with_revert_html",{event_id:e[0].event_id}):I18n.t("js.calendar.messages.event_deleted"),t.jGrowl(a,{life:5e3,theme:"flash_notice"}),refresh_events(e),t.lock_is_active=!1,"undefined"!=typeof mpq&&mpq.track("Appointment deleted"),n.success&&n.success()},error:function(e,a,r){if(422===e.status){var s=JSON.parse(e.responseText);s.errors[0]&&t.jGrowl(s.errors[0],{life:5e3,theme:"flash_alert"})}else VersumUtils.handle_ajax_error(e,a,r);n.error&&n.error()}})},e.mark_event=function(e){e.animate({opacity:.3},300,function(){e.animate({opacity:1},200,function(){e.addClass("e2e-event-marked")})})}}(window.CalendarEvent=window.CalendarEvent||{},jQuery),function(e,t,n){e.BEGINNING_OF_DAY_MIDNIGHT="0:00",e.END_OF_DAY_MIDNIGHT="24:00",e.date_from_string=function(e){return e==n&&(e=""),moment.utc(e,"YYYY-MM-DD HH:mm")},e.date_to_string=function(e){return moment(e).format("YYYY-MM-DD")},e.current_moment_no_time_zone=function(){return e.date_from_string(moment().format("YYYY-MM-DD HH:mm"))},e.moment_without_time_zone=function(e){return e.format("YYYY-MM-DD HH:mm")}}(window.CalendarUtils=window.CalendarUtils||{},jQuery),function(e,t,n){function a(n){t(".bg2 .price_summary_t .price").each(function(){var a=t(this),r=!1,s=e.parse(a.val());s<0?(r=!0,a.val(0)):s>n&&(r=!0,a.val(n)),r&&e.balance_prices()})}function r(){return t(".price_summary_t table").find("select").map(function(){return t(this).val()})}function s(e){return-1!=t.inArray(e,r())}e.update_price_summary=function(){if(t(".price_summary_t table tbody tr").length>0){var n=0;t(".bg2 .services_content .price").length>0?t(".bg2 .services_content .price").each(function(){n+=e.parse(t(this).val())}):t(".price_summary_t table tbody .price").each(function(){n+=e.parse(t(this).val())});var a=t("#order_price_summary");a.length>0?n+=e.parse(a.text()):n+=e.parse(t("#existing_sale_price_summary").val()),isNaN(n)&&(n=0),n=Math.round(100*n)/100,t("#price_summary").val(n),t("#price, #price2").html(e.format_price(n)),2==t(".price_summary_t table tbody tr").length&&t(".bg2 .price_summary_t .price").val(n)}},e.add_payment_form=function(){var n=t(".price_summary_t table"),a=n.find("tbody tr").length;if(2==a&&n.find("tbody tr:eq(0) td:eq(0)").html('<input type="text" class="price" name="payment[0][val]" value="'+t("#price_summary").val()+'"> PLN'),a>0&&a<11){var r=n.find("tbody tr:eq(0)").html().replace(/\[0\]/g,"["+(a-1)+"]").replace(/td class="/g,'td class="top ');t("<tr>"+r+"</tr>").insertBefore(".price_summary_t table tbody tr.last_row");var i=n.find("tbody tr:eq("+(a-1)+")");i.find("td:eq(0) input").val(0),i.find("td:eq(2)").html('<a href="javascript:void(0)" onclick="CalendarPayment.remove_payment_form($(this))" class="icon sprite-delete" title="'+I18n.t("js.delete")+'">'+I18n.t("js.delete")+"</a>"),n.find("tbody tr.last_row").css("display","table-row");var o=i.find("select option").map(function(){return t(this).attr("value")}).get();i.find("select").val(o.filter(function(e){return!s(e)})[0])}e.disable_used_payment_forms(),n.find("select").unbind("change").bind("change",function(){e.disable_used_payment_forms()})},e.remove_payment_form=function(t){t.parent().parent().remove(),e.balance_prices(),e.disable_used_payment_forms()},e.balance_prices=function(r){if(r===n&&(r=t(".bg2 .price_summary_t .price").first()),t(".bg2 .services_content .price").length>0){var s=e.parse(t("#price_summary").val()),i=t(".price_summary_t table tbody tr").length;3==i&&(t(".bg2 .price_summary_t .price").each(function(){if(t(this).attr("name")!=t(r).attr("name")){var n=e.parse(r.val());isNaN(n)&&(n=0),t(this).val(Math.round(100*e.parse(s)-100*n)/100)}}),a(s)),i<3&&r.val(s)}},e.format_price=function(e){return parseFloat(e).toFixed(2).toString().replace(".",",")},e.parse=function(e){return null==e||e==n?null:parseFloat(e.toString().replace(",","."))},e.disable_used_payment_forms=function(){var e=t(".price_summary_t table");e.find("option").removeAttr("disabled"),e.find("option:not(:selected)").filter(function(){return s(t(this).attr("value"))}).attr("disabled","disabled")}}(window.CalendarPayment=window.CalendarPayment||{},jQuery),window.CalendarViewState=function(){function e(e){n(e)?s():r()}function t(e){return!a(e)}function n(e){return a(e)}function a(e){return e===CalendarViewType.RECEPTION}function r(){p=u}function s(){p=d}function i(e){return o()&&n(e)||c()&&t(e)}function o(){return p===u}function c(){return p===d}function _(t){e(t)}var p,l={},u="single_user",d="multi_user";return l.init=function(t){e(t)},l.handle_view_type_change=function(e,t){t=t||{},i(e)&&(_(e),"function"==typeof t.state_changed&&t.state_changed())},l.is_single_user=o,l.is_multi_user=c,l}(jQuery),function(e){function t(){e.get(c.data("url"),function(e){c.html(e)});var t=e("[data-views-index-container]");t.length>0&&e.get(t.data("url"),function(e){t.html(e)})}function n(){e(document).secureOn("click","[data-calendar-view-entities]",function(t){t.preventDefault();var n=e(this);switch(n.closest(".dropdown").removeClass("open"),n.data("calendar-view-entities")){case"employees_and_resources":CalendarResourceManager.set_multi_user_mode("all"),CalendarResourceManager.switch_to_multiple_entities_page(1);break;case"employees":CalendarResourceManager.set_multi_user_mode("employees"),CalendarResourceManager.switch_to_multiple_entities_page(1);break;case"resources":CalendarResourceManager.set_multi_user_mode("resources"),CalendarResourceManager.switch_to_multiple_entities_page(1);break;default:var a=e.map(n.data("calendar-view-entities"),function(e){return{id:e.entity_id,type:e.entity_type}});CalendarResourceManager.set_multi_user_mode("all"),CalendarResourceManager.set_multiple_entities(a)}CalendarResourcePager.update_controls(),CalendarResourcePager.scroll_to_first_input()})}function a(){e(document).secureOn("click","[data-calendar-views-index-link]",function(t){t.preventDefault(),r(e(this))}),e(document).secureOn("click","[data-calendar-view-form-link]",function(t){t.preventDefault();var n=e(this);s({url:n.attr("href"),title:n.attr("title"),success_message:I18n.t("js.calendar.views.updated")})}),e(document).secureOn("click","[data-destroy-calendar-view]",function(t){t.preventDefault(),o(e(this))})}function r(t){VersumUtils.show_indicator(),e.get(t.attr("href"),function(n){VersumUtils.hide_indicator();var a=e("<div>");a.append(n);BootstrapDialog.show({title:t.attr("title"),message:a,buttons:[{cssClass:"button-blue",label:I18n.t("js.calendar.views.add_new"),action:function(){s({url:c.data("new-view-url"),title:I18n.t("js.calendar.views.add_new"),success_message:I18n.t("js.calendar.views.created")})}},{label:I18n.t("js.dialog.close"),action:function(e){e.close()}}]})})}function s(t){VersumUtils.show_indicator(),e.get(t.url,function(n){VersumUtils.hide_indicator();var a=e("<div>");a.append(n);var r=BootstrapDialog.show({title:t.title,message:a,buttons:[{cssClass:"button-blue",label:I18n.t("js.dialog.save"),action:function(e){i({form:a.find("form").first(),dialog:e,dialog_body:a,success_message:t.success_message})}},{label:I18n.t("js.dialog.cancel"),action:function(e){e.close()}}]});a.on("submit","form",function(n){return VersumUtils.preventEvent(n),i({form:e(this),dialog:r,dialog_body:a,success_message:t.success_message}),!1})})}function i(n){var a=n.form.serializeArray();VersumUtils.show_indicator(),e.ajax({url:n.form.attr("action"),type:n.form.attr("method"),data:a,dataType:"json",success:function(){e.jGrowl(n.success_message,{life:5e3,theme:"flash_notice"}),VersumUtils.hide_indicator(),t(),n.dialog.close()},error:function(t,a,r){VersumUtils.hide_indicator(),422===t.status?n.dialog_body.html(e.parseJSON(t.responseText).html):VersumUtils.handle_ajax_error(t,a,r)}})}function o(n){BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:I18n.t("js.dialog.confirm"),message:n.attr("data-confirmation-message"),buttons:[{label:I18n.t("js.dialog.accept"),cssClass:"button-danger",action:function(a){VersumUtils.show_indicator(),e.ajax({url:n.attr("href"),type:"DELETE",success:function(){e.jGrowl(I18n.t("js.calendar.views.deleted"),{life:5e3,theme:"flash_notice"}),VersumUtils.hide_indicator(),t(),a.close()}})}},{label:I18n.t("js.dialog.cancel"),action:function(e){e.close()}}]})}var c;e(function(){c=e("[data-calendar-views-container]").first(),c.length>0&&(n(),a())})}(jQuery);var CalendarState=function(e){function t(e){return e?"employee"===e.type?"e"+String(e.id):"resource"===e.type?"r"+String(e.id):null:null}function n(e){if(!e)return null;if("string"!=typeof e)return e;var t=null;return"e"===e[0]?t="employee":"r"===e[0]&&(t="resource"),t?{type:t,id:parseInt(e.replace(/[^\d]/g,""))}:null}function a(){return s(c("long_term"))}function r(){return s(c("this_day"))}function s(t){var n=e.cookie(t);return n?(n=JSON.parse(n),VersumConfig.user_id===n.user_id?n:{}):{}}function i(){_(c("long_term"),u,{expires:moment().endOf("day").add(1,"year").toDate()})}function o(){_(c("this_day"),d,{expires:moment().endOf("day").toDate()})}function c(e){return[h,e].join("_")}function _(t,n,a){n=e.extend({},n,{user_id:VersumConfig.user_id}),a=e.extend({path:"/"},a||{}),e.cookie(t,JSON.stringify(n),a)}function p(e){return!!v[e]}function l(e){return"current_date"===e}var u,d,m={},h="__versum_calendar_state",v={current_view:!0,current_single_entity:!0,current_multiple_entities:!0,multi_user_mode:!0};return m.init=function(){u=a(),d=r()},m.get=function(t){var a=null;return p(t)?a=u[t]:l(t)&&(a=d[t]),a?("current_multiple_entities"===t?a=e.map(a,n):"current_single_entity"===t&&(a=n(a)),a):null},m.set=function(n,a){a?"current_multiple_entities"===n?a=e.map(a,t):"current_single_entity"===n&&(a=t(a)):a=null,p(n)?(u[n]=a,i()):l(n)&&(d[n]=a,o())},m}(jQuery),CalendarResourceManager=function(e){function t(){e("#users_list").show(),e("#resources_list").show(),C=g,CalendarViewState.is_multi_user()&&("employees"===k?(e("#resources_list").hide(),C=g.filter('[data-entity-type="employee"]')):"resources"===k&&(e("#users_list").hide(),C=g.filter('[data-entity-type="resource"]')))}function n(e){var t=null;e&&e.id&&e.type&&(t=g.filter('[data-entity-type="'+e.type+'"][data-entity-id="'+e.id+'"]').first()),t&&0!==t.length||(t=g.filter(".current-user").first()),y=t}function a(t){var n=[];t&&t.length>0&&e.each(t,function(e,t){if(t.type&&t.id){var a=g.filter('[data-entity-type="'+t.type+'"][data-entity-id="'+t.id+'"]').first();if(a.length>0){var r=g.index(a);n[r]=a}}}),n=e.grep(n,function(e){return e}),n.length>0?b=n:r(1)}function r(t){var n=(t-1)*s();n>C.length||(b=[],e.each(C.slice(n,n+s()),function(t,n){var a=e(n);b.push(a)}))}function s(){return CalendarResourcePager.get_per_page()}function i(e){t(),CalendarViewState.is_single_user()?(o(),E.hide(),h(e)):(c(),E.show(),h(e)),_(),p()}function o(){g.each(function(){e(this).attr("type","radio")}),l(),y.prop("checked",!0)}function c(){g.each(function(){e(this).attr("type","checkbox")}),l(),u(b)}function _(){g.each(function(){e(this).parents(".entity_list_item").toggleClass("active",e(this).is(":checked"))})}function p(){var e=R.offset().top,t=N.height()-e;E.is(":visible")&&(t-=E.outerHeight()+15),R.height(t)}function l(){g.each(function(){e(this).prop("checked",!1)})}function u(t){e.each(t,function(t,n){e(n).prop("checked",!0)})}function d(){return CalendarViewState.is_single_user()?f(y):null}function m(){return e.map(b,function(e){return f(e)})}function h(t){var n=get_new_calendar_api().getResources();if(n){var a=e.map(n,function(e){return e.id}),r=e.map(x.get_active_entities_list(),function(e){return e.id});a.sort().join(",").toString()!==r.sort().join(",").toString()&&v(t)}else v(t)}function v(t){CalendarViewState.is_single_user()&&(e.show_events_during_refetch=!1),get_new_calendar_api().refetchResources(),t||get_new_calendar_api().refetchEvents()}function f(e){return{id:e.data("entity-id"),type:e.data("entity-type"),title:e.data("entity-name"),class_name:e.data("entity-color")}}var g,y,b,E,w,R,k,C,N,x={};return x.init=function(t){g=t.inputs,E=t.multiple_entities_options_container,R=t.resources_list_container,k=VersumConfig.resources_activated?t.multi_user_mode||"all":"all",N=e(window),w={single_entity:t.current_single_entity,multiple_entities:t.current_multiple_entities}},x.run=function(){t(),n(w.single_entity),a(w.multiple_entities),i(),N.resize(p),setTimeout(p,500),e("#menu-toggler").click(function(){setTimeout(p,100)})},x.handle_view_state=i,x.get_active_entities_list=function(){return CalendarViewState.is_single_user()?[d()]:m()},x.update_active_entities=function(){CalendarViewState.is_single_user()?(y=g.filter(":checked").first(),h()):(b=[],g.filter(":checked").each(function(){b.push(e(this))}),h()),_()},x.get_current_single_entity=d,x.set_single_entity=n,x.get_current_multiple_entities=m,x.set_multiple_entities=function(e){a(e),CalendarViewState.is_multi_user()&&(l(),u(b),_(),h())},x.set_multi_user_mode=function(e){VersumConfig.resources_activated||(e="all"),k=e,CalendarState.set("multi_user_mode",e),t(),CalendarResourcePager.reset_pagination()},x.get_multiple_entities_count=function(){return b.length},x.get_entity_objects=function(){return e.map(g,function(t){return f(e(t))})},x.get_visible_inputs=function(){return C},x.switch_to_multiple_entities_page=function(e){r(e),h(),CalendarViewState.is_multi_user()&&(l(),u(b),_())},x}(jQuery),CalendarResourcePager=function(e){function t(){u=new VersumPagination(l,{items:i(),itemsOnPage:o(),edges:1,displayedPages:3,onPageClick:function(e){CalendarResourceManager.switch_to_multiple_entities_page(e),_()}}),a(),r(),_()}function n(){a(),r()}function a(){CalendarViewState.is_single_user()||i()<=o()?l.hide():l.show()}function r(e){CalendarViewState.is_single_user()||(e=e||s(),u.draw_page(e))}function s(){var e=CalendarResourceManager.get_visible_inputs().filter(":checked"),t=o(),n=e.length,a=CalendarResourceManager.get_visible_inputs().index(e.first()),r=CalendarResourceManager.get_visible_inputs().index(e.last()),s=CalendarResourceManager.get_visible_inputs().length-1;return a%t==0&&r-a+1===n&&(n===t||a+t-1>s)?a/t+1:null}function i(){return CalendarResourceManager.get_visible_inputs().length}function o(){return m}function c(){var e=screen_is_narrow?80:100,t=d.width()-50,n=Math.floor(t/e);m=Math.max(n,2)}function _(){var e=CalendarResourceManager.get_visible_inputs().filter(":checked").first(),t=e.closest("[data-"+e.data("entity-type")+"-input-container]");t.prev("[data-scrollable-list-header]").length&&(t=t.prev("[data-scrollable-list-header]")),p(t)}function p(e){if(e.is(":visible")){var t=e.closest("[data-scrollable-list]"),n=e.offset().top+t.scrollTop(),a=t.offset().top,r=n-a;t.animate({scrollTop:r})}}var l,u,d,m,h={};return h.init=function(e){l=e.pages_container,d=e.calendar_object,c()},h.run=function(){a(),t(),e(window).secureOn("resize.calendar_entity_pager",function(){var e=s(),n=m;c(),null!==e&&m!==n&&(CalendarResourceManager.switch_to_multiple_entities_page(1),t())})},h.handle_view_state=n,h.update_controls=r,h.scroll_to_first_input=_,h.get_per_page=o,h.reset_pagination=t,h}(jQuery),CalendarWorkingHours=function(e){function t(e,t,n,a,r){v=v||{},v[e]=v[e]||{},v[e][t]=v[e][t]||{},v[e][t][n]=v[e][t][n]||{},v[e][t][n][a]=r}function n(e,t,n,a){return v[e]&&v[e][t]&&v[e][t][n]?v[e][t][n][d(a)]||null:null}function a(e){return e===CalendarViewType.RECEPTION?"agendaResource":e===CalendarViewType.DAY?"agendaDay":e===CalendarViewType.WEEK?"agendaWeek":e===CalendarViewType.MONTH?"month":void 0}function r(n,r,i,o){var c,_=i.format("YYYY-MM-DD"),p=d(i),l={};e.get("/settings/timetable/schedules/"+rand(),{format:"json",employee_ids:n.employee,resource_ids:n.resource,date:_,period:a(r)},function(a){for(var i in a){var _=d(i);for(var u in a[i]){l[u]=l[u]||{};for(var m in a[i][u]){c=parseInt(m);var h=e.map(a[i][u][c],s);l[u][c]=l[u][c]||[],l[u][c]=l[u][c].concat(h),t(u,c,CalendarViewType.DAY,_,l[u][c]),t(u,c,CalendarViewType.RECEPTION,_,l[u][c])}}}if(r!==CalendarViewType.DAY&&r!==CalendarViewType.RECEPTION)for(var u in n)for(var v in n[u])c=n[u][v],l[u][c]&&t(u,c,r,p,l[u][c]);o(l)})}function s(e){return{start:e.valid_from,end:e.valid_to,allday:e.allday,kind:e.kind,kind_extension:e.kind_extension,kind_extension_name:e.kind_extension_name}}function i(e,t){o(e,t),_(e)}function o(e,t){var n=[];for(var a in e)for(var r in e[a]){var s=parseInt(r),i=e[a][s];for(var o in i){var c=i[o];"closed"===c.kind&&n.push({title:"",start:c.start,end:c.end,rendering:"background",resourceIds:[s.toString()],allDay:c.allday})}}t(n)}function c(e,t){f=f||{},f[e]=t}function _(e){var t={};for(var n in e)for(var a in e[n]){var r=parseInt(a),s=e[n][r];for(var i in s){var o=s[i];1==o.length?p(t,o,n,r):"closed"===o.kind?o.kind_extension_name&&p(t,o,n,r):p(t,o,n,r)}}for(var _ in t)c(_,t[_].annotation);get_new_calendar_api().rerender()}function p(e,t,n,a){var r=u(t.start),s=u(t.end),i=l(u(t.start),n,a),o=DateUtils.format_time(s);o===CalendarUtils.BEGINNING_OF_DAY_MIDNIGHT&&(o=CalendarUtils.END_OF_DAY_MIDNIGHT);var c=t.allday||DateUtils.format_time(r)===o?"":DateUtils.format_time(r)+" - "+o,_="closed"===t.kind?t.kind_extension_name:"";e[i]?e[i].annotation+="<br>"+c:e[i]={start:r.startOf("day").format(),end:r.endOf("day").format(),annotation:[_,c].join(" "),entities:[{id:a,type:n}],closed:"closed"===t.kind}}function l(e,t,n){return e.format("YYYYMMDD")+t+n}function u(e){return moment.parseZone(e)}function d(e){return"string"==typeof e&&(e=moment(e)),e.format("YYYYMMDD")}var m,h={},v={},f={};return h.init=function(e){m=e.calendar_object},h.load_working_hours=function(t){var a=t.date,s=t.period,o=t.entity_ids,c=t.calendar_callback,_={},p={},l=!1;for(var u in o){_[u]=_[u]||[],p[u]=p[u]||{};for(var d in o[u]){var m=parseInt(o[u][d]),h=n(u,m,s,a);h?p[u][m]=h:(_[u].push(m),l=!0)}}l?r(_,s,a,function(t){e.extend(!0,p,t),i(p,c)}):i(p,c)},h.get_period_annotation=function(e,t,n){return f[l(moment.utc(e),t,n)]},h}(jQuery);!function(e,t){var n;e.init=function(e,t){n=e,n.resource_allocations=t.event.resource_allocations,this.render(t),this.bindActions()},e.render=function(n){var a='<table class="table"><thead><tr><th class="col-xs-4">Podmiot</th><th class="col-xs-8">Status</th></tr></thead><tbody>';t.each(n.event.resource_allocations,function(){var e=this;a+="<tr>","single"==e.recipe_type?(a+='<td><select data-recipe-resources="'+e.recipe_id+'" class="form-control">',t.each(e.items,function(){a+='<option data-resource-id="'+this.entity_id+'" value="'+this.id+'" '+(parseInt(e.item_id)==parseInt(this.id)?"selected":"")+">"+this.entity_name+"</option>"}),a+="</select></td>"):a+="<td>"+e.entity_name+"</td>",a+="<td>",e.valid?a+='<span class="label label-success">OK</span>':a+='<span class="label label-danger">Error</span> '+e.error_messages,a+="</td>",a+="</tr>"}),a+="</tbody></table>";BootstrapDialog.show({title:"Dost\u0119pno\u015b\u0107 pracownik\xf3w oraz zasob\xf3w",message:a,closable:!1,buttons:[{cssClass:"button-blue",label:I18n.t("js.dialog.continue"),action:function(t){e.save(!1),t.close()}},{cssClass:"btn-default",label:I18n.t("js.dialog.skip"),action:function(t){e.save(!0),t.close()}},{label:I18n.t("js.dialog.correct_event"),action:function(e){e.close(),t.lock_is_active=!1}}]})},e.bindActions=function(){t(document).on("change","select[data-recipe-resources]",function(){t(this).find("option").each(function(e,a){var r=t(a).data("resource-id").toString();t.inArray(r,n.resource_ids)>-1?n.resource_ids.splice(t.inArray(r,n.resource_ids),1):n.resource_ids.push(r)}),t("#event_resource_ids").val(n.resource_ids).trigger("change")})},e.save=function(e){n.id&&String(n.id).match("new_event")?CalendarEvent.rest_create(this.modelToJSON(e)):CalendarEvent.rest_update(this.modelToJSON(e))},e.modelToJSON=function(e){var a=t.extend({},n);return e&&(a.skip_resources=!0),t.each(a.resource_allocations,function(){var e=this;"single"==e.recipe_type&&(e.item_id=parseInt(t("select[data-recipe-resources="+e.recipe_id+"]").val())),t.each(["entity","items","errors","error_messages","item_name","recipe_type","valid"],function(){delete e[this]})}),a}}(window.CalendarResourceAllocations=window.CalendarResourceAllocations||{},jQuery),function(e){var t,n,a=e(window),r={},s=[],i=[],o=null,c="_open",_="_close",p=[],l=null,u=/(iPad|iPhone|iPod)/g.test(navigator.userAgent),d={_init:function(t){var n=e(t),a=n.data("popupoptions");i[t.id]=!1,s[t.id]=0,n.data("popup-initialized")||(n.attr("data-popup-initialized","true"),d._initonce(t)),a.autoopen&&setTimeout(function(){d.show(t,0)},0)},_initonce:function(n){var a,r,s=e(n),i=e("body"),p=s.data("popupoptions");if(o=parseInt(i.css("margin-right"),10),l=document.body.style.webkitTransition!==undefined||document.body.style.MozTransition!==undefined||document.body.style.msTransition!==undefined||document.body.style.OTransition!==undefined||document.body.style.transition!==undefined,"tooltip"==p.type&&(p.background=!1,p.scrolllock=!1),p.backgroundactive&&(p.background=!1,p.blur=!1,p.scrolllock=!1),p.scrolllock){var m,h;void 0===t&&(m=e('<div style="width:50px;height:50px;overflow:auto"><div/></div>').appendTo("body"),h=m.children(),t=h.innerWidth()-h.height(99).innerWidth(),m.remove())}if(s.attr("id")||s.attr("id","j-popup-"+parseInt(1e8*Math.random(),10)),s.addClass("popup_content"),i.prepend(n),s.wrap('<div id="'+n.id+'_wrapper" class="popup_wrapper" />'),a=e("#"+n.id+"_wrapper"),a.css({opacity:0,visibility:"hidden",position:"absolute"}),u&&a.css("cursor","pointer"),"overlay"==p.type&&a.css("overflow","auto"),s.css({opacity:0,visibility:"hidden",display:"inline-block"}),p.setzindex&&!p.autozindex&&a.css("z-index","100001"),p.outline||s.css("outline","none"),p.transition&&(s.css("transition",p.transition),a.css("transition",p.transition)),s.attr("aria-hidden",!0),p.background&&!e("#"+n.id+"_background").length){i.prepend('<div id="'+n.id+'_background" class="popup_background"></div>');var v=e("#"+n.id+"_background");v.css({opacity:0,visibility:"hidden",backgroundColor:p.color,position:"fixed",top:0,right:0,bottom:0,left:0}),p.setzindex&&!p.autozindex&&v.css("z-index","100000"),p.transition&&v.css("transition",p.transition)}"overlay"==p.type&&(s.css({textAlign:"left",position:"relative",verticalAlign:"middle"}),r={position:"fixed",width:"100%",height:"100%",top:0,left:0,textAlign:"center"},p.backgroundactive&&(r.position="relative",r.height="0",r.overflow="visible"),a.css(r),a.append('<div class="popup_align" />'),e(".popup_align").css({display:"inline-block",verticalAlign:"middle",height:"100%"})),s.attr("role","dialog");var f=p.openelement?p.openelement:"."+n.id+c;e(f).each(function(t,n){e(n).attr("data-popup-ordinal",t),n.id||e(n).attr("id","open_"+parseInt(1e8*Math.random(),10))}),s.attr("aria-labelledby")||s.attr("aria-label")||s.attr("aria-labelledby",e(f).attr("id"));var g=p.closeelement?p.closeelement:"."+n.id+_;e(document).on("click",g,function(e){d.hide(n),e.preventDefault()}),"hover"==p.action?(p.keepfocus=!1,e(f).on("mouseenter",function(){d.show(n,e(this).data("popup-ordinal"))}),e(f).on("mouseleave",function(){d.hide(n)})):e(document).on("click",f,function(t){t.preventDefault();var a=e(this).data("popup-ordinal");setTimeout(function(){d.show(n,a)},0)}),p.detach?s.hide().detach():a.hide()},show:function(r,c){var u=e(r);if(!u.data("popup-visible")){u.data("popup-initialized")||d._init(r),u.attr("data-popup-initialized","true");var h=e("body"),v=u.data("popupoptions"),f=e("#"+r.id+"_wrapper"),g=e("#"+r.id+"_background");if(m(r,c,v.beforeopen),i[r.id]=c,setTimeout(function(){p.push(r.id)},0),v.autozindex){for(var y=document.getElementsByTagName("*"),b=y.length,E=0,w=0;w<b;w++){var R=e(y[w]).css("z-index");"auto"!==R&&(R=parseInt(R,10),E<R&&(E=R))}s[r.id]=E,v.background&&s[r.id]>0&&e("#"+r.id+"_background").css({zIndex:s[r.id]+1}),s[r.id]>0&&f.css({zIndex:s[r.id]+2})}v.detach?(f.prepend(r),u.show()):f.show(),n=setTimeout(function(){f.css({visibility:"visible",opacity:1}),e("html").addClass("popup_visible").addClass("popup_visible_"+r.id),u.addClass("popup_content_visible")},20),v.scrolllock&&(h.css("overflow","hidden"),h.height()>a.height()&&h.css("margin-right",o+t)),v.backgroundactive&&u.css({top:(a.height()-(u.get(0).offsetHeight+parseInt(u.css("margin-top"),10)+parseInt(u.css("margin-bottom"),10)))/2+"px"}),u.css({visibility:"visible",opacity:1}),v.background&&(g.css({visibility:"visible",opacity:v.opacity}),setTimeout(function(){g.css({opacity:v.opacity})},0)),u.data("popup-visible",!0),d.reposition(r,c),u.data("focusedelementbeforepopup",document.activeElement),v.keepfocus&&(u.attr("tabindex",-1),setTimeout(function(){"closebutton"===v.focuselement?e("#"+r.id+" ."+r.id+_+":first").focus():v.focuselement?e(v.focuselement).focus():u.focus()},v.focusdelay)),e(v.pagecontainer).attr("aria-hidden",!0),u.attr("aria-hidden",!1),m(r,c,v.onopen),l?f.one("transitionend",function(){m(r,c,v.opentransitionend)}):m(r,c,v.opentransitionend)}},hide:function(t){n&&clearTimeout(n);var a=e("body"),r=e(t),s=r.data("popupoptions"),c=e("#"+t.id+"_wrapper"),_=e("#"+t.id+"_background");r.data("popup-visible",!1),1===p.length?e("html").removeClass("popup_visible").removeClass("popup_visible_"+t.id):e("html").hasClass("popup_visible_"+t.id)&&e("html").removeClass("popup_visible_"+t.id),p.pop(),e("html").hasClass("popup_content_visible")&&r.removeClass("popup_content_visible"),s.keepfocus&&setTimeout(function(){e(r.data("focusedelementbeforepopup")).is(":visible")&&r.data("focusedelementbeforepopup").focus()},0),c.css({visibility:"hidden",opacity:0}),r.css({visibility:"hidden",opacity:0}),s.background&&_.css({visibility:"hidden",opacity:0}),e(s.pagecontainer).attr("aria-hidden",!1),r.attr("aria-hidden",!0),m(t,i[t.id],s.onclose),l&&"0s"!==r.css("transition-duration")?r.one("transitionend",function(){r.data("popup-visible")||(s.detach?r.hide().detach():c.hide()),s.scrolllock&&setTimeout(function(){a.css({overflow:"visible","margin-right":o})},10),m(t,i[t.id],s.closetransitionend)}):(s.detach?r.hide().detach():c.hide(),s.scrolllock&&setTimeout(function(){a.css({overflow:"visible","margin-right":o})},10),m(t,i[t.id],s.closetransitionend))},toggle:function(t,n){
e(t).data("popup-visible")?d.hide(t):setTimeout(function(){d.show(t,n)},0)},reposition:function(t,n){var r=e(t),s=r.data("popupoptions"),i=e("#"+t.id+"_wrapper");e("#"+t.id+"_background");if(n=n||0,"tooltip"==s.type){i.css({position:"absolute"});var o;o=s.tooltipanchor?e(s.tooltipanchor):s.openelement?e(s.openelement).filter('[data-popup-ordinal="'+n+'"]'):e("."+t.id+c+'[data-popup-ordinal="'+n+'"]');var _=o.offset();"right"==s.horizontal?i.css("left",_.left+o.outerWidth()+s.offsetleft):"leftedge"==s.horizontal?i.css("left",_.left+o.outerWidth()-o.outerWidth()+s.offsetleft):"left"==s.horizontal?i.css("right",a.width()-_.left-s.offsetleft):"rightedge"==s.horizontal?i.css("right",a.width()-_.left-o.outerWidth()-s.offsetleft):i.css("left",_.left+o.outerWidth()/2-r.outerWidth()/2-parseFloat(r.css("marginLeft"))+s.offsetleft),"bottom"==s.vertical?i.css("top",_.top+o.outerHeight()+s.offsettop):"bottomedge"==s.vertical?i.css("top",_.top+o.outerHeight()-r.outerHeight()+s.offsettop):"top"==s.vertical?i.css("bottom",a.height()-_.top-s.offsettop):"topedge"==s.vertical?i.css("bottom",a.height()-_.top-r.outerHeight()-s.offsettop):i.css("top",_.top+o.outerHeight()/2-r.outerHeight()/2-parseFloat(r.css("marginTop"))+s.offsettop)}else"overlay"==s.type&&(s.horizontal?i.css("text-align",s.horizontal):i.css("text-align","center"),s.vertical?r.css("vertical-align",s.vertical):r.css("vertical-align","middle"))}},m=function(t,n,a){var s=r.openelement?r.openelement:"."+t.id+c,i=e(s+'[data-popup-ordinal="'+n+'"]');"function"==typeof a&&a.call(e(t),t,i)};e(document).on("keydown",function(t){if(p.length){var n=p[p.length-1],a=document.getElementById(n);e(a).data("popupoptions")&&e(a).data("popupoptions").escape&&27==t.keyCode&&e(a).data("popup-visible")&&d.hide(a)}}),e(document).on("click",function(t){if(p.length){var n=p[p.length-1],a=document.getElementById(n);e(a).data("popupoptions")&&e(a).data("popupoptions").blur&&!e(t.target).parents().andSelf().is("#"+n)&&e(a).data("popup-visible")&&2!==t.which&&(d.hide(a),"overlay"===e(a).data("popupoptions").type&&t.preventDefault())}}),e(document).on("focusin",function(t){if(p.length){var n=p[p.length-1],a=document.getElementById(n);e(a).data("popupoptions")&&e(a).data("popupoptions").keepfocus&&(a.contains(t.target)||(t.stopPropagation(),a.focus()))}}),e.fn.popup=function(t){return this.each(function(){if($el=e(this),"object"==typeof t){var n=e.extend({},e.fn.popup.defaults,t);$el.data("popupoptions",n),r=$el.data("popupoptions"),d._init(this)}else"string"==typeof t?($el.data("popupoptions")||($el.data("popupoptions",e.fn.popup.defaults),r=$el.data("popupoptions")),d[t].call(this,this)):($el.data("popupoptions")||($el.data("popupoptions",e.fn.popup.defaults),r=$el.data("popupoptions")),d._init(this))})},e.fn.popup.defaults={type:"overlay",autoopen:!1,background:!0,backgroundactive:!1,color:"black",opacity:"0.5",horizontal:"center",vertical:"middle",offsettop:0,offsetleft:0,escape:!0,blur:!0,setzindex:!0,autozindex:!1,scrolllock:!1,keepfocus:!0,focuselement:null,focusdelay:50,outline:!1,pagecontainer:null,detach:!1,openelement:null,closeelement:null,transition:null,tooltipanchor:null,beforeopen:null,onclose:null,onopen:null,opentransitionend:null,closetransitionend:null}}(jQuery),function(e){function t(e){var t=e.changedTouches,n=t[0],a="mouseover",r=document.createEvent("MouseEvent");r.initMouseEvent(a,!0,!0,window,1,n.screenX,n.screenY,n.clientX,n.clientY,!1,!1,!1,!1,0,null),n.target.dispatchEvent(r),a="mousedown",r=document.createEvent("MouseEvent"),r.initMouseEvent(a,!0,!0,window,1,n.screenX,n.screenY,n.clientX,n.clientY,!1,!1,!1,!1,0,null),n.target.dispatchEvent(r),c||(o=n.target,c=!0)}function n(n){var a="";if(!(n.touches.length>1)){switch(n.type){case"touchstart":if(e(n.changedTouches[0].target).is("select"))return;return t(n),n.preventDefault(),!1;case"touchmove":a="mousemove",n.preventDefault();break;case"touchend":if(_)return _=!1,n.preventDefault(),!1;a="mouseup";break;default:return}var r=n.changedTouches,s=r[0],i=document.createEvent("MouseEvent");i.initMouseEvent(a,!0,!0,window,1,s.screenX,s.screenY,s.clientX,s.clientY,!1,!1,!1,!1,0,null),s.target.dispatchEvent(i)}}function a(t){e(this).data("tooltip")&&e(this).uitooltip("disable"),i=setTimeout(function(){l=!0,n(t)},p)}function r(e){clearTimeout(i),l&&(n(e),l=!1)}function s(e){clearTimeout(i),l&&n(e)}var i,o=null,c=!1,_=!1,p=1200,l=!1;e.extend(e.support,{touch:"ontouchend"in document}),e.fn.addTouch=function(){e.support.touch&&this.each(function(e,t){t.addEventListener("touchstart",a,!1),t.addEventListener("touchmove",s,!1),t.addEventListener("touchend",r,!1),t.addEventListener("touchcancel",n,!1)})},e.fn.removeTouch=function(){e.support.touch&&this.each(function(e,t){t.removeEventListener("touchstart",a,!1),t.removeEventListener("touchmove",s,!1),t.removeEventListener("touchend",r,!1),t.removeEventListener("touchcancel",n,!1)})}}(jQuery),function(e,t,n){function a(e){e.find("tr").each(function(e,n){t(n).find("td:first").html(e+1)})}function r(){var n=0;t("#products_input tbody tr").each(function(){var e=t(this),a=s(e);a>n&&(n=a)}).get(),t('#products_input input[name$="[id]"]').each(function(){var e=t(this),a=e.attr("name").match(/\[(\d+)\]\[id\]$/)[1],r=parseInt(a);!isNaN(r)&&r>n&&(n=r)}),e.current_row_index=n}function s(e){var t=e.find('input[name$="[product_id]"]');if(t.length){var n=t.attr("name").match(/\[(\d+)\]\[product_id\]$/)[1],a=parseInt(n);if(isNaN(a))throw"Cannot get index from this row";return a}}function i(){return e.current_row_index+=1,e.current_row_index}function o(){jQuery.ajax({type:"POST",url:t("#products_input").attr("data-versum-drafts-url"),data:t("form").serialize().replace("_method=patch","_method=post"),cache:!1,dataType:"json",success:function(e){t("#draft_id").val(e.id),e.created_at==e.updated_at&&(t("[data-versum-badge=drafts_count_box]").show(),t("[data-versum-badge=drafts_count]").html(parseInt(t("[data-versum-badge=drafts_count]").text())+1));var n=moment(e.updated_at);t("[data-versum-badge=last_draft]").show().find("span").html(DateUtils.format_time(n,"seconds")+" "+DateUtils.format_date(n))}})}function c(e){var t=e.id,n=e.name;F.val(t),Q.hide(),J.hide(),G.show(),W.text(n)}function p(){var e=i();console.warn({el:t("#products_input tbody tr:eq(0)")});var n=(t("#products_input tbody tr:eq(0)").html()||"").replace(/_[0-9]*_/g,"_"+e+"_").replace(/\[[0-9]*\]/g,"["+e+"]").replace(/\<b\>(.*?)\<\/b\>/g,"");$table=t("#products_input tbody"),$table.append("<tr>"+n+"</tr>");var r=t("#products_input tbody tr:last");return r.find("td:eq(1) b").remove(),r.find('input[name*="[id]"]').remove(),r.find("td:eq(1) :input:not(select)").show().val("").attr("disabled",!1).removeClass("gray_hint").focus().click(),r.find('input[type="text"]').val(""),r.find('td[data-oblok-name="units"]').html(""),r.find('.quantity_container span, [date-oblok-name="unit"]').first().text(b("pack")),r.find(".quantity_in_packs").hide(),r.find(".product_inventory").html(""),r.find('input[name$="[quantity]"]').prop("defaultValue","").removeClass("error"),r.find('input[name$="[vat_percentage]"]').val(""),r.find(".popover").remove(),t("#sum_suma_"+e+"_a").html("0"),a($table),l(),u(e),U(),R(),r}function l(){if(t("#products_input").hasClass("supply_table")){var e=t("#products_input tbody tr:last");e.find('[data-oblok-name="units"], [data-oblok-name="unit"], .product_inventory').html(""),e.find("input.product-quantity").hide()}}function u(e){return d({form_type:h(),element:t("input[id*='products_attributes_"+e+"_product_name']"),success_callback:function(e,t){v(t.closest("tr"),e),t.autocomplete("disable")}})}function d(e){var n=e.form_type,a=!1;e.element.autocomplete({source:function(r,s){var i={term:r.term,form:n};e.size&&(i.size=e.size),t.ajax({url:"/products/autocomplete.json",dataType:"json",data:i,success:function(i){if(0==i.length){if("use"==n)var o=t("<div data-url='/products/new?in_popup=1' title='"+I18n.t("js.stockroom.add_new_supply")+"'>"+I18n.t("js.stockroom.supply_not_found")+"<br><span class='new_customer'>"+I18n.t("js.stockroom.add_new_supply")+"</span></div>");else var o=t("<div data-url='/products/new?in_popup=1' title='"+I18n.t("js.stockroom.add_new_product")+"'>"+I18n.t("js.stockroom.product_not_found")+"<br><span class='new_customer'>"+I18n.t("js.stockroom.add_new_product")+"</span></div>");o.click(function(){V(o.get(0),I18n.t("js.dialog.add"),"physical_products_product","products",function(t){e.create_callback&&(t.success_callback=e.create_callback),t.form_type=n,B(t)})}),i.push({id:0,value:r.term,label:o})}else 1==i.length&&r.term.length>5&&r.term.length==parseInt(r.term).toString().length?a=!0:t.each(i,function(e,t){t.name_without_type_info=t.name,m(n,t)});s(i)}})},minLength:1,html:!0,select:function(n,a){a.item.id>0&&e.success_callback(a.item,t(this))},response:function(e,n){a&&(n.item=n.content[0],t(this).data("ui-autocomplete")._trigger("select","autocompleteselect",n),t(this).autocomplete("close")),a=!1}})}function m(e,t){var n="";if("orders"!==e&&"deliveries"!==e||"supply"!==t.state?"use"===e&&"product"===t.state&&(n=I18n.t("js.stockroom.products.states.product")):n=I18n.t("js.stockroom.products.states.supply"),""!==n){var a=' <span class="opposite_product_type">('+n+")</span>";t.label+=a,t.name+=a}}function h(){return t("#products_input").data("form-type")}function v(e,t){"use"==h()?f(e,t):g(e,t),M()}function f(e,n){var a=s(e);w(a,n.name,n.id),t('input[id*="products_attributes_'+a+'_product_id"]').val(n.id),t('input[id*="products_attributes_'+a+'_price"]').val(n.price),t('input[id*="products_attributes_'+a+'_available_packs"]').val(n.available_packs),y(n,e.find(".product_inventory")),E(n,{parent:e,id:a,form:"use"}),t('input[id*="products_attributes_'+a+'_quantity"]').show(),t("#product_"+a+"_available_packs").text(n.available_packs.toString().replace(".",",")+" "+b("pack"));var r=e.find('[data-oblok-name="units"]'),i=r.find("select");i.length&&e.find('[data-oblok-name="unit"]').html(b(i.val()))}function g(e,n){var a=s(e);w(a,n.name,n.id);var r="gross"==t("#physical_delivery_price_type").val()?n.gross_price:n.price;t('input[id*="products_attributes_'+a+'_product_id"]').val(n.id),t('input[id*="products_attributes_'+a+'_gross_price"]').val(z(r)),t('input[id*="products_attributes_'+a+'_price"]').val(z(r)),t('input[id*="products_attributes_'+a+'_available_packs"]').val(n.available_packs);var i=t("#delivery_data").length>0?0:1;t('input[id*="products_attributes_'+a+'_quantity"]').val(i),t('input[id*="products_attributes_'+a+'_vat_percentage"]').val(n.vat),E(n,{parent:e,id:a,selected:"pack",form:"order"}),j(a)}function y(e,t){var n=e.inventory+" "+b(e.unit_for_supplies);A(e.unit_for_supplies)||(n+=" ("+e.available_packs+" "+b("pack")+")"),t.text(n)}function b(e){return I18n.t("js.stockroom.products.units.short."+e)}function E(e,n){var a=n.id,r=n.parent,s=n.parent.find('[data-oblok-name="units"]'),i=e.unit_for_supplies,o=h(),c=b(i),_="deliveries"===o?"physical_delivery_delivered_products_attributes_"+a+"_unit":"physical_order_sold_products_attributes_"+a+"_unit",p="deliveries"===o?"physical_delivery[delivered_products_attributes]["+a+"][unit]":"physical_order[sold_products_attributes]["+a+"][unit]";if(t('input[id*="products_attributes_'+a+'_supply_pack_size"]').val(e.supply_pack_size),A(i)){var l='<input type="hidden" id="'+_+'" name="'+p+'" value="'+i+'">',u=c+l;s.html(u),r.find('span[data-oblok-name="unit"]').text(c)}else{var d='<select id="'+_+'" name="'+p+'">';i.length>0&&(d+='<option value="'+i+'">'+c+"</option>"),"pack"!=e.unit_for_supplies&&(d+='<option value="pack"',"pack"===n.selected&&(d+=' selected="selected"'),d+=">"+b("pack")+"</option>"),d+="</select>",s.html(d)}}function w(e,n,a){var r="/products/"+a,s='<a href="'+r+'" target="_blank">'+n+"</a>";t('input[id*="products_attributes_'+e+'_product_name"]').hide(),t('input[id*="products_attributes_'+e+'_product_name"]').parent().append("<b>"+s+"</b>"),t('input[id*="products_attributes_'+e+'_product_name"]').closest("tr").find(".product_name_span").html(s)}function R(){t("input[name*='[gross_price]'], input[name*='[price]'], input[name*='[quantity]']").unbind("keyup").keyup(function(e){j(t(e.target).attr("id").split("_")[5])}),t("input[name*='[quantity]']").secureOn("keyup",function(){var e=t(this),n=e.closest("tr");P(n),D(e,n);var a=e.attr("id").match(/\d+/);if(a){j(a[0])}}),t(".remove_product").unbind("click").click(function(e){if(e.preventDefault(),t("#products_input tbody tr").length>1)t(this).closest("tr").remove(),U();else{var r=i();t("#products_input tbody tr").first().find("input, span.product_inventory").each(function(){var e=t(this),a=e.attr("id").replace(/_[0-9]*_/g,"_"+r+"_");e.attr("id",a);var s=e.attr("name");if(s!==n){var i=s.replace(/\[[0-9]*\]/g,"["+r+"]");e.attr("id",a).attr("name",i)}});t("#products_input tbody tr").first().find('span[name*="[suma]"]').first().attr("id",["sum_suma_",r,"_a"].join("")).attr("name",["sum[suma][",r,"]"].join("")),t("input[name*='[gross_price]'], input[name*='[price]'], input[name*='[quantity]']").val(0),t("input[name*='[quantity]']").removeClass("error").popover("destroy"),t("span[name*='[suma]']").html(0),t("input[name*='[product_id]'], input[name*='[product]']").val(""),t("input[name*='[product_name]']").autocomplete("enable").val("").show().parent().find("b").remove(),t('input[name$="[vat_percentage]"]').val(""),t("#products_input tbody .product_inventory").html(""),U(),l()}a(t("#products_input tbody")),t("#delivery_data").length>0&&o()})}function k(e){if("gross_price"==t(e).attr("id")){var n=z(Math.round(O(t("#gross_price").val())/(1+N(t("#physical_products_product_vat").val()))*100)/100);t("#physical_products_product_net_price").val(n),t('div[data-oblok-name="net_price_calc"]').text(n),t("#physical_products_product_net_price_precise").val(O(t("#gross_price").val())/O(1+N(t("#physical_products_product_vat").val()))),"none"==t('div[data-oblok-name="net_price_fields"]').css("display")&&t('div[data-oblok-name="net_price_fields"]').css("display","inline-block")}else t("#gross_price").val(z(Math.round(O(t("#physical_products_product_net_price").val())*(1+N(t("#physical_products_product_vat").val()))*100)/100)),t("#physical_products_product_net_price_precise").val(O(t("#physical_products_product_net_price").val()))}function C(e){var n=N(t("#physical_products_product_vat").val()),a=t("#physical_products_product_last_purchase_net_price"),r=t("#last_purchase_gross_price"),s=t("#last_purchase_gross_price_text");if("gross"===e){var i=O(r.val()),o=z(Math.round(i/(1+n)*100)/100);a.val(o)}else{var o=O(a.val()),i=z(Math.round(o*(1+n)*100)/100);r.val(i),s.text(i)}}function N(e){return vat_rates[e]/100}function x(e){price_field=t(t("input[id*='products_attributes_"+e+"_gross_price']").length>0?"input[id*='products_attributes_"+e+"_gross_price']":"input[id*='products_attributes_"+e+"_price']");var n=O(price_field.val()),a=t("select[id*='products_attributes_"+e+"_unit']");if(a.length>0&&"pack"!==a.val()){n/=O(t("input[id*='products_attributes_"+e+"_supply_pack_size']").val())}return n*=O(t("input[id*='products_attributes_"+e+"_quantity']").val())}function j(e,n){var a=x(e);t("#sum_suma_"+e+"_a").html(z(Math.round(100*a)/100)),n||U()}function M(){t('input[name*="[quantity]"]').each(function(){var e=t(this);D(e,e.closest("tr"))})}function D(e,t){var n=I(t);if(null!==n){S(e,t)>n?e.hasClass("error")||(e.closest("td").css("position","relative").addClass("error-popover"),e.addClass("error").popover({html:!0,content:'<div style="white-space:nowrap">'+I18n.t("js.stockroom.insufficient_inventory",{count:n})+"</div>",trigger:"focus",placement:"top"}),e.is(":focus")&&e.popover("show")):e.removeClass("error").popover("destroy")}}function I(e){var t=e.find("input[id*=available_packs]");return 0===t.length?null:O(t.val())}function S(e,t){var n=O(e.val()),a=O(e.prop("defaultValue"));(a>0&&n!=a&&(n-=a),A(t.find('select[name*="[unit]"]').val()||"pack"))||(n/=t.find("input[id*=supply_pack_size]").val());return n}function U(){var e=0,n=t("#order_price_summary"),a=O(n.text());t("#products_input tbody tr").each(function(){e+=x(s(t(this)))}),n.html(z(e)),e>0&&t("#physical_order_payment").length>0&&0==t("#physical_order_payment")[0].defaultValue.length&&t("#physical_order_payment").val(e).removeClass("gray_hint").unbind("click"),a!==e&&n.trigger("order_price_summary_change")}function P(e){var t=O(e.find('input[id*="supply_pack_size"]').val()),n=O(e.find('input[name*="[quantity]"]').val()),a=Math.round(n/t*100)/100;e.find(".quantity_in_packs .value").text(a)}function O(e){if(String(e).length>0){var t=parseFloat(String(e).replace(",","."));return isNaN(t)&&(t=0),t}return 0}function z(e){return e||(e=0),CurrencyUtils.number_to_currency(e,{symbol:""})}function T(e){var n;n=e?e.find("#add-manufacturer"):t("#add-manufacturer"),n.unbind("click").click(function(e){return VersumUtils.preventEvent(e),t(this).blur(),V(this,I18n.t("js.dialog.add"),"physical_products_manufacturer","manufacturers",$)})}function V(e,n,a,r,s,i){var o=e.href||t(e).data("url");return t.get(o,{r:rand()},function(o){var c=t("<div data-remote-dialog-content></div>");c.append(o),BootstrapDialog.show({title:e.title,message:c,onshown:function(){t('[data-toggle="tooltip"]').tooltip(),VersumConfig.lumo&&VersumConfig.lumo.lumo_product_purchase_enabled&&PointsConverter.init(),"true"===t("#physical_products_product_is_online_orders_activated").val()&&(StockroomProductOnlineOrders.init(),t("[data-gallery-component]").each(function(){GalleryComponents.init_gallery(t(this))}));var e=t("#physical_products_product_description");e.length>0&&WysiwygUtils.create_rich_content_editor(e.attr("data-content-type"),e)},onhide:function(){i&&i()},buttons:[{label:I18n.t("js.dialog.cancel"),action:function(e){e.close()}},{cssClass:"button-blue",label:n,action:function(e){s({singular:a,plural:r,dialog:e})}}]}),T(c)}),!1}function $(e){Y(t.extend({success_callback:function(e){added_id=e.id,added_name=e.name,added_parent_id=e.parent_id,t("#physical_products_product_manufacturer_id").append('<option value="'+added_id+'">'+added_name+"</option>"),t("#physical_products_product_manufacturer_id").val(""+added_id),t.jGrowl(I18n.t("js.flashes.added_manufacturer"),{life:9e3,theme:"flash_notice"})}},e))}function q(e){Y(t.extend({success_callback:function(e){added_id=e.id,added_name=e.name,t("#physical_delivery_supplier_id").append('<option value="'+added_id+'">'+added_name+"</option>"),t("#physical_delivery_supplier_id").select2("val",added_id),t('#physical_delivery_supplier_id option[value*="'+added_id+'"]').attr("selected",!0),t.jGrowl(I18n.t("js.flashes.supplier_created"),{life:9e3,theme:"flash_notice"})}},e))}function B(e){Y(t.extend({success_callback:function(e){var n=t('#products_input tbody input[name$="[product_id]"]').filter(function(){var e=t(this).val();return""===e||null===e}).last();v(0===n.length?p():n.closest("tr"),e)}},e))}function Y(e){var n=t("#new_"+e.singular),a=[{name:"format",value:"json"},{name:"r",value:rand()},{name:"in_popup",value:"1"},{name:"form_type",value:e.form_type||h()}];t.each(a,function(e,a){n.append(t("<input>",t.extend({type:"hidden"},a)))}),WysiwygUtils.update_form_controls(),t.ajax({url:n.attr("action"),data:n.serialize(),type:"POST",success:function(t){e.success_callback(t),e.dialog.close()},error:function(n,a,r){if(422==n.status){var s=e.dialog.getModal(),i=s.find("[data-remote-dialog-content]");i.html(t.parseJSON(n.responseText).html),T(i),s.scrollTop(0)}else VersumUtils.handle_ajax_error(n,a,r)}})}function L(e){var n=e.val(),a=b(n);H({select:t("#unit_for_minimal_stock_select"),span:t("#unit_for_minimal_stock_span"),non_pack_value:"unit_for_supplies",unit:n,unit_name:a}),H({select:t("#unit_for_inventory_change_select"),span:t("#unit_for_inventory_change_span"),non_pack_value:n,unit:n,unit_name:a})}function H(e){if(A(e.unit))e.span.text(e.unit_name).show(),e.select.hide().prop("disabled",!0);else{e.span.hide(),e.select.prop("disabled",!1).show();var n=e.select.find('option:not([value="pack"])');n.length<=0?(n=t('<option value="'+e.non_pack_value+'"></option>'),e.select.append(n)):n.attr("value",e.non_pack_value),n.text(e.unit_name)}}function A(e){return t.inArray(e,["pack","service_unit"])>-1}var Q,F,G,W,K,J;_.set(window,"reactLegacyBridge.stockroom.openNewProductModal",function(e){V({href:"/products/new?hide_inventory=true&in_popup=true",title:I18n.t("js.stockroom.add_new_product")},I18n.t("js.dialog.add"),"physical_products_product","products",function(n){Y(t.extend({success_callback:function(t){n.dialog.close(),e.successCallback(t)}},n))},e.closeCallback)}),_.set(window,"reactLegacyBridge.stockroom.openNewSupplierModal",function(e){V({href:"/suppliers/new?in_popup=1",title:I18n.t("js.stockroom.add_new_supplier")},I18n.t("js.dialog.add"),"physical_products_supplier","supplier",function(n){Y(t.extend({success_callback:function(n){added_id=n.id,added_name=n.name,t(e.supplierSelectSelector).append('<option value="'+added_id+'">'+added_name+"</option>"),t(e.supplierSelectSelector).select2("val",added_id),t(e.supplierSelectSelector+' option[value*="'+added_id+'"]').attr("selected",!0),t.jGrowl(I18n.t("js.flashes.supplier_created"),{life:9e3,theme:"flash_notice"}),e.successCallback(n)}},n))},e.closeCallback)}),_.set(window,"reactLegacyBridge.stockroom.makeSupplierSelect",function(e){t(e.selector).versum_select2({width:252,dropdownCssClass:"fixed_content_styles",allowClear:!0}).on("change",function(){var n=t(e.selector).select2("data")||{};e.successCallback&&n.id&&e.successCallback({id:parseInt(n.id),label:n.text})})}),e.current_row_index=0,e.bindings_on=!1,e.is_unconvertible_unit=function(e){return A(e)},e.correct_inventory_popover_positions=function(){t('input[name*="[quantity]"]').popover("show")},e.make_product_combobox=function(e){return d(e)},e.ajaxify=function(){if(r(),T(),t("#add-supplier-popup").unbind("click").click(function(e){return VersumUtils.preventEvent(e),t(this).blur(),V(this,I18n.t("js.dialog.add"),"physical_products_supplier","supplier",q)}),t("#new_product_popup").unbind("click").click(function(e){return VersumUtils.preventEvent(e),t(this).blur(),V(this,I18n.t("js.dialog.add"),"physical_products_product","products",B)}),t(".order_form").length>0){Q=t("#customer"),F=t("#physical_order_customer_id"),G=t("#order_customer_data"),W=G.find(".name").first(),K=G.find("a").first(),J=t("#add-new-customer-form"),CustomerSearcher.run({autocomplete_input:Q,new_customer_button:J,on_customer_pick:function(e){c(e)}}),K.click(function(e){VersumUtils.preventEvent(e),Q.val(""),F.val(""),G.hide(),J.show(),Q.show().focus()}),t("#physical_order_use_employee_ids, #physical_order_refferal, #physical_delivery_supplier_id").versum_select2({width:252,dropdownCssClass:"fixed_content_styles",allowClear:!0}),t(".combobox_input button").click(function(e){e.preventDefault()}),t("#products_input tbody tr").each(function(e){u(e),j(e,!0)}),U(),t("#add-product").click(function(e){e.preventDefault(),p()}),parseFloat(t("#physical_order_customer_id").val())>0&&c({id:t("#physical_order_customer_id").val(),value:t("#customer_data_name").val()})}R(),M(),t("input[name*='[product_id]']").each(function(e,n){var a=t(n).attr("id").split("_"),r=t(n).closest("tr").find(".product_name_span").html();parseInt(t(n).val())>0&&w(a[5],r,t(n).val())}),t("form").submit(function(){VersumUtils.loading_start(t(this).find('input[type="submit"]'))}),t(".no_enter").keypress(function(e){13==e.which&&e.preventDefault()})},e.set_bindings=function(){if(e.bindings_on)return!1;t(document).on("change",'[data-oblok-name="units"] select',function(){var e=t(this),n=e.attr("id").split("_"),a=e.closest("tr, form"),r=t("[data-oblok-persisted]");a.find('[data-oblok-name="unit"]').html(b(e.val())),P(a),A(e.val())?(t('[data-oblok-name="supply_pack_size"]').hide(),a.find(".quantity_in_packs").hide(),t("li.available_stock_field, li.minimal_packs_field.togglable").show()):(t('[data-oblok-name="supply_pack_size"]').show(),a.find(".quantity_in_packs").show(),r.data("oblok-persisted")&&t("li.available_stock_field, li.minimal_packs_field.togglable").hide()),L(e),j(n[5])}),t(document).on("change","#physical_delivery_price_type",function(){var e=t(this),n=e.val();t('[data-oblok-name="price_type"]').text(e.find(":selected").text()),t('input[name$="[price]"]').each(function(){var e,a=t(this),r=O(a.val()),s=O(a.closest("tr").find('input[name$="[vat_percentage]"]').val());if(0!==r&&0!==s){e="gross"===n?r*(1+s):r/(1+s),e=Math.round(100*e)/100,a.val(z(e));j(a.attr("id").match(/_(\d+)_/)[1])}})}),t(document).on("change",'[data-oblok-name="product_types"] input',function(){"supply"!=t(this).val()&&(t(this).is(":checked")?t('[data-oblok-name="product_fields"]').show():t('[data-oblok-name="product_fields"]').hide())}),t(document).on("click",'a[data-oblok-name="net_price_edit"]',function(){t(this).blur().hide(),t('div[data-oblok-name="net_price_calc"]').hide(),t("#physical_products_product_net_price").attr("disabled",!1).show(),t(".net_price_lbl").show()}),t(document).on("keyup","#gross_price, #physical_products_product_net_price",function(){k(t(this))}),t(document).on("change","#physical_products_product_vat",function(){k(t(this)),C()}),t(document).on("submit","form[data-delivery-form]",function(){setTimeout(function(){VersumUtils.prevent_unload("Formularz jest w\u0142a\u015bnie przetwarzany. Nie opuszczaj jeszcze tej strony, aby unikn\u0105\u0107 b\u0142\u0119d\xf3w.")},100)}),t(document).secureOn("keyup","#last_purchase_gross_price",function(){C("gross")}),t(document).secureOn("keyup","#physical_products_product_last_purchase_net_price",function(){C(),t("#last_purchase_gross_price_box").show()}),t(document).secureOn("click","#edit_last_purchase_gross_price",function(e){e.preventDefault(),t(this).hide(),t("#last_purchase_gross_price_box").show(),t("#last_purchase_gross_price_text").hide(),t("#last_purchase_gross_price").show()}),e.bindings_on=!0},e.drafts=function(){t(document).on("change","#delivery_data form input, #delivery_data form select, #delivery_data form textarea",function(){o()})},e.float_val=function(e){return O(e)},e.number_to_currency=function(e){return z(e)},e.set_customer=c}(window.StockroomForm=window.StockroomForm||{},jQuery),window.EventComponents=window.EventComponents||{t:function(e,t){return t=t||{},t.scope=t.scope||"js.event_components",I18n.t(e,t)},get_slot_length_in_minutes:function(){return slot_length_in_minutes},get_coupon_info:function(e){var t="";return t+=EventComponents.t("coupons.site_name",{site_name:e.coupon_site}),e.coupon_code&&e.coupon_code.length>0&&(t+=EventComponents.t("coupons.coupon_code",{code:e.coupon_code})),e.coupon_security&&e.coupon_security.length>0&&(t+=EventComponents.t("coupons.security_code",{code:e.coupon_security})),t+=EventComponents.t("coupons.edit_coupon",{url:e.coupon_url})},check_prepayment_requirements:function(e,t){var n=this,a=_.get(window,"reactLegacyBridge.prepayments.getEventPrepaymentRequirements")||function(){return new Promise(function(e){e({})})},r=e.services.map(function(e){return e.id||0}),s=e.customer&&e.customer.id||undefined,i=e.beginning&&e.beginning.format()||moment().format(),o={services:r,startedAt:i};s&&(o.customer=s),a(o).then(function(a){e.prepayment.requirements=a;var r=e.prepayment_amount_input();0!==r&&""!==r||!t||e.refresh_prepayment_amount(),e.prepayment.amount_paid||(a.required&&(e.prepayment.required=!0,t&&(e.prepayment.disabled=!1)),e.prepayment.required&&!a.required&&(e.prepayment.required=!1),a.amount!==e.prepayment.amount&&e.prepayment.amount>0&&t&&(e.is_prepayment_confirmation_visible=!0),a.amount&&!e.is_prepayment_confirmation_visible&&t&&(e.prepayment.amount=a.amount),(0===e.prepayment.requirements.amount||e.prepayment.amount===a.amount&&!e.prepayment.requirements.required)&&(e.is_prepayment_confirmation_visible=!1)),n.update_state()})}},window.CalendarModels=function(){return{create_service_adjusting_reverter:function(e,t){return t=t||{},t.event_time_manager||(t.event_time_manager=CalendarModels.create_event_time_manager(e)),new CalendarModels.ServiceAdjustingReverter(e,t)},create_services_resizer:function(e,t){return new CalendarModels.ServicesResizer(e,t)},create_default_event_resources_modal:function(e,t){return new CalendarModels.DefaultEventResourcesModal(e,t)},create_service_resources_modal:function(e,t){return new CalendarModels.ServiceResourcesModal(e,t)},create_event_time_manager:function(e){return new CalendarModels.EventTimeManager(e)},create_services_adjuster:function(e,t){return t=t||{},t.event_time_manager||(t.event_time_manager=CalendarModels.create_event_time_manager(e)),new CalendarModels.ServicesAdjuster(e,t)},create_formula_manager:function(e){return new CalendarModels.FormulaManager(e)},create_event_transformer:function(e,t){return new CalendarModels.EventTransformer(e,t)},create_finalizer:function(e){return new CalendarModels.Finalizer(e)},create_event_saver:function(e){return new CalendarModels.EventSaver(e)},create_allocation_error_resolver:function(e){return new CalendarModels.AllocationErrorResolver(e)},create_event_error_handler:function(e,t,n,a){return new CalendarModels.EventErrorHandler(e,t,n,a)},create_event_mover:function(e,t){return new CalendarModels.EventMover(e,t)},create_event_resizer:function(e,t){return new CalendarModels.EventResizer(e,t)},create_event_reverter:function(e,t){return new CalendarModels.EventReverter(e,t)},create_event:function(e){return new CalendarModels.Event(e)},create_order:function(e){return new CalendarModels.Order(e)},create_product:function(e){var t=e.discount?e.discount:null;delete e.discount;var n=new CalendarModels.Product(e);return n.discount=t?this.create_discount_for_item(n,t):this.create_empty_discount_for_item(n),n},create_empty_product:function(){return{empty:!0,key:ComponentHelpers.Keys.get_unique_key()}},create_service:function(e){var t=e.discount?e.discount:null;delete e.discount;var n=new CalendarModels.Service(e);return n.discount=t?this.create_discount_for_item(n,t):this.create_empty_discount_for_item(n),n},create_discount:function(e){return new CalendarModels.Discount(e)},create_customer_health_survey:function(e){return new CalendarModels.CustomerHealthSurvey(e)},create_product_from_formula:function(e){var t=e.product;return CalendarModels.create_product({id:t.id,name:t.name,name_with_type_info:t.name,price:parseFloat(t.price),unit_for_supplies:t.unit_for_supplies,selected_unit:e.unit,supply_pack_size:parseFloat(t.supply_pack_size),inventory:parseFloat(t.inventory),quantity:parseFloat(e.quantity_in_product_unit),formula_id:e.id,key:ComponentHelpers.Keys.get_unique_key()})},create_discount_for_item:function(e,t){return CalendarModels.Discount.create_for_item(e,t)},create_empty_discount_for_item:function(e){return CalendarModels.Discount.create_empty_for_item(e)}}}(jQuery),CalendarModels.AllocationErrorResolver=function(e){function t(e){this.allocations=e}return t.prototype.run=function(){var t=e.grep(this.allocations,function(e){return e.error_message.length}),n=e.Deferred(),a=!1,r=e("<div>"),s=BootstrapDialog.show({title:I18n.t("js.dialog.notice"),message:r,buttons:[{label:EventComponents.t("allocation_error_resolver.correct"),cssClass:"button-blue",action:function(e){e.close()}},{label:EventComponents.t("allocation_error_resolver.ignore"),action:function(){a=!0,s.close()}}],onhide:function(){ReactDOM.unmountComponentAtNode(r.get(0)),n.resolve(a)}});return ReactDOM.render(React.createElement(EventComponents.AllocationErrorResolver,{allocations:t}),r.get(0)),n.promise()},t}(jQuery),CalendarModels.CustomerHealthSurvey=function(e){function t(t){t.last_sent_at=t.last_sent_at?moment(t.last_sent_at,n):null,t.filled_at=t.filled_at?moment(t.filled_at,n):null,t.next_message_at=t.next_message_at?moment(t.next_message_at,n):null,e.extend(this,t)}var n="YYYY-MM-DD HH:mm";return t.prototype.get_state=function(){return!this.next_message_at||this.last_sent_at||this.filled_at?this.last_sent_at&&!this.filled_at?"sent":this.filled_at?"filled":"absent":"pending"},t.prototype.is_positive=function(){return this.status&&"positive"===this.status},t.prototype.details_props=function(e){return{client:e||"",lastSentAt:this.last_sent_at?DateUtils.format_datetime(this.last_sent_at):"",filledAt:this.filled_at?DateUtils.format_datetime(this.filled_at):"",status:this.status||"",ip:this.ip_address||"",browser:this.browser||"",os:this.os||""}},t.prototype.set_last_sent_at=function(e){this.last_sent_at=moment(new Date(e))},t}(jQuery),CalendarModels.DefaultEventResourcesModal=function(e){function t(t,n){this.event=t,this.employees_with_calendar=n.employees_with_calendar,this.resources=n.resources,this.event_edition_enabled=n.event_edition_enabled,this.on_set_edit_mode=n.on_set_edit_mode||function(){},this.hide_actions=!!n.hide_actions,
this.old_employee=t.employee?e.extend({},t.employee):null,this.old_resource=t.default_resource?e.extend({},t.default_resource):null,this.deferred=e.Deferred()}return t.prototype.run=function(){return this._show_modal(),this.deferred.promise()},t.prototype._show_modal=function(){var t,n=this,a=e("<div>"),r=VersumConfig.resources_activated?EventComponents.t("default_event_resources_modal.title"):EventComponents.t("default_event_resources_modal.title_no_resources"),s=[{id:"accept-button",label:I18n.t("js.dialog.accept"),cssClass:"button-blue",action:function(e){n.deferred.resolve(),e.close()}},{id:"cancel-button",label:I18n.t("js.dialog.cancel"),action:function(e){e.close()}},{id:"close-button",label:I18n.t("js.dialog.close"),cssClass:"button-blue",action:function(e){e.close()}}];this.event.editable&&!this.hide_actions&&s.push({id:"edit-button",label:I18n.t("js.dialog.edit"),action:function(e){n._set_edit_mode(e,t)}});BootstrapDialog.show({title:r,message:function(e){return n.event_edition_enabled?(e.getButton("close-button").hide(),n._hide_edit_button(e)):(e.getButton("accept-button").hide(),e.getButton("cancel-button").hide()),a},buttons:s,cssClass:"resources-modal",onhide:function(){"pending"===n.deferred.state()&&(n.event.employee=n.old_employee,n.event.default_resource=n.old_resource,n.deferred.reject())}});t=ReactDOM.render(React.createElement(EventComponents.DefaultEventResourcesModal,{event:this.event,employees_with_calendar:this.employees_with_calendar,resources:this.resources,event_edition_enabled:this.event_edition_enabled}),a.get(0))},t.prototype._set_edit_mode=function(e,t){this.event_edition_enabled=!0,e.getButton("close-button").hide(),this._hide_edit_button(e),e.getButton("accept-button").show(),e.getButton("cancel-button").show(),t.set_edit_mode(),this.on_set_edit_mode()},t.prototype._hide_edit_button=function(e){var t=e.getButton("edit-button");t&&t.hide()},t}(jQuery),CalendarModels.Discount=function(e){function t(t){t.active=t.active||!1,t.key=t.key||ComponentHelpers.Keys.get_unique_key(),e.extend(this,t)}return t.create_for_item=function(e,n){return new t({item:e,discount_type:n.discount_type,discount_value:NumberUtils.parse_price(n.discount_value)})},t.create_empty_for_item=function(e){return new t({item:e,discount_type:"proportional",discount_value:0})},t.prototype.is_proportional=function(){return"proportional"===this.discount_type},t.prototype.is_amount=function(){return"amount"===this.discount_type},t.prototype.price_drop=function(){return 0===this.quantity()?0:NumberUtils.round_price(this.value_drop()/this.quantity())},t.prototype.base_price=function(){return this.item.get_base_price_for_discount?NumberUtils.round_price(this.item.get_base_price_for_discount()):NumberUtils.round_price(this.item.price)},t.prototype.quantity=function(){return this.item.get_quantity_in_packs?this.item.get_quantity_in_packs():1},t.prototype.base_value=function(){return NumberUtils.round_price(this.base_price()*this.quantity())},t.prototype.new_value=function(){if(this.is_proportional()){var e=this.base_value()*this.get_discount_value()/100;return NumberUtils.round_price(this.base_value()-e)}return NumberUtils.round_price(this.base_value()-this.get_discount_value())},t.prototype.new_price=function(){return NumberUtils.round_price(this.precise_new_price())},t.prototype.precise_new_price=function(){return this.base_price()-this.precise_price_drop()},t.prototype.value_drop=function(){return this.is_proportional()?NumberUtils.round_price(this.base_value()-this.new_value()):this.get_discount_value()},t.prototype.price_drop=function(){return NumberUtils.round_price(this.precise_price_drop())},t.prototype.precise_price_drop=function(){return 0===this.quantity()?0:this.value_drop()/this.quantity()},t.prototype.get_discount_value=function(){return this.active?this.is_proportional()?NumberUtils.round_percents(this.discount_value):NumberUtils.round_price(this.discount_value):0},t.prototype.init_discount_value=function(e){this.get_discount_value()||(this.discount_value=e||0)},t.prototype.get_percentage=function(){return NumberUtils.round_percentage(this.get_precise_percentage())},t.prototype.get_precise_percentage=function(){return 0===this.base_price?1:this.is_proportional()?this.get_discount_value()/100:this.get_discount_value()/this.base_value()},t.prototype.activate=function(){this.active=!0},t.prototype.deactivate=function(){this.active=!1},t.prototype.serialize_for_save=function(){return{discount_type:this.discount_type,discount_value:this.get_discount_value(),base_price:this.base_price(),quantity:this.quantity()}},t}(jQuery),CalendarModels.Event=function(e){function t(t){e.extend(this,t)}return t.prototype.get_customer_id=function(){return this.customer&&this.customer.id?this.customer.id:null},t.prototype.should_send_reminder=function(){if(this.id||this._send_reminder_locked)return!!this.send_reminder;var e=moment().add(1,"day").startOf("day");return!(this.beginning.isBefore(e)&&!this.customer_health_survey)&&!!this.send_reminder},t.prototype.lock_send_reminder=function(){this._send_reminder_locked=!0},t.prototype.is_active=function(){return!this.canceled&&!this.deleted_at&&!this.destroy},t.prototype.get_sold_products=function(){return this.order?this.order.get_products():[]},t.prototype.get_sold_gift_cards=function(){return this.order?this.order.get_sold_gift_cards():[]},t.prototype.get_sold_packages=function(){return this.order?this.order.get_sold_packages():[]},t.prototype.filter_sold_packages=function(e){for(var t=[],n=this.get_sold_packages(),a=0;a<n.length;a++)n[a].package_type===e&&t.push(n[a]);return t},t.prototype.get_total_price=function(){var e=0;return this.order&&(e+=this.order.get_total_price()),e+=this.get_total_services_price(),NumberUtils.round_price(e)},t.prototype.get_total_price_after_discount=function(){var e=0;return this.order&&(e+=this.order.get_total_price_after_discount()),e+=this.get_total_services_price_after_discount(),NumberUtils.round_price(e)},t.prototype.get_total_net_price_after_discount=function(){var e=0;return this.order&&(e+=this.order.get_total_net_price_after_discount()),e+=this.get_total_services_net_price_after_discount(),NumberUtils.round_price(e)},t.prototype.get_total_services_price=function(){for(var e=0,t=0;t<this.services.length;t++)e+=this.services[t].price;return NumberUtils.round_price(e)},t.prototype.is_prepayment_paid=function(){return this.prepayment.id&&this.prepayment.amount_paid>0},t.prototype.is_refund_possible=function(){return this.prepayment.amount_paid>0&&-1!==["paid","refund_failed"].indexOf(this.prepayment.status)},t.prototype.get_prepayment_amount=function(){return this.prepayment.amount||this.get_total_services_prepayment_amount()},t.prototype.refresh_prepayment_amount=function(){this.prepayment.amount=this.prepayment.requirements&&this.prepayment.requirements.amount?this.prepayment.requirements.amount:this.get_total_services_prepayment_amount(),this.prepayment.required&&(this.prepayment.disabled=!(this.get_total_services_prepayment_amount()>0))},t.prototype.prepayment_amount_input=function(){return this.is_prepayment_paid()?this.prepayment.amount_paid:this.prepayment.amount},t.prototype.services_prepayment_amount=function(){return this.is_prepayment_paid()?this.prepayment.amount_paid:this.get_total_services_prepayment_amount()},t.prototype.is_unpaid_moment_reservation=function(){return this.prepayment.created_by_customer&&"paid"!==this.prepayment.status},t.prototype.is_add_prepayment_enabled=function(){var e=!!(this.customer||{}).id,t=this.customer_name&&""!=this.customer_name;return e||t},t.prototype.get_total_services_prepayment_amount=function(){return NumberUtils.round_price(this.services.reduce(function(e,t){return e+t.prepayment_amount||0},0))},t.prototype.is_prepayment_amount_valid=function(){var e=NumberUtils.parse_number(this.prepayment.amount);return!this.prepayment.changed||!isNaN(e)&&e>0},t.prototype.is_prepayment_method_valid=function(){return!!this.prepayment.payment_method},t.prototype.get_total_services_price_after_discount=function(){for(var e=0,t=0;t<this.services.length;t++)e+=this.services[t].price_after_discount();return NumberUtils.round_price(e)},t.prototype.get_total_services_net_price_after_discount=function(){for(var e=0,t=0;t<this.services.length;t++)e+=this.services[t].net_price_after_discount();return NumberUtils.round_price(e)},t.prototype.get_total_services_duration=function(){for(var e=0,t=0;t<this.services.length;t++)e+=this.services[t].item_duration;return e},t.prototype.get_default_services_duration=function(){for(var e=0,t=0;t<this.services.length;t++)e+=this.services[t].duration;return e},t.prototype.get_lumo_points=function(e,t,n){for(var a=this.services,r=0,s=0;s<a.length;s++)r+=a[s].get_lumo_points(e,t);return this.order&&(r+=this.order.get_lumo_points(e,n)),Math.round(r)},t.prototype.zero_lumo_points=function(){for(var e=this.services,t=0;t<e.length;t++)e[t].item_lumo_points=0;this.order&&this.order.zero_lumo_points()},t.prototype.reset_lumo_points=function(){for(var e=this.services,t=0;t<e.length;t++)e[t].reset_lumo_points();this.order&&this.order.reset_lumo_points()},t.prototype.get_lumo_items=function(){var e={};return e.services=VersumConfig.lumo.lumo_service_purchase_enabled?this.services:[],e.products=VersumConfig.lumo.lumo_product_purchase_enabled&&this.order?this.order.get_products():[],e},t.prototype.get_duration_in_minutes=function(){var e=this.end.diff(this.beginning);return Math.round(moment.duration(e).asMinutes())},t.prototype.get_duration_in_days=function(){var e=moment(this.beginning).startOf("day"),t=moment(this.end).startOf("day"),n=t.diff(e);return Math.round(moment.duration(n).asDays())},t.prototype.get_first_employee=function(){for(var e=0;e<this.services.length;e++)if(this.services[e].employee)return this.services[e].employee;return null},Object.defineProperty(t.prototype,"prepayment",{get:function(){return this._prepayment},set:function(e){this._prepayment=e}}),Object.defineProperty(t.prototype,"recurrence_manager",{get:function(){return this._recurrence_manager},set:function(e){this._recurrence_manager=e}}),t.prototype.is_recurring_event=function(){return!!this.recurrence_manager},t}(jQuery),CalendarModels.EventErrorHandler=function(e){function t(e,t,n,a){this.xhr=e,this.text_status=t,this.error_thrown=n,this.params=a||{},this.params.on_error=this.params.on_error||{},this.error_handled=!1,this.modal_shown=!1}return t.prototype.run=function(){return this.deferred=e.Deferred(),this._handle_recurrence(),422===this.xhr.status?this._handle_422():403===this.xhr.status?this._handle_403():(this.params.on_error[this.xhr.status]&&(this.error_handled=!0,this.params.on_error[this.xhr.status]()),this._resolve()),this.deferred.promise()},t.prototype.modal_shown=function(){return this.modal_shown},t.prototype._handle_recurrence=function(){var t=e.parseJSON(this.xhr.responseText);Array.isArray(t.error_messages)&&this.params.on_error.recurrence_conflicts&&this.params.on_error.recurrence_conflicts(t.error_messages)},t.prototype._handle_422=function(){var t=e.parseJSON(this.xhr.responseText);if(t.is_in_the_past&&!this.params.on_error.recurrence_conflicts||t.is_in_the_past&&this.params.on_error.recurrence_conflicts&&!Array.isArray(t.error_messages))this._standard_modal("is_in_the_past");else if(t.supply_use_quantity_exceeded)this._standard_modal("supply_use_quantity_exceeded");else if(t.gift_cards_invalid_certificate_type)this._standard_modal("gift_cards_invalid_certificate_type",{message:I18n.t("js.gift_cards.invalid_certificate_type")});else if(t.gift_cards_invalid_items)this._standard_modal("gift_cards_invalid_items",{message:I18n.t("js.gift_cards.invalid_items.message."+t.gift_cards_invalid_items)});else if(t.medical_service_permissions_required)this.error_handled=!0,e.jGrowl(I18n.t("js.errors.medical_service_permissions_required.message"),{life:5e3,theme:"flash_alert"}),this._resolve();else{var n=this._get_allocations(t);n.length&&(this.error_handled=!0,this.modal_shown=!0,this._handle_allocations_error(n))}this.params.on_error[422]&&(this.error_handled=!0,this.params.on_error[422](t)),this.error_handled||this._resolve()},t.prototype._get_allocations=function(t){if(!t.error_messages)return[];var n=[];return t.error_messages.allocations?e.each(t.error_messages.allocations,function(e,t){n=n.concat(t)}):t.error_messages.events&&e.each(t.error_messages.events,function(t,a){a.allocations&&e.each(a.allocations,function(e,t){n=n.concat(t)})}),e.grep(n,function(e){return e.error_message.length})},t.prototype._standard_modal=function(e,t){var t=t||{},n=this,a=!1;this.error_handled=!0,this.modal_shown=!0,BootstrapDialog.show({title:I18n.t("js.dialog.notice"),message:t.message||EventComponents.t(e+".message"),buttons:[{label:I18n.t("js.dialog.correct"),cssClass:"button-blue",action:function(e){e.close()}},{label:I18n.t("js.dialog.ignore"),action:function(e){a=!0,e.close()}}],onhide:function(){a?n.params[e+"_skipped"]&&n.params[e+"_skipped"]():n.params[e+"_unskipped"]&&n.params[e+"_unskipped"](),n._resolve()}})},t.prototype._handle_allocations_error=function(e){var t=this;CalendarModels.create_allocation_error_resolver(e).run().then(function(e){e?t.params.allocation_errors_skipped&&t.params.allocation_errors_skipped():t.params.allocation_errors_unskipped&&t.params.allocation_errors_unskipped(),t._resolve()})},t.prototype._handle_403=function(){if(this.error_handled=!0,this.xhr.responseJSON&&"manipulating_past_events_disabled"===this.xhr.responseJSON.message){var e=I18n.t("js.calendar.messages.create_permission_error",{days_while_editable:_fullcalendar_days_while_editable});throwAlert(e)}else VersumUtils.handle_ajax_error(this.xhr,this.text_status,this.error_thrown);this.params.on_error[403]&&this.params.on_error[403](),this._resolve()},t.prototype._resolve=function(){!this.error_handled&&this.params.unhandled_error_action&&this.params.unhandled_error_action(),this.deferred.resolve()},t}(jQuery),CalendarModels.EventMover=function(e){function t(e,t){this.calendar_event=e,this.delta=t.delta,this.all_employees=t.all_employees,this.employees_with_calendar=t.employees_with_calendar,this.all_resources=t.all_resources}return t.prototype.move=function(){VersumUtils.show_indicator();var t=this;return this.deferred=e.Deferred(),t._entity_type_changed()?this._reject():EventViews.fetch_event_data({event_id:this.calendar_event.extendedProps.event_id}).then(function(e){if(e.finalized)t._reject();else{var n=CalendarModels.create_event_transformer(e.main_event);t.event=n.run(),t.event_time_manager=CalendarModels.create_event_time_manager(t.event),t.services_adjuster=CalendarModels.create_services_adjuster(t.event,{event_time_manager:t.event_time_manager,resources:t.all_resources,employees_with_calendar:t.employees_with_calendar,cancelable:!0}),t.event.allday?t._perform_allday_move():t._perform_move()}},function(){t._reject()}),this.deferred.always(function(){VersumUtils.hide_indicator()}),this.deferred.promise()},t.prototype._entity_type_changed=function(){return this.calendar_event.newEntity&&this.calendar_event.originalEntity&&this.calendar_event.newEntity.extendedProps.type!==this.calendar_event.originalEntity.extendedProps.type},t.prototype._perform_allday_move=function(){var e=this.event;e.allday_beginning=moment(e.allday_beginning).add(this.delta.asMinutes(),"minutes"),e.allday_end=moment(e.allday_end).add(this.delta.asMinutes(),"minutes"),this._save_event()},t.prototype._perform_move=function(){var t=this,n=this.calendar_event.extendedProps.block_events_services_ids,a=!0;e.each(this.event.services,function(r,s){s.started_at=moment(s.started_at).add(t.delta.asMinutes(),"minutes"),-1!==e.inArray(s.event_service_id,n)?t._update_entities(s):a=!1}),this.event_time_manager.fix_event_time(),a?this._save_event():this._adjust()},t.prototype._update_entities=function(t){var n=this.calendar_event.newEntity,a=this.calendar_event.originalEntity;if(n&&a&&n.id!==a.id)if("employee"===n.extendedProps.type){var r=e.grep(this.all_employees,function(e){return e.id.toString()===n.id})[0];r&&(t.employee=e.extend({},r))}else if("resource"===n.extendedProps.type){var s=null;e.each(t.resources,function(e,t){t.id.toString()===a.id&&(s=e)});var i=e.grep(this.all_resources,function(e){return e.id.toString()===n.id})[0];null!==s&&i&&(t.resources[s]=e.extend({},i,{switchable:!1}))}},t.prototype._save_event=function(){VersumUtils.show_indicator();var e=this;CalendarModels.create_event_saver({event:this.event,skip_hours_check:!!this.skip_hours_check,skip_resources_check:!!this.skip_resources_check,calendar_action:"move"}).run().done(function(t){e.deferred.resolve(t)}).fail(function(t,n,a){e._handle_save_fail(t,n,a)})},t.prototype._handle_save_fail=function(t,n,a){VersumUtils.hide_indicator();var r=this,s=!1;CalendarModels.create_event_error_handler(t,n,a,{unhandled_error_action:function(){e.jGrowl(I18n.t("js.calendar.messages.event_save_error"),{life:5e3,theme:"flash_alert"})},is_in_the_past_skipped:function(){r.skip_hours_check=!0,s=!0},allocation_errors_skipped:function(){r.skip_resources_check=!0,s=!0}}).run().then(function(){s?r._save_event():r._reject()})},t.prototype._adjust=function(){VersumUtils.hide_indicator();var e=this;this.services_adjuster.adjust().done(function(){e._save_event()}).fail(function(){e._reject()})},t.prototype._reject=function(){this.deferred.reject()},t}(jQuery),CalendarModels.EventResizer=function(e){function t(e,t){this.calendar_event=e,this.delta=t.delta,this.employees_with_calendar=t.employees_with_calendar,this.all_resources=t.all_resources}return t.prototype.resize=function(){VersumUtils.show_indicator();var t=this;return this.deferred=e.Deferred(),EventViews.fetch_event_data({event_id:this.calendar_event.extendedProps.event_id}).then(function(e){if(e.finalized)t._reject();else{var n=CalendarModels.create_event_transformer(e.main_event);t.event=n.run(),t.event_time_manager=CalendarModels.create_event_time_manager(t.event),t.services_adjuster=CalendarModels.create_services_adjuster(t.event,{event_time_manager:t.event_time_manager,resources:t.all_resources,employees_with_calendar:t.employees_with_calendar,cancelable:!0}),t._perform_resize()}},function(){t._reject()}),this.deferred.always(function(){VersumUtils.hide_indicator()}),this.deferred.promise()},t.prototype._perform_resize=function(){var t=this,n=this.event,a="YYYY-MM-DD HH:mm",r=moment(moment.utc(this.calendar_event.start).format(a)),s=moment(moment.utc(this.calendar_event.end).format(a)),i=moment(s).subtract(this.delta.asMinutes(),"minutes"),o=this.calendar_event.extendedProps.block_events_services_ids,c=!0;if(s.isSame(i)||!s.isAfter(r))return void this._reject();var _=(EventComponents.get_slot_length_in_minutes(),[]);e.each(n.services,function(n,a){if(n>0&&(c=!1),-1===e.inArray(a.event_service_id,o))return c=!1,void(a.started_at.isAfter(r)&&(a.started_at=moment(a.started_at).add(t.delta.asMinutes(),"minutes")));_.push(a)}),CalendarModels.create_services_resizer(_,{start:r,end:s,old_end:i}).resize(),this.event_time_manager.fix_event_time(),c?this._save_event():this._adjust()},t.prototype._save_event=function(){VersumUtils.show_indicator();var e=this;CalendarModels.create_event_saver({event:this.event,skip_hours_check:!0,skip_resources_check:!!this.skip_resources_check,calendar_action:"resize"}).run().done(function(t){e.deferred.resolve(t)}).fail(function(t,n,a){e._handle_save_fail(t,n,a)})},t.prototype._handle_save_fail=function(t,n,a){VersumUtils.hide_indicator();var r=this,s=!1;CalendarModels.create_event_error_handler(t,n,a,{unhandled_error_action:function(){e.jGrowl(I18n.t("js.calendar.messages.event_save_error"),{life:5e3,theme:"flash_alert"})},allocation_errors_skipped:function(){r.skip_resources_check=!0,s=!0}}).run().then(function(){s?r._save_event():r._reject()})},t.prototype._adjust=function(){VersumUtils.hide_indicator();var e=this;this.services_adjuster.adjust().done(function(){e._save_event()}).fail(function(){e._reject()})},t.prototype._reject=function(){this.deferred.reject()},t}(jQuery),CalendarModels.EventReverter=function(e){function t(e,t){this.event_id=e,this.action=t}return t.prototype.run=function(){return this.deferred=e.Deferred(),this._save_event(),this.deferred.promise()},t.prototype._save_event=function(){var t=this,n=this._get_url();if(!n)return void this._reject();e.ajax({url:n,type:"PUT"}).done(function(e){t.deferred.resolve(e)}).fail(function(e,n,a){t._handle_save_fail(e,n,a)})},t.prototype._handle_save_fail=function(t,n,a){var r=this,s=!1;CalendarModels.create_event_error_handler(t,n,a,{unhandled_error_action:function(){e.jGrowl(I18n.t("js.calendar.messages.changes_cannot_be_reverted"),{life:5e3,theme:"flash_alert"})},allocation_errors_skipped:function(){r.skip_resources_check=!0,s=!0}}).run().then(function(){s?r._save_event():r._reject()})},t.prototype._get_url=function(){return"revert"===this.action?"/events/"+this.event_id+"/versions/revert":"undelete"===this.action?"/events/"+this.event_id+"/versions/undelete":"restore"===this.action?"/events/"+this.event_id+"/versions/restore":void 0},t.prototype._reject=function(){this.deferred.reject()},t}(jQuery),CalendarModels.EventSaver=function(e,t){function n(t){e.extend(this,t)}return n.prototype.run=function(){var t={skip_hours_check:!!this.skip_hours_check&&"skip",supply_use_updated:this._supply_use_updated(),event:this._prepare_data_for_event(),customer_name:this.event.customer_name};if(this.update_all_future_events&&(t.update_all_future_events=1),this.event.recurrence_manager){var n=this.event.recurrence_manager.getRecurringEventsPayload(this.update_all_future_events);_.merge(t,n),this.event.recurrence_manager.recurringEvents=n.recurring_events}if(this.event.id)var a="put",r="/events/"+this.event.id;else var a="post",r="/events";return this.calendar_action&&(t.calendar_action=this.calendar_action,r=r+"?calendar_action="+t.calendar_action),e.ajax({url:r,method:a,dataType:"json",contentType:"application/json",data:JSON.stringify(t)})},n.prototype.update_events_in_finalization=function(t){var n,a,r,s=t.services;t.not_an_appointment&&t.allday?(n=CalendarUtils.moment_without_time_zone(t.allday_beginning),a=CalendarUtils.moment_without_time_zone(t.allday_end),r=null):(n=CalendarUtils.moment_without_time_zone(t.beginning),a=CalendarUtils.moment_without_time_zone(t.end),r=t.get_customer_id());for(var i=0;i<s.length;i++)s[i].supply_use_updated&&(is_supply_use_updated=!0);var o={customer_id:r,beginning:n,end:a,description:t.description,event_services_attributes:this._prepare_services_data(t),tag_ids:e.map(t.tags,function(e){return e.id}),not_an_appointment:t.not_an_appointment,allday:t.not_an_appointment&&t.allday,send_reminder:t.should_send_reminder(),skip_resources:!0,prepayment_attributes:t.prepayment.prepayment_attributes},c={skip_hours_check:"skip",supply_use_updated:this._supply_use_updated(t.services),event:o,customer_name:t.customer_name};return e.ajax({url:"/events/"+t.id,method:"put",dataType:"json",contentType:"application/json",data:JSON.stringify(c)})},n.prototype._supply_use_updated=function(e){e===t&&(e=this.event.services);for(var n=0;n<e.length;n++)if(e[n].supply_use_updated)return!0;return!1},n.prototype._prepare_data_for_event=function(){var t,n,a,r=this.event;return r.not_an_appointment&&r.allday?(t=CalendarUtils.moment_without_time_zone(r.allday_beginning),n=CalendarUtils.moment_without_time_zone(r.allday_end),a=null):(t=CalendarUtils.moment_without_time_zone(r.beginning),n=CalendarUtils.moment_without_time_zone(r.end),a=r.get_customer_id()),{customer_id:a,beginning:t,end:n,description:r.description,event_services_attributes:this._prepare_services_data(),tag_ids:e.map(r.tags,function(e){return e.id}),not_an_appointment:r.not_an_appointment,allday:r.not_an_appointment&&r.allday,send_reminder:r.should_send_reminder(),skip_resources:this.skip_resources_check,prepayment_attributes:r.prepayment.prepayment_attributes}},n.prototype._prepare_services_data=function(n){if(n===t&&(n=this.event),n.not_an_appointment)return{0:this._prepare_blockade_service_data()};if(!n.services.length)return{0:this._prepare_unknown_service_data()};for(var a={},r=0;r<n.services.length;r++){var s=n.services[r],i=this._get_resource_ids_params(s,!s.event_service_id);if(a[r]={service_id:s.id,event_service_id:s.event_service_id,employee_ids:s.employee?[s.employee.id]:[],switchable_resource_ids:i.switchable,unswitchable_resource_ids:i.unswitchable,duration:s.item_duration,started_at:CalendarUtils.moment_without_time_zone(s.started_at),duration_before:s.get_item_duration_before(),duration_after:s.get_item_duration_after(),break_offset:s.get_item_break_offset(),break_duration:s.get_item_break_duration()},s.supply_use&&s.supply_use.get_products().length){var o=s.supply_use.get_products();a[r].used_product_params=e.map(o,function(e){return{product_id:e.id,unit:e.selected_unit,quantity:e.get_quantity_for_chosen_unit(),formula_id:e.formula_id}})}s.random_employee&&(a[r].random_employee=s.random_employee)}return a},n.prototype._get_resource_ids_params=function(e,t){for(var n=[],a=[],r=0;r<e.resources.length;r++){var s=e.resources[r].id;t&&e.resources[r].switchable?n.push(s):a.push(s)}return{switchable:n,unswitchable:a}},n.prototype._prepare_blockade_service_data=function(){var t=this.event,n=[],a=[];if(t.id&&t.services.length)for(var r=0;r<t.services.length;r++){var s=t.services[r],i=this._get_resource_ids_params(s,!s.event_service_id);n=n.concat(s.employee?[s.employee.id]:[]),a=a.concat(i.unswitchable)}else t.default_resource&&(a=[t.default_resource.id]),t.employee&&(n=[t.employee.id]);return{employee_ids:e.unique(n),unswitchable_resource_ids:e.unique(a)}},n.prototype._prepare_unknown_service_data=function(){var e=this.event,t=[],n=[];return e.default_resource&&(n=[e.default_resource.id]),e.employee&&(t=[e.employee.id]),{service_id:-1,employee_ids:t,unswitchable_resource_ids:n,duration:e.get_duration_in_minutes&&e.get_duration_in_minutes()||0,started_at:e.beginning&&CalendarUtils.moment_without_time_zone(e.beginning)}},n}(jQuery),CalendarModels.EventTimeManager=function(e,t){function n(e){this.event=e}return n.prototype.fix_event_time=function(){if(!this.event.services.length)return void(this.event.end=moment(this.event.beginning).add(EventComponents.get_slot_length_in_minutes(),"minutes"));var t=null,n=null;e.each(this.event.services,function(e,a){var r=a.get_finished_at();(null===t||a.started_at.isBefore(t))&&(t=a.started_at),(null===n||r.isAfter(n))&&(n=r)}),this.event.services.sort(function(e,t){return e.started_at.isSame(t.started_at)?0:e.started_at.isBefore(t.started_at)?-1:1}),this.event.beginning=moment(t),this.event.end=moment(n),this.event.finalized_at=this.event.end},n.prototype.move_event_time=function(e){if(this.event.services.length)return this.move_services(e);this.event.beginning=moment(this.event.beginning).add(e,"minutes"),this.event.end=moment(this.event.end).add(e,"minutes"),this.event.finalized_at=this.event.end},n.prototype.move_services=function(n,a){a=a||{};var r=e.grep(this.event.services,function(e){return!(a.excluded_service_key!==t&&a.excluded_service_key===e.key||a.min_start&&e.started_at.isBefore(a.min_start))});e.each(r,function(e,t){t.started_at=moment(t.started_at).add(n,"minutes")}),this.fix_event_time()},n}(jQuery),CalendarModels.EventTransformer=function(e){function t(e,t){t=t||{},this.event=e,this.default_employee_id=t.default_employee_id,this.default_resource_id=t.default_resource_id,this.available_employees=t.available_employees,this.available_resources=t.available_resources}var n="YYYY-MM-DD HH:mm";return t.get_datetime_format=function(){return n},t.prototype.run=function(){var t=this.event,a={},r=moment(t.end,n),s={customer:this._extract_customer_data(t),employee:this._create_event_default_employee(),default_resource:this._create_event_default_resource(),beginning:moment(t.beginning,n),end:r,allday_beginning:moment(t.allday_beginning,n),allday_end:moment(t.allday_end,n),finalized_at:t.finalized_at?moment(t.finalized_at,n):r,created_at:moment(t.created_at,n),tags:t.tags||[],initial_payments:t.payments,initial_group_payments:t.group_payments,send_reminder:!!t.send_reminder,not_an_appointment:!!t.not_an_appointment,allday:!!t.allday};e.extend(a,t,s),this._create_services(a),this._create_order(a),this._create_supply_use(a),this._create_customer_health_survey(a);var i=CalendarModels.create_event(a);if(1===i.services.length&&-1===i.services[0].id&&(i.services[0].duration=i.get_duration_in_minutes()),i.gift_cards_employee=i.sold_gift_cards.length>0?i.sold_gift_cards[0].employee||{}:e.extend({},i.employee),i.packages_employee=i.sold_packages.length>0?i.sold_packages[0].employee||{}:e.extend({},i.employee),i._prepayment=new reactLegacyBridge.prepayments.Prepayment({id:t.prepayment_id,amount:t.prepayment_amount,amount_paid:t.prepayment_amount_paid,amount_paid_with_gift_coupon:t.prepayment_amount_paid_with_gift_coupon,status:t.prepayment_status,real_status:t.prepayment_real_status,cancel_event_after_hours:t.prepayment_cancel_event_after_hours,created_at:t.prepayment_created_at,creator_type:t.prepayment_creator_type,created_by_customer:t.prepayment_created_by_customer,paid_at:t.prepayment_paid_at,expiration_date_time:t.prepayment_expiration_date_time,payment_method:t.prepayment_payment_method,blik_subsidy_amount:t.prepayment_blik_subsidy_amount,payment_type:t.prepayment_payment_type,paid_online_via:t.prepayment_paid_online_via,payment_request_sent_at:t.prepayment_payment_request_sent_at,payment_request_sent_to:t.prepayment_payment_request_sent_to,payments:t.prepayment_payments,gift_card:t.prepayment_gift_card}),Object.keys(i).forEach(function(e){-1!==e.indexOf("prepayment_")&&delete i[e]}),t.prepayment_created_by_customer&&!t.prepayment_amount_paid&&(i.prepayment_disabled=!0,i.prepayment_amount=0,i.prepayment_status=null),t.recurrence_params){i.recurrence_params=t.recurrence_params;try{i._recurrence_manager=new window.reactLegacyBridge.eventRecurrence.EventRecurrenceManager(i)}catch(e){console.error("Can't instantiate Event recurrence manager, please chceck recurrence_params",t.recurrence_params,e)}}return i},t.prototype._extract_customer_data=function(e){return{id:e.customer_id,name:e.customer_name,phone_number:e.customer_phone_number,phone_number_formatted:e.customer_phone_number_formatted,email:e.customer_email,description:e.customer_description,description_content_type:e.customer_description_content_type,customer_email_url:e.customer_email_url,customer_sms_url:e.customer_sms_url,customer_url:e.customer_url,customer_data_protection:e.customer_data_protection,lumo_points:e.customer_lumo_points,lumo_state:e.customer_lumo_state,phone:{countryPrefix:e.customer_phone&&e.customer_phone_number?e.customer_phone_number.replace(e.customer_phone,"").replace("+",""):"48",countryCode:e.customer_phone_number_country_code?e.customer_phone_number_country_code:"PL",number:e.customer_phone?e.customer_phone:""}}},t.prototype._create_services=function(t){var a=this.event;a.services&&a.services.length>0?t.services=e.map(a.services||[],function(t){var r=NumberUtils.parse_price(t.raw_price),s=a.finalized?NumberUtils.parse_price(t.base_price):r;return t=e.extend({},t,{key:ComponentHelpers.Keys.get_unique_key(),employee:t.employees[0],price:s,default_price:r,default_price_max:NumberUtils.parse_price(t.raw_price_max),duration:parseInt(t.raw_duration),lumo_standard_conversion:"true"===String(t.lumo_standard_conversion),item_duration:parseInt(t.event_service_duration),item_duration_before:parseInt(t.event_service_duration_before),item_duration_after:parseInt(t.event_service_duration_after),item_break_offset:parseInt(t.event_service_break_offset),item_break_duration:parseInt(t.event_service_break_duration),started_at:moment(t.started_at,n)}),CalendarModels.create_service(t)}):t.services=[]},t.prototype._create_order=function(t){var n=this,a=this.event;if(a.sale){var r={employee:a.sale.employee,sold_gift_cards:e.map(a.sold_gift_cards||[],function(e){return new GiftCards.GiftCard(e)}),sold_packages:e.map(a.sold_packages||[],function(e){return new Packages.Package(e)}),products:e.map(a.sale.products,function(e){return e.price=e.base_price,e.lumo_standard_conversion="true"===String(e.lumo_standard_conversion),n._create_product(e)})};t.order=CalendarModels.create_order(r)}},t.prototype._create_supply_use=function(e){this.event.supply_use&&(1===e.services.length?this._create_supply_use_for_single_service(e,e.services[0]):this._create_supply_use_for_multiple_services(e))},t.prototype._create_supply_use_for_single_service=function(t,n){var a=this;n.supply_use=CalendarModels.create_order({products:e.map(a.event.supply_use.products,function(e){return a._create_product(e)})}),t.supply_use=null},
t.prototype._create_supply_use_for_multiple_services=function(e){var t,n=this.event.supply_use.products,a=e.services,r={},s={};for(t=0;t<a.length;t++){var i=a[t];s[i.event_service_id]=[],r[i.event_service_id]=i}for(t=0;t<n.length;t++){var o=n[t],c=this._create_product(o),_=o.event_service_id;_&&s[_]||(_=a[0].event_service_id),s[_].push(c)}for(var p in s){n=s[p];var l=CalendarModels.create_order({products:n});r[p].supply_use=l}e.supply_use=null},t.prototype._create_customer_health_survey=function(e){e.customer_health_survey&&(e.customer_health_survey=CalendarModels.create_customer_health_survey(e.customer_health_survey))},t.prototype._create_product=function(e){return e.key=ComponentHelpers.Keys.get_unique_key(),e.initial_quantity=e.quantity,e.name_with_type_info=e.name,CalendarModels.create_product(e)},t.prototype._create_event_default_employee=function(){var t=this.event,n=e.map(t.services,function(e){return e.employees[0]?e.employees[0].id:null});if(this.default_employee_id&&(0===n.length||-1!==e.inArray(this.default_employee_id,n)))for(var a=0;a<this.available_employees.length;a++){var r=this.available_employees[a].id;if(r===this.default_employee_id)return e.extend({},this.available_employees[a])}return t.services[0]&&t.services[0].employees[0]?e.extend({},t.services[0].employees[0]):null},t.prototype._create_event_default_resource=function(){this.event;if(this.default_resource_id)for(var t=0;t<this.available_resources.length;t++){var n=this.available_resources[t].id;if(n===this.default_resource_id)return e.extend({},this.available_resources[t])}return null},t}(jQuery),CalendarModels.Finalizer=function(e){function t(t){e.extend(this,t)}return t.prototype.run=function(){var t=this;this._set_package_service_uuids();var n={events:e.map(this.events,function(e){return t._prepare_data_for_single_event(e)}),payments:this._prepare_payments_data(),total_price:this.total_price,total_price_before_discount:this.total_price_before_discount,total_payment:this.total_payment,group_id:this.group_id,set_flash_on_success:this.set_flash_on_success,discount_type:this.discount_type,group_discount:this.group_discount.serialize_for_save(),tips:this._prepare_tips(),skip_gift_cards_invalid_items:this.skip_gift_cards_invalid_items,skip_gift_cards_invalid_certificate_type:this.skip_gift_cards_invalid_certificate_type};return e.ajax({url:"/events/finalize",method:"post",dataType:"json",contentType:"application/json",data:JSON.stringify(n)})},t.prototype._set_package_service_uuids=function(){e.each(this.events,function(t,n){e.each(n.services,function(e,t){t.package_service_uuid=UUIDGenerator.unique_uuid()})})},t.prototype._prepare_data_for_single_event=function(t){return{event:this._prepare_event_data(t),customer_name:t.customer_name,order:this._prepare_order_data(t.order),sold_gift_cards:e.map(t.get_sold_gift_cards(),function(e){return e.serialize_for_save()}),sold_packages:e.map(t.get_sold_packages(),function(e){return e.serialize_for_save()}),supply_use:{ignore_product_inventories:this.ignore_supply_use_inventories}}},t.prototype._prepare_event_data=function(t){return{id:t.id,price:t.get_total_price_after_discount(),customer_id:t.get_customer_id(),beginning:CalendarUtils.moment_without_time_zone(t.beginning),end:CalendarUtils.moment_without_time_zone(t.end),finalized_at:t.finalized_at.format("YYYY-MM-DD"),canceled:t.canceled,cancel_event_prepayment_decision:t.cancel_event_prepayment_decision,destroy:t.destroy,description:t.description,events_services:this._prepare_services_data(t),tag_ids:e.map(t.tags,function(e){return e.id}),skip_resources:this.skip_resources_check}},t.prototype._prepare_services_data=function(t){var n=this;return t.services.length?e.map(t.services,function(e){var a=n._get_resource_ids_params(e,!e.event_service_id),r={service_id:e.id,price:e.price_after_discount(),event_service_id:e.event_service_id,employee_ids:e.employee?[e.employee.id]:[],switchable_resource_ids:a.switchable,unswitchable_resource_ids:a.unswitchable,package_service_uuid:e.package_service_uuid,duration:e.item_duration,started_at:CalendarUtils.moment_without_time_zone(e.started_at),duration_before:e.get_item_duration_before(),duration_after:e.get_item_duration_after(),break_offset:e.get_item_break_offset(),break_duration:e.get_item_break_duration()};return VersumConfig.lumo.lumo_activated&&VersumConfig.lumo.lumo_service_purchase_enabled&&t.customer&&"enabled"===t.customer.lumo_state&&(r.lumo_points=e.get_lumo_points(n.group_discount,n.excluded_lumo_points_percentage_for_services)),e.discount&&(r.discount_attributes=e.discount.serialize_for_save()),e.supply_use&&e.supply_use.get_products().length&&(r.used_product_params=n._prepare_used_products_data(e.supply_use.get_products())),r}):[this._prepare_unknown_service_data(t)]},t.prototype._get_resource_ids_params=function(e,t){for(var n=[],a=[],r=0;r<e.resources.length;r++){var s=e.resources[r].id;t&&e.resources[r].switchable?n.push(s):a.push(s)}return{switchable:n,unswitchable:a}},t.prototype._prepare_unknown_service_data=function(e){var t=[],n=[];return e.default_resource&&(n=[e.default_resource.id]),e.employee&&(t=[e.employee.id]),{service_id:-1,price:0,employee_ids:t,unswitchable_resource_ids:n,duration:e.get_duration_in_minutes(),started_at:CalendarUtils.moment_without_time_zone(e.beginning)}},t.prototype._prepare_order_data=function(t){if(!t)return null;var n=this;return{total_price:t.get_products_price_after_discount(),refferal:t.get_employee_id(),sold_products:e.map(t.get_products(),function(e){var t={id:e.sold_product_id,product_id:e.id,unit:e.selected_unit,quantity:e.get_quantity_for_chosen_unit(),quantity_in_packs:e.get_quantity_in_packs(),vat:VatUtils.is_no_vat_value(e.vat_value)?"no_vat":e.vat_value,gross_price:e.price_after_discount()};return VersumConfig.lumo.lumo_activated&&VersumConfig.lumo.lumo_product_purchase_enabled&&(t.lumo_points=e.get_lumo_points(n.group_discount,n.excluded_lumo_points_percentage_for_products)),e.discount&&(t.discount_attributes=e.discount.serialize_for_save()),t})}},t.prototype._prepare_used_products_data=function(t){return e.map(t,function(e){return{id:e.sold_product_id,product_id:e.id,unit:e.selected_unit,quantity:e.get_quantity_for_chosen_unit(),formula_id:e.formula_id}})},t.prototype._prepare_payments_data=function(){var t=e.grep(this.payments,function(e){return!0!==e.predefined&&("balance"!==e.payment_method||0!==e.value)});return e.map(t,function(t){var n={payment_method:PaymentMethods.get_payload_payment_method_token(t.payment_method),price:t.value};return t.gift_card&&(n.gift_card_id=t.gift_card.id,n.gift_card_usage_id=t.gift_card.usage_id),t.gift_coupon&&(n.gift_coupon_number=t.gift_coupon.number,n.gift_coupon_usage_id=t.gift_coupon.usage_id),t.package_item&&(n.package_id=t.package_item.id,t.package_services&&(n.package_service_uuids=e.map(t.package_services,function(e){return e.package_service_uuid}))),"blik"===t.payment_method&&(n.prepayment_transaction_id=t.prepayment_transaction_id),n})},t.prototype._prepare_tips=function(){return e.map(this.group_tips,function(e){return Tips.serialize_for_save(e)})},t}(jQuery),CalendarModels.FormulaManager=function(e){function t(e){this.formulas_data=e||{}}return t.prototype.get_formulas_for_service=function(e){return this.formulas_data[e]},t.prototype.set_formulas_for_service=function(e,t){this.formulas_data[e]=t},t.prototype.update_formulas_data=function(t){e.extend(this.formulas_data,t)},t}(jQuery),CalendarModels.Order=function(e){function t(t){e.extend(this,t),this.products||this.sold_products||(this.products=[]),this.sold_gift_cards||(this.sold_gift_cards=[]),this.sold_packages||(this.sold_packages=[])}return t.prototype.get_employee_id=function(){return this.employee?this.employee.id:null},t.prototype.get_products_price=function(){for(var e=0,t=0;t<this.get_products().length;t++)e+=this.get_products()[t].get_value();return this.delivery_method&&(e+=this.delivery_gross_price),NumberUtils.round_price(e)},t.prototype.get_products_price_after_discount=function(){for(var e=0,t=0;t<this.get_products().length;t++)e+=this.get_products()[t].get_value_after_discount();return this.delivery_method&&(e+=this.delivery_gross_price),NumberUtils.round_price(e)},t.prototype.get_products_net_price_after_discount=function(){return NumberUtils.round_price(this.get_products_precise_net_price_after_discount())},t.prototype.get_products_precise_net_price_after_discount=function(){for(var e=0,t=0;t<this.get_products().length;t++)e+=this.get_products()[t].get_precise_net_value_after_discount();return this.delivery_method&&(e+=this.delivery_net_price),e},t.prototype.get_sold_gift_cards_price=function(){for(var e=0,t=this.get_sold_gift_cards(),n=0;n<t.length;n++)e+=t[n].price;return NumberUtils.round_price(e)},t.prototype.get_sold_packages_price=function(){for(var e=0,t=this.get_sold_packages(),n=0;n<t.length;n++)e+=t[n].price;return NumberUtils.round_price(e)},t.prototype.get_total_price=function(){return NumberUtils.round_price(this.get_products_price()+this.get_sold_gift_cards_price()+this.get_sold_packages_price())},t.prototype.get_total_price_after_item_discounts=function(){var e,t=this.get_products_price_after_discount(),n=this.get_sold_gift_cards();for(e=0;e<n.length;e++)t+=n[e].price_after_discount();var a=this.get_sold_packages();for(e=0;e<a.length;e++)t+=a[e].price_after_discount();return NumberUtils.round_price(t)},t.prototype.get_total_net_price_after_item_discounts=function(){var e,t=this.get_products_precise_net_price_after_discount(),n=this.get_sold_gift_cards();for(e=0;e<n.length;e++)t+=n[e].net_price_after_discount();var a=this.get_sold_packages();for(e=0;e<a.length;e++)t+=a[e].net_price_after_discount();return NumberUtils.round_price(t)},t.prototype.get_base_price_for_discount=function(){return this.get_total_price_after_item_discounts()},t.prototype.get_total_price_after_discount=function(){return this.discount&&this.discount.active?this.discount.new_value():this.get_total_price_after_item_discounts()},t.prototype.get_total_net_price_after_discount=function(){var e=this.get_total_net_price_after_item_discounts();return this.discount&&this.discount.active&&(e=e*(100-100*this.discount.get_precise_percentage())/100,e=NumberUtils.round_price(e)),e},t.prototype.get_products=function(){return e.grep(this.products||this.sold_products,function(e){return!e.empty})},t.prototype.get_sold_gift_cards=function(){return this.sold_gift_cards=this.sold_gift_cards||[],this.sold_gift_cards},t.prototype.get_sold_packages=function(){return this.sold_packages=this.sold_packages||[],this.sold_packages},t.prototype.filter_sold_packages=function(e){for(var t=[],n=this.get_sold_packages(),a=0;a<n.length;a++)n[a].package_type===e&&t.push(n[a]);return t},t.prototype.get_lumo_points=function(e,t,n){for(var a=this.get_products(),r=0,s=0;s<a.length;s++)r+=a[s].get_lumo_points(e,t,n);return Math.round(r)},t.prototype.zero_lumo_points=function(){for(var e=this.get_products(),t=0;t<e.length;t++)e[t].item_lumo_points=0},t.prototype.reset_lumo_points=function(){for(var e=this.get_products(),t=0;t<e.length;t++)e[t].reset_lumo_points()},t.prototype.get_lumo_items=function(){return VersumConfig.lumo.lumo_product_purchase_enabled?{products:this.get_products(),services:[]}:{products:[],services:[]}},t.prototype.is_cost_defined=function(){var e=this.get_products();if(0===e.length)return!1;for(var t=0;t<e.length;t++){if(!e[t].is_cost_defined())return!1}return!0},t}(jQuery),CalendarModels.Product=function(e,t){function n(t){e.extend(this,t),VatUtils.is_no_vat_value(this.vat_value)&&(this.vat_value=VatUtils.NO_VAT_VALUE)}return n.prototype.get_vat_value_as_number=function(){return VatUtils.is_no_vat_value(this.vat_value)?0:this.vat_value},n.prototype.quantity_exceeded=function(){var e=this.initial_quantity||0;return NumberUtils.round_quantity(this.quantity-e)>this.inventory},n.prototype.get_value=function(){return NumberUtils.round_price(this.price*this.get_quantity_in_packs())},n.prototype.get_net_value=function(){return NumberUtils.round_price(this.get_net_price()*this.get_quantity_in_packs())},n.prototype.get_net_price=function(){var e=(this.price||0)/(1+this.get_vat_value_as_number()/100);return NumberUtils.round_price(e)},n.prototype.get_value_after_discount=function(){return this.discount?this.discount.new_value():this.get_value()},n.prototype.get_net_value_after_discount=function(){return NumberUtils.round_price(this.get_precise_net_value_after_discount())},n.prototype.get_precise_net_value_after_discount=function(){return this.precise_net_price_after_discount()*this.get_quantity_in_packs()},n.prototype.get_quantity_in_packs=function(){return this.quantity/this.supply_pack_size},n.prototype.get_quantity_for_chosen_unit=function(){return"pack"===this.selected_unit?this.get_quantity_in_packs():this.quantity},n.prototype.set_quantity_for_chosen_unit=function(e){"pack"===this.selected_unit?this._set_quantity_in_packs(e):this.quantity=e},n.prototype.get_available_quantity_for_chosen_unit=function(){return"pack"===this.selected_unit?this.get_available_packs():this.inventory},n.prototype.get_available_packs=function(){return NumberUtils.round_quantity(this.inventory/this.supply_pack_size)},n.prototype.price_after_discount=function(){return this.discount?this.discount.new_price():this.price},n.prototype.precise_price_after_discount=function(){return this.discount?this.discount.precise_new_price():this.price},n.prototype.net_price_after_discount=function(){return NumberUtils.round_price(this.precise_net_price_after_discount())},n.prototype.precise_net_price_after_discount=function(){return this.precise_price_after_discount()/(1+this.get_vat_value_as_number()/100)},n.prototype.get_lumo_points=function(e,n,a){return VersumConfig.lumo.lumo_product_purchase_enabled?null===this.item_lumo_points||this.item_lumo_points===t?this.count_auto_lumo_points(e,a):Math.round(this.item_lumo_points):0},n.prototype.count_auto_lumo_points=function(e,t){var n=this.lumo_standard_conversion?this.get_value()*VersumConfig.lumo.lumo_product_purchase_points:this.lumo_points*this.get_quantity_in_packs();return t&&(n-=t/100*n),this.discount&&(n-=n*this.discount.get_percentage()),e&&(n-=n*e.get_percentage()),Math.round(n)},n.prototype.reset_lumo_points=function(){this.item_lumo_points=null},n.prototype.are_lumo_points_modified=function(){return null!==this.item_lumo_points&&this.item_lumo_points!==t&&this.item_lumo_points!==this.count_auto_lumo_points()},n.prototype.is_cost_defined=function(){return null!=this.net_cost},n.prototype._set_quantity_in_packs=function(e){this.quantity=NumberUtils.round_quantity(e*this.supply_pack_size)},n}(jQuery),CalendarModels.Service=function(e,t){function n(t){e.extend(this,t),VatUtils.is_no_vat_value(this.vat_value)&&(this.vat_value=VatUtils.NO_VAT_VALUE)}return n.prototype.get_vat_value_as_number=function(){return VatUtils.is_no_vat_value(this.vat_value)?0:this.vat_value},n.prototype.price_after_discount=function(){return this.discount?this.discount.new_price():this.price},n.prototype.net_price_after_discount=function(){var e=this.price_after_discount()/(1+this.get_vat_value_as_number()/100);return NumberUtils.round_price(e)},n.prototype.get_lumo_points=function(e,n){return VersumConfig.lumo.lumo_service_purchase_enabled?null===this.item_lumo_points||this.item_lumo_points===t?this.count_auto_lumo_points(e,n):Math.round(this.item_lumo_points):0},n.prototype.count_auto_lumo_points=function(e,t){var n=this.lumo_standard_conversion?this.price*VersumConfig.lumo.lumo_service_purchase_points:this.lumo_points;return t&&(n-=t/100*n),this.discount&&(n-=n*this.discount.get_percentage()),e&&(n-=n*e.get_percentage()),Math.round(n)},n.prototype.reset_lumo_points=function(){this.item_lumo_points=null},n.prototype.are_lumo_points_modified=function(){return null!==this.item_lumo_points&&this.item_lumo_points!==t&&this.item_lumo_points!==this.count_auto_lumo_points()},n.prototype.get_finished_at=function(){return moment(this.started_at).add(this.item_duration,"minutes")},n.prototype.get_item_duration_before=function(){return this.item_duration_before||0},n.prototype.get_item_duration_after=function(){return this.item_duration_after||0},n.prototype.get_item_break_offset=function(){return this.item_break_offset||0},n.prototype.get_item_break_duration=function(){return this.item_break_duration||0},n.prototype.get_item_duration_before_break=function(){return this.get_item_break_offset()},n.prototype.get_item_duration_after_break=function(){var e=this.item_duration-this.get_item_break_offset()-this.get_item_break_duration();return e<0&&(e=0),e},n.prototype.get_item_break_started_at=function(){return moment(this.started_at).add(this.get_item_break_offset(),"minutes")},n.prototype.get_item_break_finished_at=function(){return moment(this.started_at).add(this.get_item_break_offset()+this.get_item_break_duration(),"minutes")},n.prototype.is_unknown=function(){return-1===this.id},n}(jQuery),CalendarModels.ServiceAdjustingReverter=function(e){function t(e,t){this.event=e,this.event_time_manager=t.event_time_manager,this._stored_data={}}return t.prototype.save_state=function(){var t={};e.each(this.event.services,function(n,a){t[a.key]={started_at:moment(a.started_at),item_duration:a.item_duration,employee:a.employee?e.extend(!0,{},a.employee):a.employee,resources:a.resources?e.extend(!0,[],a.resources):a.resources}}),this._stored_data=t},t.prototype.revert=function(){var t=this._stored_data;e.each(this.event.services,function(e,n){var a=t[n.key];a&&(n.started_at=a.started_at,n.item_duration=a.item_duration,n.employee=a.employee,n.resources=a.resources)}),this.event_time_manager.fix_event_time()},t}(jQuery),CalendarModels.ServiceResourcesModal=function(e){function t(t,n){this.service=t,this.event_editable=n.event_editable,this.employees_with_calendar=n.employees_with_calendar,this.resources_by_item_id=n.resources_by_item_id,this.resources=n.resources,this.event_edition_enabled=n.event_edition_enabled,this.on_set_edit_mode=n.on_set_edit_mode||function(){},this.on_service_change=n.on_service_change,this.hide_actions=!!n.hide_actions,this.modal_title=n.modal_title,this.old_employee=t.employee?e.extend({},t.employee):null,this.old_resources=e.extend([],t.resources),this.deferred=e.Deferred()}return t.prototype.run=function(){return this._show_modal(),this.deferred.promise()},t.prototype._show_modal=function(){var t,n=this,a=e("<div>"),r=[{id:"accept-button",label:I18n.t("js.dialog.accept"),cssClass:"button-blue e2e-save-dialog",action:function(e){n.deferred.resolve(),e.close()}},{id:"cancel-button",label:I18n.t("js.dialog.cancel"),action:function(e){e.close()}},{id:"close-button",label:I18n.t("js.dialog.close"),cssClass:"button-blue",action:function(e){e.close()}}];this.event_editable&&!this.hide_actions&&r.push({id:"edit-button",label:I18n.t("js.dialog.edit"),action:function(e){n._set_edit_mode(e,t)}});BootstrapDialog.show({title:this.modal_title||this.service.name,message:function(e){return n.event_edition_enabled?(e.getButton("close-button").hide(),n._hide_edit_button(e)):(e.getButton("accept-button").hide(),e.getButton("cancel-button").hide()),a},buttons:r,cssClass:"resources-modal",onhide:function(){n.event_edition_enabled&&"pending"===n.deferred.state()&&(n.service.employee=n.old_employee,n.service.resources=n.old_resources,n.deferred.reject())}});t=ReactDOM.render(React.createElement(EventComponents.ServiceResourcesModal,{service:this.service,employees_with_calendar:this.employees_with_calendar,resources_by_item_id:this.resources_by_item_id,resources:this.resources,event_edition_enabled:this.event_edition_enabled}),a.get(0))},t.prototype._set_edit_mode=function(e,t){this.event_edition_enabled=!0,e.getButton("close-button").hide(),this._hide_edit_button(e),e.getButton("accept-button").show(),e.getButton("cancel-button").show(),t.set_edit_mode(),this.on_set_edit_mode()},t.prototype._hide_edit_button=function(e){var t=e.getButton("edit-button");t&&t.hide()},t}(jQuery),CalendarModels.ServicesAdjuster=function(e){function t(e,t){this.event=e,this.event_time_manager=t.event_time_manager,this.employees_with_calendar=t.employees_with_calendar,this.resources=t.resources,this.cancelable=t.cancelable}return t.prototype.adjust=function(){return this._render_component()},t.prototype._render_component=function(){var t=this,n=e.Deferred(),a=e("<div>"),r=[{label:I18n.t("js.dialog.accept"),cssClass:"button-blue",action:function(e){n.resolve(),e.close()}}];this.cancelable&&r.push({label:I18n.t("js.dialog.cancel"),action:function(e){e.close()}});BootstrapDialog.show({title:I18n.t("js.dialog.notice"),message:a,buttons:r,closable:this.cancelable,onhide:function(){ReactDOM.unmountComponentAtNode(a.get(0)),"pending"===n.state()&&(t.cancelable?n.reject():n.resolve())}});return ReactDOM.render(React.createElement(EventComponents.ServicesAdjuster,{event:this.event,event_time_manager:this.event_time_manager,employees_with_calendar:this.employees_with_calendar,resources:this.resources,resources_by_item_id:this._resources_by_item_id()}),a.get(0)),n.promise()},t.prototype._resources_by_item_id=function(){for(var e={},t=0;t<this.resources.length;t++){var n=this.resources[t];e[n.resource_item_id]=n}return e},t}(jQuery),CalendarModels.ServicesForSelectManager=function(e){function t(){this.services_tree=null,this.fetching_started=!1,this.deferred_list=[]}return t.get_singleton_instance=function(e){return this._singleton_instance||(this._singleton_instance=new t),e&&this._singleton_instance.get_services_tree(),this._singleton_instance},t.prototype.get_services_tree=function(){if(null!==this.services_tree)return e.Deferred().resolve(this.services_tree).promise();if(this.fetching_started){var t=e.Deferred();return this.deferred_list.push(t),t.promise()}return this.fetching_started=!0,this._fetch()},t.prototype._fetch=function(){var t=this,n=e.Deferred();return this.deferred_list.push(n),e.ajax({url:"/services/for_select.json",cache:!1,dataType:"json"}).done(function(e){t.services_tree=e;for(var n=0;n<t.deferred_list.length;n++)t.deferred_list[n].resolve(e)}).fail(function(e,n,a){for(var r=0;r<t.deferred_list.length;r++)t.deferred_list[r].reject(e,n,a)}),n.promise()},t}(jQuery),CalendarModels.ServicesResizer=function(e,t){function n(e,t){this.services=e,this.start=t.start,this.end=t.end,this.old_end=t.old_end}return n.prototype.resize=function(){var t,n,a=this;e.each(this.services,function(e,r){var s=r.get_finished_at(),i=r.item_duration;if(r.item_duration=0===a._get_old_total_duration()?5*Math.round(a._get_total_duration()/a.services.length/5):5*Math.round(i*a._get_ratio()/5),0===r.item_duration&&(r.item_duration=5),e>0){var o=a._get_diff_in_minutes(r.started_at,n),c=0===a._get_old_total_duration()?0:5*Math.round(o*a._get_ratio()/5);r.started_at=moment(t).add(c,"minutes")}r.started_at.isAfter(a.end)?(r.started_at=moment(a.end),r.item_duration=0):r.get_finished_at().isAfter(a.end)&&(r.item_duration=a._get_diff_in_minutes(a.end,r.started_at)),t=r.get_finished_at(),n=s})},n.prototype._get_diff_in_minutes=function(e,t){var n=e.diff(t);return Math.round(moment.duration(n).asMinutes())},n.prototype._get_ratio=function(){return this._ratio===t&&(this._ratio=this._get_total_duration()/this._get_old_total_duration()),this._ratio},n.prototype._get_total_duration=function(){return this._total_duration===t&&(this._total_duration=this._get_diff_in_minutes(this.end,this.start)),this._total_duration},n.prototype._get_old_total_duration=function(){return this._old_total_duration===t&&(this._old_total_duration=this._get_diff_in_minutes(this.old_end,this.start)),this._old_total_duration},n}(jQuery),window.ComponentHelpers={on_print_receipt:function(e){var t=this;return function(n){n.preventDefault(),t.print_receipt(e)}},on_print_tss_receipt:function(e,t){return function(n){return n.preventDefault(),window.reactLegacyBridge.modals.NewReceiptModal.renderModal({type:"prepayment",id:e,onReceiptIssued:t})}},print_receipt:function(e){FiscalPrinter.build_receipt_form_manager({form_url:e}).run()},on_print_invoice:function(e,t){this.open_invoice_popup(e+"&type="+t,!0)},open_invoice_popup:function(e,t){VersumUtils.show_indicator();var n=this;$.get(e,function(e){VersumUtils.hide_indicator();var a=$(e),r=[];t?r.push({label:I18n.t("js.dialog.save"),cssClass:"button-blue",action:function(e){var s=a.find("form"),i=new XMLHttpRequest;$.ajax({type:"POST",url:s.attr("action"),data:s.serialize(),xhr:function(){return i},success:function(){e.close(),n.open_invoice_popup(i.responseURL)},error:function(n){e.close(),BootstrapDialog.show({message:n.responseText.replace(/(\r\n|\n|\r)/gm,""),title:$(n).attr("data-title"),buttons:r,cssClass:t?null:"wide-dialog"})}})}}):r.push({label:I18n.t("js.dialog.print"),cssClass:"button-blue",action:function(){document.getElementById("invoice-iframe").contentWindow.print()}},{label:I18n.t("js.dialog.save_pdf"),cssClass:"button-outline-blue",action:function(){window.open(a.attr("data-pdf-url"),"_blank")}}),r.push({label:I18n.t("js.dialog.cancel"),cssClass:"ml-auto",action:function(e){e.close()}}),BootstrapDialog.show({message:a,title:a.attr("data-title"),buttons:r,cssClass:t?null:"wide-dialog",onhide:function(){}})})},on_show_receipt:function(e){return function(t){t.preventDefault(),FiscalPrinter.build_receipt_list_popup_manager({url:e}).run()}},on_show_tss_receipt:function(e,t,n){return function(a){return a.preventDefault(),window.reactLegacyBridge.modals.ShowReceiptModal.renderModal({receipts:e,type:"prepayment",id:t,onReceiptIssued:n})}},add_modal_enter_key_action:function(e,t,n){t.on("keydown",function(t){var a=t&&t.target&&t.target.classList.contains("js-submittable");13===t.keyCode&&a&&e.options.buttons[n].action(e)})}},window.ComponentHelpers.Customers=function(){function e(e){var t=e.id,n=e.customer_email_url,a=e.customer_sms_url,r=e.customer_url;return _fullcalendar_restricted||(n||(n="/newsletters/new?platform=email&recipient="+encodeURIComponent(e.email)+"&single=1"),a||(a="/newsletters/new?platform=sms&recipient="+encodeURIComponent(e.phone_number)+"&single=1"),r||(r="/customers/"+t)),{email_url:n,sms_url:a,customer_url:r}}return{generate_customer_html:function(t,n,a){if(!t.name)return I18n.t("js.missing");var r="",s=e(t);if(r+='<a href="'+s.customer_url+'" class="customer_popover e2e-customer-name">'+t.name+"</a>",s.customer_url&&(r+='&nbsp; <a href="'+s.customer_url+'" target="_blank" title="'+I18n.t("js.calendar.customers.customer_card")+'" class="e2e-customer-card""><span class="icon sprite-customer_card"></span></a>'),r+='<span id="customer_full_data">',t.customer_data_protection)var i="/settings/data_protection/create_log.json?id="+t.id,o='<span class="customer_phone_number"><a class="show_contact_data" href="'+i+'">'+I18n.t("js.calendar.customers.show_contact_data")+"</a></span>",c='<span class="customer_email"><a class="show_contact_data" href="'+i+'">'+I18n.t("js.calendar.customers.show_contact_data")+"</a></span>",_='<table style="margin-bottom: 10px;"><tr><td><span class="light_label">'+I18n.t("js.calendar.customers.phone_number")+":&nbsp;</span></td><td>"+(t.phone_number&&t.phone_number.length>0?o:I18n.t("js.not_specified"))+'</td></tr><tr>\n<td><span class="light_label">'+I18n.t("js.calendar.customers.email")+":&nbsp;</span></td><td>"+(t.email&&t.email.length>0?c:I18n.t("js.not_specified"))+"</td></tr></table>";else var o=s.sms_url?'<a href="'+s.sms_url+'">'+t.phone_number_formatted+"</a>":t.phone_number_formatted,c=s.email_url?'<a href="'+s.email_url+'">'+t.email+"</a>":t.email,_='<table style="margin-bottom: 10px;"><tr><td><span class="light_label">'+I18n.t("js.calendar.customers.phone_number")+":&nbsp;</span></td><td>"+(t.phone_number&&t.phone_number.length>0?o:I18n.t("js.not_specified"))+'</td></tr><tr>\n<td><span class="light_label">'+I18n.t("js.calendar.customers.email")+":&nbsp;</span></td><td>"+(t.email&&t.email.length>0?c:I18n.t("js.not_specified"))+"</td></tr></table>";return r+=_,n||(r+='<a id="customer_arrived_activate" href ="javascript:void(0)">'+I18n.t("js.calendar.customers.customer_arrived")+"</a><br>"),r+='<div class="clearfix" style="margin-top: 12px"><div class="pull-left"><span class="light_label">'+I18n.t("js.calendar.customers.description")+': </span></div><div class="pull-right nowrap">',_fullcalendar_restricted||a||(r+='<a data-action="edit_description" href="javascript:;">'+I18n.t("js.calendar.customers.edit_description")+"</a>"),r+="</div> </div>",r+='<div id="customer_description" data-customer_name="'+t.name+'" data-customer_id="'+t.id+'" data-customer_url="/customers/'+t.id+'">'+(t.description&&t.description.length>0?'<div class="description-content">'+window.markdownUtils.richContentHtml(t.description,t.description_content_type,"")+"</div>":'<div class="description-content"></div><span data-placeholder="description">'+I18n.t("js.calendar.customers.no_description")+"</span>")+"</div>",r+="</span>"}}}(jQuery),window.ComponentHelpers.Employees=function(e){return{get_employee_options:function(t,n){n=n||{};var a=n.current_employee,r=n.include_empty_option,s=!1,i=e.map(t,function(e){return a&&a.id===e.id&&(s=!0),React.createElement("option",{key:e.id,value:e.id,"data-entity":JSON.stringify(e)},e.name," ",e.duration?"("+e.duration+" min)":"")});return!s&&a&&a.id&&i.push(React.createElement("option",{key:a.id,value:a.id,"data-entity":JSON.stringify(a)},a.name)),r?[React.createElement("option",{key:"empty_option"})].concat(i):i}}}(jQuery),window.ComponentHelpers.Keys=function(){return{get_unique_key:function(){for(var e=(new Date).getTime();e===(new Date).getTime(););return(new Date).getTime()}}}(jQuery);var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,s=t,i=n;a=!1,null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,s);if(o!==undefined){if("value"in o)return o.value;var c=o.get;return c===undefined?undefined:c.call(i)}var _=Object.getPrototypeOf(r);if(null===_)return undefined;e=_,t=s,n=i,a=!0,o=_=undefined}},Input=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),this.state={value:e.value},this.handleOnKeyPress=this.handleOnKeyPress.bind(this)}return _inherits(t,e),_createClass(t,[{key:"componentWillReceiveProps",value:function(e){this.setState({value:e.value})}},{key:"render",value:function(){return React.createElement("input",{className:"pagination-page-input",type:"text",value:this.state.value,onChange:this.handleOnKeyPress,onKeyPress:this.handleOnKeyPress})}},{key:"handleOnKeyPress",value:function(e){"Enter"===e.key?this.props.handleChangePage(e):this.setState({value:Number(e.currentTarget.value)})}}]),t}(React.Component);Input.propTypes={value:React.PropTypes.number,handleChangePage:React.PropTypes.func};var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,s=t,i=n;a=!1,null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,s);if(o!==undefined){if("value"in o)return o.value;var c=o.get;return c===undefined?undefined:c.call(i)}var _=Object.getPrototypeOf(r);if(null===_)return undefined;e=_,t=s,n=i,a=!0,o=_=undefined}},Last=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){return React.createElement("a",{href:"javascript:;","data-next-page":this.props.value,onClick:this.props.onClick},this.props.value)}}]),t}(React.Component);Last.propTypes={value:React.PropTypes.number,onClick:React.PropTypes.func};var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,s=t,i=n;a=!1,null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,s);if(o!==undefined){if("value"in o)return o.value;var c=o.get;return c===undefined?undefined:c.call(i)}var _=Object.getPrototypeOf(r);if(null===_)return undefined;e=_,t=s,n=i,a=!0,o=_=undefined}},NextArrow=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),
_createClass(t,[{key:"render",value:function(){return React.createElement("a",{href:"javascript:;",className:"button button-link button_next ml-s",title:this.props.title,"data-next-page":this.props.pageNo,onClick:this.props.onClick},React.createElement("span",{className:"fc-icon fc-icon-right-single-arrow"}))}}]),t}(React.Component);NextArrow.propTypes={title:React.PropTypes.string,pageNo:React.PropTypes.number.isRequired,onClick:React.PropTypes.func.isRequired};var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,s=t,i=n;a=!1,null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,s);if(o!==undefined){if("value"in o)return o.value;var c=o.get;return c===undefined?undefined:c.call(i)}var _=Object.getPrototypeOf(r);if(null===_)return undefined;e=_,t=s,n=i,a=!0,o=_=undefined}},PaginationContainer=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=null;this.props.pageNo<this.props.collectionSize/this.props.perPage&&(e=React.createElement(NextArrow,{title:"Nast\u0119pna strona",pageNo:this.props.pageNo+1,onClick:this.props.handleChangePage}));var t=null;this.props.pageNo>1&&(t=React.createElement(PrevArrow,{title:"Poprzednia strona",pageNo:this.props.pageNo-1,onClick:this.props.handleChangePage}));var n=Math.ceil(this.props.collectionSize/this.props.perPage);return React.createElement("div",{className:"form_pagination"},t,React.createElement(Input,{value:this.props.pageNo,handleChangePage:this.props.handleChangePage}),"\xa0z\xa0",React.createElement(Last,{value:n,onClick:this.props.handleChangePage}),e)}}]),t}(React.Component);PaginationContainer.propTypes={pageNo:React.PropTypes.number.isRequired,perPage:React.PropTypes.number.isRequired,collectionSize:React.PropTypes.number.isRequired,handleChangePage:React.PropTypes.func.isRequired};var PaginationWrapper=ReactRedux.connect(function(e){var t=e.pagination;return{pageNo:t.page,perPage:t.per_page,collectionSize:t.collection_size}},function(){return{handleChangePage:TodoHandlers.handlePaginationChangePage}})(PaginationContainer),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,s=t,i=n;a=!1,null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,s);if(o!==undefined){if("value"in o)return o.value;var c=o.get;return c===undefined?undefined:c.call(i)}var _=Object.getPrototypeOf(r);if(null===_)return undefined;e=_,t=s,n=i,a=!0,o=_=undefined}},PrevArrow=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){return React.createElement("a",{href:"javascript:;",className:"button button-link button_prev mr-s",title:this.props.title,"data-next-page":this.props.pageNo,onClick:this.props.onClick},React.createElement("span",{className:"fc-icon fc-icon-left-single-arrow"}))}}]),t}(React.Component);PrevArrow.propTypes={title:React.PropTypes.string,pageNo:React.PropTypes.number.isRequired,onClick:React.PropTypes.func.isRequired},window.ComponentHelpers.Services=function(){return{get_full_service_name:function(e,t){if(t=t||{},e.is_unknown())return React.createElement("span",null,t.bare_name_for_unknown_service?I18n.t("js.services.bare"):e.name);var n=NumberUtils.format_price(e.default_price),a=e.default_price_max>e.default_price?React.createElement("span",null,n," - ",NumberUtils.format_price(e.default_price_max)):React.createElement("span",null,n),r=React.createElement("span",null,e.duration," ",EventComponents.t("minutes_short")),s=e.prepayment_amount?" - "+NumberUtils.format_price(e.prepayment_amount)+" "+I18n.t("js.services.prepayment"):null;return React.createElement("span",null,e.name," ",React.createElement("small",null,"(",r,", ",a,e.paid&&", "+I18n.t("js.services.paid")," ",s,")"))},get_full_service_name_str:function(e,t){if(t=t||{},e.is_unknown())return t.bare_name_for_unknown_service,I18n.t("js.services.bare");var n=NumberUtils.format_price(e.default_price),a=e.default_price_max>e.default_price?"<span>"+n+" - "+NumberUtils.format_price(e.default_price_max)+"</span>":"<span>"+n+"</span>",r="<span>"+e.duration+" "+EventComponents.t("minutes_short")+"</span>";return"<span>"+e.name+" <small>("+r+", "+a+")</small></span>"},get_icon_class_for_tab:function(e){switch(e){case"general":return"sprite-calendar_event";case"duration":return"sprite-calendar_duration";case"resources":return"sprite-calendar_resources";case"supply_use":return"sprite-calendar_supply_use";case"employee":return"sprite-calendar_employees";default:return""}}}}(jQuery);var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,s=t,i=n;a=!1,null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,s);if(o!==undefined){if("value"in o)return o.value;var c=o.get;return c===undefined?undefined:c.call(i)}var _=Object.getPrototypeOf(r);if(null===_)return undefined;e=_,t=s,n=i,a=!0,o=_=undefined}},UserButton=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this;return React.createElement("div",{className:"border-color user"},React.createElement("a",{href:this.props.href,className:this.props.color,title:this.props.title,"data-toggle":"tooltip",onClick:this.stopPropagation,ref:function(t){return e.box=t}},this.props.initials))}},{key:"stopPropagation",value:function(e){e.stopPropagation()}},{key:"componentDidMount",value:function(){this.props.initTooltip&&this.props.initTooltip($(this.box))}}]),t}(React.Component);UserButton.propTypes={href:React.PropTypes.string,color:React.PropTypes.string,title:React.PropTypes.string,initials:React.PropTypes.string,initTooltip:React.PropTypes.func},function(){window.LumoComponents=window.LumoComponents||{t:function(e,t){return t=t||{},t.scope=t.scope||"js.lumo",I18n.t(e,t)},parse_points:function(e){return"string"==typeof e&&(e=e.replace(",",".").trim()),e=parseInt(e),isNaN(e)&&(e=0),e}}}(jQuery),LumoComponents.LumoBox=function(e){return React.createClass({render:function(){var e,t=this.props.item.customer;return e=t?(this["render_for_state_"+t.lumo_state]||this.render_for_no_customer)():this.render_for_no_customer(),React.createElement("div",{className:"lumo-box"},e)},render_for_no_customer:function(){return LumoComponents.t("lumo_box.no_customer")},render_for_state_initial:function(){var e,t=this.state.updating_customer;return e=this.props.event_edition_enabled?React.createElement("span",{className:"initial-question"},LumoComponents.t("lumo_box.initial_question"),React.createElement("button",{type:"button",className:"btn btn-primary",onClick:this.activate,disabled:t},LumoComponents.t("lumo_box.yes")),React.createElement("button",{type:"button",className:"btn",onClick:this.deactivate,disabled:t},LumoComponents.t("lumo_box.no"))):React.createElement("span",null,LumoComponents.t("lumo_box.initial_text")),this.render_for_state_other_than_enabled(e)},render_for_state_disabled:function(){var e=this.props.event_edition_enabled?React.createElement("a",{href:"#",className:"edit-link",onClick:this.set_initial},LumoComponents.t("lumo_box.edit")):React.createElement("span",null),t=React.createElement("span",null,LumoComponents.t("lumo_box.disabled_text")," ",e);return this.render_for_state_other_than_enabled(t)},render_for_state_suspended:function(){var e=this.props.event_edition_enabled?React.createElement("a",{href:"#",className:"edit-link",onClick:this.set_initial},LumoComponents.t("lumo_box.edit")):React.createElement("span",null),t=React.createElement("span",null,LumoComponents.t("lumo_box.suspended_text")," ",e);return this.render_for_state_other_than_enabled(t)},render_for_state_other_than_enabled:function(e){return React.createElement("div",{className:"row pt-xs"},React.createElement("div",{className:"col-sm-8"},e),React.createElement("div",{className:"col-sm-4"},React.createElement("div",{className:"points points-prediction"},this.props.item.get_lumo_points(this.props.group_discount)," ",LumoComponents.t("points_short"))))},render_lumo_points_sum:function(){var e;this.props.event_edition_enabled&&this.items_present()&&(e=React.createElement("a",{href:"#",className:"edit-link",onClick:this.edit_points},LumoComponents.t("lumo_box.edit")));var t=this.props.item.get_lumo_points(this.props.group_discount,this.props.excluded_lumo_points_percentage_for_services,this.props.excluded_lumo_points_percentage_for_products);return React.createElement("span",{className:"points"},t<0?0:t," ",LumoComponents.t("points_short"),e)},render_for_state_enabled:function(){var e="test"===VersumConfig.lumo.lumo_state?LumoComponents.t("lumo_box.test_customer_points"):LumoComponents.t("lumo_box.customer_points");return this.state.edit_mode?this.render_items_table():React.createElement("div",null,this.render_lumo_points_sum(),React.createElement("span",{className:"customer-points"},e,": ",React.createElement("span",{className:"value"},this.props.item.customer.lumo_points)))},render_items_table:function(){var e="test"===VersumConfig.lumo.lumo_state?LumoComponents.t("lumo_box.test_customer_points"):LumoComponents.t("lumo_box.customer_points");return React.createElement("div",null,React.createElement("div",{className:"customer-points"},e,": ",React.createElement("span",{className:"value"},this.props.item.customer.lumo_points)),this.render_items_table_element(),this.render_input_lumo_points_warning())},render_items_table_element:function(){var e=this.props.item.get_lumo_items();if(this.items_present(e))return React.createElement("div",{className:"data_table"},React.createElement("table",null,React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",{className:"transparent-border transparent-bg"}),React.createElement("th",null,LumoComponents.t("lumo_box.name")),React.createElement("th",null,LumoComponents.t("lumo_box.auto_value")),React.createElement("th",null,LumoComponents.t("lumo_box.own_value")))),React.createElement("tbody",null,this.render_table_rows(e.services,e.products))))},render_table_rows:function(e,t){var n=[];if(e.length>0){n.push(React.createElement("tr",{key:"services"},React.createElement("th",{rowSpan:e.length+1},LumoComponents.t("lumo_box.services"))));for(var a=0;a<e.length;a++)n.push(this.render_table_row(e[a]))}if(t.length>0){n.push(React.createElement("tr",{key:"products"},React.createElement("th",{rowSpan:t.length+1},LumoComponents.t("lumo_box.products"))));for(var a=0;a<t.length;a++)n.push(this.render_table_row(t[a]))}return n},render_table_row:function(e){return React.createElement(LumoComponents.LumoItem,{item:e,group_discount:this.props.group_discount,on_change:this.props.on_change,key:e.key,excluded_lumo_points_percentage_for_services:this.props.excluded_lumo_points_percentage_for_services,excluded_lumo_points_percentage_for_products:this.props.excluded_lumo_points_percentage_for_products})},render_input_lumo_points_warning:function(){var e=this.props.item.get_lumo_items(),t=0;if(e.services.length>0)for(var n=0;n<e.services.length;n++)e.services[n].item_input_lumo_points&&(t+=+e.services[n].item_input_lumo_points);if(e.products.length>0)for(var n=0;n<e.products.length;n++)e.products[n].item_input_lumo_points&&(t+=+e.products[n].item_input_lumo_points);if(t<0)return React.createElement("div",{className:"box-line prepayment-line"},React.createElement("div",{className:"box-line-content prepayment-line-content"},React.createElement("div",{className:"v2-row v2-row-s"},React.createElement("div",{className:"v2-col-auto"},React.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"#ed8e05",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},React.createElement("path",{d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}),React.createElement("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),React.createElement("line",{x1:"12",y1:"17",x2:"12",y2:"17"}))),React.createElement("div",{className:"v2-col"},React.createElement("div",null,React.createElement("span",null,LumoComponents.t("lumo_box.negative_lumo_points")))))))},getInitialState:function(){return{updating_customer:!1,edit_mode:!1}},componentWillMount:function(){this.reset_lumo_points_if_needed()},reset_lumo_points_if_needed:function(){var e=this.props.item.get_lumo_items();for(var t in e)for(var n=e[t],a=0;a<n.length;a++){var r=n[a];r.are_lumo_points_modified()||r.reset_lumo_points()}},items_present:function(e){return e=e||this.props.item.get_lumo_items(),e.services.length>0||e.products.length>0},set_initial:function(e){e.preventDefault(),this.props.item.customer.lumo_state="initial",this.props.on_change()},activate:function(){this.change_customer_state("enabled")},deactivate:function(){this.change_customer_state("suspended")},change_customer_state:function(t){var n=this,a=this.props.item.customer;this.setState({updating_customer:!0}),VersumUtils.show_indicator(),e.ajax({url:"/customers/"+a.id,type:"PUT",data:{physical_customers_cosmetics:{lumo_state:t},physical_customers_glaxo:{lumo_state:t}},dataType:"json"}).then(function(e){VersumUtils.hide_indicator(),n.state.updating_customer=!1,a.lumo_state=e.lumo_state,n.props.on_lumo_state_change()})},edit_points:function(e){e.preventDefault(),this.setState({edit_mode:!0})}})}(jQuery),LumoComponents.LumoItem=function(){return React.createClass({render:function(){var e=this.props.item,t=e.count_auto_lumo_points(this.props.group_discount,this.props.excluded_lumo_points_percentage_for_services,this.props.excluded_lumo_points_percentage_for_products);return React.createElement("tr",null,React.createElement("td",null,e.name),React.createElement("td",null,t<=0?0:t),React.createElement("td",null,React.createElement("input",{type:"text",value:this.state.input_value,onChange:this.update_points,className:"points-input"})))},getInitialState:function(){var e=this.props.item.get_lumo_points(this.props.group_discount,this.props.excluded_lumo_points_percentage_for_services,this.props.excluded_lumo_points_percentage_for_products);return this.props.item.item_input_lumo_points=e<=0?0:e,this.props.on_change(),{input_value:e<=0?0:e}},componentWillReceiveProps:function(e){var t=e.item.get_lumo_points(this.props.group_discount,this.props.excluded_lumo_points_percentage_for_services,this.props.excluded_lumo_points_percentage_for_products);t!==LumoComponents.parse_points(this.state.input_value)&&this.setState({input_value:t<=0?0:t})},update_points:function(e){var t=LumoComponents.parse_points(e.target.value);this.props.item.item_lumo_points=t,this.props.item.item_input_lumo_points=t,this.state.input_value=e.target.value,this.props.on_change()}})}(jQuery),window.PaymentComponents=window.PaymentComponents||{},PaymentComponents.CommonMethods=function(e,t){return{render_method_row:function(e,t){e.key=e.key||ComponentHelpers.Keys.get_unique_key();var n=e.predefined||e.uneditable||e.prepayment_transaction_id||this.is_finalized_overpayment_balance(e);return this.props.hide_balance&&"balance"===e.payment_method?React.createElement("div",{key:e.key,className:"payment-method"},this.render_add_button(t)):React.createElement("div",{key:e.key,className:"payment-method"},n?this.render_price_value(e,t):this.render_price_input(e,t),n?this.render_payment_method_label(t):this.render_payment_method_select(t),this.render_payment_pending_info(e,t),this.render_prepayment_transaction_info(e),this.render_gift_card_number(t),this.render_gift_coupon_number(t),this.render_carnet_number(t),this.render_method_link(t),this.render_gift_card(t),this.render_gift_coupon(t),this.render_package(t),this.render_carnet(t),this.render_overpayment_balance(t),this.render_validation(e),this.render_add_button(t))},is_method_valid:function(e){return!e.errors||0===e.errors.length},is_finalized_overpayment_balance:function(e){return"overpayment_balance"===e.payment_method&&this.props.already_finalized},validate_payments:function(){var e=this;e.state.payments.forEach(function(t){e.validate_payment(t)}),e.state.is_valid=e.state.payments.every(function(t){return e.is_method_valid(t)}),e.forceUpdate()},validate_payment:function(e){var t=e.value,n=e.payment_method,a=this.props.overpayment_balance;e.errors=[],"overpayment_balance"===n&&(t<=0&&e.errors.push(I18n.t("js.validation.more_than_zero")),!this.props.already_finalized&&t>a&&e.errors.push(I18n.t("js.validation.more_than_balance")))},render_validation:function(e){var t=(e.errors||[]).join(", ");if(t.length>0)return React.createElement("div",{style:{color:"red"}},t)},render_payment_pending_info:function(e,t){var n=this.state.payments[t];return(n.is_pending||n.is_online_payment_pending)&&React.createElement("span",{className:"pl-s pending right_space"},"(",I18n.t("js.payments.pending"),")")||""},render_prepayment_transaction_info:function(e){var t=_.get(window,"reactLegacyBridge.modals.PaymentTransactionStatusModal.renderModal",function(){});if((PaymentMethods.is_online(e.payment_method)||"balance"===e.payment_method)&&e.online_payment_ids&&e.online_payment_ids.length>0)return React.createElement("a",{href:"javascript:void(0)",onClick:function(){t({ids:e.online_payment_ids})}},I18n.t("js.payments.details"))},render_price_input:function(e,t){var n,a=this.is_method_valid(e);return n=e.package_services?React.createElement("input",{type:"text",value:NumberUtils.format_price_for_input(e.value),style:{width:70},className:classNames("right_space price-input",{error:!a}),readOnly:!0}):this.is_whole_price_prepaid()?React.createElement("input",{type:"text",value:e.input_value,style:{width:70},className:"right_space price-input",disabled:!0}):React.createElement("input",{type:"text",value:e.input_value,style:{width:70},className:classNames("right_space price-input",{error:!a}),onChange:this.update_method_value(t)}),React.createElement("span",null,CurrencyUtils.react_with_symbol(n))},render_price_value:function(e){return React.createElement("span",{className:"right_space paid-price-non-editable"},NumberUtils.format_price(e.value))},render_payment_method_select:function(t){var n=this,a=n.state.payments[t].payment_method,r=PaymentMethods.get_active_tokens();return r.splice(r.indexOf("certificate_with_gift_card"),1),r.splice(r.indexOf("certificate_with_gift_card_spv"),1),r.splice(r.indexOf("registered_carnet"),1),PaymentMethods.has_active_method(a)||r.push(a),this.is_whole_price_prepaid()?React.createElement("span",null,React.createElement("select",{value:a,disabled:!0,className:"left_space right_space auto_width"},e.map(r,function(e){return React.createElement("option",{disabled:!0,key:e+ComponentHelpers.Keys.get_unique_key(),value:e},PaymentMethods.t(e))})),React.createElement("i",{className:"icon sprite-info_tip2 left_space",title:I18n.t("js.prepayments.event_already_paid"),"data-toggle":"tooltip"})):React.createElement("select",{value:a,onChange:this.switch_method(t),className:"left_space right_space auto_width"},e.map(r,function(e){return React.createElement("option",{disabled:n.is_option_disabled(e,a),key:e+ComponentHelpers.Keys.get_unique_key(),value:e},PaymentMethods.t(e))}))},render_payment_method_label:function(e){var t=this,n=t.state.payments[e],a=NumberUtils.format_price(this.props.prepayment_amount-this.props.price);return React.createElement("span",null,!this.props.already_finalized&&this.props.prepayment_amount>this.props.price&&this.props.price>=0&&React.createElement("span",{className:"right-space light-font"},I18n.t("js.payments.overpayment")," ",a," (",EventComponents.t("payments.overpayment_change_info"),")"),this.props.prepayment_amount<this.props.price&&React.createElement("span",{className:"right_space"},PaymentMethods.t(n.payment_method)),n.is_refund&&React.createElement("span",{className:"refund right_space"},"(",I18n.t("js.payments.refund"),")"),PaymentMethods.is_online_or_gift_coupon(n.payment_method)&&!n.is_online_payment_pending&&React.createElement("span",{className:"pending right_space"},"(",I18n.t("js.payments.paid"),")"),n.details_url&&!this.props.hide_details_url&&React.createElement("a",{className:"right_space details-link",target:"_blank",href:n.details_url},I18n.t("js.payments.details")))},render_method_link:function(e){var t=this.state.payments[e],n=0===this.props.customers.length;return this.is_whole_price_prepaid()?"":!this.is_finalized_overpayment_balance(t)&&!t.predefined&&!t.uneditable||n?React.createElement("a",{href:"#",onClick:this.delete_method(e)},React.createElement("i",{className:"icon sprite-delete"})):void 0},render_gift_card_number:function(e){var t=this,n=this.state.payments[e];if(VersumConfig.gift_cards_activated&&"certificate"===n.payment_method&&(this.props.use_gift_cards||this.props.use_packages))return React.createElement(GiftCards.Components.PaymentGiftCardNumber,{payment:n,use_gift_cards:this.props.use_gift_cards,use_packages:this.props.use_packages,on_payment_change:function(){t.on_change()},customers:this.props.customers||[],package_type:this.props.package_type_certificate,package_type_certificate:this.props.package_type_certificate,package_type_carnet:this.props.package_type_carnet})},render_gift_card:function(e){var t=this.state.payments[e];if(this.props.use_gift_cards&&"certificate"===t.payment_method&&t.gift_card)return React.createElement(GiftCards.Components.PaymentGiftCard,{gift_card:t.gift_card})},render_gift_coupon_number:function(e){var t=this.state.payments[e];if(PaymentMethods.is_gift_coupon(t.payment_method)&&(!t.gift_coupon||t.gift_coupon&&!t.gift_coupon.usage_id))return React.createElement(PaymentComponents.PaymentGiftCouponNumber,{payment:t,on_payment_change:this.on_change,customers:this.props.customers||[]})},render_gift_coupon:function(e){var t=this.state.payments[e];if(PaymentMethods.is_gift_coupon(t.payment_method)&&t.gift_coupon)return React.createElement(PaymentComponents.PaymentGiftCoupon,{gift_coupon:t.gift_coupon})},render_package:function(t){var n=this,a=this.state.payments[t];if(this.props.use_packages&&"certificate"===a.payment_method&&a.package_item){var r=e.grep(this.state.payments,function(e,n){return n!==t});return React.createElement(Packages.Components.PaymentPackage,{other_payments:r,services:this.props.services,payment:a,package_item:a.package_item,edit_mode:this.props.event_edition_enabled,on_change:function(){n.on_change()},package_type_certificate:this.props.package_type_certificate,package_type_carnet:this.props.package_type_carnet})}},render_carnet_number:function(e){var t=this,n=this.state.payments[e];if(VersumConfig.gift_cards_activated&&"carnet"===n.payment_method&&(this.props.use_gift_cards||this.props.use_packages))return React.createElement(GiftCards.Components.PaymentGiftCardNumber,{payment:n,use_gift_cards:!1,use_packages:this.props.use_packages,on_payment_change:function(){t.on_change()},customers:this.props.customers||[],package_type:this.props.package_type_carnet,package_type_certificate:this.props.package_type_certificate,package_type_carnet:this.props.package_type_carnet})},render_carnet:function(t){var n=this,a=this.state.payments[t];if(this.props.use_packages&&"carnet"===a.payment_method&&a.package_item){var r=e.grep(this.state.payments,function(e,n){return n!==t});return React.createElement(Packages.Components.PaymentPackage,{other_payments:r,services:this.props.services,payment:a,package_item:a.package_item,edit_mode:this.props.event_edition_enabled,on_change:function(){n.on_change()},package_type_certificate:this.props.package_type_certificate,package_type_carnet:this.props.package_type_carnet})}},render_add_button:function(e){if(this.state.payments.length-1===e)return React.createElement("div",{className:"add-button"},React.createElement("a",{href:"#",onClick:this.add_method},I18n.t("js.payments.add_payment")))},render_disabled_add_button:function(e,t){if(this.state.payments.length-1===e)return React.createElement("div",{className:"add-button light-font"},React.createElement("span",{title:t,"data-toggle":"tooltip"},I18n.t("js.payments.add_payment")))},getInitialState:function(){var e=this;this.available_balance=this.get_available_balance();var t=this.transform_payments(this.props.initial_payments,this.props.price);return this.props.event_edition_enabled&&this.is_whole_price_prepaid()&&t.push(this.build_initial_payment(0)),document.removeEventListener("payment_methods_changed",e.rerender_component),document.addEventListener("payment_methods_changed",e.rerender_component),{payments:t}},rerender_component:function(){this.isMounted()&&this.forceUpdate()},get_available_balance:function(e){if(e=e||this.props,null!=e.prepayment_amount)return e.prepayment_amount;for(var t=0,n=0;n<e.initial_payments.length;n++){var a=e.initial_payments[n];"balance"===a.payment_method&&(t+=NumberUtils.parse_price(a.price),!0)}return t},componentWillReceiveProps:function(e){this.remove_stale_payments(e.services,e.price),this.fix_payment_prices();var t=e.price-this.props.price,n=this.props.prepayment_amount!=e.prepayment_amount;if(0!==t||n){this.fix_balance_payment(e);var a,r=this.get_total_payment();t>0?(a=Math.max(r,e.price),this.balance_methods(a,r)):t<0&&r===this.props.price?(a=e.price,this.balance_methods(a,r)):n&&(a=e.price,this.balance_methods(a,r))}},componentWillMount:function(){this.before_mount_or_update()},componentWillUpdate:function(){this.before_mount_or_update()},remove_stale_payments:function(t,n){var a=e.grep(this.state.payments,function(n){return!n.predefined||!n.package_service||-1!==e.inArray(n.package_service,t)});a.length<=0&&(a=[this.build_initial_payment(n)]),this.state.payments=a},fix_payment_prices:function(){e.each(this.state.payments,function(t,n){if(n.package_services){var a=0;e.each(n.package_services,function(e,t){a+=t.price_after_discount()}),n.value=a,n.input_value=NumberUtils.format_price_for_input(a)}})},fix_balance_payment:function(e){for(var t=e.price,n=null,a=0;a<this.state.payments.length;a++){var r=this.state.payments[a];if("balance"===r.payment_method){n=r;break}}if(n&&(n.value=Math.min(this.get_available_balance(e),t),n.value===t))for(var a=0;a<this.state.payments.length;a++){var r=this.state.payments[a];"balance"!==r.payment_method&&(r.value=0,r.input_value=0)}},build_initial_payment:function(e){return{payment_method:this.get_initial_payment_token(),value:e,predefined:!1,input_value:NumberUtils.format_price_for_input(e)}},get_initial_payment_token:function(){var e=PaymentMethods.get_active_tokens();return Array.isArray(e)&&e[0]?e[0]:"cash"},before_mount_or_update:function(){for(var e=this.state.payments,t={},n=0;n<e.length;n++){var a=e[n].payment_method;"certificate"!==a&&"carnet"!==a&&(t[e[n].payment_method]=!0),PaymentMethods.is_online(a)&&(t.online_blik=!0,t.online_link=!0)}this.state.disabled_methods=t},get_state_payments:function(){return this.state.payments},get_payments:function(){return(this.state.payments||[]).map(function(e){return PaymentMethods.is_online(e.payment_method)?Object.assign({},e,{payment_method:e.payment_method.replace("_blik","").replace("_link","")}):e})},get_first_available_method:function(){for(var e=PaymentMethods.get_active_tokens(),t=0;t<e.length;t++)if(!this.state.disabled_methods.hasOwnProperty(e[t]))return e[t];return null},get_total_payment:function(){for(var e=this.state.payments,t=0,n=0;n<e.length;n++)t+=e[n].value;return NumberUtils.round_price(t)},get_change:function(){return NumberUtils.round_price(this.get_total_payment()-this.props.price)},change_classes:function(e,t){var n={change:"true","change-error":e<0,"change-active":e>0};return n[t]=!0,classNames(n)},balance_methods:function(e,t,n){var a,r,s=this.state.payments,i=null;if(e>t){for(r=0;r<s.length;r++)if(r!==n&&!s[r].package_services&&!s[r].predefined&&!s[r].uneditable){i=s[r];break}if(i)a=NumberUtils.round_price(i.value+e-t),this.set_method_values(i,a);else{var o=this.get_first_available_method();if(o){var c={payment_method:o};this.set_method_values(c,e-t),this.state.payments.push(c)}}}else if(e<t){for(r=0;r<s.length;r++)if(r!==n&&!s[r].package_services&&(s[r].value>0||e<0)&&!s[r].predefined&&!s[r].uneditable){i=s[r];break}if(i){var _=i.value;a=NumberUtils.round_price(_+e-t),a<0&&e>=0?(this.set_method_values(i,0),this.balance_methods(e,t-_,n)):this.set_method_values(i,a)}}},add_method:function(e){e.preventDefault();var t=this.get_first_available_method();if(t){var n=this.get_total_payment(),a=this.props.price,r=a>n?NumberUtils.round_price(a-n):0,s={payment_method:t,predefined:!1};this.set_method_values(s,r),this.state.payments.push(s),this.on_change()}},is_balance_method_in_payments:function(){return this.state.payments.some(function(e){return"balance"===e.payment_method})},delete_method:function(e){var t=this,n=this.props.hide_balance&&t.is_balance_method_in_payments()?2:1,a=this.props.hide_balance&&t.is_balance_method_in_payments()?1:0;return function(r){if(r&&r.preventDefault(),t.state.payments.length>n)t.state.payments.splice(e,1);else{var s=t.state.payments[a];t.reset_payment(s)}t.on_change()}},reset_payment:function(e){e&&(e.payment_method="cash",delete e.gift_card,delete e.package_item,delete e.package_services,delete e.uneditable,delete e.prepayment_transaction_id,delete e.is_online_payment_pending,delete e.gift_coupon)},switch_method:function(e){var t=this;return function(n){n.preventDefault();var a=t.state.payments[e];if(a.payment_method=n.target.value,"certificate"!==a.payment_method&&(delete a.gift_card,delete a.package_item,delete a.package_services),"online_gift_coupon"!==a.payment_method&&delete a.gift_coupon,PaymentMethods.is_online(a.payment_method)||(a.is_online_payment_pending=!1),"overpayment_balance"===a.payment_method&&t.props.overpayment_balance>0){var r=Math.min(t.props.overpayment_balance,a.value);a.value=r,a.input_value=NumberUtils.format_price_for_input(r)}t.on_change()}},set_method_values:function(e,n,a){a===t&&(a=NumberUtils.format_price_for_input(n)),this.is_finalized_overpayment_balance(e)||(e.value=n,e.input_value=a)},update_method_value:function(e){var t=this;return function(n){n.preventDefault();var a=NumberUtils.parse_price(n.target.value),r=t.state.payments[e],s=t.state.payments.filter(function(e){return!e.predefined});if(!s.length||s[0]===r||s[0].edited_manually||s[0].package_services)t.set_method_values(r,a,n.target.value);else{t.set_method_values(r,a,n.target.value);var i=t.get_total_payment();t.balance_methods(t.props.price,i,e)}r.edited_manually=!0,t.on_change()}},is_option_disabled:function(e,t){return!PaymentMethods.is_gift_coupon(e)&&((!this.props.show_overpayment||this.props.already_finalized)&&"overpayment_balance"===e||this.state.disabled_methods.hasOwnProperty(e)&&(PaymentMethods.is_online(e)?!("online_blik"===t&&"online_link"===e||"online_link"===t&&"online_blik"===e):t!==e))},is_whole_price_prepaid:function(){return this.props.prepayment_amount&&this.props.prepayment_amount>=this.props.price},transform_payments:function(e,t){for(var n=[],a=0,r=!0,s=null,i=0;i<e.length;i++){var o=e[i],c=NumberUtils.parse_price(o.price),_=NumberUtils.parse_price(PaymentMethods.is_gift_coupon(o.payment_method)&&o.gift_coupon&&"paid"===o.gift_coupon.status?o.price:o.price_paid),p="balance"===o.payment_method,l=PaymentMethods.is_online(o.payment_method)&&c!==_||PaymentMethods.is_gift_coupon(o.payment_method)&&o.gift_coupon&&"pending"===o.gift_coupon.status,u=PaymentMethods.is_online(o.payment_method)&&o.is_refund||PaymentMethods.is_gift_coupon(o.payment_method)&&o.gift_coupon&&"refunded"===o.gift_coupon.status;if(a+=c,PaymentMethods.is_online_or_gift_coupon(o.payment_method)&&o.online_payment_type&&(o.payment_method=o.online_payment_type),o.predefined&&o.uneditable||(r=!1),p&&s)s.value+=c;else{var d={payment_method:o.payment_method,value:c,paid:_,input_value:NumberUtils.format_price_for_input(c),gift_card:o.gift_card,gift_coupon:o.gift_coupon,package_item:o.package_item,package_services:o.package_services,predefined:o.predefined,
details_url:o.details_url,is_refund:u,is_pending:o.is_pending,is_online_payment_pending:l,uneditable:p||PaymentMethods.is_online_or_gift_coupon(o.payment_method)&&_>0,prepayment_transaction_id:o.prepayment_transaction_id,online_payment_ids:o.online_payment_ids};p&&(s=d),n.push(d)}}if(this.available_balance>0&&!s){var m=Math.min(this.available_balance,this.props.price);a+=m,s={payment_method:"balance",value:m,predefined:!1,uneditable:!0},n.push(s)}return r&&t!==a&&n.push(this.build_initial_payment(t-a)),n.sort(function(e,t){return"balance"===e.payment_method&&"balance"!==t.payment_method?-1:"balance"!==e.payment_method&&"balance"===t.payment_method?1:0}),n},on_change:function(){this.validate_payments(),this.props.on_change?this.props.on_change({payments:this.state.payments}):this.forceUpdate()},render_overpayment_balance:function(e){var t=this.state.payments[e],n=t&&"overpayment_balance"===t.payment_method;return this.props.show_overpayment&&n?React.createElement(EventComponents.CustomerOverpayment,{className:"ml-s",amount:this.props.overpayment_balance,extended:!0}):null}}}(jQuery),PaymentComponents.PaymentGiftCoupon=function(e,t){return React.createClass({render:function(){return React.createElement("div",{className:"gift-cards-box",style:{marginTop:10}},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-xs-5"},React.createElement("span",{className:"icon_box mr-xs"},React.createElement("span",{className:"icon sprite-gift_cards_gift_cards"})),React.createElement("span",{className:"bigger"},I18n.t("js.payments.gift_coupons.name"))),React.createElement("div",{className:"col-xs-4"},React.createElement("span",{className:"light_text2 mr-xs"},I18n.t("js.payments.gift_coupons.number"),":"),React.createElement("span",{className:"bigger"},"******-***",this.props.gift_coupon.last_characters)),this.props.gift_coupon.left_value===t||this.props.gift_coupon.usage_id?null:React.createElement("div",{className:"col-xs-3"},React.createElement("span",{className:"light_text2 mr-xs"},I18n.t("js.payments.gift_coupons.balance"),":"),React.createElement("span",{className:"bigger"},NumberUtils.format_price(this.props.gift_coupon.left_value)))))}})}(jQuery),PaymentComponents.PaymentGiftCouponNumber=function(){return React.createClass({render:function(){var e="";return this.props.payment.gift_coupon&&(e=this.props.payment.gift_coupon.number),React.createElement("span",{className:"left_space right_space"},React.createElement("span",{className:"light_text2"},I18n.t("js.payments.gift_coupons.number"),":")," ",React.createElement("input",{type:"text",style:{width:130},ref:"gift_coupon_number_input",className:"v_middle",defaultValue:e})," ",this.render_picker_button())},render_picker_button:function(){if(this.props.customers&&this.props.customers.length>0)return React.createElement("button",{type:"button",className:"btn left_space v_middle",onClick:this.fetch_gift_coupon},I18n.t("js.payments.gift_coupons.apply"))},componentDidUpdate:function(){if(this.refs.gift_coupon_number_input){var e="";this.props.payment.gift_coupon&&(e=this.props.payment.gift_coupon.number),ReactDOM.findDOMNode(this.refs.gift_coupon_number_input).value=e}},fetch_gift_coupon:function(){var e=this;window.reactLegacyBridge.giftCoupons.fetchGiftCoupon&&window.reactLegacyBridge.giftCoupons.fetchGiftCoupon(ReactDOM.findDOMNode(this.refs.gift_coupon_number_input).value).then(function(t){t&&"active"===t.state?e.set_gift_coupon(t):e.run_modal_for_gift_coupon_fetch_error(I18n.t("js.payments.gift_coupons.error."+(t?t.state:"not_found")))})},set_gift_coupon:function(e){this.props.payment.gift_coupon=e,this.props.on_payment_change()},run_modal_for_gift_coupon_fetch_error:function(e){var t=this;BootstrapDialog.show({title:I18n.t("js.dialog.notice"),message:e,buttons:[{cssClass:"btn-primary",label:I18n.t("js.dialog.close"),action:function(e){t.props.on_payment_change(),e.close()}}]})}})}(jQuery),window.Refunds=window.Refunds||{show_refund_method_modal:function(e){var t=this,n=_.get(window,"reactLegacyBridge.modals.RefundMethodModal.renderModal",function(){});e.onMethodSelect=function(n){t.refund_payment(e,n)},n(e)},refund_payment:function(e,t){_.get(window,"reactLegacyBridge.prepayments.refundPayment",function(){})({refundSubject:e.refundSubject,chargeBack:{id:e.id,chargeBackMethod:t},prepaymentPaymentMethod:e.paymentMethod,prepaymentPaidOnlineVia:e.paymentPaidOnlineVia}).then(function(n){e.onRefund&&e.onRefund({isRefunded:n,method:t})})}},EventComponents.AlldayTimeControls=function(e){return React.createClass({render:function(){return this.props.edit_mode?React.createElement("span",{className:"e2e-edit-all-day-controls"},React.createElement("span",{className:"time-controls-line"},this.render_beginning_date_input())," - ",React.createElement("span",{className:"time-controls-line"},this.render_end_date_input())," ",React.createElement("span",{className:"time-controls-line"},this.render_duration())):this.get_beginning().isSame(this.get_end())?React.createElement("span",{className:"time-controls-info e2e-single-all-day-controls"},React.createElement("span",{className:"date-font"},this.format_beginning_date())," ",this.render_duration()):React.createElement("span",{className:"time-controls-info e2e-multi-all-day-controls"},React.createElement("span",{className:"date-font"},this.format_beginning_date()," - ",this.format_end_date())," ",this.render_duration())},getInitialState:function(){return{beginning_date_input_value:this.format_beginning_for_input(),end_date_input_value:this.format_end_for_input()}},componentDidMount:function(){this.init_inputs()},componentDidUpdate:function(){this.init_inputs()},init_inputs:function(){if(this.props.edit_mode){var e=this;this.get_beginning_date_input().data("datepicker-attached")||(this.get_beginning_date_input().data("datepicker-attached",!0),this.get_beginning_date_input().datepicker({inline:!1,showOtherMonths:!0,selectOtherMonths:!0,dateFormat:DateUtils.get_date_format("default_datepicker"),onSelect:function(){e.update_beginning()}})),this.get_end_date_input().data("datepicker-attached")||(this.get_end_date_input().data("datepicker-attached",!0),this.get_end_date_input().datepicker({inline:!1,showOtherMonths:!0,selectOtherMonths:!0,dateFormat:DateUtils.get_date_format("default_datepicker"),onSelect:function(){e.update_end()}}))}},render_beginning_date_input:function(){var e=this;return React.createElement("input",{type:"text",className:"date-input pointer e2e-all-day-start-input",ref:"beginning_date",onChange:function(t){e.setState({beginning_date_input_value:t.target.value})},value:this.state.beginning_date_input_value,onBlur:this.update_beginning})},render_end_date_input:function(){var e=this;return React.createElement("input",{type:"text",className:"date-input pointer e2e-all-day-end-input",ref:"end_date",onChange:function(t){e.setState({end_date_input_value:t.target.value})},value:this.state.end_date_input_value,onBlur:this.update_end})},render_duration:function(){var e=this.props.event.allday_end.diff(this.props.event.allday_beginning);return React.createElement("span",{className:"e2e-all-day-duration"},"(",Math.round(moment.duration(e).asDays())," ",EventComponents.t("days"),")")},on_event_change:function(){this.state.beginning_date_input_value=this.format_beginning_for_input(),this.state.end_date_input_value=this.format_end_for_input(),this.props.on_event_change()},update_beginning:function(){if(this.inputs_mounted()){var e=moment(this.get_beginning_date_input().val(),DateUtils.get_date_format());if(e.isValid()&&!e.isSame(this.props.event.allday_beginning)){var t=e.diff(this.props.event.allday_beginning,"minutes");this.props.event.allday_beginning=e,this.props.event.allday_end=moment(this.props.event.allday_end).add(t,"minutes")}this.on_event_change()}},update_end:function(){if(this.inputs_mounted()){var e=moment(this.get_end_date_input().val(),DateUtils.get_date_format()).add(1,"day");e.isValid()&&(e.isAfter(this.props.event.allday_beginning)||(e=moment(this.props.event.allday_beginning).add(1,"days")),this.props.event.allday_end=e),this.on_event_change()}},inputs_mounted:function(){return!!this.refs.beginning_date},format_beginning_for_input:function(){return DateUtils.format_date(this.get_beginning())},format_end_for_input:function(){return DateUtils.format_date(this.get_end())},format_beginning_date:function(){return DateUtils.format_date(this.get_beginning(),"with_weekday_name")},format_end_date:function(){return DateUtils.format_date(this.get_end(),"with_weekday_name")},get_beginning:function(){return this.props.event.allday_beginning},get_end:function(){return moment(this.props.event.allday_end).subtract(1,"day")},get_beginning_date_input:function(){return e(ReactDOM.findDOMNode(this.refs.beginning_date))},get_end_date_input:function(){return e(ReactDOM.findDOMNode(this.refs.end_date))}})}(jQuery),EventComponents.AllocationErrorResolver=function(e){return React.createClass({render:function(){return React.createElement("div",{className:"allocation-error-resolver"},React.createElement("p",null,EventComponents.t("allocation_error_resolver.message")),React.createElement("div",{className:"data_table"},React.createElement("table",{className:"allocations-table"},React.createElement("tbody",null,React.createElement("tr",null,React.createElement("th",null,EventComponents.t("allocation_error_resolver.service")),React.createElement("th",null,EventComponents.t("allocation_error_resolver.conflict"))),e.map(this.props.allocations,function(e,t){var n=e.error_message.join("<br>");return React.createElement("tr",{key:t},React.createElement("td",{className:"wrap"},e.service_info),React.createElement("td",{className:"wrap",dangerouslySetInnerHTML:{__html:n}}))})))))}})}(jQuery),EventComponents.CustomerOverpayment=function(){return React.createClass({render:function(){var e=this.props.amount,t=this.props.extended;return e?t&&React.createElement("span",{className:this.props.className||"overpayment_extended"},React.createElement("span",{className:"overpayment"},React.createElement("span",{className:"overpayment__icon"},React.createElement(Icons.Svg,{name:"overpayment"})),React.createElement("span",{className:"overpayment__info"},React.createElement("span",null,React.createElement("span",{className:"light-text"},I18n.t("js.prepayments.overpayment")+": "),React.createElement("strong",null,NumberUtils.format_price(e))))))||React.createElement("span",{className:this.props.className||"overpayment_simple","data-toggle":"tooltip",title:I18n.t("js.prepayments.overpayment")+": "+NumberUtils.format_price(e)},React.createElement(Icons.Svg,{name:"overpayment"})):null}})}(),EventComponents.DefaultEventResources=function(e){return React.createClass({render:function(){return React.createElement("span",{className:"text-nowrap"},React.createElement("span",{className:"mr-s"},this.render_employee()),this.render_resource())},render_employee:function(){var e=this.props.event.employee,t="employee-tag pointer";return e?(t+=" "+e.calendar_class_name,React.createElement("span",{title:EventComponents.t("default_event_resources.employee")+": "+e.name,"data-toggle":"tooltip","data-desktop-tooltip":!0,"data-container":".event-box",className:t,onClick:this.show_modal},e.initials)):(t+=" no-entity",React.createElement("span",{title:EventComponents.t("default_event_resources.no_employee"),"data-toggle":"tooltip","data-desktop-tooltip":!0,"data-container":".event-box",className:t,onClick:this.show_modal},React.createElement("span",{className:"icon sprite-calendar_employees"})))},render_resource:function(){if(VersumConfig.resources_activated){var e=this.props.event.default_resource;return e?React.createElement("span",{title:EventComponents.t("default_event_resources.resource")+": "+e.name,"data-toggle":"tooltip","data-desktop-tooltip":!0,"data-container":".event-box",onClick:this.show_modal,className:"resource-tag pointer"},React.createElement("span",{className:"icon sprite-calendar_resources"}),React.createElement("span",{className:"resources-length"},"1")):React.createElement("span",{title:EventComponents.t("default_event_resources.no_resource"),"data-toggle":"tooltip","data-desktop-tooltip":!0,"data-container":".event-box",onClick:this.show_modal,className:"resource-tag pointer no-entity"},React.createElement("span",{className:"icon sprite-calendar_resources"}))}},componentDidMount:function(){e('[data-toggle="tooltip"]').tooltip()},componentDidUpdate:function(){e('[data-toggle="tooltip"]').tooltip("fixTitle")},show_modal:function(){var e=this;CalendarModels.create_default_event_resources_modal(this.props.event,{employees_with_calendar:this.props.employees_with_calendar,resources:this.props.resources,event_edition_enabled:this.props.event_edition_enabled,on_set_edit_mode:this.props.set_edit_mode}).run().always(function(){e.props.on_event_change()})}})}(jQuery),EventComponents.DefaultEventResourcesModal=function(e){return React.createClass({render:function(){return React.createElement("div",null,React.createElement("div",{className:"employee"},React.createElement("div",{className:"resource-label"},React.createElement("span",{className:"icon sprite-calendar_employees"})," ",React.createElement("span",{className:"semibold"},EventComponents.t("default_event_resources_modal.employee"))),React.createElement("div",{className:"resource-entity"},this.render_employee_content())),this.render_default_resource())},render_employee_content:function(){return this.state.event_edition_enabled?React.createElement("select",{value:this.get_employee().id,ref:"employee_select",className:"resource-select"},ComponentHelpers.Employees.get_employee_options(this.props.employees_with_calendar,{current_employee:this.get_employee(),include_empty_option:!0})):this.get_employee().name},render_default_resource:function(){if(VersumConfig.resources_activated)return React.createElement("div",{className:"resources"},React.createElement("div",{className:"resource-label"},React.createElement("span",{className:"icon sprite-calendar_resources"})," ",React.createElement("span",{className:"semibold"},EventComponents.t("default_event_resources_modal.resource"))),React.createElement("div",{className:"resource-entity"},this.render_resource_content()))},render_resource_content:function(){return this.state.event_edition_enabled?React.createElement("select",{value:this.get_resource().id,ref:"resource_select",className:"resource-select"},React.createElement("option",null),e.map(this.props.resources,function(e){return React.createElement("option",{key:e.id,value:e.id,"data-entity":JSON.stringify(e)},e.name)})):this.get_resource().name},getInitialState:function(){return{event_edition_enabled:this.props.event_edition_enabled}},componentDidMount:function(){this.init_selects()},componentDidUpdate:function(){this.init_selects()},set_edit_mode:function(){this.setState({event_edition_enabled:!0})},get_employee:function(){return this.props.event.employee||{name:EventComponents.t("default_event_resources.no_employee")}},get_resource:function(){return VersumConfig.resources_activated?this.props.event.default_resource||this.props.event.services[0]&&this.props.event.services[0].resources[0]||{name:EventComponents.t("default_event_resources.no_resource")}:{}},init_selects:function(){this.init_select("employee","employee_select",this.props.employees_with_calendar),this.init_select("default_resource","resource_select",this.props.resources)},init_select:function(t,n){var a=this,r=this.refs[n];if(r){var s=e(ReactDOM.findDOMNode(r)),i=!!this.get_employee().id&&!!this.get_resource().id;s.off("change").select2("destroy").versum_select2({allowClear:i}).on("change",function(){var n=s.select2("data");a.props.event[t]=n?e(n.element).data("entity"):null,a.forceUpdate()})}}})}(jQuery),EventComponents.EventBox=function(e,t){return React.createClass({render:function(){return React.createElement("form",{className:this.get_box_class()},React.createElement("div",{className:"box-line box-header"},React.createElement("div",{className:"box-line-label"},EventComponents.t("event_box.event"),":"),this.render_header_content()),this.render_body())},render_header_content:function(){return this.props.event.destroy?React.createElement("div",{className:"box-line-content"},React.createElement("span",{className:"right_space"},EventComponents.t("event_box.deleted")),React.createElement("a",{href:"#",onClick:this.revert_event,title:"przywr\xf3\u0107"},EventComponents.t("event_box.restore"))):React.createElement("div",{className:"box-line-content"},this.render_remove_event_link(),React.createElement("div",{className:"row no-margin"},React.createElement("div",{className:"col-sm-7 no-padding time-controls-container"},React.createElement(EventComponents.EventTimeControls,{ref:"time_controls",event:this.props.event,on_event_change:this.props.on_event_change,event_time_manager:this.state.event_time_manager,services_adjuster:this.state.move_services,service_adjusting_reverter:this.state.service_adjusting_reverter,event_edition_enabled:this.props.event_edition_enabled})),React.createElement("div",{className:"col-sm-5 no-padding cancel-controls"},this.render_cancel_controls())))},render_header_content:function(){return this.props.event.destroy?React.createElement("div",{className:"box-line-content"},React.createElement("span",{className:"right_space"},EventComponents.t("event_box.deleted")),React.createElement("a",{href:"#",onClick:this.revert_event,title:"przywr\xf3\u0107"},EventComponents.t("event_box.restore"))):React.createElement("div",{className:"box-line-content"},this.render_remove_event_link(),React.createElement("div",{className:"row no-margin"},React.createElement("div",{className:"col-sm-7 no-padding time-controls-container"},React.createElement(EventComponents.EventTimeControls,{ref:"time_controls",event:this.props.event,on_event_change:this.props.on_event_change,event_time_manager:this.state.event_time_manager,services_adjuster:this.state.move_services,service_adjusting_reverter:this.state.service_adjusting_reverter,event_edition_enabled:this.props.event_edition_enabled})),React.createElement("div",{className:"col-sm-5 no-padding cancel-controls"},this.render_cancel_controls())))},render_cancel_controls:function(){if(this.props.finalization){if(this.props.event_edition_enabled)return React.createElement("label",null,React.createElement("input",{type:"checkbox",checked:this.props.event.canceled,onChange:this.update_canceled})," ",EventComponents.t("event_box.canceled"));if(this.props.event.canceled)return React.createElement("span",{className:"event-status-canceled"},EventComponents.t("event_box.canceled"));if(this.props.event.deleted_at)return React.createElement("span",{className:"event-status-deleted"},EventComponents.t("event_box.deleted"))}else if("popup"===this.props.view_type)return React.createElement("a",{href:"#",onClick:this.props.on_screen_close,className:"x-close-link e2e-close-event"},React.createElement("span",{className:"icon sprite-close_X"}))},render_errors:function(){var t=this.props.error_messages;return t.event||t.order||t.supply_use||t.gift_cards||t.packages||t.prepayment?React.createElement("div",{className:"error-explanation"},React.createElement("h2",null,EventComponents.t("errors_occured"),":"),e.map(["event","order","supply_use","gift_cards","packages","prepayment"],function(n,a){return t[n]&&t[n].length>0?React.createElement("div",{key:a},React.createElement("p",null,EventComponents.t("errors."+n)),React.createElement("ul",null,e.map(t[n],function(e,t){return React.createElement("li",{key:t},e)}))):React.createElement("span",{key:a})})):React.createElement("span",null)},render_body:function(){return this.props.event.destroy?React.createElement("div",{"data-popup-element":"body"},this.render_errors()):this.props.event.canceled||this.props.event.deleted_at?React.createElement("div",{"data-popup-element":"body"},this.render_errors(),this.render_description_controls(),this.render_tag_controls(),this.render_deals_site_coupon_info(),this.render_customer(),this.render_services(!1),this.render_created_at_info(),this.render_customer_health_survey(),this.render_recurrence_controls_container(),this.render_undelete_link(),this.render_prepayment_info(),this.render_event_id()):this.props.finalization?React.createElement("div",{"data-popup-element":"body"},this.render_errors(),this.render_customer(),this.render_description_controls(),this.render_tag_controls(),this.render_deals_site_coupon_info(),this.render_services(!0),this.render_products_controls(),this.render_gift_cards_controls(),this.render_packages_controls(),this.render_carnets_controls(),this.render_order_employee(),this.render_created_at_info(),this.render_customer_health_survey(),this.render_finalized_at_info(),this.render_finalized_at_controls(),this.render_prepayment_controls_for_finalization(),this.render_prepayment_gift_card(),this.render_prepayment_gift_card_extra_payment_controls(),this.should_render_prepayment_confirmation_in_finalization()?this.render_prepayment_confirmation():null,this.render_event_id(),this.render_lumo()):this.props.event.not_an_appointment?React.createElement("div",{"data-popup-element":"body"},this.render_errors(),this.render_event_type_controls(),this.render_description_controls(),this.render_created_at_info(),this.render_event_id()):React.createElement("div",{"data-popup-element":"body"},this.render_errors(),this.render_event_type_controls(),this.render_recurrence_controls_container(),this.render_customer(),this.render_services(!0),this.render_services_time(),this.render_description_controls(),this.render_tag_controls(),this.render_prepayment_controls(),this.render_prepayment_gift_card(),this.render_prepayment_gift_card_extra_payment_controls(),this.render_prepayment_confirmation(),this.render_deals_site_coupon_info(),this.render_reminder_controls(),this.render_created_at_info(),this.render_customer_health_survey(),this.render_event_id())},render_event_type_controls:function(){if(this.props.event_edition_enabled&&(this.props.event.not_an_appointment||"overlay"===this.props.view_type))return React.createElement(EventComponents.EventType,{event:this.props.event,on_event_change:this.props.on_event_change})},render_recurrence_controls_container:function(){if(this.props.event.recurrence_manager&&"overlay"===this.props.view_type)return React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},I18n.t("js.event_recurrence.recurrence_type"),":"),React.createElement("div",{className:"box-line-content"},this.props.event_edition_enabled?React.createElement("div",{className:"d-flex ai-center",id:"event_recurrence_controls"}):React.createElement("span",{className:"d-flex ai-center"},this.props.event.recurrence_manager.toText())))},render_recurrence_controls:function(){this.props.event.recurrence_manager&&(this.props.event.recurrence_manager.renderControls(document.querySelector("#event_recurrence_controls")),this.props.event.recurrence_manager=Object.assign(this.props.event.recurrence_manager,{eventBoxUpdate:this.props.on_event_change,eventTimeManager:this.state.event_time_manager}))},render_event_id:function(){return"overlay"===this.props.view_type&&!this.props.event_edition_enabled&&React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("event_box.event_id"),":"),React.createElement("div",{className:"box-line-content"},this.props.event.pretty_id))||""},render_customer:function(){return React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("event_box.customer"),":"),React.createElement("div",{className:"box-line-content"},React.createElement(EventComponents.EventCustomer,{ref:"customer",event:this.props.event,on_prepayment_requirements_change:this.props.on_prepayment_requirements_change,on_event_change:this.props.on_event_change,event_edition_enabled:this.props.event_edition_enabled,finalization:this.props.finalization,on_arrived_tag_change:this.props.on_arrived_tag_change,customer_edition_enabled:this.props.customer_edition_enabled,gift_cards_counts_for_customers_store:this.props.gift_cards_counts_for_customers_store,on_prepayment_remove:this.remove_prepayment,overpayment_balance:this.props.overpayment_balance,show_overpayment:this.props.show_overpayment,on_overpayment_change:this.props.on_overpayment_change})))},render_services:function(e){return React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("event_box.services"),":"),React.createElement("div",{className:"box-line-content"},React.createElement(EventComponents.EventServices,{ref:"services",event:this.props.event,init_products:this.init_products,productss_shown:this.should_show_products(),init_gift_cards:this.init_gift_cards,gift_cards_shown:this.should_show_gift_cards(),init_packages:this.init_packages,packages_shown:this.should_show_packages(),init_carnets:this.init_carnets,carnets_shown:this.should_show_carnets(),on_event_change:this.props.on_event_change,on_services_change:this.on_services_change,before_service_addition:this.props.before_service_addition,after_service_addition:this.props.after_service_addition,formula_manager:this.props.formula_manager,event_edition_enabled:this.props.event_edition_enabled&&e,employees_with_calendar:this.props.employees_with_calendar,resources:this.props.resources,event_time_manager:this.state.event_time_manager,finalization:this.props.finalization,view_type:this.props.view_type,set_edit_mode:this.props.set_edit_mode,services_for_select_manager:this.props.services_for_select_manager,hide_actions:this.props.hide_actions})))},should_render_prepayment_confirmation_in_finalization:function(){return VersumConfig.prepayments_enabled&&!this.props.event.finalized&&!this.props.event.is_prepayment_paid()&&this.props.event_edition_enabled&&!PaymentMethods.is_online(this.props.event.prepayment.payment_method)},on_services_change:function(){var e=this.props.event.prepayment_amount_input(),t=this.props.event.services_prepayment_amount(),n=!(!this.props.event.id||!this.props.event.is_prepayment_paid());this.props.event.is_prepayment_confirmation_visible=e!==t&&0!==e&&""!==e&&!n,this.props.event.prepayment.required&&(0!==e&&""!==e||(this.props.event.prepayment.disabled=!(this.props.event.get_total_services_prepayment_amount()>0)),this.props.event.prepayment.disabled=!this.props.event.is_prepayment_paid()&&!(t>0)),t>0||(this.props.event.is_prepayment_confirmation_visible=!1),_.get(this,"props.event.services.length")||this.props.event.is_prepayment_paid()||this.props.event.prepayment.id||(this.props.event.prepayment.amount=0,this.remove_prepayment()),this.props.on_prepayment_requirements_change&&this.props.on_prepayment_requirements_change(!0),this.props.on_event_change()},render_services_time:function(){if(!this.props.event_edition_enabled&&"popup"===this.props.view_type){var e=this.props.event.get_duration_in_minutes(),t=this.props.event.get_total_services_duration(),n=e===t?EventComponents.t("event_box.services_time",{event_duration:e,default_duration:this.props.event.get_default_services_duration()}):EventComponents.t("event_box.full_services_time",{event_duration:e,services_duration:t,default_duration:this.props.event.get_default_services_duration()});return React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("event_box.time"),":"),React.createElement("div",{className:"box-line-content",dangerouslySetInnerHTML:{__html:n}}))}},render_reminder_controls:function(){if("overlay"===this.props.view_type||!this.props.event_edition_enabled)return React.createElement(EventComponents.EventReminder,{event:this.props.event,on_event_change:this.props.on_event_change,event_edition_enabled:this.props.event_edition_enabled})},render_prepayment_payment_method_options:function(e){function t(e){return e&&e.indexOf("certificate")>-1}function n(e){return e&&PaymentMethods.is_online(e)}var a=this.state.prepayment_methods,r=this.props.event;return(e||r.recurrence_manager)&&(a=a.filter(function(e){return!t(e)})),this.props.finalization&&(a=a.filter(function(e){return!n(e)&&!t(e)})),t(r.prepayment.payment_method)&&(a=a.filter(function(e){return"online_link"!==e})),a.map(function(e){return React.createElement("option",{key:e,value:e},I18n.t(e,{scope:"js.payment_methods"}))})},render_prepayment_gift_cards_modal:function(){var t=this,n=this.props.event.customer.id,a=this.props.event.customer_name.trim(),r=!!n||a&&""!==a,s=this.props.event.prepayment;if(!r)return void e.jGrowl(EventComponents.t("prepayment_giftcards.no_customer"),{life:5e3,theme:"flash_alert"});window.reactLegacyBridge.modals.PrepaymentGiftCardsModal.renderModal({customerName:this.props.event.customer.name||"",customerID:this.props.event.customer.id,serviceIDs:this.props.event.services.map(function(e){return e.id}),prepaymentAmount:this.props.event.prepayment.amount,servicesMaxVatValue:this.props.event.services.reduce(function(e,t){return t.vat_value>e?t.vat_value:e},0),onSave:function(e){t.props.event.prepayment.addGiftcardPayment(e),t.props.on_event_change()},onClose:function(){s.giftCard||(s.payment_method="cash",s.payment_status="queued",t.props.on_event_change())}})},render_prepayment_gift_card:function(){var e=this,t=e.props.event.prepayment,n=t.gift_card,a=(n||{value:0}).value||0,r=(n||{valueLeft:0}).valueLeft||0,s=t.amount||0,i=t.id?r:Math.max(a-s,0);t.payments[1];if(n&&this.props.event_edition_enabled)return React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"}),React.createElement("div",{className:"box-line-content"},React.createElement("div",{className:"vrsm-row prepayment_giftcard m-0 p-s"},React.createElement("div",{className:"vrsm-col-auto mt-0"},React.createElement("i",{className:"icon sprite-gift_cards_gift_cards mr-s",className:"icon sprite-gift_cards_gift_cards mr-s",title:n.number?EventComponents.t("prepayment_giftcards.number")+": "+n.number:"","data-toggle":"tooltip"}),React.createElement("span",{className:"mr-xl"},n.name),a&&React.createElement("span",{className:"text-muted"},EventComponents.t("prepayment_giftcards.value")+": ",NumberUtils.format_price(a))||""),React.createElement("div",{className:"vrsm-col mt-0"},React.createElement("span",null,React.createElement("strong",null,EventComponents.t("prepayment_giftcards.balance")+":"),React.createElement("b",{className:"ml-s"},NumberUtils.format_price(i))),!e.props.finalization&&!t.isPaid()&&"refund_pending"!==t.status&&React.createElement("a",{href:"#",className:"icon sprite-delete pull-right",onClick:function(){t.removeGiftcardPayment(),e.props.on_event_change()}})||""))))},render_prepayment_gift_card_extra_payment_controls:function(){function e(){return"creator_type_online_customer"===n.creator_type||"online_online_booking"===n.payment_type?"online_booking":a&&n.isOnline(a)?n.payment_type:(a||{}).paymentMethod||"placeholder"}var t=this.props.on_event_change,n=this.props.event.prepayment,a=n.payments[1],r=n.gift_card;return!this.props.finalization&&a&&r?this.props.event_edition_enabled&&React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},"Dop\u0142ata: "),React.createElement("div",{className:"box-line-content"},React.createElement("div",null,React.createElement("div",{className:"d-flex ai-center flex-wrap"},React.createElement("input",{type:"text",value:NumberUtils.format_price(a.amount)+" ",size:"8",className:"e2e-prepayment-extra-amount-input",disabled:!0,readOnly:!0}),React.createElement("span",{className:"ml-s"}," "+CurrencyUtils.get_current_symbol()),React.createElement("select",{value:e(),className:"prepayment-extra-payment-method-select mx-s",onChange:function(e){a.paymentMethod=e.target.value,n.isOnline(a)&&(n.payment_type=e.target.value,n.status="queued",a.status="queued"),t()},disabled:n.isPaid()||"refund_pending"===n.status},React.createElement("option",{value:"placeholder",hidden:!0},I18n.t("payment_method",{scope:"js.calendar.popup"})),React.createElement("option",{value:"online_booking",hidden:!0},I18n.t("js.payment_methods.online_online_booking")),this.render_prepayment_payment_method_options(1)),React.createElement("label",{className:"m-0 mr-m no-select text-nowrap"},React.createElement("input",{type:"checkbox",className:"v2-form-check mr-s e2e-prepayment-status-checkbox",checked:"paid"===a.status,disabled:n.isPaid()&&!n.status_was_changed||"refund_pending"===n.status,onChange:function(){n.isOnline(a)||(n.all_statuses=a.status="paid"===a.status?"queued":"paid",t())}}),React.createElement("span",null,this.get_prepayment_status_name("paid")))))))||"":""},
on_prepayment_change:function(t,n){var a=this.props.event;delete this.props.event.prepayment.id;var r=n.target.value;if(t="prepayment_"+t,-1!==["certificate_with_gift_card","certificate_with_gift_card_spv","certificate"].indexOf(r)){if(!a.customer.id)return void e.jGrowl(EventComponents.t("prepayment_giftcards.no_customer_id"),{life:9e3,theme:"flash_alert"});this.render_prepayment_gift_cards_modal()}if("prepayment_payment_method"===t&&(this.props.event.prepayment.payment_method_selected=r,this.props.event.prepayment.payment_method=r,PaymentMethods.is_online(r)&&(this.props.event.prepayment.status="queued",this.props.event.prepayment.payment_type=r)),this.props.event.prepayment.changed=!0,"prepayment_amount"===t){var s=n.target.value.replace(/,/g,".");if(r&&""!==r&&!isNaN(s)&&" "!==s&&(this.props.event.prepayment.amount=r),r&&""!==r||(this.props.event.prepayment.amount=""),this.props.finalization&&(this.props.event.should_update_event=!0,"paid"===this.props.event.prepayment.status)){var i=this.props.event.prepayment.amount_input_value;this.props.event.prepayment.amount_paid=i,this.props.on_prepayment_finalization_change()}}else this.props.event[t]=r;this.throttled_event_change()},throttled_event_change:function(){_.throttle(this.props.on_event_change,500)()},get_prepayment_select_class_names:function(){return classNames({"prepayment-payment-method-select mx-s e2e-prepayment-method-select":!0,prepayment_invalid:!this.props.event.is_prepayment_method_valid()&&this.props.show_prepayment_validation})},get_prepayment_input_class_names:function(){return classNames({"e2e-prepayment-amount-input":!0,prepayment_invalid:!this.props.event.is_prepayment_amount_valid()&&this.props.show_prepayment_validation,prepayment_warning:this.props.event.is_prepayment_confirmation_visible})},get_prepayment_status_name:function(e){return I18n.t("js.prepayments.status."+e)},get_prepayment_method_default_select_value:function(){var e=this.props.event.prepayment;return(PaymentMethods.is_online(e.payment_method)?e.payment_type:e.payment_method)||"placeholder"},set_prepayment_as_refunded:function(){this.props.event.prepayment.status="refund_pending",this.props.on_event_change()},remove_prepayment:function(){return this.props.event.prepayment.clear(),this.props.event.is_prepayment_confirmation_visible=!1,this.props.finalization&&(this.props.event.should_update_event=!0),this.props.on_event_change(),!1},render_add_prepayment_button:function(){return React.createElement("div",{style:{marginTop:6}},I18n.t("js.prepayments.no_prepayment"),!this.props.event.is_unpaid_moment_reservation()&&this.props.event.is_add_prepayment_enabled()&&React.createElement("a",{className:"ml-m e2e-add-prepayment",href:"javascript:void(0)",onClick:this.add_prepayment},"+ "+I18n.t("js.prepayments.add_prepayment"))||React.createElement("span",{className:"ml-m text-muted",title:this.props.event.is_unpaid_moment_reservation()?EventComponents.t("unpaid_moment_reservation_explanation"):EventComponents.t("no_customer_prepayment_explanation"),"data-toggle":"tooltip"},"+ "+I18n.t("js.prepayments.add_prepayment")))},add_prepayment:function(){this.props.event.is_unpaid_moment_reservation()||(this.props.event.prepayment.disabled=!1,this.props.event.prepayment.changed=!0,this.props.event.prepayment.charged_back=!1,this.props.event.prepayment.amount=this.props.event.get_prepayment_amount(),this.props.event.is_prepayment_confirmation_visible=!1,this.props.finalization&&(this.props.event.should_update_event=!0),this.props.event.refresh_prepayment_amount(),this.props.on_event_change(),this.props.on_prepayment_requirements_change&&this.props.on_prepayment_requirements_change(!0))},get_prepayments_status_classname:function(e){return classNames({"v2-label mx-s e2e-prepayment-status":!0,"v2-label-success":"paid"===e,"v2-label-warning":-1!==["queued","refund_pending"].indexOf(e),"v2-label-error":-1!==["unpaid","refund_failed"].indexOf(e)})},render_prepayment_status_label:function(){return React.createElement("span",{className:this.get_prepayments_status_classname(this.props.event.prepayment.status),"data-toggle":"tooltip",title:this.props.event.prepayment.cancel_event_after_hours?this.show_prepayment_remaining_time():this.show_prepayment_paid_date()},this.get_prepayment_status_name(this.props.event.prepayment.status))},can_prepayment_refund_be_shown:function(){return VersumConfig.prepayments_enabled&&this.props.event_edition_enabled&&!this.props.event.finalized&&this.props.event.is_refund_possible()},refund_prepayment:function(){var e=this.props.event,t=e.prepayment,n=t.extraPayments[0];window.Refunds.show_refund_method_modal({refundSubject:"eventPrepayment",id:e.id,amount:t.amount_paid,customerName:e.customer_name,paymentStatus:t.status,paymentMethod:t.payment_type||(n||{}).paymentMethod||t.payment_method,paymentPaidOnlineVia:t.paid_online_via||"",prepaymentBlikSubsidyAmount:t.blik_subsidy_amount,amountPaidWithGiftCoupon:t.amount_paid_with_gift_coupon,amountPaidWithGiftCard:t.amount_paid_with_gift_card,onRefund:this.on_refund})},render_prepayment_payment_method:function(){return I18n.t(this.props.event.prepayment.amount_paid_with_gift_coupon>0?"online_gift_coupon":this.props.event.prepayment.payment_type||this.props.event.prepayment.payment_method,{scope:"js.payment_methods"})},render_prepayment_controls_for_finalization:function(){var e=this,t=this.props.event.prepayment,n=t.extraPayments[0];if((VersumConfig.prepayments_enabled||e.props.event.prepayment.id)&&(!e.props.event.finalized||e.props.event.prepayment.id)){var a=t.amount_input_value,r=this.props.event.prepayment.payment_method,s=this.get_prepayment_select_class_names(),i=this.get_prepayment_input_class_names(),o=null,c=e.render_add_prepayment_button();return!e.props.event.is_unpaid_moment_reservation()&&PaymentMethods.is_online(r)&&!this.props.event.customer_was_edited||!e.props.event_edition_enabled||e.props.event.finalized?o=n?e.render_prepayment_with_extra_payment_info():e.render_prepayment_payment_info():(o=!VersumConfig.prepayments_enabled||"paid"===this.props.event.prepayment.status&&!this.props.event.prepayment.status_was_changed||this.props.event.prepayment.gift_card?n?e.render_prepayment_with_extra_payment_info():e.render_prepayment_payment_info():React.createElement("div",null,React.createElement("div",{className:"d-flex ai-center"},React.createElement("input",{type:"text",value:a,size:8,onChange:this.on_prepayment_change.bind(this,"amount"),className:i,disabled:"paid"===this.props.event.prepayment.status&&!this.props.event.prepayment.status_was_changed}),React.createElement("span",{className:"ml-s"}," "+CurrencyUtils.get_current_symbol()),React.createElement("select",{value:e.props.event.prepayment.payment_method||"placeholder",className:s,onChange:function(t){var n=t.target.value;e.props.event.prepayment.payment_method=n,e.props.event.should_update_event=!0,e.props.on_event_change()},disabled:"paid"===this.props.event.prepayment.status&&!this.props.event.prepayment.status_was_changed},React.createElement("option",{value:"placeholder",hidden:!0},I18n.t("payment_method",{scope:"js.calendar.popup"})),this.render_prepayment_payment_method_options()),React.createElement("label",{className:"m-0 no-select text-nowrap"},React.createElement("input",{checked:"paid"===this.props.event.prepayment.status,type:"checkbox",className:"v2-form-check mr-s ml-m e2e-prepayment-status-checkbox",disabled:"paid"===this.props.event.prepayment.status&&!this.props.event.prepayment.status_was_changed,onChange:function(){e.props.event.prepayment.changed=!0,e.props.finalization&&(e.props.event.should_update_event=!0),e.props.event.prepayment.status||(e.props.event.prepayment.status="queued");var t="queued"===e.props.event.prepayment.status?"paid":"queued";"paid"===t&&(e.props.event.prepayment.amount_paid=a),"queued"===t&&(e.props.event.prepayment.amount_paid=0),e.props.event.prepayment.status_was_changed=!0,e.props.event.prepayment.status=t,e.props.on_prepayment_finalization_change(),e.props.on_event_change()}}),I18n.t("paid",{scope:"js.prepayments.status"})),this.can_prepayment_refund_be_shown()&&!this.props.event.prepayment.status_was_changed&&React.createElement("a",{className:"ml-l",href:"javascript:void(0)",onClick:e.refund_prepayment},I18n.t("js.payments.do_refund"))||React.createElement("a",{href:"javascript:void(0)",onClick:this.remove_prepayment,className:"ml-l e2e-remove-prepayment"},I18n.t("delete_prepayment",{scope:"js.prepayments"}))),(!this.props.event.is_prepayment_amount_valid()||!this.props.event.is_prepayment_method_valid())&&this.props.show_prepayment_validation&&React.createElement("div",{className:"prepayment_validation_box"},this.props.event.is_prepayment_amount_valid()||this.props.event.is_prepayment_method_valid()?this.props.event.is_prepayment_amount_valid()?EventComponents.t("prepayment_method_invalid"):EventComponents.t("prepayment_amount_invalid"):EventComponents.t("prepayment_amount_invalid")+", "+EventComponents.t("prepayment_method_invalid"))),c=e.render_add_prepayment_button()),this.props.event.is_unpaid_moment_reservation()&&this.props.event.finalized&&" "||React.createElement("div",{className:"box-line"},React.createElement("div",{className:"online"===r||!this.props.event_edition_enabled||this.props.event.finalized?"box-line-label pt-s":"box-line-label"},EventComponents.t("prepayment"),":"),React.createElement("div",{className:"box-line-content"},this.props.event.prepayment.disabled?c:o))}},render_prepayment_controls:function(){var e=this,t=this.props.event.prepayment,n=this.get_prepayment_select_class_names(),a=this.get_prepayment_input_class_names(),r=this.props.event.prepayment.extraPayments[0];if(VersumConfig.prepayments_enabled||this.props.event.prepayment.id){if(this.props.event_edition_enabled&&VersumConfig.prepayments_enabled){var s=null,i=e.render_add_prepayment_button(),o=this.props.event.is_prepayment_paid()?this.props.event.prepayment.amount_paid:t.amount_input_value,c="paid"===this.props.event.prepayment.status&&!PaymentMethods.is_online(this.props.event.prepayment.payment_method)||this.props.event.is_prepayment_paid();return s=this.props.event.is_prepayment_paid()?React.createElement("div",{className:"pt-xs"},NumberUtils.format_price(o)+" ",React.createElement(EventComponents.PrepaymentStatusLabel,{prepayment_expiration_date_time:this.props.event.prepayment.expiration_date_time,payment_status:this.props.event.prepayment.status,prepayment_paid_at:this.props.event.prepayment.paid_at}),this.can_prepayment_refund_be_shown()&&React.createElement("a",{className:"ml-m",href:"javascript:void(0)",onClick:e.refund_prepayment},I18n.t("js.payments.do_refund"))):React.createElement("div",null,React.createElement("div",{className:"d-flex ai-center flex-wrap"},React.createElement("input",{type:"text",value:o,size:8,onChange:this.on_prepayment_change.bind(this,"amount"),disabled:this.props.event.is_prepayment_paid(),className:a}),React.createElement("span",{className:"ml-s"}," "+CurrencyUtils.get_current_symbol()),React.createElement("select",{value:e.get_prepayment_method_default_select_value(),className:n,onChange:this.on_prepayment_change.bind(this,"payment_method"),disabled:this.props.event.is_prepayment_paid()},React.createElement("option",{value:"placeholder",hidden:!0},I18n.t("payment_method",{scope:"js.calendar.popup"})),this.render_prepayment_payment_method_options()),React.createElement("label",{className:"m-0 mr-m no-select text-nowrap"},React.createElement("input",{checked:c,type:"checkbox",className:"v2-form-check mr-s e2e-prepayment-status-checkbox",disabled:PaymentMethods.is_online(this.props.event.prepayment.payment_method)||this.props.event.is_prepayment_paid()||"certificate"===this.props.event.prepayment.payment_method,onChange:function(){e.props.event.prepayment.changed=!0,e.props.event.prepayment.status||(e.props.event.prepayment.status="queued");var t="queued"===e.props.event.prepayment.status?"paid":"queued";e.props.event.prepayment.status=t,e.props.on_event_change()}}),I18n.t("paid",{scope:"js.prepayments.status"})),(!this.props.event.prepayment.id||this.props.event.prepayment.id&&"paid"!==this.props.event.prepayment.status)&&React.createElement("a",{href:"javascript:void(0)",onClick:this.remove_prepayment,className:"e2e-remove-prepayment"},I18n.t("delete_prepayment",{scope:"js.prepayments"})),this.can_prepayment_refund_be_shown()&&React.createElement("a",{className:"ml-s",href:"javascript:void(0)",onClick:e.refund_prepayment},I18n.t("js.payments.do_refund"))),(!this.props.event.is_prepayment_amount_valid()||!this.props.event.is_prepayment_method_valid())&&this.props.show_prepayment_validation&&React.createElement("div",{className:"prepayment_validation_box"},this.props.event.is_prepayment_amount_valid()||this.props.event.is_prepayment_method_valid()?this.props.event.is_prepayment_amount_valid()?EventComponents.t("prepayment_method_invalid"):EventComponents.t("prepayment_amount_invalid"):EventComponents.t("prepayment_amount_invalid")+", "+EventComponents.t("prepayment_method_invalid")),VersumConfig.online_payments_enabled&&PaymentMethods.is_online(this.props.event.prepayment.payment_method)&&this.props.event.prepayment.id&&"queued"===this.props.event.prepayment.status&&!this.props.event.prepayment.amount_paid&&this.props.event.prepayment.payment_type&&React.createElement("div",{className:"mt-s"},React.createElement("a",{href:"javascript:void(0)",onClick:this.pay_prepayment_again(this.props.event.prepayment.payment_type),"data-toggle":"tooltip","data-html":"true",title:"online_link"===this.props.event.prepayment.payment_type&&(this.props.event.prepayment.payment_request_sent_at&&I18n.t("js.payments.link_sent_at",{date:moment(this.props.event.prepayment.payment_request_sent_at).format("DD.MM.YYYY")})+"<br>"||"")+((this.props.event.prepayment.payment_request_sent_to||[]).length&&I18n.t("js.payments.link_sent_to",{sent_to:(this.props.event.prepayment.payment_request_sent_to||[]).join(", ")})||"")||""},"online_blik"===this.props.event.prepayment.payment_type?I18n.t("js.payments.pay_again"):I18n.t("js.payments.send_link_again")))),React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("prepayment"),":"),React.createElement("div",{className:"box-line-content"},!this.props.event.prepayment.disabled||this.props.event.prepayment.amount>0&&this.props.event.id?s:i))}return React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("prepayment"),":"),r?this.render_prepayment_with_extra_payment_info():React.createElement("div",{className:"box-line-content"},this.props.event.prepayment.amount>0?React.createElement("span",{className:"e2e-prepayment-amount"},NumberUtils.format_price(this.props.event.prepayment.amount)):I18n.t("js.missing"),this.props.event.prepayment.amount&&React.createElement("span",{className:"ml-s e2e-prepayment-payment-method"},this.render_prepayment_payment_method())||"",this.props.event.prepayment.amount>0&&this.props.event.prepayment.status&&React.createElement(EventComponents.PrepaymentStatusLabel,{prepayment_expiration_date_time:this.props.event.prepayment.expiration_date_time,payment_status:this.props.event.prepayment.status,prepayment_paid_at:this.props.event.prepayment.paid_at})||""))}},render_prepayment_payment_info:function(){var e=this,t=this.props.event.prepayment,n=t.amount;return React.createElement("div",{className:"pt-xs"},NumberUtils.format_price(n)+" ",I18n.t(this.props.event.prepayment.payment_type||t.payment_method,{scope:"js.payment_methods"}),this.render_prepayment_status_label(),this.can_prepayment_refund_be_shown()&&React.createElement("a",{className:"ml-s",href:"javascript:void(0)",onClick:e.refund_prepayment},I18n.t("js.payments.do_refund"))||"")},render_prepayment_with_extra_payment_info:function(){var e=this,t=this.props.event.prepayment,n=t.extraPayments[0];return React.createElement("div",{className:"box-line-content pt-xs"},"("+I18n.t(t.payment_method,{scope:"js.payment_methods"})+" - "+NumberUtils.format_price(t.mainPayment.amount)+" + "+I18n.t(PaymentMethods.is_online(n.paymentMethod)?t.payment_type:n.paymentMethod,{scope:"js.payment_methods"})+" - "+NumberUtils.format_price(n.amount)+")",t.status&&this.render_prepayment_status_label()||"",this.can_prepayment_refund_be_shown()&&React.createElement("a",{className:"ml-s",href:"javascript:void(0)",onClick:e.refund_prepayment},I18n.t("js.payments.do_refund"))||"")},on_refund:function(e){var n=this.props.event.prepayment,a=n.extra_payment;e.isRefunded&&(n.charged_back=!0,PaymentMethods.is_online(e.method)||(this.remove_prepayment(),n.payment_method="cash",n.payment_type=t),(PaymentMethods.is_online(e.method)||a&&PaymentMethods.is_online(a.payment_method))&&this.set_prepayment_as_refunded(),n.created_by_customer&&(n.created_by_customer=!1),this.props.on_prepayment_refund&&this.props.on_prepayment_refund())},is_prepayment_status_select_visible:function(){return!!this.props.event.prepayment.payment_method&&!PaymentMethods.is_online(this.props.event.prepayment.payment_method)&&"cash"!==this.props.event.prepayment.payment_method},show_prepayment_remaining_time:function(){var e=this.props.event.prepayment.status,t=this.props.event.prepayment.cancel_event_after_hours,n=moment(this.props.event.prepayment.payment_request_sent_at||this.props.event.prepayment.created_at||null).add(t,"hours"),a=n.diff(Date.now(),"hours"),r=n.diff(Date.now(),"minutes");return r>60&&"queued"===e?I18n.t("js.prepayments.prepayments_details.time_left_hours",{time:a}):r>0&&r<=60&&"queued"===e?I18n.t("js.prepayments.prepayments_details.time_left_minutes",{time:r}):r<=0&&"paid"!==e&&"refund_failed"!==e?I18n.t("js.prepayments.prepayments_details.time_over"):this.show_prepayment_paid_date()},show_prepayment_paid_date:function(){var e=DateUtils.format_datetime(moment(this.props.event.prepayment.paid_at));if("paid"===this.props.event.prepayment.status)return I18n.t("js.prepayments.prepayments_details.paid")+e},pay_prepayment_again:function(e){var t=this;return function(){var n=_.get(window,"reactLegacyBridge.modals.OnlinePaymentModal.renderModal",function(){});t.props.on_online_payment_start(),n({customerId:_.get(t,"props.event.customer.id"),amount:_.get(t,"props.event.prepayment.amount"),subjectId:_.get(t,"props.event.prepayment.id"),subjectType:"EVENT_PREPAYMENT",paymentMethod:e,description:"Prepayment for prepayment: "+_.get(t,"props.event.prepayment.id"),helperPayments:prepayment.getOnlineHelperPaymentsInput(),onPaymentSuccess:function(){t.props.event.prepayment.amount_paid=t.props.event.prepayment.amount,t.props.event.prepayment.status="paid",t.props.event.online_payment_finished=!0,t.props.on_event_change()},onLinkSent:function(){t.props.event.online_payment_finished=!0,t.props.on_payment_link_sent(),t.props.on_event_change()},onClose:function(){t.props.on_event_change()}})}},render_description_controls:function(){var e;e=this.props.event.canceled?EventComponents.t("event_box.cancellation_reason"):this.props.event.not_an_appointment?EventComponents.t("event_box.blockade_reason"):EventComponents.t("event_box.description");var t=null;this.props.event.info_from_customer&&(t=I18n.t("js.calendar.popup.info_from_customer",{customer:customer_desc_namespace})+": "+nl2br(simple_html_escape(this.props.event.info_from_customer)));var n;if(this.props.event_edition_enabled)n=React.createElement("div",null,React.createElement("div",{className:"v2-row v2-row-s"},React.createElement("div",{className:"v2-col-sm-9"},React.createElement("textarea",{defaultValue:this.props.event.description,className:"description-field e2e-event-description",onChange:this.update_description})),React.createElement("div",{className:"v2-col-sm-3 as-center"},this.render_tag_link())));else if(this.props.event.description){var a=nl2br(simple_html_escape(this.props.event.description));t&&(a+="<br>"+t),n=React.createElement("div",{className:"text-break",dangerouslySetInnerHTML:{__html:a}})}else n=t||("overlay"===this.props.view_type||this.props.event.not_an_appointment?EventComponents.t("missing"):null);if(null!==n)return React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},e,":"),React.createElement("div",{className:"box-line-content text-break"},n))},render_deals_site_coupon_info:function(){if(!this.props.event_edition_enabled&&null!=this.props.event.coupon_site&&this.props.event.coupon_site.length>0){var e=EventComponents.get_coupon_info(this.props.event);return React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("event_box.deals_site_coupon"),":"),React.createElement("div",{className:"box-line-content",dangerouslySetInnerHTML:{__html:e}}))}},render_products_controls:function(){var e=this;return this.should_show_products()?React.createElement("div",null,React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("event_box.products_sale"),":"),React.createElement("div",{className:"box-line-content"},React.createElement(EventComponents.OrderProducts,{ref:"products",order:this.props.event.order,is_sale:!0,on_order_change:this.props.on_event_change,event_edition_enabled:this.props.event_edition_enabled,all_employees:this.props.all_employees,on_last_item_deletion:function(){e.state.show_products=!1,e.props.on_event_change()}})))):React.createElement("span",null)},render_gift_cards_controls:function(){var e=this;if(this.should_show_gift_cards())return React.createElement("div",null,React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("gift_cards_sale"),":"),React.createElement("div",{className:"box-line-content"},React.createElement(EventComponents.GiftCardsSale,{order:this.props.event.order,gift_cards:this.props.event.order.sold_gift_cards,on_change:this.props.on_event_change,edit_mode:this.props.event_edition_enabled,on_last_item_deletion:function(){e.state.show_gift_cards=!1,e.props.on_event_change()}}))))},render_packages_controls:function(){var e=this;if(this.should_show_packages())return React.createElement("div",null,React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("packages_sale"),":"),React.createElement("div",{className:"box-line-content"},React.createElement(EventComponents.PackagesSale,{order:this.props.event.order,packages:this.props.event.order.sold_packages,on_change:this.props.on_event_change,edit_mode:this.props.event_edition_enabled,on_last_item_deletion:function(){e.state.show_packages=!1,e.props.on_event_change()},package_type:this.props.package_type_certificate,package_type_certificate:this.props.package_type_certificate,package_type_carnet:this.props.package_type_carnet}))))},render_carnets_controls:function(){var e=this;if(this.should_show_carnets())return React.createElement("div",null,React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("carnets_sale"),":"),React.createElement("div",{className:"box-line-content"},React.createElement(EventComponents.PackagesSale,{order:this.props.event.order,packages:this.props.event.order.sold_packages,on_change:this.props.on_event_change,edit_mode:this.props.event_edition_enabled,on_last_item_deletion:function(){e.state.show_carnets=!1,e.props.on_event_change()},package_type:this.props.package_type_carnet,package_type_certificate:this.props.package_type_certificate,package_type_carnet:this.props.package_type_carnet}))))},render_order_employee:function(){if(this.should_show_products()||this.should_show_gift_cards()||this.should_show_packages()||this.should_show_carnets())return React.createElement("div",null,React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("event_box.sale_employee"),":"),React.createElement("div",{className:"box-line-content"},React.createElement(EventComponents.OrderEmployee,{order:this.props.event.order,all_employees:this.props.all_employees,on_order_change:this.props.on_event_change,event_edition_enabled:this.props.event_edition_enabled}))))},render_tag_controls:function(){return this.show_tag_controls()?React.createElement(EventComponents.EventTags,{ref:"event_tags",event:this.props.event,on_event_change:this.props.on_event_change,all_tags:this.props.all_tags,event_edition_enabled:this.props.event_edition_enabled}):React.createElement("span",null)},render_tag_link:function(){return this.show_tag_controls()||this.props.event.not_an_appointment?React.createElement("span",null):React.createElement("a",{href:"#",onClick:this.edit_tags,className:"e2e-add-tag"},EventComponents.t("event_box.add_tag"))},render_tag_link:function(){return this.show_tag_controls()||this.props.event.not_an_appointment?React.createElement("span",null):React.createElement("a",{href:"#",onClick:this.edit_tags,className:"e2e-add-tag"},EventComponents.t("event_box.add_tag"))},render_remove_event_link:function(){return!this.props.event_edition_enabled||this.props.events_number<=1||this.props.event.destroy?React.createElement("span",null):this.props.event.finalized?React.createElement("a",{href:"#",onClick:this.destroy_event,className:"icon sprite-delete remove_event",title:I18n.t("js.delete")}):React.createElement("a",{href:"#",onClick:this.remove_event_from_group,className:"icon sprite-close_X remove_event",title:EventComponents.t("remove_from_finalization_form")})},render_created_at_info:function(){return this.props.event_edition_enabled?React.createElement("span",null):React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("created_at"),":"),React.createElement("div",{className:"box-line-content"},React.createElement("span",{className:"right_space"},DateUtils.format_datetime(this.props.event.created_at)),React.createElement("span",{className:"left_space"},React.createElement("a",{href:"/events/"+this.props.event.id+"/versions",target:"_blank"},EventComponents.t("event_box.show_all_versions",{count:this.props.event.version||1})))))},render_customer_health_survey:function(){var e=moment("2020-05-17").toDate();return this.props.event.customer_health_survey&&this.props.event.id&&this.props.event.beginning.toDate()>e?React.createElement(EventComponents.EventCustomerHealthSurvey,{event:this.props.event}):React.createElement("span",null)},render_finalized_at_info:function(){return this.props.event_edition_enabled||!this.props.event.finalized?React.createElement("span",null):React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("finalized_at"),":"),React.createElement("div",{className:"box-line-content"},DateUtils.format_datetime(this.props.event.finalized_at)))},render_finalized_at_controls:function(){if(this.props.event_edition_enabled){var e=this.props.event;return React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("finalized_at"),":"),React.createElement("div",{className:"box-line-content"},React.createElement("input",{type:"text",className:"date_input",ref:"finalized_at_input",value:DateUtils.format_date(e.finalized_at),onChange:function(){}}),React.createElement("i",{className:"icon sprite-info_tip2 left_space",title:EventComponents.t("finalized_at_explanation"),"data-toggle":"tooltip"})))}},render_lumo:function(){var e=this.props.event;if(VersumConfig.lumo.lumo_activated&&(VersumConfig.lumo.lumo_service_purchase_enabled||VersumConfig.lumo.lumo_product_purchase_enabled&&e.order)&&(this.props.event_edition_enabled||e.finalized)){var t="box-line lumo-line";return e.customer&&"initial"===e.customer.lumo_state&&(t+=" state-initial"),"test"===VersumConfig.lumo.lumo_state&&(t+=" state-test"),React.createElement("div",{className:t},React.createElement("div",{className:"box-line-label"},EventComponents.t("lumo.title"),":"),React.createElement("div",{className:"box-line-content"},React.createElement(LumoComponents.LumoBox,{item:e,on_change:this.props.on_event_change,event_edition_enabled:this.props.event_edition_enabled,on_lumo_state_change:this.on_lumo_state_change,group_discount:this.props.group_discount,excluded_lumo_points_percentage_for_services:this.props.excluded_lumo_points_percentage_for_services,excluded_lumo_points_percentage_for_products:this.props.excluded_lumo_points_percentage_for_products})))}return React.createElement("span",null)},handle_prepayment_confirmation_click:function(e){if("yes"===e){if(this.props.event.is_prepayment_confirmation_visible=!1,this.props.event.refresh_prepayment_amount(),this.props.finalization&&(this.props.event.should_update_event=!0,"paid"===this.props.event.prepayment.status)){var t=this.props.event.prepayment.amount_input_value;this.props.event.prepayment.amount_paid=t,this.props.on_prepayment_finalization_change()}this.props.on_prepayment_requirements_change(!0)}"no"===e&&(this.props.event.is_prepayment_confirmation_visible=!1),this.props.on_event_change()},render_prepayment_confirmation:function(){var e=this,t=this.props.event;if(VersumConfig.prepayments_enabled&&!t.prepayment.disabled&&t.is_prepayment_confirmation_visible){var n=this.props.event.is_prepayment_paid()?this.props.event.prepayment.amount_paid:this.props.event.prepayment.requirements&&this.props.event.prepayment.requirements.amount||this.props.event.get_total_services_prepayment_amount(),a=React.createElement("span",null,EventComponents.t("prepayments.confirmation.confirm_content")+" ",React.createElement("b",{className:"e2e-prepayment-fetched-amount"},n+" "+CurrencyUtils.get_current_symbol()+". "),EventComponents.t("prepayments.confirmation.confirm_question")),r=React.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"#ed8e05",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},React.createElement("path",{d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}),React.createElement("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),React.createElement("line",{x1:"12",y1:"17",x2:"12",y2:"17"})),s=React.createElement("div",null,React.createElement("button",{type:"button",className:"btn btn-primary mr-xs e2e-accept-new-prepayment-value",onClick:function(){e.handle_prepayment_confirmation_click("yes")}},EventComponents.t("prepayments.confirmation.yes")),React.createElement("button",{type:"button",className:"btn e2e-dont-accept-new-prepayment-value",onClick:function(){e.handle_prepayment_confirmation_click("no")}},EventComponents.t("prepayments.confirmation.no")));return React.createElement("div",{className:"box-line prepayment-line"},React.createElement("div",{className:"box-line-label"}),React.createElement("div",{className:"box-line-content prepayment-line-content e2e-prepayment-amount-changed-info"},React.createElement("div",{className:"v2-row v2-row-s"},React.createElement("div",{className:"v2-col-auto"},r),React.createElement("div",{className:"v2-col"},React.createElement("div",null,a),React.createElement("div",{className:"mt-m"},s)))))}return React.createElement("span",null)},render_undelete_link:function(){return!this.props.event_edition_enabled&&this.props.event.can_restore_in_calendar?React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"}),React.createElement("div",{className:"box-line-content"},React.createElement("a",{href:"javascript:restore_event_with_confirmation("+this.props.event.id+")"},EventComponents.t("event_box.undelete")))):React.createElement("span",null)},render_prepayment_info:function(){return this.props.event.prepayment.amount>0&&("paid"===this.props.event.prepayment.status||"paid_canceled"===this.props.event.prepayment.status)&&React.createElement("div",null,React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("prepayment")),React.createElement("div",{className:"box-line-content"},React.createElement("div",null,React.createElement("span",{className:"font-strong"
},NumberUtils.format_price(NumberUtils.parse_price(this.props.event.get_prepayment_amount()))),React.createElement("br",null),this.props.event.canceled&&this.props.event_edition_enabled&&!this.props.event.finalized&&React.createElement("div",null,this.render_prepayment_decision_select()),React.createElement("div",null,"consume"===this.props.event.cancel_event_prepayment_decision||"paid_canceled"===this.props.event.prepayment.status?EventComponents.t("prepayment_consume_info"):EventComponents.t("prepayment_return_info"))))))},handle_prepayment_decision_change:function(e){var t=e.target.value;this.props.event.cancel_event_prepayment_decision=t,this.props.on_event_change()},render_prepayment_decision_select:function(){return this.props.event.prepayment.amount>0&&"paid"===this.props.event.prepayment.status&&React.createElement("select",{className:"my-s w-auto",onChange:this.handle_prepayment_decision_change},React.createElement("option",{value:""},EventComponents.t("prepayment_keep")),React.createElement("option",{value:"consume"},EventComponents.t("prepayment_consume")))},init_prepayment_inputs:function(){var t=e("[data-prepayment-payment-methods]").data("prepayment-payment-methods");t&&this.setState({prepayment_methods:t})},getInitialState:function(){var e=CalendarModels.create_event_time_manager(this.props.event);return{tags_edit_mode:!1,event_time_manager:e,services_adjuster:CalendarModels.create_services_adjuster(this.props.event,{event_time_manager:e,resources:this.props.resources,employees_with_calendar:this.props.employees_with_calendar,cancelable:!0}),service_adjusting_reverter:CalendarModels.create_service_adjusting_reverter(this.props.event,{event_time_manager:e}),current_beginning_date:moment(this.props.event.beginning).startOf("day"),current_allday_beginning_date:moment(this.props.event.allday_beginning).startOf("day"),prepayment_methods:[],prepayment_payment_method:this.props.event.prepayment.payment_method}},componentWillMount:function(){this.init_prepayment_inputs()},componentWillUnmount:function(){var e=document.querySelector("#event_recurrence_controls");e&&e.dispatchEvent(new Event("unmount"))},componentDidMount:function(){var t=e("textarea.description-field");t.length&&t.autogrow({animate:!1,fixMinHeight:!1}).focus(function(){e(this).keyup()}),this.set_max_height_for_popup_body(),this.init_finalized_at_input(),this.render_recurrence_controls()},componentDidUpdate:function(){this.init_finalized_at_input(),this.set_max_height_for_popup_body(),this.render_recurrence_controls();var e=moment(this.props.event.beginning).startOf("day");this.state.current_beginning_date.isSame(e)||(this.state.current_beginning_date=e,"function"==typeof this.props.on_beginning_date_change&&this.props.on_beginning_date_change(e));var t=moment(this.props.event.allday_beginning).startOf("day");this.state.current_allday_beginning_date.isSame(t)||(this.state.current_allday_beginning_date=t,"function"==typeof this.props.on_beginning_date_change&&this.props.on_beginning_date_change(t))},get_customer_name:function(){return this.props.event.customer.name},get_box_class:function(){var e="event-box simple_form";return this.props.event.destroy&&(e+=" destroy"),this.props.event.canceled&&(e+=" canceled"),this.props.event.selected&&(e+=" selected"),e},update_description:function(e){this.props.event.description=e.target.value,this.props.on_event_change()},update_canceled:function(e){this.props.event.canceled=e.target.checked,this.props.on_event_change()},init_finalized_at_input:function(){if(this.refs.finalized_at_input){var t=this;e(ReactDOM.findDOMNode(this.refs.finalized_at_input)).datepicker({inline:!1,showOtherMonths:!0,selectOtherMonths:!0,dateFormat:DateUtils.get_date_format("default_datepicker"),onSelect:function(){t.props.event.finalized_at=moment(e(this).val(),DateUtils.get_date_format()),t.props.on_event_change()}})}},set_max_height_for_popup_body:function(){var t=this,n=e(ReactDOM.findDOMNode(t));if("popup"===t.props.view_type&&e(window).width()>768){var a=n.find(".box-header").outerHeight(),r=n.parent().parent().find(".form-actions").outerHeight(),s=n.offset().top+parseInt(a)+parseInt(r)+10,i=e(window).height()-s;i>120&&n.find('[data-popup-element="body"]').addClass("popup-body").css("max-height",i+"px")}else n.find('[data-popup-element="body"]').removeClass("popup-body").css("max-height","none")},init_products:function(){this.init_order(),this.setState({show_products:!0})},init_gift_cards:function(){this.init_order(),this.setState({show_gift_cards:!0})},init_packages:function(){this.init_order(),this.setState({show_packages:!0})},init_carnets:function(){this.init_order(),this.setState({show_carnets:!0})},init_order:function(){this.props.event.order||(this.props.event.order=CalendarModels.create_order({employee:this.props.event.employee?e.extend({},this.props.event.employee):null})),this.props.event.order.products.length<=0&&(this.props.event.order.products=[CalendarModels.create_empty_product()])},should_show_products:function(){return this.props.event.get_sold_products().length>0||this.state.show_products},should_show_gift_cards:function(){return this.props.event.get_sold_gift_cards().length>0||this.state.show_gift_cards},should_show_packages:function(){return this.props.event.filter_sold_packages(this.props.package_type_certificate).length>0||this.state.show_packages},should_show_carnets:function(){return this.props.event.filter_sold_packages(this.props.package_type_carnet).length>0||this.state.show_carnets},delete_order:function(){delete this.props.event.order,this.props.on_event_change()},show_tag_controls:function(){return this.state.tags_edit_mode||this.props.event.tags.length>0},edit_tags:function(e){e.preventDefault(),this.setState({tags_edit_mode:!0})},remove_event_from_group:function(e){e.preventDefault(),this.props.remove_event(this.props.index)},destroy_event:function(e){e.preventDefault(),this.props.event.destroy=!0,this.props.on_event_change()},revert_event:function(e){e.preventDefault(),this.props.event.destroy=!1,this.props.on_event_change()},on_lumo_state_change:function(){var e=this.props.event.customer;this.props.on_lumo_state_change(e.id,e.lumo_state)}})}(jQuery),EventComponents.EventCustomer=function(e,t){return React.createClass({render:function(){return this.state.edit_mode?React.createElement("div",{className:"v2-row v2-row-s"},React.createElement("div",{id:"customer_autocomplete",className:"v2-col v2-col-sm-9"},React.createElement("input",{type:"text",ref:"customer",className:"customer-field right_space flex-fill e2e-customers-search",placeholder:I18n.t("js.customer.placeholder"),onBlur:this.update_customer_name})),React.createElement("div",{className:"v2-col-auto v2-col-sm-3"},React.createElement("button",{type:"button",className:"button e2e-add-customer",ref:"add_customer",tabIndex:"-1"},I18n.t("js.customer.add")))):React.createElement("div",{className:"customer-name-container"},React.createElement("span",{className:"customer-name right_space",dangerouslySetInnerHTML:{__html:this.get_customer_html()}}),this.render_gift_cards_count(),this.props.show_overpayment&&React.createElement(EventComponents.CustomerOverpayment,{amount:this.props.overpayment_balance}),this.render_edit_link())},render_gift_cards_count:function(){if(VersumConfig.gift_cards_activated&&this.get_customer()&&(this.get_customer().gift_cards_count>0||this.get_customer().packages_count>0)){var e=I18n.t("js.gift_cards.customer_gift_cards_and_packages_count",{gift_cards_count:this.get_customer().gift_cards_count,packages_count:this.get_customer().packages_count});return React.createElement("span",{className:"left_space right_space","data-toggle":"tooltip","data-html":"true",title:e},React.createElement(Icons.Svg,{name:"gift_card"}))}},render_edit_link:function(){return this.props.event_edition_enabled?React.createElement("a",{className:"left_space mr-s e2e-change-customer",onClick:this.edit_customer,href:"#"},EventComponents.t("change")):React.createElement("span",null)},getInitialState:function(){return{edit_mode:!this.props.event.id}},componentDidMount:function(){this.init_customer_searcher(),this.attach_popover(),this.init_gift_cards_count()},componentDidUpdate:function(){this.init_customer_searcher(),this.attach_popover(),this.init_gift_cards_count()},componentWillUnmount:function(){var t=e(ReactDOM.findDOMNode(this)).find(".customer_popover");t.length>0&&t.popover("destroy")},init_gift_cards_count:function(){if(VersumConfig.gift_cards_activated&&this.get_customer()&&this.get_customer().id&&this.get_customer().gift_cards_count===t){var e=this,n=this.get_customer();this.props.gift_cards_counts_for_customers_store.get_count_for_customer(n.id).done(function(t){n.gift_cards_count=t.gift_cards_count,n.packages_count=t.packages_count,e.props.on_event_change()})}},attach_popover:function(){var t=this,n=this.props.event,a=e(ReactDOM.findDOMNode(this)).find(".customer_popover");if(a.length&&!a.data("popover-attached")){a.data("popover-attached",!0);var r=a.parent();a.on("click",function(e){1===e.which&&e.preventDefault()}).popover({title:function(){return a.text()},content:function(){return r.find("#customer_full_data").html()},trigger:"click",html:!0,placement:"bottom",container:"body"}).on("shown.bs.popover",function(){if(!_fullcalendar_restricted){var r=t.find_arrived_tag(n.tags);r?e(".popover #customer_arrived_activate").addClass("active").secureOn("click",function(a){a.preventDefault(),VersumUtils.show_indicator(),e.ajax({type:"DELETE",dataType:"json",url:"/events/"+n.id+"/tags/"+r.id,success:function(e){VersumUtils.hide_indicator(),"function"==typeof t.props.on_arrived_tag_change&&t.props.on_arrived_tag_change(e)}})}):e(".popover #customer_arrived_activate").secureOn("click",function(a){a.preventDefault(),VersumUtils.show_indicator(),e.ajax({type:"POST",dataType:"json",url:"/events/"+n.id+"/tags",success:function(e){VersumUtils.hide_indicator(),"function"==typeof t.props.on_arrived_tag_change&&t.props.on_arrived_tag_change(e)}})}),e('.popover [data-action="edit_description"]').secureOn("click",function(e){e.preventDefault(),a.popover("hide"),t.edit_description()})}}),a.data("bs.popover").tip().addClass("popover_calendar"),e("html").secureOn("click.components_event_customer_popover",function(t){e(t.target).is(a)||0!==e(".popover").has(t.target).length||a.popover("hide")})}},find_arrived_tag:function(e){for(var t=0;t<e.length;t++){var n=e[t];if("customer_arrived"===n.kind)return n}return null},edit_description:function(){var t=this,n=this.get_customer().id,a=e("<textarea />",{text:e(ReactDOM.findDOMNode(this)).find('[data-customer_id="'+n+'"] .description-content').html()||"",id:"customer_description_textarea"});a.hide(),BootstrapDialog.show({title:EventComponents.t("customer.edit_description_title",{customer_name:this.get_customer().name}),message:a,buttons:[{label:I18n.t("js.dialog.save"),cssClass:"button-blue",action:function(e){t.save_description(e,a)}},{label:I18n.t("js.dialog.cancel"),action:function(e){e.close()}}],onshown:function(){a.show(),WysiwygUtils.create_rich_content_editor(t.get_customer().description_content_type,a,{max_container_width:"auto",autoGrow_maxHeight:250})},onhidden:function(){WysiwygUtils.destroy_editor_instances("customer_description_textarea")}})},save_description:function(t,n){VersumUtils.show_indicator(),WysiwygUtils.update_form_controls();var a=this,r=this.get_customer().id,s="physical_customers_"+customer_namespace+"[description]",i="physical_customers_"+customer_namespace+"[description_content_type]",o={};o[s]=n.val(),o[i]=a.get_customer().description_content_type,e.ajax({url:"/customers/"+r+"?field=description",method:"put",data:o,dataType:"json",success:function(n){VersumUtils.hide_indicator(),e('[data-customer_id="'+r+'"] .description-content').html(window.markdownUtils.richContentHtml(n.description,n.description_content_type,"")),n.description&&n.description.length>0?e('[data-customer_id="'+r+'"] [data-placeholder="description"]').hide():e('[data-customer_id="'+r+'"] [data-placeholder="description"]').show(),e.jGrowl(EventComponents.t("customer.description_updated"),{life:2e3,theme:"flash_notice"}),t.close()},error:function(t,n,a){n.responseJSON?e.jGrowl(n.responseJSON.join("<br>"),{life:4e3,theme:"flash_alert"}):VersumUtils.handle_ajax_error(t,n,a)}})},get_customer_html:function(){var e,t;return this.props.customer_edition_enabled?(e=this.props.event_edition_enabled||!this.props.event.editable||this.props.finalization,t=!this.props.event.editable):(e=!0,t=!0),ComponentHelpers.Customers.generate_customer_html(this.get_customer(),e,t)},get_customer:function(){return this.props.event.customer},edit_customer:function(e){return e.preventDefault(),this.props.event.prepayment.id&&-1!==["paid","refund_pending","refund_failed"].indexOf(this.props.event.prepayment.status)?void BootstrapDialog.show({title:I18n.t("js.dialog.error"),type:BootstrapDialog.TYPE_DANGER,message:I18n.t("js.prepayments.cant_change_customer_when_prepayment_paid"),buttons:[{label:I18n.t("js.dialog.close"),action:function(e){e.close()}}]}):this.props.event.is_recurring_event()&&this.props.event.id&&this.props.event.customer&&this.props.event.customer.id?void BootstrapDialog.show({title:I18n.t("js.dialog.error"),type:BootstrapDialog.TYPE_DANGER,message:I18n.t("js.event_recurrence.cant_change_customer_on_recurring_event"),buttons:[{label:I18n.t("js.dialog.close"),action:function(e){e.close()}}]}):(PaymentMethods.set_metod_active("overpayment_balance",!1),this.props.event.prepayment.payment_request_sent_at=t,this.props.event.prepayment.created_by_customer=!1,this.props.event.prepayment.customer_touched=!0,this.props.event.prepayment.disabled=!0,this.props.event.customer_was_edited=!0,this.props.event.should_update_event=!0,this.props.event.customer_name="",this.props.event.customer={},this.props.on_event_change(),this.props.on_prepayment_remove(),this.props.on_prepayment_requirements_change&&this.props.on_prepayment_requirements_change(!0),void this.setState({edit_mode:!0}))},init_customer_searcher:function(){if(this.refs.customer){var t=e(ReactDOM.findDOMNode(this.refs.customer));if(!t.data("customer-searcher-attached")){var n=this;CustomerSearcher.run({autocomplete_input:t,new_customer_button:e(ReactDOM.findDOMNode(this.refs.add_customer)),on_customer_pick:function(e){n.update_customer(e),n.props.on_customer_change&&n.props.on_customer_change()}}),t.focus()}}},update_customer:function(e){this.state.edit_mode=!1;var t=e;this.props.event.customer.id&&(this.props.event.prepayment.customer_replace=!0),this.props.event.customer=t,!this.props.event.prepayment.disabled&&this.props.event.prepayment.required&&(this.props.event.prepayment.disabled=!1),this.props.event.should_update_event=!0,this.props.on_event_change(),this.update_overpayment(t.id),this.props.on_prepayment_requirements_change&&this.props.on_prepayment_requirements_change(!0)},update_customer_name:function(e){this.props.event.customer_name=e.target.value,this.props.on_event_change(),this.props.on_prepayment_requirements_change&&this.props.on_prepayment_requirements_change(!0)},update_overpayment:function(e){var t=this;_.get(window,"reactLegacyBridge.prepayments.getCustomerOverpayment",Promise.resolve(0))(e).then(function(e){PaymentMethods.set_metod_active("overpayment_balance",e>0),t.props.on_overpayment_change&&t.props.on_overpayment_change(e)})}})}(jQuery),EventComponents.EventCustomerHealthSurvey=function(){return React.createClass({render:function(){return React.createElement("div",{className:"box-line d-flex ai-end"},React.createElement("div",{className:"box-line-label"},EventComponents.t("customer_health_survey.label"),":"),React.createElement("div",{className:"box-line-content"},this.render_customer_health_survey()))},render_customer_health_survey:function(){var e=this,t=this.props.event.customer_health_survey,n=this;if(!this.props.event.customer.id)return React.createElement("span",null,EventComponents.t("customer_health_survey.no_client"));switch(t.get_state()){case"pending":return React.createElement("div",{className:"d-flex ai-center"},React.createElement("span",{className:"left_space"},EventComponents.t("customer_health_survey.scheduled")," ",DateUtils.format_date(t.next_message_at)),this.render_health_survey_send_button(t,EventComponents.t("customer_health_survey.send_now")));case"sent":return React.createElement("div",{className:"d-flex ai-center"},React.createElement("span",{className:"left_space"},EventComponents.t("customer_health_survey.sent")," ",DateUtils.format_datetime(t.last_sent_at)),this.render_health_survey_send_button(t,EventComponents.t("customer_health_survey.resend")));case"filled":return React.createElement("div",{className:"d-flex ai-center"},React.createElement("div",{className:"d-flex ai-end"},React.createElement("span",{className:"left_space mr-xs"},EventComponents.t("customer_health_survey.sent")," ",DateUtils.format_datetime(t.filled_at)),this.render_customer_health_survey_badge(t)),React.createElement("div",{className:"ml-xs right_space"},React.createElement("a",{href:"javascript:void(0)",onClick:function(){n.show_customer_health_survey_details_modal(t,e.props.event.customer.name)}},EventComponents.t("customer_health_survey.details"))));default:return React.createElement("div",{className:"d-flex ai-center"},React.createElement("span",{className:"left_space"},EventComponents.t("customer_health_survey.not_scheduled")),this.render_health_survey_send_button(t,EventComponents.t("customer_health_survey.send")))}},render_customer_health_survey_badge:function(e){return e.is_positive()?React.createElement("span",{className:"status_tag tag_green"},EventComponents.t("customer_health_survey.no_threat")):React.createElement("span",{className:"status_tag tag_red"},EventComponents.t("customer_health_survey.infection_risk"))},show_customer_health_survey_details_modal:function(e,t){_.get(window,"reactLegacyBridge.modals.HealthSurveyDetailsModal.renderModal",function(){})(e.details_props(t))},show_customer_health_survey_resend_modal:function(e){var t=this;_.get(window,"reactLegacyBridge.modals.HealthSurveyResendModal.renderModal",function(){})({deliveryPreference:e.reminder_platform,customerPhone:this.props.event.customer.phone,eventCustomerPhone:this.props.event.customer_phone_number,customerEmail:this.props.event.customer.email,message:e.sms_message,eventId:this.props.event.id,customerId:this.props.event.customer.id,onSuccess:function(n){e.set_last_sent_at(n.sentAt),t.forceUpdate()}})},render_health_survey_send_button:function(e,t){var n=this,a=this;return React.createElement("span",{className:"right_space ml-xs",key:"button_text"},this.props.event.can_resend_customer_health_survey?React.createElement("a",{href:"javascript:void(0)",onClick:function(){a.show_customer_health_survey_resend_modal(e,n.props.event.id)}},t):"")}})}(jQuery),EventComponents.EventDiscounts=function(e){return React.createClass({render:function(){return React.createElement("div",null,React.createElement("div",{className:"overlay-line"},React.createElement("div",{className:"overlay-line-label"},I18n.t("js.discounts.discount"),":"),React.createElement("div",{className:"overlay-line-content event-discounts"},this.render_discount_type_select(),this.render_discounts())))},getInitialState:function(){return{discount_type:this.props.initial_discount_type}},get_discount_type:function(){return this.state.discount_type},get_items:function(){return this.get_services().concat(this.get_products()).concat(this.get_gift_cards())},get_services:function(){var t=[];return e.each(this.get_active_events(),function(e,n){t=t.concat(n.services||[])}),t},get_products:function(){var t=[];return e.each(this.get_active_events(),function(n,a){if(a.order){var r=e.grep(a.order.products||[],function(e){return!e.empty});t=t.concat(r)}}),t},get_gift_cards:function(){var t=[];return e.each(this.get_active_events(),function(e,n){t=t.concat(n.get_sold_gift_cards()),t=t.concat(n.get_sold_packages())}),t},get_active_events:function(){return e.grep(this.props.events,function(e){return!e.canceled&&!e.destroy})},update_discount_type:function(e){var t,n=this.get_items(),a=e.target.value;if("individual"===a){for(t=0;t<n.length;t++)n[t].discount&&n[t].discount.activate();this.props.group.discount&&this.props.group.discount.deactivate()}else{for(t=0;t<n.length;t++)n[t].discount&&n[t].discount.deactivate();this.props.group.discount&&this.props.group.discount.activate()}this.state.discount_type=a,this.update()},render_discount_type_select:function(){return this.props.event_edition_enabled?React.createElement("select",{value:this.state.discount_type||"",onChange:this.update_discount_type,className:classNames("discount-type-select",{"mb-m":"individual"===this.props.initial_discount_type})},React.createElement("option",{key:"group",value:"group"},I18n.t("js.discounts.group")),React.createElement("option",{key:"individual",value:"individual"},I18n.t("js.discounts.individual"))):React.createElement("span",{className:"discount-type-select inline_block"},I18n.t("js.discounts."+this.state.discount_type))},render_discounts:function(){if("individual"===this.state.discount_type){var e=this.get_services(),t=this.get_products(),n=this.get_gift_cards();return 0===e.length&&0===t.length&&0===n.length?React.createElement("div",{className:"empty-discount-items"},I18n.t("js.discounts.empty_items")):React.createElement("div",{className:"data_table"},React.createElement("table",{className:"discounts-table"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",{className:"transparent-border"}),React.createElement("th",null,I18n.t("js.discounts.name")),React.createElement("th",null,I18n.t("js.discounts.discount_downcase")),React.createElement("th",{className:"before-discount-cell"},I18n.t("js.discounts.price")),React.createElement("th",{className:"after-discount-cell"},I18n.t("js.discounts.price_after_discount")))),React.createElement("tbody",null,this.render_discount_rows(e,t,n))))}return React.createElement(EventComponents.EventDiscount,{event_edition_enabled:this.props.event_edition_enabled,item:this.props.group,discount_type:this.state.discount_type,on_update:this.update,hideable:!0})},render_discount_rows:function(e,t,n){var a=[];return this.append_discount_rows(a,"services",e),this.append_discount_rows(a,"gift_cards",n),this.append_discount_rows(a,"products",t),a},append_discount_rows:function(e,t,n){if(n.length>0){e.push(React.createElement("tr",{key:t},React.createElement("th",{rowSpan:n.length+1},I18n.t("js.discounts."+t)),React.createElement("td",{style:{height:0,padding:0}})));for(var a=0;a<n.length;a++)e.push(this.render_discount_row(n[a]))}},render_discount_row:function(e){return React.createElement(EventComponents.EventDiscount,{event_edition_enabled:this.props.event_edition_enabled,item:e,discount_type:this.state.discount_type,key:e.key,on_update:this.update,hideable:!0})},update:function(){this.props.on_update(this.state)}})}(jQuery),EventComponents.EventDiscount=function(){return React.createClass({render:function(){var e=this.props.item,t=e.discount;return"individual"===this.props.discount_type?React.createElement("tr",null,React.createElement("td",{className:"item-name"},e.name),this.props.event_edition_enabled&&this.props.hideable&&React.createElement("td",null,React.createElement("span",null,this.render_price_input(),this.render_discount_type_select(t)))||React.createElement("td",null,this.render_price_input(),this.render_discount_type_select(t)),React.createElement("td",{className:this.before_class(t)},NumberUtils.format_price(t.base_value())),React.createElement("td",{className:"after-discount-cell"},this.render_value_after_discount(t))):React.createElement("span",null,this.render_price_input(),this.render_discount_type_select(t))},getInitialState:function(){var e=this.props.item.discount;return{input_value:NumberUtils.format_price_for_input(e.discount_value)}},update_discount_value:function(e){this.state.input_value=e.target.value;var t=this.props.item.discount.is_proportional()?NumberUtils.parse_percents(e.target.value):NumberUtils.parse_price(e.target.value);this.props.item.discount.discount_value=Math.abs(t),this.props.on_update()},update_discount_type:function(e){this.props.item.discount.discount_type=e.target.value,this.props.on_update()},before_class:function(e){var t="before-discount-cell";return e.discount_value>0&&(t+=" before-discount line-through"),t},render_price_input:function(){if(this.props.event_edition_enabled)return React.createElement("input",{type:"text",className:"js-submittable price-input right_space",value:this.state.input_value,onChange:this.update_discount_value});var e=this.props.item.discount,t="amount"===e.discount_type?NumberUtils.format_price(e.discount_value):NumberUtils.format_number(e.discount_value)+"%";return React.createElement("span",{className:"right_space"},t)},render_discount_type_select:function(e){return this.props.event_edition_enabled?React.createElement("select",{value:e.discount_type,onChange:this.update_discount_type,className:"js-submittable discount-unit-select"},React.createElement("option",{key:"proportional",value:"proportional"},"%"),React.createElement("option",{key:"amount",value:"amount"},CurrencyUtils.get_current_symbol())):React.createElement("span",null)},render_value_after_discount:function(e){return 0===e.discount_value?React.createElement("span",null):React.createElement("span",null,NumberUtils.format_price(e.new_value()))}})}(jQuery),EventComponents.EventPayments=function(e){return React.createClass(e.extend({},PaymentComponents.CommonMethods,{render:function(){var t=this,n=this.get_change(),a=this.state.payments,r=NumberUtils.format_price(this.props.prepayment_amount-this.props.price);return React.createElement("div",null,React.createElement("div",{className:"overlay-line"},React.createElement("div",{className:"overlay-line-label paid-label"},EventComponents.t("payments.tendered"),":"),React.createElement("div",{className:"overlay-line-content payment-methods e2e-payment-methods"},e.map(a,function(e,n){return t.render_method_row(e,n)}))),React.createElement("div",{className:"overlay-line"},React.createElement("div",{className:"overlay-line-label"},EventComponents.t("payments.change"),":"),React.createElement("div",{className:this.change_classes(n,"overlay-line-content e2e-change")},NumberUtils.format_price(n),!this.props.already_finalized&&this.props.prepayment_amount>this.props.price&&this.props.price>=0&&React.createElement("span",{className:"change-overpayment ml-s"},I18n.t("js.payments.overpayment")," ",r," (",EventComponents.t("payments.overpayment_change_info"),")"))))},render_tips:function(){if(0!==Tips.get_active_tips(this.props.tips).length)return React.createElement("div",{className:"overlay-line"},React.createElement("div",{className:"overlay-line-label"},EventComponents.t("tip"),":"),React.createElement("div",{className:"overlay-line-content"},React.createElement(Tips.TipsComponent,{change:this.get_change(),tips:this.props.tips,employees:this.props.tips_employees,default_employee:this.props.tips_default_employee,total_price:this.props.price,edit_mode:this.props.event_edition_enabled,update_component:this.on_change})))},render_price_input:function(e){return this.props.event_edition_enabled?PaymentComponents.CommonMethods.render_price_input.apply(this,arguments):React.createElement("span",{className:"right_space paid-price-non-editable"},NumberUtils.format_price(e.value))},render_payment_method_select:function(e){if(this.props.event_edition_enabled)return PaymentComponents.CommonMethods.render_payment_method_select.apply(this,arguments);if(this.is_whole_price_prepaid())return"";var t=this.state.payments[e].payment_method;return React.createElement("span",null,PaymentMethods.t(t))},render_method_link:function(){return this.props.event_edition_enabled?PaymentComponents.CommonMethods.render_method_link.apply(this,arguments):React.createElement("span",null)},render_gift_card_number:function(){return this.props.event_edition_enabled?PaymentComponents.CommonMethods.render_gift_card_number.apply(this,arguments):React.createElement("span",null)},render_gift_coupon_number:function(){return this.props.event_edition_enabled?PaymentComponents.CommonMethods.render_gift_coupon_number.apply(this,arguments):React.createElement("span",null)},render_carnet_number:function(){return this.props.event_edition_enabled?PaymentComponents.CommonMethods.render_carnet_number.apply(this,arguments):React.createElement("span",null)},render_add_button:function(e){return this.props.event_edition_enabled?this.is_whole_price_prepaid()?PaymentComponents.CommonMethods.render_disabled_add_button.apply(this,[e,I18n.t("js.prepayments.event_already_paid")]):PaymentComponents.CommonMethods.render_add_button.apply(this,[e]):React.createElement("span",null)},componentDidUpdate:function(t){this.is_whole_price_prepaid()&&t.price!==this.props.price&&(this.setState(this.getInitialState()),window.setTimeout(function(){e('[data-toggle="tooltip"]').tooltip()},0))}}))}(jQuery),EventComponents.EventTags=function(){return React.createClass({render:function(){}})},EventComponents.EventReminder=function(e){return React.createClass({render:function(){return React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("reminder.reminder"),":"),React.createElement("div",{className:"box-line-content"},this.render_reminder()))},render_reminder:function(){return this.props.event.reminder_handled_by_booksy?EventComponents.t("reminder.booksy"):this.props.event_edition_enabled&&!this.props.event.send_reminder_edition_locked?React.createElement("select",{className:"tag-field",value:this.props.event.should_send_reminder(),ref:"reminder_select"},React.createElement("option",{value:!0},EventComponents.t("reminder.enabled")),React.createElement("option",{value:!1},EventComponents.t("reminder.disabled"))):this.props.event.should_send_reminder()?EventComponents.t("reminder.enabled"):EventComponents.t("reminder.disabled")},componentDidMount:function(){this.init_select()},componentDidUpdate:function(){this.init_select()},init_select:function(){if(this.props.event_edition_enabled){var t=this,n=e(ReactDOM.findDOMNode(this.refs.reminder_select));if(n.data("select2")){var a=String(this.props.event.should_send_reminder());n.select2("val",a)}else n.off("change").select2("destroy").versum_select2({minimumResultsForSearch:-1}).on("change",function(){t.props.event.send_reminder="true"===e(this).val(),t.props.event.lock_send_reminder(),t.props.on_event_change()})}}})}(jQuery),EventComponents.EventSelect=function(e){return React.createClass({render:function(){return React.createElement("div",{id:"event_select_dialog"},React.createElement("span",{className:"v_align right_space"},EventComponents.t("event_select.date"),":"),React.createElement("input",{className:"pointer date_input",type:"text",ref:"date",defaultValue:DateUtils.format_date(this.props.date)}),React.createElement("div",{className:"data_table table-container"},React.createElement("table",{ref:"events_table"},React.createElement("thead",null,React.createElement("tr",null,this.render_additional_header_column(),React.createElement("th",null,EventComponents.t("event_select.customer")),React.createElement("th",null,EventComponents.t("event_select.services")),React.createElement("th",null,EventComponents.t("event_select.employee")),React.createElement("th",null,EventComponents.t("event_select.date_downcase")))),React.createElement("tbody",null,this.render_rows()))))},getInitialState:function(){return{events:this.props.events}},componentDidMount:function(){var t=this;e(ReactDOM.findDOMNode(this.refs.date)).datepicker({inline:!1,showOtherMonths:!0,selectOtherMonths:!0,dateFormat:DateUtils.get_date_format("default_datepicker"),onSelect:function(){t.after_date_change(e(this))}}),this.activate_data_table()},after_date_change:function(t){VersumUtils.show_indicator();var n=this,a=moment(t.val(),DateUtils.get_date_format());e.get("/events/events_for_select.json",{event_ids:this.props.current_event_ids,date:a.format()}).then(function(e){VersumUtils.hide_indicator(),n.remove_data_table(),n.setState({events:e}),n.activate_data_table()})},activate_data_table:function(){var t=e(ReactDOM.findDOMNode(this.refs.events_table));t.find("th.transparent-border").length>0&&!t.hasClass("dataTable")&&(t.parent().css("margin-top",0),t.dataTable({bPaginate:!1,"bFilter ":!0,bInfo:!1,bLengthChange:!1,aoColumnDefs:[{bSortable:!1,bSearchable:!1,aTargets:[0]}]}))},remove_data_table:function(){var t=e(ReactDOM.findDOMNode(this.refs.events_table));t.hasClass("dataTable")&&(t.dataTable().fnDestroy(),t.removeClass("dataTable"),
t.find("th").attr("style",!1),t.parent().attr("style",!1))},select_event:function(e){var t=this;return function(){VersumUtils.show_indicator(),EventViews.fetch_event_data({event_id:e,skip_other_events:!0}).then(function(e){VersumUtils.hide_indicator(),t.props.on_event_select(e)})}},render_additional_header_column:function(){if(this.state.events.length>0)return React.createElement("th",{className:"transparent-border"},"\xa0")},render_rows:function(){if(this.state.events.length>0){var t=this;return e.map(this.state.events,function(n,a){var r=n.services.length,s=classNames({pointer:!0,odd:a%2==0,even:a%2!=0});return React.createElement("tr",{key:n.id,className:s,onClick:t.select_event(n.id)},React.createElement("td",null,React.createElement("a",{href:"#"},EventComponents.t("event_select.choose"))),React.createElement("td",{className:"wrap"},n.customer_name),React.createElement("td",{className:"wrap"},e.map(n.services,function(e,t){var n=r===t+1?"":",";return React.createElement("span",{key:t},e,n,React.createElement("br",null))})),React.createElement("td",{className:"wrap"},n.employee_name),React.createElement("td",{className:"wrap"},t.render_time(n)))})}return React.createElement("tr",null,React.createElement("td",{colSpan:"4",className:"wrap",dangerouslySetInnerHTML:{__html:EventComponents.t("event_select.not_found")}}))},render_time:function(e){var t=moment(e.beginning),n=moment(e.end),a=moment(t).startOf("day"),r=moment(n).startOf("day");return a.isSame(r)?React.createElement("span",null,React.createElement("span",{className:"nowrap"},DateUtils.format_date(t),",")," ",React.createElement("span",{className:"nowrap"},DateUtils.format_time(t)," - ",DateUtils.format_time(n))):React.createElement("span",null,React.createElement("span",{className:"nowrap"},DateUtils.format_datetime(t)," -")," ",React.createElement("span",{className:"nowrap"},DateUtils.format_datetime(n)))}})}(jQuery),EventComponents.EventServiceDuration=function(e){return React.createClass({render:function(){var e=DateUtils.get_time_format(),t=DateUtils.get_time_format();return this.props.service.started_at.isSame(this.props.service.get_finished_at(),"day")?this.props.event.beginning.isSame(this.props.event.end,"day")||(e=DateUtils.get_datetime_format()):(e=DateUtils.get_datetime_format(),t=DateUtils.get_datetime_format()),this.props.event_edition_enabled?this.render_edit_mode(e,t):this.render_show_mode(e,t)},render_show_mode:function(e,t){return this.state.has_break?this.render_show_mode_with_break(e,t):this.render_show_mode_without_break(e,t)},render_show_mode_with_break:function(e,t){return React.createElement("tbody",null,React.createElement("tr",{className:"service-row"},React.createElement("td",{className:"wrap"},this.render_duration_before_info(),this.render_service_name(),EventComponents.t("services.break"),this.render_service_name(),this.render_duration_after_info()),React.createElement("td",{className:"service-finish short-cell"},React.createElement("span",{className:"light_text2"},EventComponents.t("services.reserved_time"),":")," ",this.props.service.get_item_duration_before_break()," ",EventComponents.t("minutes_short")," ","(",this.props.service.started_at.format(e)," - ",this.props.service.get_item_break_started_at().format(t),")")),React.createElement("tr",{className:"service-row-break"},React.createElement("td",null),React.createElement("td",null,this.props.service.get_item_break_duration()," ",EventComponents.t("minutes_short")," ","(",this.props.service.get_item_break_started_at().format(e)," - ",this.props.service.get_item_break_finished_at().format(t),")")),React.createElement("tr",{className:"service-row"},React.createElement("td",{className:"wrap"},this.render_service_name()),React.createElement("td",{className:"service-finish short-cell"},React.createElement("span",{className:"light_text2"},EventComponents.t("services.reserved_time"),":")," ",this.props.service.get_item_duration_after_break()," ",EventComponents.t("minutes_short")," ","(",this.props.service.get_item_break_finished_at().format(e)," - ",this.props.service.get_finished_at().format(t),")")))},render_show_mode_without_break:function(e,t){return React.createElement("tbody",null,React.createElement("tr",{className:"service-row"},React.createElement("td",{className:"wrap"},this.render_duration_before_info(),this.render_service_name(),this.render_duration_after_info()),React.createElement("td",{className:"service-finish short-cell"},React.createElement("span",{className:"light_text2"},EventComponents.t("services.reserved_time"),":")," ",this.props.service.item_duration," ",EventComponents.t("minutes_short")," ","(",this.props.service.started_at.format(e)," - ",this.props.service.get_finished_at().format(t),")")))},render_duration_before_info:function(){if(this.state.has_duration_before)return React.createElement("div",null,EventComponents.t("services.duration_before"),":"," ",this.props.service.get_item_duration_before()," ",EventComponents.t("minutes_short"))},render_duration_after_info:function(){if(this.state.has_duration_after)return React.createElement("div",null,EventComponents.t("services.duration_after"),":"," ",this.props.service.get_item_duration_after()," ",EventComponents.t("minutes_short"))},render_edit_mode:function(e,t){return this.state.has_break?this.render_edit_mode_with_break(e,t):this.render_edit_mode_without_break(e,t)},render_edit_mode_with_break:function(e,t){var n=this;return React.createElement("tbody",null,this.render_duration_before_row(),React.createElement("tr",{className:"service-row"},React.createElement("td",{className:"wrap"},this.render_service_name()),this.render_started_at_cell(e),React.createElement("td",null,React.createElement("input",{type:"number",className:"duration-input",defaultValue:this.props.service.get_item_duration_before_break(),onBlur:function(e){n.update_duration_before_break(e)}})," ",EventComponents.t("minutes_short")),React.createElement("td",null)),React.createElement("tr",{className:"service-row-break"},React.createElement("td",null,EventComponents.t("services.break")),React.createElement("td",null),React.createElement("td",null,React.createElement("input",{type:"number",className:"duration-input",defaultValue:this.props.service.get_item_break_duration(),onBlur:function(e){n.update_break_duration(e)}})," ",EventComponents.t("minutes_short")),React.createElement("td",null,React.createElement("a",{href:"#",title:I18n.t("js.delete"),onClick:function(e){e.preventDefault(),n.destroy_break()}},React.createElement("span",{className:"icon sprite-delete"})))),React.createElement("tr",{className:"service-row"},React.createElement("td",{className:"wrap"},this.render_service_name()),React.createElement("td",null),React.createElement("td",null,React.createElement("input",{type:"number",className:"duration-input",defaultValue:this.props.service.get_item_duration_after_break(),onBlur:function(e){n.update_duration_after_break(e)}})," ",EventComponents.t("minutes_short")),React.createElement("td",{className:"service-finish short-cell"},React.createElement("span",{className:"light_text2"},EventComponents.t("services.finish_time"),":")," ",this.props.service.get_finished_at().format(t))),this.render_duration_after_row())},render_edit_mode_without_break:function(e,t){return React.createElement("tbody",null,this.render_duration_before_row(),React.createElement("tr",{className:"service-row"},React.createElement("td",{className:"wrap"},this.render_service_name()),this.render_started_at_cell(e),this.render_duration_cell(),React.createElement("td",{className:"service-finish short-cell"},React.createElement("span",{className:"light_text2"},EventComponents.t("services.finish_time"),":")," ",this.props.service.get_finished_at().format(t))),this.render_duration_after_row())},render_duration_before_row:function(){var e=this;if(this.state.has_duration_before)return React.createElement("tr",{className:"service-row-duration-before"},React.createElement("td",null,EventComponents.t("services.duration_before")),React.createElement("td",null),React.createElement("td",{className:"service-duration short-cell"},React.createElement("input",{type:"number",className:"duration-input",defaultValue:this.props.service.get_item_duration_before(),onBlur:function(t){e.update_duration_before(t)}})," ",EventComponents.t("minutes_short")),React.createElement("td",null,React.createElement("a",{href:"#",title:I18n.t("js.delete"),onClick:function(t){t.preventDefault(),e.destroy_duration_before()}},React.createElement("span",{className:"icon sprite-delete"}))))},render_duration_after_row:function(){var e=this;if(this.state.has_duration_after)return React.createElement("tr",{className:"service-row-duration-after"},React.createElement("td",null,EventComponents.t("services.duration_after")),React.createElement("td",null),React.createElement("td",{className:"service-duration short-cell"},React.createElement("input",{type:"number",className:"duration-input",defaultValue:this.props.service.get_item_duration_after(),onBlur:function(t){e.update_duration_after(t)}})," ",EventComponents.t("minutes_short")),React.createElement("td",null,React.createElement("td",null,React.createElement("a",{href:"#",title:I18n.t("js.delete"),onClick:function(t){t.preventDefault(),e.destroy_duration_after()}},React.createElement("span",{className:"icon sprite-delete"})))))},render_started_at_cell:function(e){return this.state.start_edit_mode?React.createElement("td",{className:"service-start time-controls short-cell"},React.createElement("input",{type:"text",ref:"start_date",className:"date-input pointer",defaultValue:this.format_started_at_date(this.props.service),onBlur:this.update_start})," ",React.createElement("input",{type:"text",ref:"start_time",className:"time-input pointer",defaultValue:this.format_started_at_time(this.props.service),onBlur:this.update_start})):React.createElement("td",{className:"service-start short-cell"},React.createElement("span",{className:"v_middle"},React.createElement("span",{className:"light_text2"},EventComponents.t("services.start_time"),":")," ",this.props.service.started_at.format(e)),React.createElement("a",{href:"#",className:"icon sprite-edit_photo_description left_space",onClick:this.set_start_edit_mode,title:EventComponents.t("change")}))},render_duration_cell:function(){var e=this;return React.createElement("td",{className:"service-duration short-cell"},React.createElement("input",{value:this.state.input_value,type:"text",className:"duration-input",onKeyUp:function(t){13===t.keyCode&&e.update_duration(t.target.value)},onChange:function(t){e.setState({input_value:t.target.value})},onBlur:function(t){e.update_duration(t.target.value)}})," ",EventComponents.t("minutes_short"))},render_service_name:function(){return React.createElement("div",{className:"service-name "},ComponentHelpers.Services.get_full_service_name(this.props.service,{bare_name_for_unknown_service:!this.props.finalization}))},getInitialState:function(){var e=this.props.service.get_item_duration_before()>0||this.props.service.get_item_duration_after()>0;return{input_value:this.props.service.item_duration,start_edit_mode:!1,has_break:this.props.service.get_item_break_offset()>0&&this.props.service.get_item_break_duration()>0,has_duration_before:e,has_duration_after:e}},componentWillReceiveProps:function(e){e.service.item_duration!==NumberUtils.parse_integer(this.state.input_value)&&this.setState({input_value:e.service.item_duration}),this.refs.start_date&&(ReactDOM.findDOMNode(this.refs.start_date).value=this.format_started_at_date(e.service)),this.refs.start_time&&(ReactDOM.findDOMNode(this.refs.start_time).value=this.format_started_at_time(e.service))},componentDidUpdate:function(e,t){var n=this;this.state.start_edit_mode&&!t.start_edit_mode&&(this.get_start_date_input().datepicker({inline:!1,showOtherMonths:!0,selectOtherMonths:!0,dateFormat:DateUtils.get_date_format("default_datepicker"),onSelect:function(){n.update_start()}}),this.get_start_time_input().timepicker({minTime:"06:00",maxTime:"22:00",timeFormat:DateUtils.get_timepicker_time_format(),separator:":",step:EventComponents.get_slot_length_in_minutes(),disableTouchKeyboard:!0,className:"event-service-duration"}).on("hideTimepicker",function(){n.update_start()}))},format_started_at_date:function(e){return DateUtils.format_date(e.started_at)},format_started_at_time:function(e){return DateUtils.format_time(e.started_at)},is_first_service:function(){return 0===this.props.event.services.indexOf(this.props.service)},is_last_service:function(){return this.props.event.services.indexOf(this.props.service)===this.props.event.services.length-1},move_services_after_current_inclusive_by:function(e){return this.is_first_service()||this.props.event_time_manager.move_services(e,{min_start:this.props.service.started_at}),this.props.on_event_change()},move_services_after_current_by:function(e){this.is_last_service()||this.props.event_time_manager.move_services(e,{min_start:this.props.service.get_finished_at(),excluded_service_key:this.props.service.key}),this.props.on_event_change()},update_start:function(){var e=this.get_start_date_input().val()+" "+this.get_start_time_input().val();this.props.service.started_at=moment(e,DateUtils.get_datetime_format()),this.props.event_time_manager.fix_event_time(),this.props.on_event_change()},get_start_date_input:function(){return e(ReactDOM.findDOMNode(this.refs.start_date))},get_start_time_input:function(){return e(ReactDOM.findDOMNode(this.refs.start_time))},set_start_edit_mode:function(e){e.preventDefault(),this.setState({start_edit_mode:!0})},update_duration:function(e){this.state.input_value=e;var t=this.props.service.item_duration,n=this.props.service.get_finished_at();e=NumberUtils.parse_integer(e),e<0&&(e*=-1),this.props.service.item_duration=e;var a=this.props.service.item_duration-t;this.props.event_time_manager.move_services(a,{min_start:n,excluded_service_key:this.props.service.key}),this.props.on_event_change()},update_duration_before:function(e){var t=this.props.service.get_item_duration_before(),n=NumberUtils.parse_integer(e.target.value);this.props.service.item_duration_before=n,this.move_services_after_current_inclusive_by(n-t)},update_duration_after:function(e){var t=this.props.service.get_item_duration_after(),n=NumberUtils.parse_integer(e.target.value);this.props.service.item_duration_after=n,this.move_services_after_current_by(n-t)},update_break_duration:function(e){var t=this.props.service.get_item_break_duration(),n=NumberUtils.parse_integer(e.target.value);this.props.service.item_break_duration=n,this.update_duration(this.props.service.item_duration+n-t)},update_duration_before_break:function(e){var t=this.props.service.get_item_duration_before_break(),n=NumberUtils.parse_integer(e.target.value);this.props.service.item_break_offset=n,this.update_duration(this.props.service.item_duration+n-t)},update_duration_after_break:function(e){var t=this.props.service.get_item_duration_before_break()+this.props.service.get_item_break_duration()+NumberUtils.parse_integer(e.target.value);this.update_duration(t)},destroy_duration_before:function(){var e=this.props.service.get_item_duration_before();this.props.service.item_duration_before=0,this.state.has_duration_before=!1,this.move_services_after_current_inclusive_by(-e)},destroy_duration_after:function(){var e=this.props.service.get_item_duration_after();this.props.service.item_duration_after=0,this.state.has_duration_after=!1,this.move_services_after_current_by(-e)},destroy_break:function(){var e=this.props.service.item_duration-this.props.service.get_item_break_duration();this.props.service.item_break_offset=0,this.props.service.item_break_duration=0,this.state.has_break=!1,this.update_duration(e)}})}(jQuery),EventComponents.EventServiceGeneral=function(){return React.createClass({render:function(){return React.createElement("tbody",null,this.render_service_row())},render_service_row:function(){return React.createElement("tr",null,this.render_service_name(),this.render_price_cell(),this.render_employee_cell(),this.props.delete_cell)},render_service_name:function(){var e=this.props.service.get_item_break_offset()>0&&this.props.service.get_item_break_duration()>0;return React.createElement("td",{className:"wrap"},this.render_duration_before(),React.createElement("div",{className:"service-name e2e-service-name"},ComponentHelpers.Services.get_full_service_name(this.props.service,{bare_name_for_unknown_service:!this.props.finalization})),e&&React.createElement("div",null,React.createElement("div",{className:"service-break"},React.createElement("div",{className:"small"},EventComponents.t("services.break"),": ",this.props.service.get_item_break_duration()," ",EventComponents.t("minutes_short"))),React.createElement("div",{className:"service-name"},this.render_service_name_with_breaks())),this.render_duration_after())},render_service_name_with_breaks:function(){return React.createElement("span",null,this.props.service.name)},render_duration_before:function(){if(this.props.service.get_item_duration_before()>0)return React.createElement("div",{className:"small"},EventComponents.t("services.duration_before"),":"," ",this.props.service.get_item_duration_before()," ",EventComponents.t("minutes_short"))},render_duration_after:function(){if(this.props.service.get_item_duration_after()>0)return React.createElement("div",{className:"small"},EventComponents.t("services.duration_after"),":"," ",this.props.service.get_item_duration_after()," ",EventComponents.t("minutes_short"))},render_price_cell:function(){var e;if(!this.props.finalization)return null;if(this.props.event_edition_enabled){var t=React.createElement("input",{ref:"price",type:"text",className:"price-input",onChange:this.update_price});e=this.props.service.paid&&!this.state.price_edit_mode?React.createElement("span",null,React.createElement("span",{className:"light_text2"},EventComponents.t("paid"),":"),NumberUtils.format_price(this.props.service.price),React.createElement("a",{href:"#",className:"icon sprite-edit_photo_description left_space",onClick:this.set_price_edit_mode,title:EventComponents.t("change")})):React.createElement("span",null,CurrencyUtils.react_with_symbol(t))}else e=React.createElement("span",null,React.createElement("span",{className:"light_text2"},EventComponents.t("price"),": "),NumberUtils.format_price(this.props.service.price));return React.createElement("td",{className:"price-cell short-cell"},e)},getInitialState:function(){return{price_edit_mode:this.props.service.price_changed||!1}},set_price_edit_mode:function(e){e.preventDefault(),this.setState({price_edit_mode:!0})},render_employee_cell:function(){var e;if(!this.props.event_edition_enabled&&VersumConfig.medical_office){var t;this.props.service.can_update_medical_examination&&(this.props.event.customer_id||this.props.service.medical_examination_started)&&!window.VersumConfig.current_branch_readonly?t=this.medicalExaminationEnabledButton():this.props.service.is_medical_service&&(t=this.medicalExaminationDisabledButton()),e=React.createElement("div",{className:"d-flex text-right"},t&&React.createElement("div",{className:"mr-xs"},t),React.createElement("div",null,this.simpleServiceEmployee(),this.simpleServiceResource()))}else if("overlay"===this.props.view_type){var n;n=!this.props.finalization&&this.props.event_edition_enabled?this.serviceEmployee():this.simpleServiceEmployee(),e=React.createElement("span",null,React.createElement("span",{className:"light_text2"},EventComponents.t("services.employee"),":")," ",n)}else e=React.createElement("div",null,this.simpleServiceEmployee(),this.simpleServiceResource());return React.createElement("td",{className:"employee-cell short-cell"},e)},simpleServiceResource:function(){if(VersumConfig.resources_activated)return React.createElement(EventComponents.SimpleServiceResources,{service:this.props.service,on_click:this.show_resources_modal,event_edition_enabled:this.props.event_edition_enabled})},simpleServiceEmployee:function(){return React.createElement("span",{className:"right_space"},React.createElement(EventComponents.SimpleServiceEmployee,{service:this.props.service,on_click:this.show_resources_modal,event_edition_enabled:this.props.event_edition_enabled}))},serviceEmployee:function(){return React.createElement(EventComponents.ServiceEmployee,{service:this.props.service,employees_with_calendar:this.props.employees_with_calendar,on_service_change:this.props.on_service_change,event_edition_enabled:this.props.event_edition_enabled})},medicalExaminationEnabledButton:function(){return this.props.service.medical_examination_finished?React.createElement("a",{href:"#",className:"btn",onClick:this.redirectMedicalExaminationOnClick},this.getMedicalExaminationButtonName()):React.createElement("a",{href:this.getMedicalExaminationUrl(),className:"btn",target:"_blank",rel:"noopener noreferrer"},this.getMedicalExaminationButtonName())},medicalExaminationDisabledButton:function(){return React.createElement("span",{"data-toggle":"tooltip",title:I18n.t("js.medical.disabled_button_tooltip"),"data-desktop-tooltip":!0,"data-container":"body",className:"d-block"},React.createElement("button",{type:"button",className:"btn btn-no-events",disabled:"disabled"},I18n.t("js.medical.examination_disabled")))},getMedicalExaminationButtonName:function(){return this.props.service.medical_examination_finished?I18n.t("js.medical.finished_examination_details"):this.props.service.medical_examination_started?I18n.t("js.medical.continue_examination"):I18n.t("js.medical.start_examination")},getMedicalExaminationUrl:function(){return this.props.service.medical_examination_finished?"/medical/examinations/"+this.props.service.medical_examination_id:"/medical/examinations/start?event_item_id="+this.props.service.event_service_id},redirectMedicalExaminationOnClick:function(e){e.preventDefault(),MedicalModal.run_medical_dialog(this.getMedicalExaminationUrl())},componentDidMount:function(){this.update_price_input()},componentDidUpdate:function(){this.update_price_input()},update_price_input:function(){if(this.refs.price){var e=ReactDOM.findDOMNode(this.refs.price);NumberUtils.parse_price(e.value)!==this.props.service.price&&(e.value=NumberUtils.format_price_for_input(this.props.service.price))}},show_resources_modal:function(){var e=this;!this.props.finalization&&this.props.service.is_unknown()?CalendarModels.create_default_event_resources_modal(this.props.event,{employees_with_calendar:this.props.employees_with_calendar,resources:this.props.resources,event_edition_enabled:this.props.event_edition_enabled,on_set_edit_mode:this.props.set_edit_mode,hide_actions:this.props.hide_actions}).run().always(function(){e.props.on_service_change()}):CalendarModels.create_service_resources_modal(this.props.service,{event_editable:this.props.event.editable,employees_with_calendar:this.props.employees_with_calendar,resources_by_item_id:this.props.resources_by_item_id,resources:this.props.resources,event_edition_enabled:this.props.event_edition_enabled,on_set_edit_mode:this.props.set_edit_mode,on_service_change:this.props.on_service_change,hide_actions:this.props.hide_actions,modal_title:ComponentHelpers.Services.get_full_service_name_str(this.props.service,{bare_name_for_unknown_service:!this.props.finalization})}).run().always(function(){e.props.on_service_change()})},update_price:function(e){this.props.service.price=NumberUtils.parse_price(e.target.value),this.props.service.price_changed=!0,this.props.on_service_change()}})}(jQuery),EventComponents.EventServiceResources=function(e){return React.createClass({render:function(){return this.state.available_resources=this.props.resources,React.createElement("div",null,React.createElement("div",{className:"data_table resources-table"},React.createElement("table",null,React.createElement("tbody",null,this.render_table_body()))),this.render_footer())},render_table_body:function(){if(this.props.service.resources.length>0){var t=this;return e.map(this.props.service.resources,function(n,a){var r=t.find_recipe(t.props.service.requiredResources,n),s=r&&r.single?t.find_recipe_resources(r):[],i=e.map(s,function(e){return e.id});return i.length||(i=[n.id]),t.state.available_resources=e.grep(t.state.available_resources||[],function(t){return-1===e.inArray(t.id,i)}),React.createElement(EventComponents.EventServiceResource,{key:n.id,resource:n,recipe_resources:s,event_edition_enabled:t.props.event_edition_enabled,on_resource_change:t.on_resource_change(a),delete_resource:t.delete_resource(a)})})}return React.createElement("tr",null,React.createElement("td",null,EventComponents.t("resources.no_resources")))},render_footer:function(){if(this.props.event_edition_enabled&&this.state.available_resources.length)return React.createElement("div",{className:"resource-controls"},this.render_new_resource_controls())},render_new_resource_controls:function(){return this.state.edit_mode?React.createElement("input",{ref:"resource_select",type:"hidden"}):React.createElement("button",{className:"button",type:"button",onClick:this.set_edit_mode},EventComponents.t("resources.add_resource"))},getInitialState:function(){return{edit_mode:!1}},componentWillUpdate:function(t,n){if(!n.edit_mode&&this.refs.resource_select){var a=e(ReactDOM.findDOMNode(this.refs.resource_select));a.data("select2")&&a.select2("destroy")}},componentDidUpdate:function(){this.init_select()},set_edit_mode:function(e){e.preventDefault,this.setState({edit_mode:!0})},init_select:function(){if(this.refs.resource_select){var t=this,n=e(ReactDOM.findDOMNode(this.refs.resource_select));n.data("select2")||n.versum_select2({width:350,data:e.map(this.state.available_resources,function(e){return{id:e.id,text:e.name}})}).on("change",function(){var a=n.select2("data"),r=e.extend({},e.grep(t.props.resources,function(e){return e.id===a.id})[0],{switchable:!1});t.props.service.resources.push(r),t.props.on_service_change()}).on("select2-close",function(){n.data("select2")&&setTimeout(function(){t.setState({edit_mode:!1})},100)}).select2("open")}},find_recipe:function(t,n){if(t)for(var a=0;a<t.length;a++){var r=t[a];if(-1!==e.inArray(n.resource_item_id,r.item_ids))return r}return null},find_recipe_resources:function(t){var n=this;return e.map(t.item_ids,function(e){return n.props.resources_by_item_id[e]})},on_resource_change:function(e){var t=this;return function(n){t.props.service.resources[e]=n,t.props.on_service_change()}},delete_resource:function(e){var t=this;return function(n){n.preventDefault(),t.props.service.resources.splice(e,1),t.props.on_service_change()}}})}(jQuery),EventComponents.EventServiceResource=function(e){return React.createClass({render:function(){return this.props.recipe_resources.length&&this.props.event_edition_enabled?React.createElement("tr",null,React.createElement("td",{className:"wrap"},EventComponents.t("resources.resource_group")," ","(",e.map(this.props.recipe_resources,function(e){return e.name}).join(", "),")"),React.createElement("td",null,EventComponents.t("resources.selected_resource"),": ",this.render_selected_resource()),this.render_delete_cell()):React.createElement("tr",null,React.createElement("td",{className:"wrap",colSpan:"2"},this.props.resource.name),this.render_delete_cell())},render_selected_resource:function(){if(this.props.event_edition_enabled){var t=this.props.resource.switchable?"any":this.props.resource.id;return React.createElement("select",{value:t,ref:"resource_select"},React.createElement("option",{value:"any"},EventComponents.t("resources.any_resource")),e.map(this.props.recipe_resources,function(e){return React.createElement("option",{value:e.id,key:e.id},e.name)}))}return this.props.resource.name},render_delete_cell:function(){if(this.props.event_edition_enabled)return React.createElement("td",{className:"delete-item-cell"},React.createElement("a",{onClick:this.props.delete_resource,href:"#"},React.createElement("i",{className:"icon sprite-delete"})))},componentDidMount:function(){this.init_select()},componentDidUpdate:function(){this.init_select()},init_select:function(){if(this.refs.resource_select){var t=this,n=e(ReactDOM.findDOMNode(this.refs.resource_select));n.data("select2")||n.versum_select2({width:150}).on("change",function(){var a,r=n.select2("data");a="any"===r.id?e.extend({},t.props.recipe_resources[0],{switchable:!0}):e.extend({},e.grep(t.props.recipe_resources,function(e){return String(e.id)===r.id})[0],{switchable:!1}),t.props.on_resource_change(a)})}}})}(jQuery),EventComponents.EventServiceSupplyUse=function(){return React.createClass({render:function(){return this.init_supply_use(),React.createElement("tr",null,React.createElement("td",{className:"box-cell"},React.createElement(EventComponents.OrderProducts,{event_edition_enabled:this.props.event_edition_enabled,order:this.props.service.supply_use,on_last_item_deletion:this.set_empty_supply_use,on_order_change:this.on_supply_use_change,is_sale:!1})))},init_supply_use:function(){this.props.service.supply_use=this.props.service.supply_use||this.create_empty_supply_use()},set_empty_supply_use:function(){this.props.service.supply_use=this.create_empty_supply_use(),this.on_supply_use_change()},on_supply_use_change:function(){this.props.service.supply_use_updated=!0,this.props.on_service_change()},create_empty_supply_use:function(){return CalendarModels.create_order({products:[]})}})}(jQuery),EventComponents.EventServices=function(e){return React.createClass({render:function(){return React.createElement("div",null,this.render_table(),this.render_footer())},render_service:function(e,t){var n=this;switch(this.get_current_tab()){case"general":return React.createElement(EventComponents.EventServiceGeneral,{event:this.props.event,service:e,key:e.key,index:t,delete_cell:this.render_delete_cell(e.id,t),on_service_change:this.props.on_event_change,event_edition_enabled:this.props.event_edition_enabled,employees_with_calendar:this.props.employees_with_calendar,resources_by_item_id:this.resources_by_item_id(),resources:this.props.resources,finalization:this.props.finalization,view_type:this.props.view_type,set_edit_mode:this.props.set_edit_mode,hide_actions:this.props.hide_actions});case"duration":return React.createElement(EventComponents.EventServiceDuration,{event:this.props.event,service:e,on_event_change:n.props.on_event_change,key:e.key,event_edition_enabled:this.props.event_edition_enabled,event_time_manager:this.props.event_time_manager,finalization:this.props.finalization});case"resources":return React.createElement("tbody",{key:e.key},React.createElement("tr",{className:"with-lower-row"},React.createElement("td",{className:"service-name wrap"},ComponentHelpers.Services.get_full_service_name(e,{bare_name_for_unknown_service:!this.props.finalization}))),React.createElement("tr",{key:"service_resources_"+e.key},React.createElement("td",{className:"box-cell"},React.createElement(EventComponents.EventServiceResources,{service:e,resources_by_item_id:this.resources_by_item_id(),on_service_change:n.props.on_event_change,key:"service_resources_"+e.key,resources:this.props.resources,event_edition_enabled:this.props.event_edition_enabled}))));case"supply_use":return React.createElement("tbody",{key:e.key},React.createElement("tr",{className:"with-lower-row"},React.createElement("td",{className:"service-name wrap"},ComponentHelpers.Services.get_full_service_name(e,{bare_name_for_unknown_service:!this.props.finalization}))),React.createElement(EventComponents.EventServiceSupplyUse,{key:"service_supply_use_"+e.key,service:e,on_service_change:this.props.on_event_change,event_edition_enabled:this.props.event_edition_enabled}))}},render_table:function(){if(this.get_services().length>0)return React.createElement("div",{className:"tabbed-table"},this.render_tabs(),React.createElement("div",{className:"table-wrapper"},this.render_table_element()))},render_tabs:function(){var t=this;if("overlay"===this.props.view_type){var n=VersumConfig.resources_activated&&(this.props.resources||[]).length>0?["general","duration","resources","supply_use"]:["general","duration","supply_use"];return React.createElement("div",{className:"tabs clearfix"},e.map(n,function(e){if("supply_use"===e)return t.render_supply_use_tab();var n="tab";return t.get_current_tab()===e&&(n+=" active"),React.createElement("a",{href:"#",className:n,key:e,onClick:t.set_tab(e)},React.createElement("span",{className:"icon mr-s "+ComponentHelpers.Services.get_icon_class_for_tab(e)}),EventComponents.t("services.tabs."+e))}))}},render_table_element:function(){var t=this;return React.createElement("table",{className:"e2e-services-table"},e.map(this.get_services(),function(e,n){return t.render_service(e,n)}))},
render_supply_use_tab:function(){var e="tab";"supply_use"===this.get_current_tab()&&(e+=" active");for(var t=this.props.event.services,n=0,a=0;a<t.length;a++){var r=t[a];r.supply_use&&(n+=r.supply_use.products.length)}return 0!==n||this.props.event_edition_enabled||(e+=" empty"),React.createElement("a",{href:"#",className:e,key:"supply_use",onClick:this.set_tab("supply_use")},React.createElement("span",{className:"icon mr-s "+ComponentHelpers.Services.get_icon_class_for_tab("supply_use")}),EventComponents.t("services.tabs.supply_use")," ","(",n,")")},render_footer:function(){if(this.props.finalization||0!==this.get_services().length){if(this.service_select_shown())return React.createElement("div",{className:"service-controls full-length"},this.render_new_service_controls());var e;return 0===this.get_services().length&&(e=React.createElement("span",{className:"left_space"},this.render_default_resources())),React.createElement("div",{className:"row"},React.createElement("div",{className:this.props.event.services.length?"col-sm-6 d-flex":"col-sm-6"},React.createElement("div",{className:"d-flex mb-s mr-s"},this.render_new_service_controls(),e),this.render_sales_controls()),React.createElement("div",{className:"col-sm-6 services-footer-extra"},this.render_footer_right_col()))}return React.createElement("div",{className:"v2-row v2-row-s"},React.createElement("span",{className:"v2-col v2-col-sm-9"},this.render_new_service_controls()),React.createElement("span",{className:"v2-col-auto v2-col-sm-3"},this.render_default_resources()))},render_footer_right_col:function(){var e=this.get_current_tab();return 0===this.get_services().length?React.createElement("span",null):"general"===e?React.createElement("div",{className:"services-total items-value"},EventComponents.t("services.total"),":\xa0",React.createElement("span",{className:"value"},this.format_total_price())):"duration"===e?React.createElement("div",{className:"services-total items-value"},EventComponents.t("services.total_time"),":"," ",React.createElement("span",{className:"value"},this.props.event.get_total_services_duration()," ",EventComponents.t("minutes_short"))," ",React.createElement("small",null,"(",EventComponents.t("services.default_time"),":"," ",this.props.event.get_default_services_duration()," ",EventComponents.t("minutes_short"),")")):void 0},render_default_resources:function(){return React.createElement(EventComponents.DefaultEventResources,{event:this.props.event,employees_with_calendar:this.props.employees_with_calendar,resources:this.props.resources,on_event_change:this.props.on_event_change,set_edit_mode:this.props.set_edit_mode,event_edition_enabled:this.props.event_edition_enabled})},render_new_service_controls:function(){var e=this.props.event.id||"new",t="sb-"+e;return _.set(window,"reactLegacyBridge.servicesBrowser.components["+t+"]",{branchCategoryPath:this.props.event.branch_category_path,isBooksyPossible:this.props.event.is_booksy_possible,employee:this.props.event.employee,hasAddedServices:!!this.get_services().length,selectService:this.onServiceSelect}),this.props.event_edition_enabled?(window.reactLegacyBridge.servicesBrowser.renderServicesBrowser(t),React.createElement("div",{id:t})):React.createElement("span",null)},render_sales_controls:function(){if(this.props.event_edition_enabled&&this.props.finalization&&!this.service_select_shown())return VersumConfig.gift_cards_activated?this.render_sales_dropdown():this.render_order_button()},render_sales_dropdown:function(){var e,t,n,a,r=this;if(this.props.products_shown||(e=React.createElement("li",null,React.createElement("a",{href:"#",onClick:function(e){e.preventDefault(),r.props.init_products()}},EventComponents.t("services.product_sale")))),VersumConfig.gift_cards_activated&&(this.props.gift_cards_shown||(t=React.createElement("li",null,React.createElement("a",{href:"#",onClick:function(e){e.preventDefault(),r.props.init_gift_cards()}},EventComponents.t("services.gift_card_sale")))),this.props.packages_shown||(n=React.createElement("li",null,React.createElement("a",{href:"#",onClick:function(e){e.preventDefault(),r.props.init_packages()}},EventComponents.t("services.package_sale")))),this.props.carnets_shown||(a=React.createElement("li",null,React.createElement("a",{href:"#",onClick:function(e){e.preventDefault(),r.props.init_carnets()}},EventComponents.t("services.carnet_sale"))))),e||t||n)return React.createElement("span",{className:"dropdown left_space"},React.createElement("a",{href:"#","data-toggle":"dropdown",className:"btn dropdown-toggle"},EventComponents.t("services.add_sale")," ",React.createElement("b",{className:"caret"})),React.createElement("ul",{className:"dropdown-menu larger-dropdown-menu"},e,t,n,a))},render_order_button:function(){if(!this.props.products_shown)return React.createElement("button",{className:"btn",type:"button",onClick:this.props.init_products},EventComponents.t("services.add_sale"))},render_delete_cell:function(e,t){if(this.props.event_edition_enabled)return React.createElement("td",{className:"text-right delete-cell"},React.createElement("a",{href:"#",className:"e2e-delete-service",onClick:this.delete_service(e,t)},React.createElement("i",{className:"icon sprite-delete"})))},getInitialState:function(){return{edit_mode:!1,tab:"general",servicesBrowserIsVisible:!1}},componentDidMount:function(){this._mounted=!0;var e=this,t=this;t.props.services_for_select_manager&&t.props.services_for_select_manager.get_services_tree().then(function(n){for(var a=n.services,r={},s=0;s<a.length;s++)for(var i=0;i<a[s].variants.length;i++)r[a[s].variants[i].id]=a[s].variants[i];e._mounted&&t.setState({servicesFetchedData:{services:a,servicesById:r}})})},componentWillUnmount:function(){this._mounted=!1},get_current_tab:function(){return"overlay"===this.props.view_type?this.state.tab:"general"},service_select_shown:function(e,t){return e=e||this.props,t=t||this.state,e.event_edition_enabled&&(t.edit_mode||!e.finalization&&0===this.get_services().length)},onServiceSelect:function(t){var n=this,a=t,r=n.props.event.employee&&t.durationsByEmployeeId[n.props.event.employee.id];a.duration=r||a.duration,a.requiredResources=a.requiredResources||[];var s,i=n.props.event.services;if(i.length){var o=i[i.length-1];s=moment(o.get_finished_at()).add(o.get_item_duration_after()+a.durationBefore,"minutes")}else s=moment(n.props.event.beginning);a=e.extend({},a,{employee:n.props.event.employee?e.extend({},n.props.event.employee):null,resources:n.get_resources_for_new_service(a),duration:parseInt(a.duration),price:NumberUtils.parse_price(a.price),default_price:NumberUtils.parse_price(a.price),default_price_max:NumberUtils.parse_price(a.price_max),key:ComponentHelpers.Keys.get_unique_key(),lumo_standard_conversion:"true"===String(a.lumo_standard_conversion),item_duration:parseInt(a.duration),item_duration_before:a.durationBefore,item_duration_after:a.durationAfter,item_break_offset:a.breakOffset,item_break_duration:a.breakDuration,started_at:s}),t=CalendarModels.create_service(a),t.discount.activate(),n.add_service(t)},get_services:function(){return this.props.event.services},get_formulas_for_service:function(t){var n=this,a=this.props.formula_manager.get_formulas_for_service(t),r=e.Deferred();return a?r.resolve(a):(VersumUtils.show_indicator(),e.ajax({url:"/services/formulas/for_calendar_events",type:"get",dataType:"json",cache:!1,data:{service_ids:[t]}}).done(function(e){VersumUtils.hide_indicator(),n.props.formula_manager.update_formulas_data(e),r.resolve(e[t]||[])})),r.promise()},add_service:function(t){var n=this;this.props.before_service_addition(),this.get_services().push(t),this.props.event_time_manager.fix_event_time(),this.props.on_services_change(),this.get_formulas_for_service(t.id).done(function(a){if(a.length>0){var r=e.map(a,function(e){return CalendarModels.create_product_from_formula(e)});t.supply_use=CalendarModels.create_order({products:r})}n.props.after_service_addition()})},format_total_price:function(){return NumberUtils.format_price(this.props.event.get_total_services_price())},format_total_prepayment_amount:function(){return this.props.event.get_total_services_prepayment_amount()},set_edit_mode:function(){this.setState({edit_mode:!0})},delete_service:function(e,t){var n=this;return function(e){e&&e.preventDefault();var a,r=n.get_services(),s=r[t];if(0!==t)a=!0;else if(s.employee&&s.employee.id){a=!0;for(var i=0;i<r.length;i++){var o=r[i];if(!o.employee||o.employee.id!==s.employee.id){a=!1;break}}}else a=!1;var c=0;if(r[t+1]&&r[t-1]?(c+=s.item_duration_after||0,c+=s.item_duration_before||0):r[t+1]?(c+=s.item_duration_after||0,c+=r[t+1].item_duration_before||0):r[t-1]&&(c+=s.item_duration_before||0,c+=r[t-1].item_duration_after||0),r.splice(t,1),a){var _=-1*(s.item_duration+c),p=s.get_finished_at();n.props.event_time_manager.move_services(_,{min_start:p})}else n.props.event_time_manager.fix_event_time();n.props.on_services_change()}},set_tab:function(e){var t=this;return function(n){n.preventDefault(),t.setState({tab:e})}},get_resources_for_new_service:function(e){var t=[],n={};this.props.event.default_resource&&(t.push(this.props.event.default_resource),n[this.props.event.default_resource.resource_item_id]=!0);for(var a=0;a<e.requiredResources.length;a++){var r=e.requiredResources[a];this.is_whole_recipe_included(r,n)||this.push_recipe(r,t,n)}return t},is_whole_recipe_included:function(e,t){if(e.optional)for(var n=0;n<=e.item_ids.length;n++){var a=e.item_ids[n];if(t[a])return!0}return!1},push_recipe:function(t,n,a){for(var r=this.get_shuffled_item_ids(t),s=0;s<=r.length;s++){var i=r[s];if(!a[i]){var o=this.get_resource_by_item_id(i);if(o&&(n.push(e.extend({},o,{switchable:t.optional})),a[i]=!0,t.optional))break}}},get_shuffled_item_ids:function(t){var n=ArrayUtils.shuffle(t.components).sort(function(e,t){return e.priority-t.priority});return e.map(n,function(e){return e.item_id})},get_resource_by_item_id:function(e){return this.resources_by_item_id()[e]||null},resources_by_item_id:function(){if(this._resources_by_item_id)return this._resources_by_item_id;this._resources_by_item_id={};for(var e=0;e<(this.props.resources||[]).length;e++){var t=this.props.resources[e];this._resources_by_item_id[t.resource_item_id]=t}return this._resources_by_item_id}})}(jQuery),EventComponents.EventTags=function(e){return React.createClass({render:function(){return React.createElement("div",{className:"box-line event-tags-line"},React.createElement("div",{className:"box-line-label"},EventComponents.t("tags.tags"),":"),React.createElement("div",{className:"box-line-content"},React.createElement("div",{className:"v2-row v2-row-s"},React.createElement("div",{className:"v2-col-sm-9"},this.render_tags()))))},render_tags:function(){return this.props.event_edition_enabled?React.createElement("select",{className:"tag-field e2e-tags-select",multiple:!0,value:e.map(this.props.event.tags,function(e){return e.id}),ref:"tags_select"},e.map(this.props.all_tags,function(e){return React.createElement("option",{key:e.id,value:e.id},e.name)})):e.map(this.props.event.tags,function(e){return React.createElement("span",{key:e.id,className:"right_space tag "+e.color+" e2e-readonly-tag",title:e.title},e.title)})},componentDidMount:function(){this.init_select()},componentDidUpdate:function(){this.init_select()},init_select:function(){if(this.props.event_edition_enabled){var t=this,n=e(ReactDOM.findDOMNode(this.refs.tags_select));n.data("select2")||n.versum_select2({e2e:"e2e-tags-select"}).on("change",function(){var a=n.select2("data");t.props.event.tags=e.map(a,function(e){return{id:e.id,name:e.text}}),e("li.select2-search-choice").attr("e2e-selected-tag",""),e("li.select2-search-choice .select2-search-choice-close").attr("e2e-selected-tag-close",""),t.props.on_event_change()})}}})}(jQuery),EventComponents.EventTimeControls=function(e){return React.createClass({render:function(){var e;return this.state.edit_mode||(e=this.render_edit_time_link()),this.props.event.allday?React.createElement("span",null,React.createElement("span",{className:"time-controls right_space"},React.createElement(EventComponents.AlldayTimeControls,{event:this.props.event,on_event_change:this.props.on_event_change,edit_mode:this.state.edit_mode})),e):this.state.edit_mode?React.createElement("span",{className:"time-controls"},React.createElement("span",{className:"time-controls-line"},this.render_beginning_date_input()," ",this.render_beginning_time_input()," - "),React.createElement("span",{className:"time-controls-line"},this.render_end_date_input()," ",this.render_end_time_input()," "),React.createElement("span",{className:"time-controls-line"},this.render_duration())):this.is_same_day()?React.createElement("span",null,React.createElement("span",{className:"time-controls-info right_space"},React.createElement("span",{className:"date-font"},this.format_beginning_date()," "),this.format_beginning_time()," - ",this.format_end_time()," ",this.render_duration()),e):React.createElement("span",null,React.createElement("span",{className:"time-controls-info right_space"},React.createElement("span",{className:"date-font"},this.format_beginning_date()," "),this.format_beginning_time(),React.createElement("span",{className:"date-font"}," - ",this.format_end_date()," "),this.format_end_time()," ",this.render_duration()),e)},render_beginning_date_input:function(){var e=this;return React.createElement("input",{type:"text",className:"date-input pointer",ref:"beginning_date",onChange:function(t){e.setState({beginning_date_input_value:t.target.value})},value:this.state.beginning_date_input_value,onBlur:this.update_beginning})},render_end_date_input:function(){var e=this;return React.createElement("input",{type:"text",className:"date-input pointer",ref:"end_date",onChange:function(t){e.setState({end_date_input_value:t.target.value})},value:this.state.end_date_input_value,onBlur:this.update_end})},render_beginning_time_input:function(){var e=this;return React.createElement("input",{type:"text",className:"time-input pointer",value:this.state.beginning_time_input_value,ref:"beginning_time",onBlur:this.update_beginning,onChange:function(t){e.setState({beginning_time_input_value:t.target.value})}})},render_end_time_input:function(){var e=this;return React.createElement("input",{type:"text",className:"time-input pointer",value:this.state.end_time_input_value,ref:"end_time",onBlur:this.update_end,onChange:function(t){e.setState({end_time_input_value:t.target.value})}})},render_duration:function(){return React.createElement("span",null,"(",this.props.event.get_duration_in_minutes()," ",EventComponents.t("minutes_short"),")")},render_edit_time_link:function(){return this.props.event_edition_enabled?React.createElement("a",{href:"#",onClick:this.edit_time,className:"e2e-time-edit-button"},EventComponents.t("change")):React.createElement("span",null)},getInitialState:function(){return{initial_event_start:moment.duration(this.format_beginning_time()).asSeconds(),initial_event_end:moment.duration(this.format_end_time()).asSeconds(),edit_mode:!1}},componentWillMount:function(){this.update_date_inputs()},componentWillReceiveProps:function(){this.update_date_inputs()},componentDidMount:function(){this.init_inputs()},componentDidUpdate:function(){this.init_inputs()},init_inputs:function(){if(this.state.edit_mode&&!this.props.event.allday){var e=this;this.get_beginning_date_input().data("datepicker-attached")||(this.get_beginning_date_input().data("datepicker-attached",!0),this.get_beginning_date_input().datepicker({inline:!1,showOtherMonths:!0,selectOtherMonths:!0,dateFormat:DateUtils.get_date_format("default_datepicker"),onSelect:function(){e.update_beginning()}})),this.get_end_date_input().data("datepicker-attached")||(this.get_end_date_input().data("datepicker-attached",!0),this.get_end_date_input().datepicker({inline:!1,showOtherMonths:!0,selectOtherMonths:!0,dateFormat:DateUtils.get_date_format("default_datepicker"),onSelect:function(){e.update_end()}})),this.get_beginning_time_input().data("timepicker-attached")||(this.get_beginning_time_input().data("timepicker-attached",!0),this.get_beginning_time_input().timepicker({minTime:this.get_minimum_time(),maxTime:this.get_maximum_time(),timeFormat:DateUtils.get_timepicker_time_format(),separator:":",step:EventComponents.get_slot_length_in_minutes(),disableTouchKeyboard:!0}).on("hideTimepicker",function(){e.update_beginning()})),this.get_end_time_input().data("timepicker-attached")||(this.get_end_time_input().data("timepicker-attached",!0),this.get_end_time_input().timepicker({minTime:this.get_minimum_end_time(),maxTime:this.get_maximum_time(),showDuration:!0,timeFormat:DateUtils.get_timepicker_time_format(),separator:":",step:EventComponents.get_slot_length_in_minutes(),disableTouchKeyboard:!0,durationTime:function(){return e.get_duration_time()},lang:{mins:EventComponents.t("minutes_short"),hr:EventComponents.t("hours_short"),hrs:EventComponents.t("hours_short")}}).on("hideTimepicker",function(){e.update_end()}))}},update_date_inputs:function(){this.setState({beginning_date_input_value:DateUtils.format_date(this.get_beginning()),beginning_time_input_value:this.format_beginning_time(),end_date_input_value:DateUtils.format_date(this.get_end()),end_time_input_value:this.format_end_time()})},is_same_day:function(){var e=moment(this.get_beginning()).startOf("day"),t=moment(this.get_end()).startOf("day");return e.isSame(t)},edit_time:function(e){e.preventDefault(),this.setState({edit_mode:!0})},update_end_time_input_options:function(){this.get_end_time_input().timepicker("option",{minTime:this.get_minimum_end_time()})},update_beginning:function(){if(this.inputs_mounted()){var e=this.read_beginning_from_inputs();if(!e.isSame(this.props.event.beginning)){var t=e.diff(this.props.event.beginning,"minutes");this.props.event_time_manager.move_event_time(t),this.update_end_time_input_options(),this.on_event_date_change()}}},update_end:function(){if(this.inputs_mounted()){var e=this,t=this.props.event,n=this.read_end_from_inputs();if(!n.isSame(t.end)){if(!n.isAfter(t.beginning)){var a=EventComponents.get_slot_length_in_minutes();n=moment(t.beginning).add(a,"minutes")}var r=t.end;if(t.end=n,t.finalized_at=n,this.update_end_time_input_options(),1===t.services.length)t.services[0].item_duration=t.get_duration_in_minutes(),this.on_event_date_change();else if(t.services.length>1){this.props.service_adjusting_reverter.save_state();var s=CalendarModels.create_services_resizer(t.services,{start:t.beginning,end:n,old_end:r});s.resize(),this.props.services_adjuster.adjust().fail(function(){e.props.service_adjusting_reverter.revert()}).always(this.on_event_date_change)}else this.on_event_date_change()}}},read_beginning_from_inputs:function(){var e=this.get_beginning_date_input().val()+" "+this.get_beginning_time_input().val();return moment(e,DateUtils.get_date_format()+" "+DateUtils.get_time_format())},read_end_from_inputs:function(){var e=this.get_end_date_input().val()+" "+this.get_end_time_input().val();return moment(e,DateUtils.get_date_format()+" "+DateUtils.get_time_format())},on_event_date_change:function(){this.update_date_inputs(),this.props.on_event_change()},inputs_mounted:function(){return!!this.refs.beginning_date},format_beginning_date:function(){return DateUtils.format_date(this.get_beginning(),"with_weekday_name")},format_end_date:function(){return DateUtils.format_date(this.get_end(),"with_weekday_name")},format_beginning_time:function(){return DateUtils.format_time(this.get_beginning())},format_end_time:function(){return DateUtils.format_time(this.get_end())},get_beginning:function(){return this.props.event.beginning},get_end:function(){return this.props.event.end},get_beginning_date_input:function(){return e(ReactDOM.findDOMNode(this.refs.beginning_date))},get_end_date_input:function(){return e(ReactDOM.findDOMNode(this.refs.end_date))},get_beginning_time_input:function(){return e(ReactDOM.findDOMNode(this.refs.beginning_time))},get_end_time_input:function(){return e(ReactDOM.findDOMNode(this.refs.end_time))},get_duration_time:function(){var e=moment(this.get_beginning()).startOf("day"),t=moment(this.get_end()).startOf("day");return moment.duration(this.get_beginning_time_input().val()).asSeconds()+moment.duration(e.diff(t)).asSeconds()},get_maximum_time:function(){var e=moment.duration(get_calendar_max_time()).asSeconds();return this.state.initial_event_end>e?this.state.initial_event_end:e},get_minimum_time:function(){var e=moment.duration(get_calendar_min_time()).asSeconds();return this.state.initial_event_start<e?this.state.initial_event_start:e},get_minimum_end_time:function(){if(this.is_same_day()){var e=this.get_beginning_time_input().timepicker("getTime").getTime()+1e3*EventComponents.get_slot_length_in_minutes()*60;return new Date(e)}return this.get_minimum_time()}})}(jQuery),EventComponents.EventType=function(e,t){var n={standard:"standard",recurring:"recurring",selected_period_blockade:"selected_period_blockade",all_day_blockade:"all_day_blockade"},a={standard:I18n.t("js.event_recurrence.regular_event"),recurring:I18n.t("js.event_recurrence.recurring_event"),selected_period_blockade:EventComponents.t("blockade.label"),all_day_blockade:EventComponents.t("blockade.allday")};return React.createClass({render:function(){this.state.selected_event_type;return React.createElement("div",{className:"box-line"},React.createElement("div",{className:"box-line-label"},I18n.t("js.event_recurrence.event_type"),":"),React.createElement("div",{className:"box-line-content",id:"event-type-select-container"}))},componentDidMount:function(){this.renderSelect()},componentDidupdate:function(){this.renderSelect()},renderSelect:function(){var e=this,t=this.state.selected_event_type;window.reactLegacyBridge.eventRecurrence.renderEventTypeSelect(document.getElementById("event-type-select-container"),{defaultValue:{label:a[t],value:n[t]},options:Object.keys(n).map(function(e){return{value:e,label:a[e]}}),onChange:e.handle_event_type_change,isOptionDisabled:function(t){return t.value===n.recurring&&e.props.event.id}})},getInitialState:function(){function e(e){return{selected_event_type:e}}return this.props.event.allday||this.props.event.not_an_appointment||this.props.event.recurrence_params||this.props.event.recurrence_manager?this.props.event.recurrence_manager?e(n.recurring):!this.props.event.allday&&this.props.event.not_an_appointment?e(n.selected_period_blockade):this.props.event.allday&&this.props.event.not_an_appointment?e(n.all_day_blockade):{selected_event_type:n.standard}:e(n.standard)},handle_event_type_change:function(e){var t=document.querySelector("#event_recurrence_controls");switch(t&&t.dispatchEvent(new Event("unmount")),this.props.event.event_type_changed=!0,this.props.event.id&&this.props.event.is_recurring_event()&&(this.props.event.was_recurring_event=!0),this.state.selected_event_type=e.value,this.state.selected_event_type){case n.standard:this.switch_event_to_standard();break;case n.recurring:this.switch_event_to_recurring();break;case n.selected_period_blockade:this.switch_event_to_not_an_appointment();break;case n.all_day_blockade:this.switch_event_to_all_day();break;default:return}},switch_event_to_standard:function(){this.props.event.allday=!1,this.props.event.not_an_appointment=!1,this.props.event.recurrence_params=null,this.props.event.recurrence_manager=null,this.props.on_event_change()},switch_event_to_recurring:function(){var e=this.props.event,n=e.prepayment;e.allday=!1,e.not_an_appointment=!1,n&&n.gift_card&&(n.payment_method="cash",n.gift_card=t,n.clearExtraPayments()),e.recurrence_params=new reactLegacyBridge.eventRecurrence.EventRecurrenceManager.RRule({freq:reactLegacyBridge.eventRecurrence.EventRecurrenceManager.RRule.DAILY,dtstart:new Date(e.beginning.toISOString()),count:10,interval:1}).toString(),e.recurrence_manager=new reactLegacyBridge.eventRecurrence.EventRecurrenceManager(e),this.props.on_event_change()},switch_event_to_not_an_appointment:function(){this.props.event.not_an_appointment&&(this.props.event.services=[]),this.props.event.allday=!1,this.props.event.not_an_appointment=!0,this.props.event.recurrence_params=null,this.props.event.recurrence_manager=null,this.props.event.not_an_appointment||(this.props.event.allday=!1),this.props.on_event_change()},switch_event_to_all_day:function(){this.props.event.allday=!0,this.props.event.allday&&(this.props.event.not_an_appointment=!0,this.props.event.recurrence_params=null,this.props.event.recurrence_manager=null,this.props.event.allday_beginning=moment(this.props.event.beginning).startOf("day"),this.props.event.allday_end=moment(this.props.event.end).add(1,"day").subtract(1,"second").startOf("day")),this.props.on_event_change()}})}(jQuery),EventComponents.FinalizationScreen=function(e,t){return React.createClass({render:function(){var t=this,n=this.state.events,a=t.state.error_messages,r=this.get_total_price();this.state.group.price=r;var s=this.get_total_price_after_discount(r),i=this.get_total_prepayment_amount_paid(),o=classNames({"event-screen":!0,"overlay-content":!0,"edit-mode":this.state.edit_mode,"show-mode":!this.state.edit_mode,"in-overlay":!0});return React.createElement("div",{className:o},this.render_title_container(),this.render_errors(),React.createElement("div",{className:"event-boxes"},e.map(n,function(e,r){var s=e.selected?"selected_event_box":"event_box_"+e.id,i=a&&a.events?a.events[e.id]||{}:{};return React.createElement(EventComponents.EventBox,{event:e,key:e.id,ref:s,all_employees:t.props.all_employees,employees_with_calendar:t.props.employees_with_calendar,resources:t.props.resources,all_tags:t.props.all_tags,on_event_change:t.update_state,index:r,remove_event:t.remove_event,formula_manager:t.props.formula_manager,error_messages:i,before_service_addition:t.before_service_addition,after_service_addition:t.after_service_addition,event_edition_enabled:t.state.edit_mode,on_lumo_state_change:t.on_lumo_state_change,events_number:n.length,group_discount:t.state.group.discount,finalization:!0,view_type:"overlay",on_screen_close:t.on_screen_close,set_edit_mode:t.set_edit_mode,on_arrived_tag_change:t.props.on_arrived_tag_change,on_beginning_date_change:t.props.on_beginning_date_change,services_for_select_manager:t.props.services_for_select_manager,hide_actions:t.props.hide_actions,customer_edition_enabled:t.props.customer_edition_enabled,gift_cards_counts_for_customers_store:t.state.gift_cards_counts_for_customers_store,package_type_certificate:t.props.package_type_certificate,package_type_carnet:t.props.package_type_carnet,on_prepayment_finalization_change:t.update_event_payments_state,on_prepayment_requirements_change:!t.already_finalized()&&EventComponents.check_prepayment_requirements.bind(t,e),show_prepayment_validation:t.state.show_prepayment_validation,excluded_lumo_points_percentage_for_services:t.state.excluded_lumo_points_percentage_for_services,excluded_lumo_points_percentage_for_products:t.state.excluded_lumo_points_percentage_for_products,show_overpayment:t.are_all_customers_the_same_person(),overpayment_balance:t.state.overpayment_balance,on_overpayment_change:t.handle_overpayment_change})})),this.render_event_select_button(),this.render_price_controls(r,s,i),this.render_actions())},refetch_events:function(){var e=this;EventViews.fetch_event_data({event_id:e.state.events[0].id}).then(function(t){e.setState({events:(t||{events:[]}).events.map(function(t){return e.transform_event(t)})})})},render_title_container:function(){return this.props.hide_title?React.createElement("span",null):React.createElement("div",{className:"row event-screen-title"},React.createElement("h2",{className:"col-xs-8"},this.render_title()),React.createElement("div",{className:"col-xs-4 text-right"},React.createElement("button",{type:"button",className:"btn btn-default2",title:EventComponents.t("close_title"),onClick:this.on_screen_close},EventComponents.t("close"))))},render_title:function(){var e;if(this.state.edit_mode){for(var t=this.state.events,n={},a=[],r=0;r<t.length;r++){var s=t[r].customer;s&&s.id&&!n[s.id]&&(n[s.id]=!0,a.push(s.name))}var i=this.already_finalized()?"edit":"finalize";i+=t.length>1?".events":".event",0===a.length?(i+=".no_customers",e=EventComponents.t("title."+i)):(i+=a.length>1?".customers":".customer",e=EventComponents.t("title."+i)+": "+a.join(", "))}else e=EventComponents.t("title.show");return React.createElement("span",null,e)},render_errors:function(){var t=this.state.error_messages;return t&&t.group?React.createElement("div",{className:"error-explanation"},React.createElement("h2",null,EventComponents.t("errors_occured"),":"),React.createElement("ul",null,e.map(t.group,function(e,t){return React.createElement("li",{key:t},e)}))):React.createElement("span",null)},render_event_select_button:function(){return this.already_finalized()||!this.state.edit_mode?React.createElement("span",null):React.createElement("div",{className:"add-another-event-container text-right"},React.createElement("a",{href:"#",onClick:this.show_event_select},EventComponents.t("add_another_event")))},render_price_controls:function(t,n,a){var r=this.state.events;if(r[0].can_access_price){for(var s=0,i=0;i<r.length;i++){r[i].is_active()&&s++}var o=s>0?{}:{display:"none"},c=this.already_finalized()||this.state.edit_mode?{}:{display:"none"};return React.createElement("div",{style:o},this.render_discount_controls(),React.createElement("div",{className:"overlay-line"},React.createElement("div",{className:"overlay-line-label"},EventComponents.t("event_price",{count:r.length}),":"),React.createElement("div",{className:"overlay-line-content"},this.render_to_be_paid(t,n))),VersumConfig.prepayments_enabled&&a>0&&React.createElement("div",{className:"overlay-line"},React.createElement("div",{className:"overlay-line-label paid-label"},EventComponents.t("payments.prepayment"),":"),React.createElement("div",{className:"overlay-line-content"},React.createElement("span",{className:"fs-h4 e2e-prepayment-amount"},NumberUtils.format_price(a)))),a>0&&React.createElement("div",{className:"overlay-line"},React.createElement("div",{className:"overlay-line-label"},EventComponents.t("to_be_paid_for_event"),":"),React.createElement("div",{className:"overlay-line-content"},React.createElement("span",{className:"fs-h4 e2e-to-be-paid-for-event"},NumberUtils.format_price(Math.max(0,n-a))))),React.createElement("div",null,React.createElement("hr",null),Tips.get_active_tips(this.state.group.tips).length>0&&React.createElement("div",{className:"overlay-line"},React.createElement("div",{className:"overlay-line-label"},EventComponents.t("tip"),":"),React.createElement("div",{className:"overlay-line-content"},React.createElement("div",null,React.createElement("span",{className:"fs-h4 e2e-tips-sum"},NumberUtils.format_price(Tips.tips_sum(this.state.group.tips))),this.state.edit_mode&&React.createElement("a",{href:"#",className:"ml-s e2e-tips-edit",onClick:this.show_tips(n)}," ",I18n.t("js.edit"))||""),React.createElement("div",null,e.map(Tips.get_active_tips(this.state.group.tips),function(e){return React.createElement("div",{key:e.key,className:"e2e-tip-preview"},React.createElement("span",{className:"light-font"}," ",NumberUtils.format_price(e.price)),React.createElement("span",{className:"light-font"}," (",Tips.payment_method_name(e.payment_method),")"),React.createElement("a",{href:"/settings/employees/"+e.employee.id}," ",e.employee.name))})))),React.createElement("div",{className:"overlay-line"},React.createElement("div",{className:"overlay-line-label strong e2e-price-to-pay-label"},EventComponents.t(this.already_finalized()?"payments.paid":"to_be_paid"),":"),React.createElement("div",{className:"overlay-line-content"},React.createElement("span",{className:"fs-h4 strong e2e-price-to-pay"},NumberUtils.format_price(Math.max(0,this.get_price_to_pay())),this.render_tips_button(n))))),React.createElement("div",{style:c},React.createElement(EventComponents.EventPayments,{ref:"event_payments",on_change:this.on_payments_change,event_ids:e.map(this.state.events,function(e){return e.id}),event_edition_enabled:this.state.edit_mode,already_finalized:this.already_finalized(),price:n,initial_payments:this.state.initial_payments,hide_balance:!0,use_gift_cards:!0,use_packages:!0,customers:e.map(this.state.events,function(e){if(e.customer&&e.customer.id)return e.customer}),services:e.map(this.state.events,function(e){return e.services}),tips:this.state.group.tips,tips_employees:this.props.all_employees,tips_default_employee:this.get_first_employee(),prepayment_amount:a,hide_details_url:this.props.hide_details_url,package_type_certificate:this.props.package_type_certificate,package_type_carnet:this.props.package_type_carnet,
overpayment_balance:this.state.overpayment_balance,show_overpayment:this.are_all_customers_the_same_person()})))}},render_net_price_controls:function(e){var t=this.get_total_net_price_after_discount(),n=NumberUtils.round_price(Math.max(0,e-t));if(VersumConfig.is_vat_payer)return React.createElement("span",{className:"light-font e2e-net-price"},VersumConfig.t_net,":"," ",NumberUtils.format_price(Math.max(0,t))," ","(",EventComponents.t("tax"),": ",NumberUtils.format_price(n),")")},render_gross_price_controls:function(e){if(VersumConfig.is_vat_payer)return React.createElement("div",{className:"overlay-line"},React.createElement("div",{className:"overlay-line-label"},EventComponents.t("gross_price",{t_gross:VersumConfig.t_gross}),":"),React.createElement("div",{className:"overlay-line-content"},NumberUtils.format_price(e)))},render_discount_controls:function(){return this.state.initial_discount_type?React.createElement("div",{id:"event-discounts",className:this.already_finalized()?"d-block":"d-none"},React.createElement(EventComponents.EventDiscounts,{ref:"event_discounts",events:this.state.events,on_update:this.update_state,group:this.state.group,initial_discount_type:this.state.initial_discount_type,event_edition_enabled:this.state.edit_mode})):React.createElement("span",null)},render_to_be_paid:function(e,t){return e===t?React.createElement("div",null,React.createElement("div",null,React.createElement("span",{className:"fs-h4 e2e-total-price"},NumberUtils.format_price(e)),this.render_discount_button(),this.render_discount(e,t)),React.createElement("div",null,this.render_net_price_controls(t))):React.createElement("div",null,React.createElement("div",null,React.createElement("span",{className:"before-discount line-through"},NumberUtils.format_price(e)),React.createElement("span",{className:"fs-h4 ml-s"},NumberUtils.format_price(t)),this.render_discount(e,t)),React.createElement("div",null,this.render_net_price_controls(t)))},render_discount:function(e,t){var n=Math.abs(t-e);return this.state.initial_discount_type&&React.createElement("span",null,this.state.edit_mode&&React.createElement("span",null,n>0?React.createElement("a",{href:"#",className:"ml-s",onClick:this.show_discount},I18n.t("js.discounts.edit_discount")):this.render_discount_button(!0)))||""},render_discount_button:function(e){return e||!this.state.initial_discount_type&&this.state.edit_mode?React.createElement("button",{className:"btn left_space discount-button e2e-discount-button",onClick:this.show_discount},EventComponents.t("add_discount")):React.createElement("span",null)},render_tips_button:function(e){if(this.state.edit_mode&&this.state.tips_activated&&0===Tips.get_active_tips(this.state.group.tips).length)return React.createElement("button",{className:"btn left_space discount-button e2e-tips-button",onClick:this.show_tips(e)},EventComponents.t("add_tip"))},render_actions:function(){return this.props.hide_actions?React.createElement("span",null):React.createElement("div",{className:"simple_form"},React.createElement("div",{className:"form-actions"},this.render_footer_buttons()))},render_footer_buttons:function(){return this.state.modified_by_another_user?React.createElement("button",{onClick:this.on_screen_close,className:"button button-blue"},EventComponents.t("close")):this.state.edit_mode?this.render_edit_mode_buttons():this.render_show_mode_buttons()},render_edit_mode_buttons:function(){var t=this.state.events,n=t[0],a=e.grep(t,function(e){return e.canceled}).length===t.length,r=this,s=n.customer_was_edited?!n.customer.id:!n.customer.customer_url,i=this.props.fiscal_printer_activated&&!this.already_finalized()&&!a,o=n.tss_receipt_issuing_available&&!this.already_finalized()&&!a,c="e2e-finalize-button button mr-s";i||o||(c+=" button-blue"),this.state.submit_enabled||(c+=" disabled");var _;_=this.already_finalized()||a?EventComponents.t("save_changes"):t.length>1?EventComponents.t("finalize_events"):EventComponents.t("finalize_event");var p,l=React.createElement("button",{onClick:this.finalize_events_without_receipt,className:c},_);if(i){var u="button button-blue mr-s";this.state.submit_enabled||(u+=" disabled"),p=React.createElement("button",{onClick:this.finalize_events_with_receipt,className:u},EventComponents.t("finalize_and_print"))}else if(o){var d="button button-blue mr-s";this.state.submit_enabled||(d+=" disabled"),p=React.createElement("button",{onClick:this.finalize_events_with_tss_receipt,className:d},EventComponents.t("finalize_and_print"))}else p=React.createElement("span",null);var m;m=t[0].show_prepayment_receipt_url?React.createElement("button",{className:"btn",onClick:this.on_show_receipt(t[0].show_prepayment_receipt_url)},EventComponents.t("show_prepayment_receipt")):n.prepayment_tss_receipt_issuing_available&&n.prepayment_id&&n.prepayment_tss_receipts&&n.prepayment_tss_receipts.length>0?React.createElement("button",{className:"btn",onClick:this.on_show_tss_receipt(n.prepayment_tss_receipts,n.prepayment_id,"prepayment",r.on_prepayment_tss_receipt_issued)},EventComponents.t("show_prepayment_receipt")):React.createElement("span",null);var h=this.props.invoice_types||[],v=(this.props.invoice_default_type,this),f=[],g=!this.already_finalized()&&!a&&h.length;if(g){var y="text-nowrap";this.state.submit_enabled||(y+=" disabled"),e.each(h,function(e,t){var n=s&&"standard"===t;f.push(n?React.createElement("a",{href:"#",key:e,className:"text-nowrap text-muted","data-toggle":"tooltip","data-placement":"right","data-original-title":"",title:EventComponents.t("add_customer_to_issue_invoice")},EventComponents.t("finalize_and_invoice_"+t)):React.createElement("a",{href:"#",key:e,onClick:function(){v.finalize_events_with_invoice(t)},className:y},EventComponents.t("finalize_and_invoice_"+t)))})}return React.createElement("div",{className:"d-flex"},p,m,l,g&&React.createElement("div",{className:"btn-group dropup"},React.createElement("button",{type:"button",className:"btn dropdown-toggle","data-toggle":"dropdown"},EventComponents.t("finalize_and_invoice")),React.createElement("ul",{className:"dropdown-menu dropdown-menu"},f.map(function(e){return React.createElement("li",{className:"dropdown-item"},e)})))||"",React.createElement("a",{className:"action-link ml-auto e2e-cancel-link",href:"#",onClick:this.on_screen_close},I18n.t("js.cancel")))},render_show_mode_buttons:function(){var t,n,a,r,s,i=this.state.events[0],o=!i.customer.customer_url,c=this;t=i.new_receipt_url?React.createElement("button",{className:"btn",onClick:this.on_print_receipt(i.new_receipt_url)},EventComponents.t("print_receipt")):i.show_receipt_url?React.createElement("button",{className:"btn",onClick:this.on_show_receipt(i.show_receipt_url)},EventComponents.t("show_receipt")):i.tss_receipt_issuing_available&&i.tss_receipts&&i.tss_receipts.length>0?React.createElement("button",{className:"btn",onClick:this.on_show_tss_receipt(i.tss_receipts,i.id,"events",c.on_tss_receipt_issued)},EventComponents.t("show_receipt")):i.tss_receipt_issuing_available?React.createElement("button",{className:"btn",onClick:this.on_print_tss_receipt()},EventComponents.t("print_receipt")):React.createElement("span",null),n=i.show_prepayment_receipt_url?React.createElement("button",{className:"btn",onClick:this.on_show_receipt(i.show_prepayment_receipt_url)},EventComponents.t("show_prepayment_receipt")):i.prepayment_tss_receipt_issuing_available&&i.prepayment_id&&i.prepayment_tss_receipts&&i.prepayment_tss_receipts.length>0?React.createElement("button",{className:"btn",onClick:this.on_show_tss_receipt(i.prepayment_tss_receipts,i.prepayment_id,"prepayment",c.on_prepayment_tss_receipt_issued)},EventComponents.t("show_prepayment_receipt")):React.createElement("span",null);var _=this.props.invoice_types||[],p=(this.props.invoice_default_type,this),l=[],a=React.createElement("span",null),u="";return i.new_invoice_url&&!i.canceled?e.each(_,function(e,t){var n=o&&"standard"===t;l.push(n?React.createElement("span",{"data-toggle":"tooltip","data-placement":"right",title:EventComponents.t("add_customer_to_issue_invoice"),key:e,className:"button button-disabled mr-s"},EventComponents.t("issue_invoice_"+t)):React.createElement("button",{key:e,onClick:function(){n||p.on_print_invoice(i.new_invoice_url,t)},className:"btn"},EventComponents.t("issue_invoice_"+t)))}):i.show_invoice_url&&(u=i.invoice_customer_name&&React.createElement("div",{className:"mb-s"},I18n.t("js.invoicing_components.invoice_for")+" "+i.invoice_customer_name)||"",a=React.createElement("button",{className:"btn",onClick:function(){p.on_show_invoice(i.show_invoice_url)}},EventComponents.t("print_invoice"))),r=1===this.state.events.length&&i.editable?React.createElement("a",{href:"#",onClick:this.delete_event,className:"action-link icon sprite-delete_blue",title:I18n.t("js.delete"),"data-toggle":"tooltip","data-desktop-tooltip":!0}):React.createElement("span",null),s=i.editable?React.createElement("a",{href:"#",onClick:this.set_edit_mode,className:"btn"},EventComponents.t("edit")):React.createElement("span",null),React.createElement("div",null,React.createElement("div",{className:"d-flex"},React.createElement("div",{className:""},t,n,u,a,l,React.createElement("a",{className:"icon sprite-print_blue",href:"/events/"+i.id+".pdf",target:"_blank",title:EventComponents.t("print_summary"),"data-toggle":"tooltip","data-desktop-tooltip":!0,"data-container":"body"})),React.createElement("div",{className:"ml-auto"},s,r)))},reset_checksum:function(){this.setState({initial_checksum:this.get_checksum(this.state.events)})},getInitialState:function(){var n=this,a=this.props.events.length,r=e.map(this.props.events,function(e){var t=e instanceof CalendarModels.Event,r=t?e:n.transform_event(e);return a>1&&r.id===n.props.selected_event_id&&(r.selected=!0),r}),s=e.map(r,function(e){return e.services}),i=r[0].initial_group_payments?r[0].initial_group_payments:e.map(r,function(e){return e.initial_payments});return e.each(i,function(t,n){n.package_item&&(n.package_services=e.grep(s,function(t){return-1!==e.inArray(t.event_service_id,n.package_event_service_ids)}))}),EventComponents.invoice_customer_id&&(EventComponents.invoice_customer_id=t),_.set(r,"[0].customer.overpayment_balance",this.props.overpayment_balance),{events:r,initial_payments:i,submit_enabled:!0,ignore_supply_use_inventories:!1,skip_resources_check:!1,skip_gift_cards_invalid_items:!1,skip_gift_cards_invalid_certificate_type:!1,edit_mode:this.props.edit_mode,is_closed:!1,modified_by_another_user:!1,gift_cards_counts_for_customers_store:new GiftCards.CountsForCustomersStore,tips_activated:VersumConfig.tips.tips_activated,show_prepayment_validation:!1,overpayment_balance:this.props.overpayment_balance}},componentWillMount:function(){this.state.group=this.build_group(),this.state.initial_discount_type=this.init_discounts(),this.sort_events(),Tips.get_active_tips(this.state.group.tips).length>0&&(this.state.tips_activated=!0),this.forceUpdate(),this.init_gift_card_counts()},componentDidMount:function(){this.props.escape_on&&this.init_escape();var t=this.state.events;if(this.already_finalized()&&t.length>1&&t[0].id!==this.props.selected_event_id){var n=e(ReactDOM.findDOMNode(this.refs.selected_event_box));this.props.overlay.animate({scrollTop:(n.offset()||{}).top-(this.props.overlay.offset()||{}).top})}!this.props.skip_service_fetching&&this.state.edit_mode&&this.props.services_for_select_manager.get_services_tree(),e('[data-toggle="tooltip"]').tooltip(),this.setState({initial_checksum:this.get_checksum(t)}),this.init_gift_card_templates()},componentWillUnmount:function(){this.escape_off(),e.lock_is_active=!1},init_gift_card_templates:function(){var t=e("[data-gift-cards-all-templates]"),n=e("[data-packages-all-templates]");t.data("gift-cards-all-templates")||e.get(GiftCards.construct_url("/templates/all_templates"),function(e){t.data("gift-cards-all-templates",e.gift_cards),n.data("packages-all-templates",e.packages)})},get_first_employee:function(){for(var e=0;e<this.state.events.length;e++){var t=this.state.events[e].get_first_employee();if(t)return t}return null},get_first_employee_from_all:function(){return this.props.all_employees?this.props.all_employees[0]:null},get_checksum:function(e){return HashCodeGenerator.simple_hashcode(e)},get_online_payment_amount:function(e){var t=this,n=_.get(t,"refs.event_payments.state.payments");return n&&n.reduce(function(t,n){return PaymentMethods.is_online(n.payment_method)?t+n[e||"value"]:t},0)||0},get_total_prepayment_amount_paid:function(){var t=0;return e.map(this.state.events,function(e){e.canceled||-1===["paid","refund_failed"].indexOf(e.prepayment.status)||(t+=+e.prepayment.amount_paid)}),t||0},get_total_price:function(){for(var e=0,t=0;t<this.state.events.length;t++){var n=this.state.events[t];n.canceled||n.destroy||(e+=n.get_total_price())}return NumberUtils.round_price(e)},get_total_price_after_discount:function(e){var t=this.refs.event_discounts?this.refs.event_discounts.get_discount_type():this.state.initial_discount_type,n=0;if(!t)return e||this.get_total_price();if("group"===t){n=this.state.group.discount.new_value()}else for(var a=0;a<this.state.events.length;a++){var r=this.state.events[a];r.canceled||r.destroy||(n+=r.get_total_price_after_discount())}return NumberUtils.round_price(n)},get_price_to_pay:function(){this.state.group.tips;return this.get_total_price_after_discount()-this.get_total_prepayment_amount_paid()},get_total_net_price_after_discount:function(){for(var e=this.refs.event_discounts?this.refs.event_discounts.get_discount_type():this.state.initial_discount_type,t=0,n=0;n<this.state.events.length;n++){var a=this.state.events[n];a.canceled||a.destroy||(t+=a.get_total_net_price_after_discount())}if(!e)return t;if("group"===e){t=t*(100-100*this.state.group.discount.get_precise_percentage())/100}return isNaN(t)?0:NumberUtils.round_price(t)},init_gift_card_counts:function(){var t=this.state.events,n=e.map(t,function(e){return e.customer});if(VersumConfig.gift_cards_activated&&!(n.length<=0)){var a=e.map(n,function(e){return e.id});if(a.length>0){var r=this;this.state.gift_cards_counts_for_customers_store.get_counts_for_customers(a).done(function(a){e.each(n,function(e,t){t.gift_cards_count=a[t.id].gift_cards_count,t.packages_count=a[t.id].packages_count}),r.setState({initial_checksum:r.get_checksum(t)})})}}},already_finalized:function(){return this.state.events[0].finalized},transform_event:function(e){var t=CalendarModels.create_event_transformer(e,{default_employee_id:this.props.default_employee_id,default_resource_id:this.props.default_resource_id,available_employees:this.props.employees_with_calendar,available_resources:this.props.resources}).run();return e.supply_use||t.finalized||this.add_formulas_to_event(t),t},add_formulas_to_event:function(e){for(var t=0;t<e.services.length;t++){var n=e.services[t],a=[],r=this.props.formula_manager.get_formulas_for_service(n.id);if(r){for(var s=0;s<r.length;s++){var i=r[s],o=CalendarModels.create_product_from_formula(i);a.push(o)}a.length>0&&(n.supply_use=CalendarModels.create_order({products:a}))}}},build_group:function(e){var t,n=e||{},a=this.state.events[0].group_discount;return t=a?CalendarModels.create_discount({item:n,discount_value:NumberUtils.parse_price(a.discount_value),discount_type:a.discount_type}):CalendarModels.create_discount({item:n,discount_value:0,discount_type:"proportional"}),n.discount=t,n.tips=this.state.events[0].group_tips||[],n},init_discounts:function(){var e=this.state.group.discount;if(e.discount_value>0)return e.activate(),"group";var t,n,a,r=null,s=this.state.events;for(t=0;t<s.length;t++){var i=s[t],o=i.services.concat(i.get_sold_gift_cards()).concat(i.get_sold_packages());for(i.order&&(o=o.concat(i.order.products)),n=0;n<o.length;n++)a=o[n].discount,a.activate(),!r&&a&&a.discount_value>0&&(r="individual")}return r},clone_discounts:function(){var e={group:_.cloneDeep(this.state.group),events:_.cloneDeep(this.state.events)};return this.refs.event_discounts&&(e.event_discounts=_.cloneDeep(this.refs.event_discounts.state)),e},clone_event_discounts:function(){var e={};return this.refs.event_discounts&&(e.event_discounts=_.cloneDeep(this.refs.event_discounts.state)),e},restore_discounts:function(e,t){e&&(this.state.events=e.events,this.state.group=e.group,this.refs.event_discounts&&t&&(this.refs.event_discounts.state=t.event_discounts,this.refs.event_discounts.forceUpdate()),this.update_state())},show_discount:function(){var t,n=this,a=n.clone_discounts();n.state.group.discount.active||(n.state.group.discount.activate(),n.setState({initial_discount_type:"group"})),n.state.group.discount.init_discount_value(),n.update_state();var r=!1,s=e('<div class="discounts-modal">'),i=new BootstrapDialog({title:EventComponents.t("add_discount"),message:s,closeByBackdrop:!1,buttons:[{label:I18n.t("js.dialog.save"),cssClass:"button-blue",action:function(e){r=!0,e.close()}},{label:I18n.t("js.dialog.cancel"),action:function(e){e.close()}}],onshow:function(){setTimeout(function(){t=n.clone_event_discounts(),n.render_modal_discounts(s.get(0))},0)},onhide:function(){r||(n.restore_discounts(a,t),ReactDOM.unmountComponentAtNode(s.get(0)))}});ComponentHelpers.add_modal_enter_key_action(i,s,0),i.open()},render_modal_discounts:function(e){function t(t){n.refs.event_discounts&&(n.refs.event_discounts.state=t||{},n.refs.event_discounts.forceUpdate()),n.update_state(),n.render_modal_discounts(e)}var n=this,a=n.state.initial_discount_type;n.refs.event_discounts&&(a=n.refs.event_discounts.state.discount_type),ReactDOM.render(React.createElement(EventComponents.EventDiscounts,{events:n.state.events,on_update:t,group:n.state.group,initial_discount_type:a,event_edition_enabled:n.state.edit_mode}),e)},show_tips:function(t){var n=this,a=n.get_first_employee()||n.get_first_employee_from_all(),r=_.cloneDeep(n.state.group.tips);return function(){0===Tips.get_active_tips(n.state.group.tips).length&&(n.state.group.tips.push(Tips.build_tip({total_price:t,employee:a})),n.forceUpdate());var s=e('<div class="tips-modal">'),i=!1,o=new BootstrapDialog({title:EventComponents.t("add_tip"),message:s,closeByBackdrop:!1,buttons:[{label:I18n.t("js.dialog.save"),cssClass:"button-blue",action:function(e){i=!0,e.close()}},{label:I18n.t("js.dialog.cancel"),action:function(e){e.close()}}],onhide:function(){i||(n.state.group.tips=r,n.forceUpdate(),ReactDOM.unmountComponentAtNode(s.get(0)))}});n.render_modal_tips(s.get(0),t),o.open(),ComponentHelpers.add_modal_enter_key_action(o,s,0)}},render_modal_tips:function(e,t){var n=this;ReactDOM.render(React.createElement(Tips.TipsComponent,{change:n.refs.event_payments.get_change(),tips:n.state.group.tips,employees:n.props.all_employees,default_employee:n.get_first_employee(),total_price:t,edit_mode:n.state.edit_mode,update_component:function(){n.refs.event_payments.on_change(),n.render_modal_tips(e,t)}}),e)},sort_events:function(){this.state.events.sort(function(e,t){return e.beginning.isBefore(t.beginning)?-1:e.beginning.isAfter(t.beginning)?1:0})},set_edit_mode:function(e){e&&e.preventDefault(),!this.props.skip_service_fetching&&this.props.services_for_select_manager&&this.props.services_for_select_manager.get_services_tree(),this.setState({edit_mode:!0})},on_screen_close:function(e){e&&e.preventDefault(),this.close()},show_close_confirm_dialog:function(e,t){var n=this;BootstrapDialog.show({title:I18n.t("js.dialog.confirm"),message:e,buttons:[{label:I18n.t("js.dialog.accept"),cssClass:"button-blue",action:function(e){e.close(),t()}},{label:I18n.t("js.dialog.cancel"),action:function(e){e.close()}}],onhide:function(){n.setState({is_closed:!1})}})},show_unfinished_online_payment_modal:function(){var e=this;e.refetch_events(),BootstrapDialog.show({type:BootstrapDialog.TYPE_PRIMARY,title:I18n.t("js.dialog.confirm"),message:I18n.t("js.online_payments.unpaid_finalization_confirm"),buttons:[{label:I18n.t("js.online_payments.edit_event"),action:function(t){e.setState({edit_mode:!0}),t.close()}},{label:I18n.t("js.online_payments.finish_later"),action:function(t){t.close(),e.perform_close()}}],onhide:function(){e.setState({online_payment_started:!1,is_closed:!1,submit_enabled:!0})}})},close:function(e){if(!this.state.is_closed){var t=this,n=this.get_checksum(this.state.events);if(this.isMounted()&&this.setState({is_closed:!0}),t.state.online_payment_started&&!t.state.online_payment_finished)return void this.show_unfinished_online_payment_modal();n!==this.state.initial_checksum&&!e&&this.state.edit_mode?t.show_close_confirm_dialog(EventComponents.t("close_confirmation"),t.perform_close):this.perform_close()}},perform_close:function(){var e=this.props.overlay;this.isMounted()&&ReactDOM.unmountComponentAtNode(ReactDOM.findDOMNode(this).parentNode),e.animate({scrollTop:0},0),VersumUtils.hide_overlay(e),e.html(""),this.escape_off()},on_payments_change:function(t){var n=t.payments;this.setState({payments:n});var a=0;e.each(this.state.events,function(e,t){a+=t.get_lumo_points()}),this.set_excluded_lumo_points(a,t),this.update_state()},handle_overpayment_change:function(e){this.setState({overpayment_balance:e}),this.refs.event_payments.setState(this.refs.event_payments.getInitialState())},set_excluded_lumo_points:function(t,n){var a=0,r=0,s=this.state.payments?this.state.payments:n.payments;e.each(s,function(e,t){"gift"!==t.payment_method&&"gratis"!==t.payment_method||(a+=Math.round(t.value*VersumConfig.lumo.lumo_service_purchase_points),r+=Math.round(t.value*VersumConfig.lumo.lumo_product_purchase_points))});var i=null,o=null;a>0&&(i=(a/t*100).toFixed(2)),r>0&&(o=(r/t*100).toFixed(2)),this.setState({excluded_lumo_points_percentage_for_services:i,excluded_lumo_points_percentage_for_products:o})},update_state:function(){this.forceUpdate()},init_escape:function(){var t=this;this.escape_on();var n=function(){t.escape_off()},a=function(){setTimeout(t.escape_on,200)};e(document).on("select2-open shown.bs.modal autocompleteopen",n).on("focus",".hasDatepicker",n).on("select2-close hidden.bs.modal autocompleteclose",a).on("blur",".hasDatepicker",a).on("v2ModalOpen",n).on("v2ModalClose",a)},escape_on:function(){var t=this;e(document).secureOn("keyup.finalization_screen",function(e){27==e.keyCode&&t.close()})},escape_off:function(){e(document).off("keyup.finalization_screen")},remove_event:function(e){this.state.events.splice(e,1),this.forceUpdate()},delete_event:function(e){e&&e.preventDefault();var t=this;destroy_event(this.state.events[0].id,!1,{start:function(){VersumUtils.show_indicator()},success:function(){VersumUtils.hide_indicator(),t.close(!0)},error:function(){VersumUtils.hide_indicator()},destroy_all_future_events_enabled:t.state.events[0].is_recurring_event()&&!t.state.events[0].finalized})},finalize_events_with_receipt:function(){return this.finalize_events("receipt")},finalize_events_with_tss_receipt:function(){return this.finalize_events("tss_receipt")},finalize_events_with_invoice:function(e){return this.finalize_events("invoice",e)},finalize_events_without_receipt:function(){return this.finalize_events()},push_finalized_events_to_calendar:function(e,t){var n=this;"function"==typeof n.props.on_finalization&&n.props.on_finalization(e,t)},set_view_as_finalized:function(){var e=this.state.events;e[0].finalized=!0,this.setState({events:e,edit_mode:!1})},should_update_events:function(){var e=this.state.events;for(i=0;i<e.length;i++)if(e[i].should_update_event)return!0;return!1},are_prepayments_for_update_events_valid:function(){var e=this.state.events,t=0;for(i=0;i<e.length;i++)if(t=e[i].prepayment.id&&e[i].prepayment.amount_paid>0?e[i].prepayment.amount_paid:e[i].prepayment.amount,(!e[i].prepayment.payment_method||t<=0)&&!e[i].prepayment.disabled)return!1;return!0},finalize_events:function(t,n){var a=this;if(this.state.submit_enabled){if(this.setState({submit_enabled:!1}),VersumConfig.prepayments_enabled&&this.should_update_events()){if(this.are_prepayments_for_update_events_valid()){var r=this.state.events.map(function(e){return CalendarModels.create_event_saver({event:e}).update_events_in_finalization(e).error(function(t){a.setState({error_messages:{events:_defineProperty({},e.id,t.responseJSON.error_messages)},submit_enabled:!0})})});return void e.when.apply(e,r).done(function(){var e=a.get_finalizer();VersumUtils.show_indicator(),a.run_finalizer(e,t,n)})}return this.setState({show_prepayment_validation:!0,submit_enabled:!0}),void this.update_state()}var s=this.get_finalizer();VersumUtils.show_indicator(),this.run_finalizer(s,t,n)}},get_finalizer:function(){var e=this.refs.event_discounts?this.refs.event_discounts.get_discount_type():null,t=this.refs.event_payments.get_payments();return CalendarModels.create_finalizer({events:this.state.events,payments:t,total_price:this.get_total_price_after_discount(),total_price_before_discount:this.get_total_price(),total_payment:this.refs.event_payments.get_total_payment(),group_id:this.state.events[0].group_id,discount_type:e,group_discount:this.state.group.discount,group_tips:this.state.group.tips,ignore_supply_use_inventories:this.state.ignore_supply_use_inventories,skip_resources_check:this.state.skip_resources_check,skip_gift_cards_invalid_items:this.state.skip_gift_cards_invalid_items,skip_gift_cards_invalid_certificate_type:this.state.skip_gift_cards_invalid_certificate_type,set_flash_on_success:this.props.set_flash_on_success,excluded_lumo_points_percentage_for_services:this.state.excluded_lumo_points_percentage_for_services,excluded_lumo_points_percentage_for_products:this.state.excluded_lumo_points_percentage_for_products})},run_finalizer:function(e,t,n){var a=this.refs.event_payments.get_payments(),r=this,s="receipt"===t,i="tss_receipt"===t,o="invoice"===t;return e.run().always(function(){VersumUtils.hide_indicator()}).done(function(e){var t=_.get(e,"events[0].group_id"),c=_.get(e,"events[0].customer_id");if(r.get_online_payment_amount()>0&&0===r.get_online_payment_amount("paid")&&(r.set_view_as_finalized(),r.render_online_payment_modal(c,t)),r.push_finalized_events_to_calendar(e.events,0===r.get_online_payment_amount()||r.get_online_payment_amount("paid")>0),s&&e.new_receipt_url)r.print_receipt(e.new_receipt_url);else if(i)window.reactLegacyBridge.modals.NewReceiptModal.renderModal({type:"events",id:e.events[0].event_id});else{if(o&&e.new_invoice_url)return void r.show_invoice_customer_popup(n,function(){ComponentHelpers.open_invoice_popup(e.new_invoice_url+"&type="+n+(r.get_invoice_customer_id()&&"&customer_id="+r.get_invoice_customer_id()||""),!0)});r.props.fiscal_printer_activated&&!r.already_finalized()&&FiscalPrinter.drawer_auto_opening()&&r.has_positive_cash_payment(a)&&FiscalPrinter.build_client().open_drawer()}return e}).fail(function(e,n,a){r.setState({submit_enabled:!0});var s=CalendarModels.create_event_error_handler(e,n,a,{on_error:{422:function(e){if(s.modal_shown)r.setState({error_messages:null});else{r.setState({error_messages:e.error_messages,modified_by_another_user:e.modified_by_another_user});var t=r.props.overlay,n=t.find(".error-explanation").first();n.length>0&&t.animate({scrollTop:n.offset().top-t.offset().top})}}},supply_use_quantity_exceeded_skipped:function(){r.state.ignore_supply_use_inventories=!0,r.finalize_events(t)},allocation_errors_skipped:function(){r.state.skip_resources_check=!0,r.finalize_events(t)},gift_cards_invalid_items_skipped:function(){r.state.skip_gift_cards_invalid_items=!0,r.finalize_events(t)},gift_cards_invalid_certificate_type_skipped:function(){r.state.skip_gift_cards_invalid_certificate_type=!0,r.finalize_events(t)}});s.run()})},has_positive_cash_payment:function(e){for(var t=0;t<e.length;t++){var n=e[t];if("cash"===n.payment_method&&n.value>0)return!0}return!1},print_receipt:function(e){FiscalPrinter.build_receipt_form_manager({form_url:e}).run()},on_print_receipt:function(e){var t=this;return function(n){n.preventDefault(),t.print_receipt(e)}},on_print_tss_receipt:function(){var e=this;return function(t){return t.preventDefault(),window.reactLegacyBridge.modals.NewReceiptModal.renderModal({type:"events",id:e.state.events[0].id,onReceiptIssued:function(t){return e.on_tss_receipt_issued(t)}})}},on_show_receipt:function(e){return function(t){t.preventDefault(),FiscalPrinter.build_receipt_list_popup_manager({url:e}).run()}},on_show_tss_receipt:function(e,t,n,a){return function(r){return r.preventDefault(),window.reactLegacyBridge.modals.ShowReceiptModal.renderModal({receipts:e,type:n,id:t,onReceiptIssued:a})}},on_tss_receipt_issued:function(e){var t=this.state.events;t[0].tss_receipts?t[0].tss_receipts.push(e):t[0].tss_receipts=[e],this.setState({events:t})},on_prepayment_tss_receipt_issued:function(e){var t=this.state.events;t[0].prepayment_tss_receipts?t[0].prepayment_tss_receipts.push(e):t[0].prepayment_tss_receipts=[e],this.setState({events:t})},on_save_invoice_click:function(e){var t=Object.assign({},this.state);delete t.events[0].new_invoice_url,_.set(t,"events[0].show_invoice_url",e),this.setState(t)},get_event_with_customer_id:function(){return this.state.events.find(function(e){return e&&e.customer&&e.customer.id})},get_invoice_customer_id:function(){var e=this.state.events[0];return!e.customer.customer_url&&e.customer.name?"":EventComponents.invoice_customer_id||_.get(this.get_event_with_customer_id(),"customer.id")},on_print_invoice:function(e,t){var n=this;n.show_invoice_customer_popup(t,function(){ComponentHelpers.open_invoice_popup(e+"&type="+t+(n.get_invoice_customer_id()&&"&customer_id="+n.get_invoice_customer_id()||""),!0,n.on_save_invoice_click)})},show_invoice_customer_popup:function(t,n){var a=this,r=this.state.events[0],s=e('<div id="customer_select_modal_content"></div>');if(r&&!a.are_all_customers_the_same_person())return BootstrapDialog.show({type:BootstrapDialog.TYPE_PRIMARY,title:EventComponents.t("select_customer"),message:s,buttons:[{label:EventComponents.t("finalize_and_invoice_"+t),cssClass:"button-blue",action:function(e){n(),e.close()}},{label:I18n.t("js.dialog.close"),action:function(e){e.close()}}],onShow:function(){}}),void setTimeout(function(){a.render_invoice_customer_modal_content()},300);n()},render_invoice_customer_modal_content:function(){var e=this,t=document.getElementById("customer_select_modal_content"),n=React.createElement("div",{className:"mb-l mb-l alert alert-warning"},React.createElement("p",{className:"mb-s"},EventComponents.t("finalize_multiple_customers_info")),e.render_invoice_customer_id_select()||"");t&&ReactDOM.render(n,t)},are_all_customers_the_same_person:function(){var e=this;return this.state.events.reduce(function(e,t){return _.get(t,"customer.id")?e+1:e},0)<=1||this.state.events.reduce(function(t,n){return _.get(e.get_event_with_customer_id(),"customer.id")===_.get(n,"customer.id")},!1)},render_invoice_customer_id_select:function(){return React.createElement("select",{onChange:function(e){EventComponents.invoice_customer_id=e.target.value}},(this.state.events||[]).map(function(e){var t=_.get(e,"customer.id");return t&&React.createElement("option",{value:t,key:t},e.customer.name)||""}))},on_show_invoice:function(e){ComponentHelpers.open_invoice_popup(e)},on_lumo_state_change:function(e,t){for(var n=this.state.events,a=0;a<n.length;a++){var r=n[a].customer;r&&r.id===e&&(r.lumo_state=t)}this.forceUpdate()},before_service_addition:function(){this.setState({submit_enabled:!1})},after_service_addition:function(){this.setState({submit_enabled:!0})},show_event_select:function(t){t.preventDefault(),VersumUtils.show_indicator();var n=this,a=e.map(this.state.events,function(e){return e.id}),r=moment();e.get("/events/events_for_select.json",{event_ids:a,date:r.format()}).then(function(t){VersumUtils.hide_indicator();var s=e("<div>"),i=new BootstrapDialog({title:EventComponents.t("event_select.title"),message:s});ReactDOM.render(React.createElement(EventComponents.EventSelect,{current_event_ids:a,on_event_select:n.add_another_event(i),events:t,date:r}),s.get(0)),i.open()})},add_another_event:function(t){var n=this;return function(a){e.jGrowl(EventComponents.t("messages.event_added_to_finalization"),{life:3e3,theme:"flash_notice"}),n.insert_additional_events(a),n.forceUpdate(),t.close()}},insert_additional_events:function(e){var t=e.formulas,n=e.events;t&&this.props.formula_manager.update_formulas_data(t);for(var a=0;a<n.length;a++){var r=this.transform_event(n[a]);r.services_tree=this.state.services_tree,this.state.events.push(r)}this.sort_events(),this.refs.event_payments.setState(this.refs.event_payments.getInitialState())},get_online_payment_method:function(){var e=_.get(this,"refs.event_payments.state.payments",[]),t=e.find(function(e){return PaymentMethods.is_online(e.payment_method)});return t&&t.payment_method},render_online_payment_modal:function(e,t){
var n=this,a=_.get(window,"reactLegacyBridge.modals.OnlinePaymentModal.renderModal",function(){});n.setState({online_payment_started:!0}),n&&a({customerId:e,amount:n.get_online_payment_amount(),subjectId:t,subjectType:"EVENT_FINALIZATION",description:"Payment for event group: "+t,paymentMethod:n.get_online_payment_method(),onPaymentSuccess:function(){n.setState({online_payment_finished:!0}),n.reset_checksum(),n.perform_close()},onLinkSent:function(){n.setState({online_payment_finished:!0}),n.reset_checksum(),n.perform_close()},onClose:function(){n.close()}})},update_event_payments_state:function(){var e=this;this.setState({prepayments_status_changed:!0}),this.get_total_prepayment_amount_paid()&&setTimeout(function(){var t=e.refs.event_payments;t.setState(t.getInitialState())},0)}})}(jQuery),EventComponents.GiftCardsSale=function(e){return React.createClass(e.extend({},GiftCards.Components.CommonSaleMethods,{render:function(){return React.createElement("div",null,this.render_table(),this.render_footer())},render_footer:function(){return this.props.edit_mode?React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement("div",{className:"col-sm-7"},this.render_new_gift_card_controls()),React.createElement("div",{className:"col-sm-5 items-value"},this.render_total_value()))):React.createElement("div",{className:"items-value"},this.render_total_value())},render_total_value:function(){return React.createElement("span",null,I18n.t("js.gift_cards.total_value"),":"," ",React.createElement("span",{className:"value"},CurrencyUtils.number_to_currency(this.props.order.get_sold_gift_cards_price())))}}))}(jQuery),EventComponents.OrderEmployee=function(e){return React.createClass({render:function(){if(this.props.event_edition_enabled)return React.createElement("div",{className:"items-employee-content"},React.createElement("select",{value:this.get_employee().id,ref:"employee_select"},ComponentHelpers.Employees.get_employee_options(this.props.all_employees,{current_employee:this.get_employee(),include_empty_option:!0})),React.createElement("i",{className:"icon sprite-info_tip2 left_space",title:EventComponents.t("order_employee.explanation"),"data-toggle":"tooltip"}));var e=this.get_employee();return e&&e.id?React.createElement("span",{className:"employee-name"},e.name):React.createElement("span",null,EventComponents.t("missing"))},componentDidMount:function(){this.props.event_edition_enabled&&e('[data-toggle="tooltip"]').tooltip(),this.init_select()},componentDidUpdate:function(t){!t.event_edition_enabled&&this.props.event_edition_enabled&&e('[data-toggle="tooltip"]').tooltip(),this.init_select()},init_select:function(){if(this.props.event_edition_enabled){var t=this,n=e(ReactDOM.findDOMNode(this.refs.employee_select));n.data("select2")||n.versum_select2({allowClear:!0}).on("change",function(){var a=n.select2("data");t.props.order.employee=a?e(a.element).data("entity"):null,t.props.on_order_change()})}},get_employee:function(){return this.props.order.employee||{name:EventComponents.t("missing")}}})}(jQuery),EventComponents.OrderProducts=function(e){return React.createClass({render:function(){return React.createElement("div",null,React.createElement("div",{className:"data_table products-table"},React.createElement("table",{className:classNames({"action-show":!this.props.event_edition_enabled})},React.createElement("thead",null,this.render_header()),React.createElement("tbody",null,this.render_product_controls(),!this.props.event_edition_enabled&&this.props.order.is_cost_defined()&&this.render_total_cost()))),this.render_footer())},render_header:function(){React.createElement("th",{className:"empty delete-item-cell"});return this.props.is_sale?React.createElement("tr",null,React.createElement("th",null,EventComponents.t("products.name")),React.createElement("th",null,EventComponents.t("products.unit")),React.createElement("th",null,EventComponents.t("products.quantity")),React.createElement("th",null,EventComponents.t("products.unit_price")," (",VersumConfig.t_gross,")"),React.createElement("th",null,EventComponents.t("products.vat")),React.createElement("th",null,EventComponents.t("products.value")," (",VersumConfig.t_gross,")"),this.render_remove_header()):React.createElement("tr",null,React.createElement("th",null,EventComponents.t("products.name")),React.createElement("th",null,EventComponents.t("products.unit")),React.createElement("th",{className:"supply-quantity"},EventComponents.t("products.quantity")),this.render_inventory_or_net_cost_header(),this.render_remove_header())},render_inventory_or_net_cost_header:function(){return this.props.event_edition_enabled?React.createElement("th",null,EventComponents.t("products.inventory")):this.props.order.is_cost_defined()?React.createElement("th",null,EventComponents.t("products.net_cost",{t_net:VersumConfig.t_net})):void 0},render_remove_header:function(){if(this.props.event_edition_enabled)return React.createElement("th",{className:"empty delete-item-cell"})},render_total_cost:function(){var e=0;return this.get_products().map(function(t){e+=t.net_cost}),React.createElement("tr",{className:"no_hover","data-non-selectable":""},React.createElement("td",{className:"empty",colSpan:"2"}),React.createElement("td",{className:"right_text",colSpan:"2"},EventComponents.t("products.net_cost",{t_net:VersumConfig.t_net}),React.createElement("strong",{className:"bigger_2 left_space"},CurrencyUtils.react_with_symbol(e.toFixed(2).replace(".",",")))))},render_product_controls:function(){if(this.get_products().length>0){var t=this;return e.map(this.get_products(),function(e,n){return React.createElement(EventComponents.OrderProduct,{product:e,key:e.key,index:n,set_product:t.set_product,on_product_change:t.props.on_order_change,on_product_delete:t.on_product_delete,is_sale:t.props.is_sale,event_edition_enabled:t.props.event_edition_enabled})})}return React.createElement("tr",null,React.createElement("td",{colSpan:"6",className:"full-width-colspan"},EventComponents.t("products.no_products")))},render_footer:function(){return this.props.is_sale?this.render_sale_footer():this.render_use_footer()},render_sale_footer:function(){return this.props.event_edition_enabled?React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement("div",{className:"col-sm-7 product-controls"},this.render_new_product_controls()),React.createElement("div",{className:"col-sm-5 products-value items-value"},this.render_products_value()))):React.createElement("div",{className:"products-value items-value"},this.render_products_value())},render_use_footer:function(){if(this.props.event_edition_enabled)return React.createElement("div",{className:"product-controls"},this.render_new_product_controls())},render_new_product_controls:function(){var e=this.get_products().length>0?EventComponents.t("products.add_another"):EventComponents.t("products.add_product");return React.createElement("button",{className:"btn right_space",type:"button",onClick:this.add_product},e)},render_products_value:function(){return this.props.is_sale?React.createElement("span",null,EventComponents.t("products.total"),": ",React.createElement("span",{className:"value"},this.format_total_price())):React.createElement("span",null)},componentDidMount:function(){StockroomForm.set_bindings()},format_total_price:function(){return NumberUtils.format_price(this.props.order.get_products_price(),!0)},get_products:function(){return this.props.order.products},add_product:function(){this.get_products().push(CalendarModels.create_empty_product()),this.props.on_order_change()},set_product:function(e,t){this.get_products()[e]=t,this.props.on_order_change()},on_product_delete:function(e){this.get_products().splice(e,1),this.get_products().length<=0?this.props.on_last_item_deletion():this.props.on_order_change()}})}(jQuery),EventComponents.OrderProduct=function(e){return React.createClass({render:function(){return this.props.product.empty?this.render_empty_product_row():this.render_product_row()},render_empty_product_row:function(){var e=React.createElement("td",{className:"autocomplete-input-cell"},React.createElement("input",{className:"no_enter",placeholder:EventComponents.t("products.placeholder"),type:"text",ref:"product_name_input"})),t=React.createElement("td",{className:"delete-item-cell"},this.render_delete_link());return this.props.is_sale?React.createElement("tr",null,e,React.createElement("td",{colSpan:5}),t):React.createElement("tr",null,e,React.createElement("td",{colSpan:3}),t)},render_product_row:function(){return this.props.is_sale?React.createElement("tr",null,React.createElement("td",{className:"product-name wrap"},React.createElement("a",{href:"/products/"+this.props.product.id,target:"_blank",dangerouslySetInnerHTML:{__html:this.props.product.name_with_type_info}})),this.render_unit_cell(),this.render_quantity_cell(),this.render_price_cell(),this.render_vat_cell(),React.createElement("td",{className:"wrap"},this.format_product_value()),this.render_remove_cell()):React.createElement("tr",null,React.createElement("td",{className:"product-name wrap"},React.createElement("a",{href:"/products/"+this.props.product.id,target:"_blank",dangerouslySetInnerHTML:{__html:this.props.product.name_with_type_info}})),this.render_unit_cell(),this.render_quantity_cell(),this.render_inventory_or_net_cost_cell(),this.render_remove_cell())},render_remove_cell:function(){var e=classNames({"delete-item-cell":!0,empty:!this.props.is_sale&&!this.props.event_edition_enabled});if(this.props.event_edition_enabled)return React.createElement("td",{className:e},this.render_delete_link())},render_unit_cell:function(){return!this.props.event_edition_enabled||StockroomForm.is_unconvertible_unit(this.props.product.unit_for_supplies)?React.createElement("td",{className:"wrap"},this.get_product_unit_name()):React.createElement("td",{className:"wrap"},React.createElement("select",{value:this.props.product.selected_unit,onChange:this.update_unit},React.createElement("option",{value:"pack"},this.get_unit_name("pack")),React.createElement("option",{value:this.props.product.unit_for_supplies},this.get_product_unit_name())))},render_price_cell:function(){if(this.props.event_edition_enabled){var e=React.createElement("input",{ref:"price",value:this.state.price_input_value,type:"text",className:"price-input",onChange:this.update_price});return React.createElement("td",null,CurrencyUtils.react_with_symbol(e))}return React.createElement("td",{className:"wrap"},NumberUtils.format_price(this.props.product.price||0))},render_vat_cell:function(){if(this.props.event_edition_enabled){var t=VatUtils.is_no_vat_value(this.props.product.vat_value)?"no_vat":this.props.product.vat_value;return React.createElement("td",null,React.createElement("select",{className:"vat-select",value:t,onChange:this.update_vat_value},e.map(VatUtils.get_all_rates(),function(e,t){return React.createElement("option",{key:t,value:VatUtils.is_no_vat_value(e.value)?"no_vat":e.value,"data-vat-value":e.value},e.label)})))}return React.createElement("td",{className:"wrap"},VatUtils.format_vat_value(this.props.product.vat_value))},render_quantity_cell:function(){return this.props.event_edition_enabled?React.createElement("td",{className:"error-popover"},React.createElement("input",{ref:"quantity",value:this.state.quantity_input_value,className:"quantity-input",type:"text",onChange:this.update_quantity})," ",this.get_selected_unit_name()):React.createElement("td",null,this.state.quantity_input_value," ",this.get_selected_unit_name())},render_inventory_or_net_cost_cell:function(){var e=this.props.product;if(this.props.event_edition_enabled){var t=NumberUtils.format_inventory(e.get_available_quantity_for_chosen_unit()),n=this.get_selected_unit_name();return React.createElement("td",null,t," ",n)}if(e.is_cost_defined())return React.createElement("td",null,NumberUtils.format_price(e.net_cost))},render_delete_link:function(){return this.props.event_edition_enabled?React.createElement("a",{onClick:this.delete_product,href:"#"},React.createElement("i",{className:"icon sprite-delete"})):React.createElement("span",null)},getInitialState:function(){var e=this.props.product;return e.empty?{}:{quantity_input_value:NumberUtils.format_number(e.get_quantity_for_chosen_unit()),price_input_value:NumberUtils.format_price_for_input(e.price||0)}},componentDidMount:function(){var t=this;if(this.props.product.empty){var n=e(ReactDOM.findDOMNode(this.refs.product_name_input));StockroomForm.make_product_combobox({form_type:this.props.is_sale?"orders":"use",size:30,element:n,success_callback:function(e){n.autocomplete("destroy"),t.set_product(e)},create_callback:function(e){n.autocomplete("destroy"),t.set_product(e)}}),n.focus()}this.check_quantity()},componentDidUpdate:function(){this.check_quantity()},check_quantity:function(){if(this.props.event_edition_enabled&&!this.props.product.empty){var t=e(ReactDOM.findDOMNode(this.refs.quantity)),n=this.props.product;if(n.quantity_exceeded()){var a=NumberUtils.format_number(n.get_available_packs()),r='<div style="white-space:nowrap">'+I18n.t("js.stockroom.insufficient_inventory",{count:a})+"</div>";t.addClass("error").popover({html:!0,content:r,trigger:"focus",placement:"top"}),t.is(":focus")&&t.popover("show")}else t.removeClass("error").popover("destroy")}},format_product_value:function(){return NumberUtils.format_price(this.props.product.get_value())},get_selected_unit_name:function(){return this.get_unit_name(this.props.product.selected_unit)},get_product_unit_name:function(){return this.get_unit_name(this.props.product.unit_for_supplies)},get_unit_name:function(e){return I18n.t(e,{scope:"js.stockroom.products.units.short"})},set_product:function(t){var n,a;this.props.is_sale?(n=NumberUtils.parse_quantity(t.supply_pack_size),is_unconvertible_unit=StockroomForm.is_unconvertible_unit(t.unit_for_supplies),a=is_unconvertible_unit?t.unit_for_supplies:"pack"):(n=0,a=t.unit_for_supplies);var r=VatUtils.is_no_vat_value(t.vat_value)?t.vat_value:NumberUtils.parse_number(t.vat_value),s=e.extend({},t,{name:t.name_without_type_info,name_with_type_info:t.name,price:NumberUtils.parse_price(t.price),selected_unit:a,supply_pack_size:NumberUtils.parse_quantity(t.supply_pack_size),inventory:NumberUtils.parse_quantity(t.inventory),quantity:n,key:ComponentHelpers.Keys.get_unique_key(),lumo_standard_conversion:"true"===String(t.lumo_standard_conversion),vat_value:r}),i=CalendarModels.create_product(s);i.discount.activate();var o=i.get_quantity_for_chosen_unit();this.state.quantity_input_value=NumberUtils.format_number(o),this.state.price_input_value=NumberUtils.format_price_for_input(i.price),this.props.set_product(this.props.index,i)},update_unit:function(e){var t=this.props.product;t.selected_unit=e.target.value,this.state.quantity_input_value=NumberUtils.format_number(t.get_quantity_for_chosen_unit()),this.props.on_product_change()},update_quantity:function(e){var t=e.target.value;this.state.quantity_input_value=t,this.props.product.set_quantity_for_chosen_unit(NumberUtils.parse_quantity(t)),this.props.on_product_change()},update_price:function(e){var t=e.target.value;this.props.product.price=NumberUtils.parse_price(t),this.state.price_input_value=t,this.props.on_product_change()},update_vat_value:function(t){var n=this.props.product,a=n.get_net_price(),r=e(t.target).find("option:selected").data("vat-value");n.vat_value=VatUtils.is_no_vat_value(r)?VatUtils.NO_VAT_VALUE:NumberUtils.parse_number(r),n.price=NumberUtils.round_price(a*(1+n.vat_value/100)),this.state.price_input_value=NumberUtils.format_price_for_input(n.price),this.props.on_product_change()},delete_product:function(e){e.preventDefault(),this.props.on_product_delete(this.props.index)}})}(jQuery),EventComponents.PackagesSale=function(e){return React.createClass(e.extend({},Packages.Components.CommonSaleMethods,{render:function(){return React.createElement("div",null,this.render_table(),this.render_footer())},render_footer:function(){return this.props.edit_mode?React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement("div",{className:"col-sm-7"},this.render_new_package_controls()),React.createElement("div",{className:"col-sm-5 items-value"},this.render_total_value()))):React.createElement("div",{className:"items-value"},this.render_total_value())},render_total_value:function(){return React.createElement("span",null,I18n.t("js.gift_cards.total_value"),":"," ",React.createElement("span",{className:"value"},CurrencyUtils.number_to_currency(this.props.order.get_sold_packages_price())))}}))}(jQuery),EventComponents.PendingEventScreen=function(e,t){return React.createClass({render:function(){var e=this.state.event;window.state=this.state;var t=classNames({"event-screen":!0,"overlay-content":!0,"edit-mode":this.state.edit_mode,"show-mode":!this.state.edit_mode,"in-popup":"popup"===this.props.view_type,"in-overlay":"overlay"===this.props.view_type});return React.createElement("div",{className:t},this.render_title_container(),React.createElement("div",{className:"event-boxes"},React.createElement(EventComponents.EventBox,{event:e,key:e.id,ref:"event_box_"+e.id,all_employees:this.props.all_employees,employees_with_calendar:this.props.employees_with_calendar,resources:this.props.resources,all_tags:this.props.all_tags,on_event_change:this.update_state,on_prepayment_requirements_change:EventComponents.check_prepayment_requirements.bind(this,e),index:0,remove_event:this.remove_event,formula_manager:this.props.formula_manager,error_messages:this.state.error_messages||{},before_service_addition:this.before_service_addition,after_service_addition:this.after_service_addition,event_edition_enabled:this.state.edit_mode,events_number:1,finalization:!1,view_type:this.props.view_type,on_screen_close:this.on_screen_close,on_payment_link_sent:this.reset_checksum,on_online_payment_start:this.handle_online_payment_start,set_edit_mode:this.set_edit_mode,on_arrived_tag_change:this.props.on_arrived_tag_change,on_beginning_date_change:this.props.on_beginning_date_change,services_for_select_manager:this.props.services_for_select_manager,hide_actions:this.props.hide_actions,customer_edition_enabled:this.props.customer_edition_enabled,package_type_certificate:this.props.package_type_certificate,package_type_carnet:this.props.package_type_carnet,on_prepayment_refund:this.handle_prepayment_refund,show_prepayment_validation:this.state.show_prepayment_validation,gift_cards_counts_for_customers_store:this.state.gift_cards_counts_for_customers_store}),this.render_paid_info()),this.render_actions())},handle_online_payment_start:function(){this.state.event.online_payment_started=!0,this.setState({edit_mode:!1})},render_title_container:function(){return this.props.hide_title?React.createElement("span",null):React.createElement("div",{className:"row event-screen-title"},React.createElement("h2",{className:"col-xs-8"},this.render_title()),React.createElement("div",{className:"col-xs-4 text-right"},React.createElement("button",{type:"button",className:"btn btn-default2",title:EventComponents.t("close_title"),onClick:this.on_screen_close},EventComponents.t("close"))))},render_title:function(){var e;return e=this.state.event.id?this.state.edit_mode?EventComponents.t("title.edit_pending"):EventComponents.t("title.show_pending"):EventComponents.t("title.new"),React.createElement("span",null,e)},render_actions:function(){return this.props.hide_actions?React.createElement("span",null):React.createElement("div",{className:"simple_form"},React.createElement("div",{className:"form-actions"},this.render_footer_buttons()))},render_footer_buttons:function(){return this.state.modified_by_another_user?React.createElement("button",{onClick:this.on_screen_close,className:"button button-blue"},EventComponents.t("close")):this.state.edit_mode?this.render_edit_mode_buttons():this.render_show_mode_buttons()},render_edit_mode_buttons:function(){var e=this.state.event.id?EventComponents.t("save_changes"):EventComponents.t("add_event");return React.createElement("div",{className:"d-flex"},React.createElement("div",null,React.createElement("button",{onClick:this.create_save_handler,className:"button button-blue e2e-save-event"},e),this.render_edit_mode_cancel_link()),React.createElement("div",{className:"ml-auto"},this.render_switch_mode_button(EventComponents.t("advanced_view"),EventComponents.t("simple_view"))))},render_edit_mode_cancel_link:function(){if("overlay"===this.props.view_type)return React.createElement("a",{className:"button button-link",href:"#",onClick:this.on_screen_close,key:"cancel_link"},I18n.t("js.cancel"))},render_show_mode_buttons:function(){var e,t;return this.state.event.editable&&(e=React.createElement("a",{href:"#",onClick:this.set_edit_mode,className:"button mr-s e2e-edit-event-button"},EventComponents.t("edit")),t=React.createElement("a",{href:"#",onClick:this.delete_event,className:"action-link icon sprite-delete_blue",title:I18n.t("js.delete"),"data-toggle":"tooltip","data-desktop-tooltip":!0})),React.createElement("div",{className:"d-flex"},React.createElement("div",null,this.render_finalization_buttons(),this.render_print_button()),React.createElement("div",{className:"ml-auto"},this.render_switch_mode_button(EventComponents.t("details"),EventComponents.t("hide_details")),e,t))},render_switch_mode_button:function(e,t){return"popup"===this.props.view_type?React.createElement("a",{href:"#",onClick:this.set_advanced_mode,className:"button mr-xs"},e):React.createElement("a",{href:"#",onClick:this.set_simple_mode,className:"button mr-xs"},t)},render_finalization_buttons:function(){return this.state.event.not_an_appointment||!this.state.event.editable?null:this.props.finalization_events.length>1?React.createElement("span",{className:"button-group mr-s"},React.createElement("button",{onClick:this.finalize_many,className:"button button-blue"},EventComponents.t("finalize_many",{count:this.props.finalization_events.length})),React.createElement("button",{className:"button button-blue button-dropdown button-divider dropdown-toggle","data-toggle":"dropdown"}),React.createElement("ul",{className:"dropdown-menu"},React.createElement("li",null,React.createElement("a",{href:"#",onClick:this.finalize_one},EventComponents.t("finalize_one"))),React.createElement("li",null,React.createElement("a",{href:"#",onClick:this.finalize_many},EventComponents.t("finalize_many",{count:this.props.finalization_events.length}))))):React.createElement("a",{href:"#",onClick:this.finalize_one,className:"button button-blue mr-s"},EventComponents.t("finalize"))},render_print_button:function(){var e=this.state.event,t=this.props.invoice_types||[],n=this,a=function(){return!e.not_an_appointment&&React.createElement("li",null,React.createElement("a",{href:"/events/"+e.id+".pdf",target:"_blank"},EventComponents.t("print_summary")))},r=function(){return e.new_receipt_url&&React.createElement("li",null,React.createElement("div",{className:"item",onClick:ComponentHelpers.on_print_receipt(e.new_receipt_url)},EventComponents.t("print_prepayment_receipt")))},s=function(){return e.prepayment_tss_receipt_issuing_available&&e.prepayment_id&&(!e.prepayment_tss_receipts||0===e.prepayment_tss_receipts.length)&&React.createElement("li",null,React.createElement("div",{className:"item",onClick:ComponentHelpers.on_print_tss_receipt(e.prepayment_id,n.on_prepayment_tss_receipt_issued)},EventComponents.t("print_prepayment_receipt")))},i=function(){return e.show_prepayment_receipt_url&&React.createElement("li",null,React.createElement("div",{className:"item",onClick:ComponentHelpers.on_show_receipt(e.show_receipt_url)},EventComponents.t("show_prepayment_receipt")))},o=function(){return e.prepayment_tss_receipt_issuing_available&&e.prepayment_id&&e.prepayment_tss_receipts&&e.prepayment_tss_receipts.length>0&&React.createElement("li",null,React.createElement("div",{className:"item",onClick:ComponentHelpers.on_show_tss_receipt(e.prepayment_tss_receipts,e.prepayment_id,n.on_prepayment_tss_receipt_issued)},EventComponents.t("show_prepayment_receipt")))},c=t.map(function(t,n){return e.new_invoice_url&&React.createElement("li",null,React.createElement("div",{className:"item",key:n,onClick:function(){ComponentHelpers.on_print_invoice(e.new_invoice_url,t)}},I18n.t("js.prepayments.invoice_"+t)))});return React.createElement("span",{className:"button-group p-relative mr-s"},React.createElement("button",{className:"button button-dropdown dropdown-toggle","data-toggle":"dropdown"},React.createElement("a",{className:"action-link icon sprite-print_blue"})),React.createElement("ul",{className:"dropdown-menu"},a(),r(),s(),i(),o(),c))},render_payment_row:function(e,t){return React.createElement("div",{className:"box-line",key:t},React.createElement("div",{className:"box-line-label paid-label"},EventComponents.t("payments.paid"),":"),React.createElement("div",{className:"box-line-content"},React.createElement("div",{key:e.key,className:"payment-method",style:{marginBottom:10}},React.createElement("span",{className:"paid-price-non-editable right_space"},CurrencyUtils.react_with_symbol(e.price)),React.createElement("span",{className:"payment-value-container"},React.createElement("span",{className:"right_space"},PaymentMethods.t(e.payment_method)),e.is_refund&&React.createElement("span",{className:"refund right_space"},"(",I18n.t("js.payments.refund"),")"),e.is_pending&&React.createElement("span",{className:"pending right_space"},"(",I18n.t("js.payments.pending"),")"),e.details_url&&!this.props.hide_details_url&&React.createElement("a",{className:"right_space details-link",target:"_blank",href:e.details_url},I18n.t("js.payments.details"))))))},render_paid_info:function(){var t=this,n=this.state.event.payments;if(n&&n.length)return React.createElement("div",{className:"payment-methods-box"},e.map(n,function(e,n){return t.render_payment_row(e,n)}))},getInitialState:function(){var e=this.transform_event(this.props.events[0]);return _.set(e,"customer.overpayment_balance",this.props.overpayment_balance),{event:e,submit_enabled:!0,edit_mode:this.props.edit_mode,is_closed:!1,is_new:null===e.id,skip_hours_check:!1,skip_resources_check:!1,modified_by_another_user:!1,show_prepayment_validation:!1,gift_cards_counts_for_customers_store:new GiftCards.CountsForCustomersStore}},componentDidMount:function(){!this.props.skip_service_fetching&&this.state.edit_mode&&this.props.services_for_select_manager.get_services_tree(),this.props.escape_on&&this.init_escape(),e('[data-toggle="tooltip"]').tooltip(),this.reset_checksum()},componentWillUnmount:function(){this.escape_off(),e.lock_is_active=!1},get_event_payload:function(){var e={event:this.state.event,skip_hours_check:this.state.skip_hours_check,skip_resources_check:this.state.skip_resources_check};return CalendarModels.create_event_saver(e)._prepare_data_for_event()},reset_checksum:function(){this.setState({initial_checksum:this.get_checksum(this.get_event_payload())})},get_checksum:function(e){return HashCodeGenerator.simple_hashcode(e)},has_prepayment_amount_but_no_client:function(){var e=this.state.event.customer.id,t=this.state.event.customer_name.trim(),n=this.state.event.get_prepayment_amount(),a=!!e||t&&""!==t;return n>0&&!a},is_prepayment_amount_valid:function(){var e=NumberUtils.parse_number(this.state.event.prepayment.amount);return!this.state.event.prepayment.changed||!isNaN(e)&&e>0},handle_prepayment_refund:function(){get_new_calendar_api().refetchEvents(),this.setState({initial_checksum:this.get_checksum(this.get_event_payload())}),this.update_state()},is_prepayment_method_valid:function(){return!(this.state.event.prepayment.payment_method||!this.state.event.prepayment.disabled)||!!this.state.event.prepayment.payment_method},show_validation_error_modal:function(e){var t=this;EventViews.show_error_modal(e,function(){t.setState({submit_enabled:!0})})},show_unfinished_online_payment_modal:function(){var e=this;BootstrapDialog.show({type:BootstrapDialog.TYPE_PRIMARY,title:I18n.t("js.dialog.confirm"),message:I18n.t("js.online_payments.unpaid_prepayment_confirm"),buttons:[{label:I18n.t("js.online_payments.edit_event"),action:function(t){e.setState({edit_mode:!0}),e.reset_checksum(),e.update_state(),t.close()}},{label:I18n.t("js.online_payments.finish_later"),action:function(t){t.close(),e.perform_close()}}],onhide:function(){e.state.event.online_payment_started=!1,e.setState({is_closed:!1,submit_enabled:!0})}})},create_save_handler:function(){return this.state.event.is_recurring_event()?this.save_recurring_event():this.save_event()},show_update_future_events_modal:function(e){var n=this;n.state.event;BootstrapDialog.show({type:BootstrapDialog.TYPE_DEFAULT,title:I18n.t("js.dialog.confirm"),message:I18n.t("js.event_recurrence.update_all_future_events"),buttons:[{cssClass:"button-blue",label:I18n.t("js.event_recurrence.save_only_current_event"),action:function(e){n.state.update_all_future_events=t,e.close()}},{label:I18n.t("js.event_recurrence.save_current_with_fututre_events"),action:function(e){n.state.update_all_future_events=1,e.close()}}],onhide:function(){e()}})},save_recurring_event:function(){var e=this,n=e.state.event,a=n.id&&!n.event_type_changed;n.recurrence_manager.recurringEventsBeginningsUpdated()||n.recurrence_manager.hasConflicts||!n.recurrence_manager.recurringEvents||(n.recurrence_manager.recurringEvents=t,n.recurrence_manager.draftRecurringEvents=[]),a?n.recurrence_manager.fetchEventsInRecurrenceGroup().then(function(){n.recurrence_manager.eventsFromServer&&n.recurrence_manager.eventsFromServer.length?e.show_update_future_events_modal(e.save_event):e.save_event()}):e.save_event()},save_event:function(e,n,a){var r=this;if(this.state.submit_enabled){this.setState({submit_enabled:!1});var s=_.get(r,"state.event.customer.id",0),i={event:this.state.event,skip_hours_check:this.state.skip_hours_check,skip_resources_check:this.state.skip_resources_check};!this.state.event.is_recurring_event()&&this.state.event.was_recurring_event||Object.assign(i,{update_all_future_events:this.state.update_all_future_events});var o=CalendarModels.create_event_saver(i);if(r.state.event.prepayment.required&&!r.state.event.skip_prepayment_requirement&&!r.state.event.prepayment.amount&&!r.state.event.prepayment.payment_method)return void BootstrapDialog.show({type:BootstrapDialog.TYPE_WARNING,title:I18n.t("js.dialog.confirm"),message:I18n.t("js.prepayments.skip_required_prepayment_confirm"),buttons:[{label:I18n.t("js.dialog.yes"),action:function(e){r.state.event.skip_prepayment_requirement=!0,e.close()}},{label:I18n.t("js.dialog.no"),action:function(e){e.close()}}],onhide:function(){r.setState({submit_enabled:!0}),r.state.event.skip_prepayment_requirement&&r.save_event(e,n,a)}});if(!r.state.event.prepayment.disabled){if(r.has_prepayment_amount_but_no_client())return void this.show_validation_error_modal(EventComponents.t("no_customer_prepayment_explanation"));if(!r.is_prepayment_amount_valid())return void this.setState({show_prepayment_validation:!0,submit_enabled:!0});if(!r.is_prepayment_method_valid())return void this.setState({show_prepayment_validation:!0,submit_enabled:!0})}return VersumUtils.show_indicator(),o.run().always(function(){VersumUtils.hide_indicator(),r.state.update_all_future_events=t,r.state.event.is_recurring_event()&&(r.state.event.recurrence_manager.hasConflicts=!1)}).done(function(e){if(e[0]){Object.assign(r.state.event,{id:e[0].event_id,created_at:moment(e[0].created_at,"YYYY-MM-DD HH:mm")});var t=r.state.event.customer_id!==_.get(r,"state.event.customer.id");r.state.event.customer.id||(s=e[0].customer_id,r.state.event.customer={id:s,name:r.state.event.customer_name}),r.update_state();var i=e[0].prepayment_id||0,o=e[0].prepayment_amount||0,c=r.state.event.prepayment.getOnlineAmount();if(!r.state.online_payment_started&&r.is_online_prepayment_not_paid_yet()||r.is_online_prepayment_not_paid_yet(t))return void r.render_online_prepayment_modal(s,i,c,function(){e[0].prepayment_amount_paid=o,e[0].prepayment_status="paid",r.state.event.online_payment_finished=!0,r.push_saved_event_to_calendar(e)},function(){r.state.event.online_payment_finished=!0,r.reset_checksum(),r.update_state()},function(){r.setState({submit_enabled:!0}),r.update_state(),r.push_saved_event_to_calendar(e)},e[0]);var p=r.state.event.was_recurring_event;return r.push_saved_event_to_calendar(e,a,p),n}}).fail(function(e,t,n){r.setState({submit_enabled:!0});var a={on_error:{422:function(e){if(s.modal_shown)r.setState({error_messages:null});else{r.setState({error_messages:e.error_messages,modified_by_another_user:e.modified_by_another_user});var t=r.props.overlay,n=t.find(".error-explanation").first()
;n.length>0&&t.animate({scrollTop:n.offset().top-t.offset().top})}}},is_in_the_past_skipped:function(){r.state.skip_hours_check=!0,r.save_event()},allocation_errors_skipped:function(){r.state.skip_resources_check=!0,r.save_event()}};r.state.event.is_recurring_event()&&(a.on_error.recurrence_conflicts=function(e){r.state.event.recurrence_manager.handleEventSaveRecurrenceErrors(e),r.state.event.recurrence_manager.showPayloadEditorModal(function(e){r.state.update_all_future_events=1,e.ignoreConflicts&&(r.state.skip_hours_check=!0,r.state.skip_resources_check=!0),r.save_event()})});var s=CalendarModels.create_event_error_handler(e,t,n,a);s.run()})}},push_saved_event_to_calendar:function(t,n,a){this.isMounted()&&this.setState({submit_enabled:!0}),"function"==typeof this.props.on_save&&this.props.on_save(t,n,a);var r=t[0].prepayment_id||0,s=t[0].prepayment_status||0,i=t[0].prepayment_amount||0;e("#prepayment-"+r).html(I18n.t("js.prepayments.status."+s)+" "+CurrencyUtils.number_to_currency(i))},is_online_prepayment_not_paid_yet:function(e){var t=this.state.event;return(e||this.state.is_new||t.prepayment.changed)&&t.prepayment.getOnlineAmount()>0&&!t.prepayment.amount_paid},render_online_prepayment_modal:function(e,t,n,a,r,s,i){var o=_.get(window,"reactLegacyBridge.modals.OnlinePaymentModal.renderModal",function(){}),c=this.state.event,p=c.prepayment.extraPayments[0];this.state.event.online_payment_started=!0,this.setState({edit_mode:!1}),this.update_state(),o({customerId:e,amount:n,subjectId:t,subjectType:"EVENT_PREPAYMENT",description:"Prepayment for event group: "+t,paymentMethod:p&&p.paymentMethod||c.prepayment.payment_method_selected||c.prepayment.payment_type||c.prepayment.payment_method,helperPayments:c.prepayment.getOnlineHelperPaymentsInput(),onPaymentSuccess:a,onLinkSent:r,onClose:s,event:i})},finalize_one:function(e){e.preventDefault(),this.finalize([this.props.events[0]])},finalize_many:function(e){e.preventDefault(),this.finalize(this.props.finalization_events)},finalize:function(t){var n=this;this.close(!0),t=e.map(t,function(e){return e.id===n.state.event.id?n.state.event:e});var a=EventViews.show_event_screen({main_event:this.props.events[0],events:t,formula_manager:this.props.formula_manager,action:"finalize",component_params:this.props.original_params});if("function"==typeof this.props.on_component_switch)return this.props.on_component_switch(a)},set_simple_mode:function(e){e.preventDefault(),EventViews.switch_to_popup(EventComponents.PendingEventScreen,this)},set_advanced_mode:function(e){e.preventDefault(),EventViews.switch_to_overlay(EventComponents.PendingEventScreen,this)},transform_event:function(e){var t=CalendarModels.create_event_transformer(e,{default_employee_id:this.props.default_employee_id,default_resource_id:this.props.default_resource_id,available_employees:this.props.employees_with_calendar,available_resources:this.props.resources}).run();return e.supply_use||this.add_formulas_to_event(t),t},add_formulas_to_event:function(e){for(var t=0;t<e.services.length;t++){var n=e.services[t],a=[],r=this.props.formula_manager.get_formulas_for_service(n.id);if(r){for(var s=0;s<r.length;s++){var i=r[s],o=CalendarModels.create_product_from_formula(i);a.push(o)}a.length>0&&(n.supply_use=CalendarModels.create_order({products:a}))}}},set_edit_mode:function(t){t&&t.preventDefault(),!this.props.skip_service_fetching&&this.props.services_for_select_manager&&this.props.services_for_select_manager.get_services_tree();var n=this.state.event.services;1===n.length&&n[0].is_unknown()?(this.state.event.services=[],n[0].resources&&1===n[0].resources.length&&(this.state.event.default_resource=n[0].resources[0])):this.state.event.services=e.grep(n,function(e){return!e.is_unknown()}),this.setState({edit_mode:!0}),EventComponents.check_prepayment_requirements.call(this,this.state.event,!1)},on_screen_close:function(e){e&&e.preventDefault(),this.close()},close:function(e){if(!this.state.is_closed){this.setState({is_closed:!0});var t=this,n=this.get_checksum(this.get_event_payload());if(t.state.event.online_payment_started&&!t.state.event.online_payment_finished)return void t.show_unfinished_online_payment_modal();n===this.state.initial_checksum||e?this.perform_close():BootstrapDialog.show({title:I18n.t("js.dialog.confirm"),message:EventComponents.t("close_confirmation"),buttons:[{label:I18n.t("js.dialog.accept"),cssClass:"button-blue",action:function(e){e.close(),t.perform_close()}},{label:I18n.t("js.dialog.cancel"),action:function(e){e.close()}}],onhide:function(){t.setState({is_closed:!1})}})}},perform_close:function(){var e=this.props.overlay;window.reactLegacyBridge.servicesBrowser.unmountServicesBrowsers(),this.isMounted()&&ReactDOM.unmountComponentAtNode(ReactDOM.findDOMNode(this).parentNode),"overlay"===this.props.view_type?(e.animate({scrollTop:0},0),VersumUtils.hide_overlay(e),e.html("")):(e.draggable("destroy").popup("hide").remove(),e.html("")),get_new_calendar_api().unselect()},update_state:function(){this.isMounted()&&this.forceUpdate()},init_escape:function(){var t=this;this.escape_on();var n=function(){t.escape_off()},a=function(){setTimeout(t.escape_on,1e3)};e(document).on("select2-open shown.bs.modal autocompleteopen",n).on("focus",".hasDatepicker",n).on("select2-close hidden.bs.modal autocompleteclose",a).on("blur",".hasDatepicker",a).on("v2ModalOpen",n).on("v2ModalClose",a)},escape_on:function(){var t=this;e(document).secureOn("keyup.finalization_screen",function(e){27==e.keyCode&&t.close()})},escape_off:function(){e(document).off("keyup.finalization_screen")},delete_event:function(e){function t(){destroy_event(a.id,r,{start:function(){VersumUtils.show_indicator()},success:function(){VersumUtils.hide_indicator(),n.close(!0)},error:function(){VersumUtils.hide_indicator()},destroy_all_future_events_enabled:a.is_recurring_event()&&!a.finalized&&a.recurrence_manager.eventsFromServer&&a.recurrence_manager.eventsFromServer.length>0})}e&&e.preventDefault();var n=this,a=n.state.event,r=this.state.event.tags.filter(function(e){return"already_paid"==e.kind}).length>0;a.is_recurring_event()?a.recurrence_manager.fetchEventsInRecurrenceGroup().then(function(){t()}):t()},before_service_addition:function(){this.setState({submit_enabled:!1})},after_service_addition:function(){this.setState({submit_enabled:!0})},on_prepayment_tss_receipt_issued:function(e){var t=this.state.event;t.prepayment_tss_receipts?t.prepayment_tss_receipts.push(e):t.prepayment_tss_receipts=[e],this.setState({event:t})}})}(jQuery),EventComponents.PrepaymentStatusLabel=function(){return React.createClass({render:function(){return React.createElement("span",{className:classNames({"v2-label mx-s e2e-prepayment-status":!0,"v2-label-success":"paid"===this.props.payment_status,"v2-label-warning":-1!==["queued","refund_pending"].indexOf(this.props.payment_status),"v2-label-error":-1!==["unpaid","refund_failed"].indexOf(this.props.payment_status)}),"data-toggle":"tooltip","data-original-title":this.state.tooltip_content},I18n.t("js.prepayments.status."+this.props.payment_status))},getInitialState:function(){return{tooltip_content:"",passed_seconds:0}},componentDidMount:function(){var e=this;"paid"===this.props.payment_status?this.setState({tooltip_content:this.get_prepayment_paid_date()}):(this.setState({tooltip_content:this.get_prepayment_remaining_time()}),this.countDownInterval=setInterval(function(){e.setState({tooltip_content:e.get_prepayment_remaining_time()})},1e3))},componentWillUnmount:function(){this.countDownInterval&&clearInterval(this.countDownInterval)},get_prepayment_remaining_time:function(){var e=moment(this.props.prepayment_expiration_date_time),t=e.subtract(this.state.passed_seconds,"seconds").diff(Date.now(),"hours"),n=e.subtract(this.state.passed_seconds,"seconds").diff(Date.now(),"minutes"),a=e.subtract(this.state.passed_seconds,"seconds").diff(Date.now(),"seconds");return a>0&&"queued"===this.props.payment_status?(this.setState(function(e){return{passed_seconds:e.passed_seconds++}}),I18n.t("js.prepayments.prepayments_details.time_left",{hours:t,minutes:n%60,seconds:a%60})):a<=0&&"paid"!==this.props.payment_status&&"refund_failed"!==this.props.payment_status?(this.countDownInterval&&clearInterval(this.countDownInterval),I18n.t("js.prepayments.prepayments_details.time_over")):(this.countDownInterval&&clearInterval(this.countDownInterval),this.get_prepayment_paid_date())},get_prepayment_paid_date:function(){var e=DateUtils.format_datetime(moment(this.props.prepayment_paid_at));if("paid"===this.props.payment_status)return I18n.t("js.prepayments.prepayments_details.paid")+e}})}(jQuery),EventComponents.ServiceEmployee=function(e){return React.createClass({render:function(){var e=this.get_employee();return this.props.event_edition_enabled?React.createElement("select",{value:e.id,ref:"employee_select",className:"e2e-employee-select"},this.state.employee_options):React.createElement("span",{className:"employee-name right_space"},e.name)},getInitialState:function(){var t=this.props.service,n=(this.props.employees_with_calendar||[]).map(function(n){return e.extend(n,{duration:t.durationsByEmployeeId&&t.durationsByEmployeeId[n.id]||null})});return{employee_options:ComponentHelpers.Employees.get_employee_options(n,{current_employee:this.get_employee(),include_empty_option:!0}),allow_clear:this.should_allow_clear()}},componentDidMount:function(){this.init()},componentDidUpdate:function(){this.init()},should_allow_clear:function(){return VersumConfig.resources_activated&&this.props.service.resources&&this.props.service.resources.length>0},init:function(){if(e('[data-toggle="tooltip"]').tooltip(),this.props.event_edition_enabled){var t=this,n=this.get_employee(),a=e(ReactDOM.findDOMNode(this.refs.employee_select)),r=this.should_allow_clear();a.data("select2")&&r===this.state.allow_clear?a.select2("val",n.id):(this.state.allow_clear=r,a.off("change").select2("destroy").versum_select2({width:this.props.select_width||150,allowClear:r}).on("change",function(){var n=a.select2("data");t.props.service.employee=n?e(n.element).data("entity"):null;var r=t.props.service.durationsByEmployeeId&&t.props.service.durationsByEmployeeId[t.props.service.employee.id];t.props.service.duration=r||t.props.service.duration,t.props.service.item_duration=r||t.props.service.item_duration,t.props.on_service_change()}))}},get_employee:function(){return this.props.service.employee||{name:EventComponents.t("missing")}}})}(jQuery),EventComponents.ServiceResourcesModal=function(){return React.createClass({render:function(){return React.createElement("div",null,React.createElement("div",{className:"employee"},React.createElement("span",{className:"icon sprite-calendar_employees"})," ",React.createElement("span",{className:"right_space semibold"},EventComponents.t("service_resources_modal.employee"))," ",React.createElement("span",{className:"left_space"},React.createElement(EventComponents.ServiceEmployee,{service:this.props.service,employees_with_calendar:this.props.employees_with_calendar,on_service_change:this.update_component,event_edition_enabled:this.state.event_edition_enabled,select_width:300}))),this.render_resources())},render_resources:function(){if(VersumConfig.resources_activated)return React.createElement("div",{className:"resources"},React.createElement("p",null,React.createElement("span",{className:"icon sprite-calendar_resources"})," ",React.createElement("span",{className:"semibold"},EventComponents.t("service_resources_modal.resources"))),React.createElement(EventComponents.EventServiceResources,{service:this.props.service,resources_by_item_id:this.props.resources_by_item_id,on_service_change:this.update_component,resources:this.props.resources,event_edition_enabled:this.state.event_edition_enabled}))},getInitialState:function(){return{event_edition_enabled:this.props.event_edition_enabled}},update_component:function(){this.forceUpdate()},set_edit_mode:function(){this.setState({event_edition_enabled:!0})}})}(jQuery),EventComponents.ServicesAdjuster=function(e){return React.createClass({render:function(){var t,n=this,a=this.props.event;return t=a.beginning.isSame(a.end,"day")?React.createElement("span",null,a.beginning.format(I18n.t("js.date_format_with_day_name"))," ",React.createElement("strong",null,a.beginning.format("HH:mm")," - ",a.end.format("HH:mm"))):React.createElement("span",null,a.beginning.format(I18n.t("js.date_format_with_day_name"))," ",React.createElement("strong",null,a.beginning.format("HH:mm"))," - ",a.end.format(I18n.t("js.date_format_with_day_name"))," ",React.createElement("strong",null,a.end.format("HH:mm"))),React.createElement("div",{className:"services-adjuster"},React.createElement("p",{dangerouslySetInnerHTML:{__html:EventComponents.t("services_adjuster.message")}}),React.createElement("p",null,EventComponents.t("services_adjuster.event_duration"),": ",t),React.createElement("div",{className:"tabbed-table"},this.render_tabs(),React.createElement("table",{className:"table-wrapper"},e.map(this.props.event.services,function(e){return n.render_service(e)}))))},render_tabs:function(){var t=this,n=VersumConfig.resources_activated&&this.props.resources.length>0?["duration","employee","resources"]:["duration","employee"];return React.createElement("div",{className:"tabs clearfix"},e.map(n,function(e){var n="tab";return t.state.tab===e&&(n+=" active"),React.createElement("a",{href:"#",className:n,key:e,onClick:t.set_tab(e)},React.createElement("span",{className:"icon right_space "+ComponentHelpers.Services.get_icon_class_for_tab(e)}),EventComponents.t("services.tabs."+e))}))},render_service:function(e){switch(this.state.tab){case"duration":return React.createElement(EventComponents.EventServiceDuration,{event:this.props.event,service:e,on_event_change:this.update_component,key:e.key,event_edition_enabled:!0,event_time_manager:this.props.event_time_manager});case"employee":return React.createElement("tbody",null,React.createElement("tr",{className:"with-lower-row",key:e.key},React.createElement("td",{className:"service-name wrap"},e.name),React.createElement("td",{className:"service-employee"},EventComponents.t("services.employee"),":"," ",React.createElement(EventComponents.ServiceEmployee,{service:e,employees_with_calendar:this.props.employees_with_calendar,on_service_change:this.update_component,event_edition_enabled:!0}))));case"resources":return React.createElement("tbody",null,React.createElement("tr",{className:"with-lower-row",key:e.key},React.createElement("td",{className:"service-name wrap"},e.name)),React.createElement("tr",{key:e.key+"_resources_table"},React.createElement("td",{className:"box-cell"},React.createElement(EventComponents.EventServiceResources,{service:e,resources_by_item_id:this.props.resources_by_item_id,on_service_change:this.update_component,key:"service_resources_"+e.key,resources:this.props.resources,event_edition_enabled:!0}))))}},getInitialState:function(){return{tab:"duration"}},set_tab:function(e){var t=this;return function(n){n.preventDefault(),t.setState({tab:e})}},update_component:function(){this.forceUpdate()}})}(jQuery),EventComponents.SimpleServiceEmployee=function(e){return React.createClass({render:function(){var e=this.props.service.employee,t="employee-tag pointer e2e-employee-tag",n=this.props.service.is_medical_service&&!this.props.event_edition_enabled,a=this.props.service.random_employee;return e?(t+=" "+e.calendar_class_name,React.createElement("span",{title:EventComponents.t("services.employee")+": "+e.name+(n?", "+EventComponents.t("services.random_employee"):""),"data-toggle":"tooltip","data-desktop-tooltip":!0,onClick:this.props.on_click,className:t+(n?"":" full-name")+(a?" random-employee":"")},n?e.initials:e.name,a&&React.createElement("span",{className:"random-employee-label"},n?EventComponents.t("services.random_employee_abbr"):EventComponents.t("services.random_employee")))):(t+=" no-entity",React.createElement("span",{title:EventComponents.t("services.no_employee"),"data-toggle":"tooltip","data-desktop-tooltip":!0,className:t,onClick:this.props.on_click},React.createElement("span",{className:"icon sprite-calendar_employees"})))},componentDidMount:function(){e('[data-toggle="tooltip"]').tooltip()},componentDidUpdate:function(){e('[data-toggle="tooltip"]').tooltip("fixTitle")}})}(jQuery),EventComponents.SimpleServiceResources=function(e){return React.createClass({render:function(){var t=this.props.service.resources;if(t&&t.length){var n=e.map(t,function(e){return e.name}).join(", ");return React.createElement("span",{title:EventComponents.t("services.resources")+": "+n,"data-toggle":"tooltip",onClick:this.props.on_click,className:"resource-tag pointer"},React.createElement("span",{className:"icon sprite-calendar_resources"}),React.createElement("span",{className:"resources-length"},t.length))}return React.createElement("span",{title:EventComponents.t("services.no_resources"),"data-toggle":"tooltip",onClick:this.props.on_click,className:"resource-tag pointer no-entity"},React.createElement("span",{className:"icon sprite-calendar_resources"}))},componentDidMount:function(){e('[data-toggle="tooltip"]').tooltip()},componentDidUpdate:function(){e('[data-toggle="tooltip"]').tooltip("fixTitle")}})}(jQuery),window.MedicalModal=function(){function e(e){e.find("[data-authorization-button], [data-medicament-button], [data-material-button]").click(function(e){e.preventDefault(),t($(this).attr("href"),$(this))}),e.find("[data-print-button]").click(function(e){e.preventDefault(),n($(this))})}function t(e,t){var n=$(t).is("[data-medicament-button]"),a=$(t).is("[data-material-button]"),r=I18n.t("js.medical.dialog.title");n?r=I18n.t("js.medical.dialog.medicine_title"):a&&(r=I18n.t("js.medical.dialog.material_title")),$.get(e).done(function(e){var t=$("<div>");t.html(e),BootstrapDialog.show({title:r,message:t,buttons:[{label:I18n.t("js.dialog.close"),action:function(e){e.close()}}]})})}function n(e){$.get(e.attr("href")).done(function(t){var n=$("<div class='medical-modal-body'>");n.html(t);var a=[{label:I18n.t("js.medical.print"),icon:"icon sprite-print_blue mr-xs",cssClass:"button",action:function(){$(".medical-modal-body").find("[data-print]").get(0).click()}},{label:I18n.t("js.medical.print_customer"),cssClass:"button",icon:"icon sprite-print_blue mr-xs",action:function(){$(".medical-modal-body").find("[data-print-customer]").get(0).click()}}];0!==n.find("[data-edit-finished-examination]").length&&a.push({label:I18n.t("js.medical.edit_finished"),cssClass:"button button-link",action:function(){$(".medical-modal-body").find("[data-edit-finished-examination]").get(0).click()}}),BootstrapDialog.show({title:e.data("title"),message:n,buttons:a,cssClass:"modal-md"})})}return{run:e,run_medical_dialog:t}}();var EventViews=function(e){function t(e){e.formula_manager||(e.formula_manager=CalendarModels.create_formula_manager(e.formulas)),delete e.formulas}var n;return{get_new_event_data:function(e){return new EventViews.NewEventBuilder(e).build()},fetch_event_data:function(e){return new EventViews.Fetcher(e).run()},show_event_screen:function(e){return n&&n.hide_view(),t(e),n=new EventViews.ViewBuilder(e),n.show_view()},render_event_screen:function(e,n){return t(n),new EventViews.ViewBuilder(n).render_view(e)},switch_to_popup:function(t,n){if("popup"!==n.props.view_type){var a=n.props.overlay,r=e("#event_popup").clone(),s=e(ReactDOM.findDOMNode(n)).parent();r.append(s),VersumUtils.show_event_popup(r);var i=e.extend({},n.props,{view_type:"popup",overlay:r});return ReactDOM.render(React.createElement(t,i),s.get(0)),VersumUtils.hide_overlay(a),a.html(""),n}},switch_to_overlay:function(t,n){if("overlay"!==n.props.view_type){var a=n.props.overlay,r=e("#event_overlay"),s=e(ReactDOM.findDOMNode(n)).parent();r.append(s),VersumUtils.show_overlay(r);var i=e.extend({},n.props,{view_type:"overlay",overlay:r});return ReactDOM.render(React.createElement(t,i),s.get(0)),VersumUtils.hide_event_popup(a),a.html(""),n}},show_error_modal:function(e,t){BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:I18n.t("js.dialog.error"),message:e,buttons:[{label:I18n.t("js.dialog.close"),action:function(e){e.close()}}],onhide:function(){t()}})}}}(jQuery);EventViews.Fetcher=function(e){function t(e){this.event_id=e.event_id,this.skip_other_events=e.skip_other_events}return t.prototype.run=function(){var t=this,n={};return this.skip_other_events&&(n.skip_other_events=!0),e.get("/events/"+this.event_id+"/screen_data",n).then(function(e){for(var n,a=e.events,r=0;r<a.length;r++)if(a[r].id=t.event_id){n=a[r];break}return{main_event:n,events:e.events,formulas:e.formulas,overpayment_balance:e.overpayment_balance}})},t}(jQuery),EventViews.NewEventBuilder=function(e){function t(e){this.beginning=moment(e.beginning),this.end=moment(e.end),this.allday=e.allday}return t.prototype.build=function(){var t=this,n=e.Deferred(),a=moment(this.beginning).startOf("day"),r=moment(this.end).startOf("day"),s=JSON.parse(e("#new_event_data").data("event").value);return s.beginning=t.beginning.format(CalendarModels.EventTransformer.get_datetime_format()),s.end=t.end.format(CalendarModels.EventTransformer.get_datetime_format()),s.allday_beginning=a.format(CalendarModels.EventTransformer.get_datetime_format()),s.allday_end=r.format(CalendarModels.EventTransformer.get_datetime_format()),t.allday&&(s.not_an_appointment=!0,s.allday=!0),n.resolve({main_event:s,events:[s],formulas:null}),n.promise()},t}(jQuery),EventViews.ViewBuilder=function(e){function t(e){this.main_event=e.main_event,this.events=e.events,this.formula_manager=e.formula_manager,this.action=e.action||"show",this.view_type=e.view_type||"popup",this.component_params=e.component_params||{}}return t.prototype.show_view=function(){var e=this._get_container();return this._show_container(e),this.currently_shown_component=this._perform_render(e,{escape_on:!0}),this.currently_shown_component},t.prototype.hide_view=function(){this.currently_shown_component&&this.currently_shown_component.isMounted()&&this.currently_shown_component.close()},t.prototype.render_view=function(e){return this._perform_render(e)},t.prototype._perform_render=function(t,n){n=n||{};var a=this.main_event.finalized||"finalize"===this.action?this.events:[this.main_event];if("finalize"===this.action||"finalize_one"===this.action)for(var r=0;r<a.length;r++)a[r].tags=this._filter_event_tags(a[r]);var s=e("<div>");t.append(s);var i=e.extend({},n,this.component_params,{events:a,overlay:t,all_employees:t.data("all-employees"),employees_with_calendar:t.data("employees-with-calendar"),all_tags:t.data("tags"),resources:t.data("all-resources"),selected_event_id:this.main_event.id,edit_mode:this._get_edit_mode(),formula_manager:this.formula_manager,fiscal_printer_activated:VersumUtils.fiscal_printer_activated(),finalization_events:this.events,view_type:this._get_view_type(),package_type_certificate:t.data("package-type-certificate"),package_type_carnet:t.data("package-type-carnet"),invoice_types:e("[data-invoice-types]").data("invoice-types")||[],invoice_default_type:e("[data-invoice-default-type]").data("invoice-default-type")});return i.services_for_select_manager=i.services_for_select_manager||CalendarModels.ServicesForSelectManagerAltered,ReactDOM.render(this._get_component_element(i),s.get(0))},t.prototype._get_edit_mode=function(){return"show"!==this.action},t.prototype._get_container=function(){return"overlay"===this._get_view_type()?e("#event_overlay"):e("#event_popup").clone()},t.prototype._show_container=function(e){"overlay"===this._get_view_type()?VersumUtils.show_overlay(e):VersumUtils.show_event_popup(e)},t.prototype._get_view_type=function(){return this.main_event.finalized||"finalize"===this.action||"finalize_one"===this.action||"overlay"===this.view_type?"overlay":"popup"},t.prototype._get_component_element=function(t){return t=e.extend({original_params:t},t),this.main_event.finalized||"finalize"===this.action||"finalize_one"===this.action?React.createElement(EventComponents.FinalizationScreen,t):React.createElement(EventComponents.PendingEventScreen,t)},t.prototype._filter_event_tags=function(t){var n=[];return t.finalized?n=t.tags:e(t.tags).each(function(e,t){"customer_arrived"!==t.kind&&n.push(t)}),n},t}(jQuery);