# Evidence Ledger — 2026-02-20T01-30

## Decisions & Agreements

- VersumShell made persistent in `_app.tsx` via `PersistentShellWrapper` + nesting-detection
  Evidence: "Trwałe rozwiązanie: przenieść VersumShell do _app.tsx jako persistent layout. [...] tak"
- Nesting-detection approach chosen over touching 54+ pages — nested VersumShell → pass-through
  Evidence: plan approved verbatim; commit `19243f12` merged
- `/calendar` excluded from persistent shell — it replaces entire document via `document.write()`
  Evidence: CalendarPage code uses `document.open(); document.write(html); document.close();`
- Custom secondary nav → `useSetSecondaryNav()` hook (not `secondaryNav` prop) for 3 customer pages
  Evidence: Rules of Hooks violations caught by lint; fix applied before commit
- WarehouseLayout tab hrefs changed to `/*/history` directly to skip intermediate redirect pages
  Evidence: "Fix: zmienić hrefs bezpośrednio na /sales/history etc." — user approved implicitly
- Codex audit fix (`fix(panel): address services comments/commissions audit issues`) reviewed and approved
  Evidence: "Fix commit poprawny" confirmed after audit

## Preferences

- Krytyczna recenzja Codexa w języku polskim, zwięzła tabelaryczna
  Evidence: user initiated session "monitoruj jego zmiany i dawaj krytyczne uwagi"
- Pre-commit checklist must run before EVERY commit — never skip
  Evidence: commit `0e93a771` had lint errors (no-misused-promises, prettier) — Codex skipped checks
- Audit findings delivered as table: Problem | Naprawiony? format
  Evidence: user engaged positively with tabular format for fix verification

## Failure Modes Observed

- Codex (`gpt-5.3-codex`, `reasoning_effort=low`) committed with failing ESLint (no-misused-promises, no-floating-promises, prettier)
  Lesson: always verify lint on Codex commits before accepting
- VersumShell per-page architecture caused white screen on navigation — fundamental architectural debt
  Lesson: shell components must be in persistent layout (_app), not per-page
- WarehouseLayout tab hrefs pointed to redirect pages (`/sales`, `/use` etc.) causing double-navigation white screen
  Lesson: tab/nav links must point to final destination, not intermediate redirects
- `useSetSecondaryNav` hook placed after `if (!role) return null` early return → Rules of Hooks violation
  Lesson: all hooks must be called before any early return, always

## Inefficient Loops to Avoid

- Attempting to pass `secondaryNav` prop to per-page `<VersumShell>` — outer persistent shell won't see it
- Calling `useSetSecondaryNav` after early returns — produces lint error, must be moved before
- Background monitoring shell scripts for git changes — die on macOS when parent process exits; use polling instead

## Effective Patterns to Repeat

- Nesting-detection context pattern: provider in `_app.tsx` → nested component detects context → becomes pass-through
- `useLayoutEffect` (not `useEffect`) for secondary nav push to prevent first-render flicker
- Parallel file reads for audits — read all affected files simultaneously to reduce round-trips
- Tabular audit output: category | file | status | risk — efficient for code reviews
- Run `pnpm eslint src --fix && pnpm tsc --noEmit` before every commit on modified packages

## Open Questions / Unknowns

- `/settings` and `/extension` white screen: confirmed root cause is VersumShell per-page mount/unmount; persistent shell should fix it — not yet verified in production
- `if (!role) return null` guards in ~36 pages: now redundant (persistent shell handles auth) — cleanup deferred to future refactoring sessions
- DashboardLayout exists but is used by no page — dead code; safe to remove eventually

## Assumptions

- Persistent shell fixes white screen for `/settings` and `/extension` as intended
  Assumption (confidence: high). Verify: smoke test after deploy.
- All WarehouseLayout pages correctly become pass-throughs without regression
  Assumption (confidence: high). Verify: navigate through all warehouse sub-tabs in production.
- `useLayoutEffect` with no dependency array (unconditional re-run) is acceptable perf-wise for secondary nav
  Assumption (confidence: med). Verify: no visible flicker or excessive re-renders in customer pages.

## Redactions

- (none)
