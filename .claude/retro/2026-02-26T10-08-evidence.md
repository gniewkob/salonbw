# Evidence Ledger — 2026-02-26T10-08

## Decisions & Agreements
- Root `pnpm.overrides.next` must match workspace `package.json` versions when upgrading
  Evidence: Root override `"next": "14.2.32"` blocked panel/landing upgrade to 15.5.10 despite workspace package.json declaring 15.5.10
- `rewrites()` in next.config.mjs must return `{beforeFiles, afterFiles, fallback}` object, never flat array
  Evidence: Crash `routesManifest.rewrites.beforeFiles.filter(...)` — beforeFiles undefined when `return rules` (array) used; fixed to object format
- After `pnpm.overrides` change in root package.json, run `rm -rf node_modules && pnpm install` (clean) not incremental
  Evidence: Incremental pnpm install after override change resulted in CI pnpm virtual store corruption (`@next/env/dist/index.js` missing in CI)
- When push changes `package.json` or `pnpm-lock.yaml`, CI marks `shared=true` → builds BOTH landing AND panel; use `workflow_dispatch target=dashboard` to deploy panel-only
  Evidence: Landing build failed CI run 22436249501; panel never deployed; fix was manual `gh workflow run ... -F target=dashboard`

## Preferences
- Deploy panel only via `gh workflow run ... -F target=dashboard` when only panel-relevant files changed and landing is known-broken
  Evidence: user said "zrób deploy i upewniuj się że poprawnie się wykonał" → agent used workflow_dispatch for panel only after landing failure
- Use `pnpm store prune` + `rm -rf node_modules` before committing lockfile after pnpm.overrides change
  Evidence: CI pnpm virtual store corruption traced to incremental install; clean install produced identical lockfile, confirming no integrity issue

## Failure Modes Observed
- Upgrading Next version in workspace package.json WITHOUT updating `pnpm.overrides` in root package.json → CI installs old version
  Evidence: Commit `d56d2c26` changed panel/landing `package.json` to `next@15.5.10` but root `pnpm.overrides` still `14.2.32`; CI `--frozen-lockfile` installed 14.2.32
- macOS `com.apple.provenance` xattr on `node_modules/.modules.yaml` → EPERM on pnpm install
  Evidence: `pnpm.stdout` showed `EPERM: operation not permitted, open '.../node_modules/.modules.yaml'`; fixed with `xattr -d com.apple.provenance`
- next.config.mjs `rewrites()` returning flat array → routes-manifest.json has wrong format → `.beforeFiles.filter()` crash at runtime
  Evidence: git diff showed old code had `// Return array format... to prevent Next.js 15.5.10 crash on empty beforeFiles; return rules` — misdiagnosis caused regression
- pnpm shared trigger (`package.json` + `pnpm-lock.yaml` changed) building both landing and panel; if landing fails, panel is never deployed
  Evidence: CI run 22436249501 failed on landing, panel skipped; required manual workflow_dispatch

## Inefficient Loops to Avoid
- Diagnosing Next.js runtime crash without first checking `pnpm.overrides` in root package.json for version pins
  Evidence: Multiple previous failing runs (22418435919, 22419261772) before root cause was found in overrides
- Running incremental `pnpm install` after override change without clean node_modules
  Evidence: CI virtual store corruption came from incremental state; clean install produced correct result

## Effective Patterns to Repeat
- Check both workspace `package.json` AND root `pnpm.overrides` when investigating version mismatches
  Evidence: root override `"next": "14.2.32"` was the actual blocker; workspace package.json was irrelevant
- `pnpm store prune && rm -rf node_modules && pnpm install` before lockfile commit after dependency upgrades
  Evidence: Produced clean lockfile; identical after prune vs. incremental; no integrity issues
- `gh workflow run ... -F target=dashboard -F environment=production` for panel-only manual deploy
  Evidence: bypassed broken landing, deployed panel successfully in 2m51s; panel returned 307, API 200
- Check `pnpm.stderr` / `pnpm.stdout` untracked files for prior failed install context
  Evidence: pnpm.stdout revealed EPERM error; git status showed these as untracked diagnostic files

## Open Questions / Unknowns
- Landing CI failure (`@next/env/dist/index.js` missing in next virtual store) — root cause not confirmed
  Assumption (confidence: med): Caused by incremental pnpm install state in prior lockfile commit. Verify: re-run push-triggered CI after verifying clean lockfile produces landing build success.
- Whether `pnpm store prune` + clean install actually fixed the CI virtual store issue for landing, or if there's a deeper pnpm v10.14 + Next 15.5 incompatibility on Linux
  Assumption (confidence: med). Verify: trigger `target=public` deploy and observe landing build in CI.

## Assumptions
- Panel is now running Next 15.5.10 on production (panel.salon-bw.pl returns 307)
  Assumption (confidence: high). Verify: check `startup_probe.txt` or panel diagnostic endpoint.
- Landing is still running previous build (Next 14 or older Next 15 attempt)
  Assumption (confidence: high). Verify: check `dev.salon-bw.pl` or landing Passenger logs.

## Redactions
- (none)
